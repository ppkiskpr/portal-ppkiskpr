<!doctype html>
<html lang="ms" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portal Rasmi PPKI SK Paya Resak</title>

  <!-- Poppins -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --brand:#1F6F4A;
      --brand2:#0f4f34;
      --text:#111827;
      --muted:#6b7280;

      --bg:#f3f4f6;
      --card:#ffffff;
      --card2:#f9fafb;
      --border:#e5e7eb;

      --shadow: 0 16px 34px rgba(17,24,39,.10);

      --radius:18px;
      --radius2:22px;

      --sidebarOpen: 292px;
      --sidebarClosed: 82px;

      --contentMax: 1200px;
    }

    html[data-mode="dark"]{
      --bg:#0b1220;
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.65);

      --card:#111827;
      --card2:#0f172a;
      --border:rgba(255,255,255,.12);

      --shadow: 0 18px 60px rgba(0,0,0,.52);

      --brand:#1F6F4A;
      --brand2:#0f4f34;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: "Poppins", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: var(--bg);
      color: var(--text);
      min-height:100vh;
    }
    a{color:inherit;text-decoration:none}
    button,input,select,textarea{font-family:inherit}

    .app{display:flex;min-height:100vh}

    /* ======================
       ONE SIDEBAR (toggle)
    ====================== */
    .sidebar{
      width: var(--sidebarOpen);
      background: var(--card);
      border-right:1px solid var(--border);
      padding: 14px;
      position: sticky;
      top:0;
      height:100vh;
      overflow:auto;
      transition: width .18s ease;
      z-index: 30;
    }
    body.sb-closed .sidebar{
      width: var(--sidebarClosed);
      padding: 14px 10px;
    }

    /* Mobile becomes drawer */
    @media (max-width: 900px){
      .sidebar{
        position: fixed;
        left:0; top:0;
        height:100vh;
        transform: translateX(-110%);
        width: min(320px, 86vw);
        box-shadow: 0 26px 70px rgba(0,0,0,.55);
        transition: transform .18s ease;
      }
      body.sb-open .sidebar{ transform: translateX(0); }
      body.sb-closed .sidebar{ width: min(320px, 86vw); } /* ignore closed on mobile */
    }

    .sbBrand{
      display:flex; gap:12px; align-items:center;
      border:1px solid var(--border);
      background: var(--card2);
      border-radius: var(--radius2);
      padding: 12px;
      cursor:pointer;
      user-select:none;
      transition: background .15s ease, border-color .15s ease;
    }
    .sbBrand:hover{ border-color: rgba(31,111,74,.35); }

    .sbLogo{
      width:46px;height:46px;border-radius:16px;
      border:1px solid var(--border);
      background: rgba(31,111,74,.14);
      overflow:hidden;
      display:grid;place-items:center;
      flex:0 0 auto;
    }
    .sbLogo img{width:100%;height:100%;object-fit:cover;display:block}

    .sbBrandText{min-width:0}
    .sbName{
      font-weight:900;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      letter-spacing:.2px;
    }
    .sbMotto{
      margin-top:2px;
      font-size:12px;
      font-weight:700;
      color: var(--muted);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }

    body.sb-closed .sbBrandText{display:none;}

    .sbList{margin-top:12px;display:flex;flex-direction:column;gap:10px;}
    .sbItem{
      display:flex;align-items:center;gap:12px;
      padding: 12px 12px;
      border-radius: 18px;
      border:1px solid transparent;
      cursor:pointer;
      user-select:none;
      transition: background .15s ease, border-color .15s ease;
      font-weight:800;
    }
    .sbItem:hover{
      background: var(--card2);
      border-color: var(--border);
    }
    .sbItem.active{
      background: rgba(31,111,74,.12);
      border-color: rgba(31,111,74,.28);
    }

    .sbIcon{
      width:40px;height:40px;border-radius:16px;
      display:grid;place-items:center;
      border:1px solid var(--border);
      background: var(--card);
      flex:0 0 auto;
      font-size:18px;
    }
    .sbLabel{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    body.sb-closed .sbLabel{display:none;}
    body.sb-closed .sbItem{justify-content:center; padding: 10px 10px;}
    body.sb-closed .sbIcon{width:44px;height:44px;border-radius:18px;}

    .sbSpacer{flex:1}
    .sbFooter{
      margin-top: 14px;
      border-radius: var(--radius2);
      border:1px solid var(--border);
      background: var(--card2);
      padding: 12px;
      font-size:12px;
      color: var(--muted);
      font-weight:700;
      line-height:1.5;
    }
    body.sb-closed .sbFooter{display:none;}

    /* ======================
       MAIN
    ====================== */
    .main{
      flex:1;
      min-width:0;
      padding: 16px 18px 28px;
    }
    @media (max-width: 900px){
      .main{padding: 12px 12px 22px;}
    }

    .topbar{
      max-width: var(--contentMax);
      margin: 0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 14px 14px;
      border-radius: var(--radius2);
      background: var(--card);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      position: sticky;
      top: 10px;
      z-index: 20;
    }
    @media (max-width: 900px){
      .topbar{top: 8px;}
    }

    .topLeft{display:flex;align-items:center;gap:12px;min-width:0;}
    .burger{
      width:46px;height:46px;border-radius:18px;
      border:1px solid var(--border);
      background: var(--card2);
      display:grid;place-items:center;
      cursor:pointer;
      user-select:none;
      font-size:18px;
    }
    .titleWrap{min-width:0}
    .pageTitle{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .pageSub{font-size:12px;color:var(--muted);font-weight:700;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .topRight{display:flex;align-items:center;gap:10px;}
    .iconBtn{
      width:46px;height:46px;border-radius:18px;
      border:1px solid var(--border);
      background: var(--card2);
      display:grid;place-items:center;
      cursor:pointer;
      user-select:none;
      font-size:18px;
    }

    .content{
      max-width: var(--contentMax);
      margin: 16px auto 0;
      display:flex;
      flex-direction:column;
      gap: 16px; /* less compact */
    }

    .banner{
      border-radius: var(--radius2);
      padding: 16px 18px;
      background: linear-gradient(90deg, var(--brand2), var(--brand));
      color: #fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      box-shadow: var(--shadow);
    }
    .banner h1{margin:0;font-size:22px;font-weight:900;letter-spacing:.2px}
    .banner .timeBox{
      background: rgba(255,255,255,.16);
      border:1px solid rgba(255,255,255,.25);
      padding: 10px 12px;
      border-radius: 16px;
      font-weight:800;
      white-space:nowrap;
      font-size:13px;
    }
    @media (max-width: 900px){
      .banner{flex-direction:column;align-items:flex-start}
      .banner h1{font-size:18px}
      .banner .timeBox{align-self:flex-end}
    }

    /* Stats: looser spacing + 2-line display */
    .gridStats{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 14px;
    }
    @media (max-width: 1100px){
      .gridStats{grid-template-columns: repeat(2, minmax(0, 1fr));}
    }
    .statCard{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius2);
      padding: 16px 16px 14px; /* less compact */
      box-shadow: var(--shadow);
      min-width:0;
    }
    .statLabel{
      font-size:13px;
      color: var(--muted);
      font-weight:800;
      letter-spacing:.1px;
    }
    .statBig{
      margin-top:10px;
      font-size:30px;
      font-weight:900;
      line-height:1.05;
    }
    .statSmall{
      margin-top:8px;
      font-size:13px;
      font-weight:800;
      color: var(--muted);
    }

    .panelRow{
      display:grid;
      grid-template-columns: 1fr 2fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 1100px){
      .panelRow{grid-template-columns: 1fr;}
    }

    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius2);
      padding: 16px;
      box-shadow: var(--shadow);
      min-width:0;
    }
    .cardHead{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      margin-bottom: 10px;
    }
    .cardHead h2{margin:0;font-size:16px;font-weight:900}
    .sub{margin:0;color:var(--muted);font-size:12px;font-weight:700}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      border:1px solid var(--border);
      background: var(--card2);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      user-select:none;
      font-weight:800;
    }
    .btnPrimary{
      background: rgba(31,111,74,.14);
      border-color: rgba(31,111,74,.28);
    }

    .pillRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{
      border:1px solid var(--border);
      background: var(--card2);
      padding: 8px 12px;
      border-radius: 999px;
      cursor:pointer;
      user-select:none;
      font-weight:800;
      color: var(--muted);
    }
    .pill.active{
      background: rgba(31,111,74,.14);
      border-color: rgba(31,111,74,.28);
      color: var(--text);
    }

    .field{
      border:1px solid var(--border);
      background: var(--card2);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      outline:none;
      font-weight:800;
      min-width: 160px;
    }
    input.field{min-width:220px}

    .annList{display:flex;flex-direction:column;gap:12px;}
    .annItem{
      border:1px solid var(--border);
      background: var(--card2);
      border-radius: 18px;
      padding: 14px;
      cursor:pointer;
      user-select:none;
    }
    .annTitle{font-weight:900;margin:0 0 8px 0}
    .annMeta{font-size:12px;color:var(--muted);font-weight:700;margin:0}

    .chartWrap{
      border:1px solid var(--border);
      background: var(--card2);
      border-radius: 18px;
      padding: 12px;
      overflow:hidden;
      min-height: 280px;
    }

    .tableWrap{
      margin-top: 14px;
      overflow:auto;
      border-radius: 18px;
      border:1px solid var(--border);
      background: var(--card);
    }
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:860px}
    th,td{padding:12px 12px;border-bottom:1px solid var(--border);vertical-align:top}
    th{position:sticky;top:0;background: var(--card);text-align:left;font-size:12px;color:var(--muted);font-weight:900}
    td{font-size:13px}
    tr:hover td{background: rgba(31,111,74,.06)}
    html[data-mode="dark"] tr:hover td{background: rgba(255,255,255,.03)}

    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding: 6px 10px;border-radius:999px;
      border:1px solid var(--border);
      background: var(--card2);
      font-weight:900;font-size:12px;
    }
    .bOk{background: rgba(34,197,94,.12);border-color: rgba(34,197,94,.28)}
    .bNo{background: rgba(239,68,68,.12);border-color: rgba(239,68,68,.28)}
    .bHi{background: rgba(245,158,11,.12);border-color: rgba(245,158,11,.30)}

    /* Modal */
    .overlay{
      position:fixed;inset:0;background: rgba(0,0,0,.55);
      display:none;z-index:80;padding:14px;overflow:auto;
    }
    .overlay.show{display:block}
    .modal{
      width:min(1020px,100%);
      margin: 40px auto;
      background: var(--card);
      border:1px solid var(--border);
      border-radius: 22px;
      box-shadow: 0 22px 90px rgba(0,0,0,.48);
      overflow:hidden;
      display:flex;flex-direction:column;
      max-height: calc(100vh - 80px);
    }
    .modalHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding: 14px;
      border-bottom:1px solid var(--border);
      background: var(--card2);
    }
    .modalHead h3{margin:0;font-size:15px;font-weight:900}
    .modalBody{padding:14px;overflow:auto}

    .warnBox{
      border:1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.12);
      border-radius: 16px;
      padding: 10px 12px;
      font-weight:900;
      display:none;
      margin-top: 10px;
    }
    .warnBox.show{display:block}

    /* Menu Manager */
    .menuCard{
      border:1px solid var(--border);
      background: var(--card2);
      border-radius: 18px;
      padding: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .menuLeft{display:flex;align-items:center;gap:12px;min-width:0}
    .menuIcon{
      width:42px;height:42px;border-radius:16px;
      border:1px solid var(--border);
      background: var(--card);
      display:grid;place-items:center;
      font-size:18px;
      flex:0 0 auto;
    }
    .menuText{min-width:0}
    .menuTitle{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .menuMeta{font-size:12px;color:var(--muted);font-weight:700;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .menuActions{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>

<body>
<div class="app">

  <!-- SIDEBAR (only one) -->
  <aside class="sidebar" id="sidebar">
    <div class="sbBrand" id="brandGoHome" title="Pergi Home">
      <div class="sbLogo" id="sideLogo"><span style="font-weight:900;">üè´</span></div>
      <div class="sbBrandText">
        <div class="sbName" id="schoolNameSide">SK Paya Resak</div>
        <div class="sbMotto" id="schoolMottoSide">Moving Forward</div>
      </div>
    </div>

    <div class="sbList" id="sbList"></div>

    <div class="sbFooter">
      <div id="footerLine1Side">¬© 2025 NK.</div>
      <div id="footerLine2Side">Hak Cipta Terpelihara.</div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <header class="topbar">
      <div class="topLeft">
        <button class="burger" id="btnMenu" title="Menu">‚ò∞</button>
        <div class="titleWrap">
          <div class="pageTitle" id="pageTitle">Laman Utama</div>
          <div class="pageSub" id="pageSub">Portal Rasmi PPKI</div>
        </div>
      </div>
      <div class="topRight">
        <button class="iconBtn" id="btnReload" title="Muat Semula">‚ü≥</button>
        <button class="iconBtn" id="btnMode" title="Mode Cerah/Gelap">üåô</button>
        <button class="iconBtn" id="btnSettings" title="Tetapan">‚öôÔ∏è</button>
      </div>
    </header>

    <section class="content">

      <!-- HOME -->
      <div class="page" id="page-home">
        <div class="banner">
          <h1 id="bannerText">Selamat Datang ke Portal Rasmi PPKI SK Paya Resak</h1>
          <div class="timeBox" id="timeNow">Ahad, 28 Disember 2025 ¬∑ 00:00:00</div>
        </div>

        <!-- 2-line stats -->
        <div class="gridStats">
          <div class="statCard">
            <div class="statLabel">Kehadiran Hari Ini</div>
            <div class="statBig" id="vTodayA">-</div>
            <div class="statSmall" id="vTodayB">-</div>
          </div>
          <div class="statCard">
            <div class="statLabel">Kehadiran Minggu Ini</div>
            <div class="statBig" id="vWeekA">-</div>
            <div class="statSmall" id="vWeekB">-</div>
          </div>
          <div class="statCard">
            <div class="statLabel">Kehadiran Bulan Ini</div>
            <div class="statBig" id="vMonthA">-</div>
            <div class="statSmall" id="vMonthB">-</div>
          </div>
          <div class="statCard">
            <div class="statLabel">% Kehadiran Bulanan</div>
            <div class="statBig" id="vPctA">-</div>
            <div class="statSmall" id="vPctB">Bulan semasa</div>
          </div>
        </div>

        <div class="panelRow">
          <div class="card">
            <div class="cardHead">
              <div>
                <h2>Status Pengumuman Aktif</h2>
                <p class="sub" id="annCount">‚Äî</p>
              </div>
              <button class="btn" id="btnToAnnouncements">Lihat Semua</button>
            </div>
            <div class="annList" id="annListHome"></div>
          </div>

          <div class="card">
            <div class="cardHead">
              <div>
                <h2>Trend Harian (Bulan Dipilih)</h2>
                <p class="sub">Pilih Bulan + Kelas dan mod paparan.</p>
              </div>
            </div>

            <div class="pillRow" id="trendMode">
              <div class="pill active" data-mode="hadir">Hadir</div>
              <div class="pill" data-mode="tidak">Tidak Hadir</div>
              <div class="pill" data-mode="pct">%</div>

              <select class="field" id="trendMonth"></select>
              <select class="field" id="trendYear"></select>
              <select class="field" id="trendClass"><option value="">Semua Kelas</option></select>
            </div>

            <div style="margin-top:12px" class="chartWrap">
              <div id="trendChart"></div>
            </div>

            <p class="sub" style="margin-top:12px">
              *Graf ringkas berdasarkan data kehadiran (Tarikh dd/mm/yyyy).
            </p>
          </div>
        </div>
      </div>

      <!-- KEHADIRAN -->
      <div class="page" id="page-attendance" style="display:none;">
        <div class="card">
          <div class="cardHead">
            <div>
              <h2>Dashboard Kehadiran</h2>
              <p class="sub">Filter di bawah akan ubah statistik kad ini mengikut pilihan (kelas/status/tarikh/carian).</p>
            </div>
            <div class="row">
              <button class="btn" id="btnReloadAttendance">Muat Semula Data</button>
            </div>
          </div>

          <div class="gridStats" style="margin-top:12px">
            <div class="statCard">
              <div class="statLabel">Kehadiran Hari Ini</div>
              <div class="statBig" id="vTodayA2">-</div>
              <div class="statSmall" id="vTodayB2">-</div>
            </div>
            <div class="statCard">
              <div class="statLabel">Kehadiran Minggu Ini</div>
              <div class="statBig" id="vWeekA2">-</div>
              <div class="statSmall" id="vWeekB2">-</div>
            </div>
            <div class="statCard">
              <div class="statLabel">Kehadiran Bulan Ini</div>
              <div class="statBig" id="vMonthA2">-</div>
              <div class="statSmall" id="vMonthB2">-</div>
            </div>
            <div class="statCard">
              <div class="statLabel">% Kehadiran Bulanan</div>
              <div class="statBig" id="vPctA2">-</div>
              <div class="statSmall" id="vPctB2">Bulan semasa</div>
            </div>
          </div>

          <div class="card" style="margin-top:14px">
            <div class="row" style="justify-content:space-between">
              <div class="row" style="flex:1;min-width:0">
                <input class="field" id="searchAttendance" placeholder="Carian (nama/kelas/status...)" style="flex:1;min-width:260px">
                <select class="field" id="filterClass"><option value="">Kelas: Semua</option></select>
                <select class="field" id="filterStatus">
                  <option value="">Status: Semua</option>
                  <option value="HADIR">Hadir</option>
                  <option value="TIDAK HADIR">Tidak Hadir</option>
                </select>
              </div>

              <div class="row">
                <input class="field" id="dateFrom" type="date" title="Tarikh mula">
                <input class="field" id="dateTo" type="date" title="Tarikh hingga">
                <button class="btn btnPrimary" id="btnApplyFilter">Tapis</button>
                <button class="btn" id="btnResetFilter">Reset</button>
              </div>
            </div>

            <div class="tableWrap">
              <table>
                <thead><tr id="attendanceHead"></tr></thead>
                <tbody id="attendanceBody"></tbody>
              </table>
            </div>

            <p class="sub" id="attendanceMeta" style="margin-top:12px">‚Äî</p>
          </div>
        </div>
      </div>

      <!-- PENGUMUMAN -->
      <div class="page" id="page-announcements" style="display:none;">
        <div class="card">
          <div class="cardHead">
            <div>
              <h2>Pengumuman</h2>
              <p class="sub">Klik kad untuk lihat butiran penuh.</p>
            </div>
            <button class="btn" id="btnReloadAnnouncements">Muat Semula</button>
          </div>
          <div id="annGrid" style="display:grid;gap:14px;grid-template-columns:repeat(2,minmax(0,1fr))"></div>
        </div>
      </div>

      <!-- DATA CSV GENERIC (future-proof) -->
      <div class="page" id="page-data" style="display:none;">
        <div class="card">
          <div class="cardHead">
            <div>
              <h2 id="dataTitle">Data CSV</h2>
              <p class="sub" id="dataSub">Paparan data daripada CSV (boleh tambah menu data lain dalam Tetapan).</p>
            </div>
            <div class="row">
              <button class="btn" id="btnReloadData">Muat Semula</button>
            </div>
          </div>

          <div class="card" style="margin-top:14px">
            <div class="row" style="justify-content:space-between">
              <div class="row" style="flex:1;min-width:0">
                <input class="field" id="dataSearch" placeholder="Carian (semua kolum)" style="flex:1;min-width:280px">
                <select class="field" id="dataColFilter">
                  <option value="">Filter Kolum: (pilih)</option>
                </select>
                <input class="field" id="dataColValue" placeholder="Nilai (contoh: 1 AL-FARABI)" style="min-width:260px">
              </div>
              <div class="row">
                <button class="btn btnPrimary" id="btnApplyDataFilter">Tapis</button>
                <button class="btn" id="btnResetDataFilter">Reset</button>
              </div>
            </div>

            <div class="tableWrap">
              <table>
                <thead><tr id="dataHead"></tr></thead>
                <tbody id="dataBody"></tbody>
              </table>
            </div>

            <p class="sub" id="dataMeta" style="margin-top:12px">‚Äî</p>
          </div>
        </div>
      </div>

      <!-- TAKWIM (placeholder) -->
      <div class="page" id="page-calendar" style="display:none;">
        <div class="card">
          <div class="cardHead">
            <div>
              <h2>Takwim</h2>
              <p class="sub">Jika cikgu nak paparan grid takwim (bulan), saya boleh upgrade.</p>
            </div>
          </div>
          <div id="calendarArea" class="sub">Belum disambungkan.</div>
        </div>
      </div>

      <!-- IBU BAPA -->
      <div class="page" id="page-parents" style="display:none;">
        <div class="card">
          <div class="cardHead">
            <div>
              <h2>Ibu Bapa</h2>
              <p class="sub">Kad info (pop out / buka tab baru ikut data CSV).</p>
            </div>
            <button class="btn" id="btnReloadParents">Muat Semula</button>
          </div>
          <div id="parentsGrid" style="display:grid;gap:14px;grid-template-columns:repeat(2,minmax(0,1fr))"></div>
        </div>
      </div>

    </section>
  </main>
</div>

<!-- Modal: Info -->
<div class="overlay" id="overlayInfo">
  <div class="modal">
    <div class="modalHead">
      <h3 id="infoTitle">Butiran</h3>
      <button class="iconBtn" id="btnCloseInfo" title="Tutup">‚úï</button>
    </div>
    <div class="modalBody" id="infoBody"></div>
  </div>
</div>

<!-- Modal: Settings -->
<div class="overlay" id="overlaySettings">
  <div class="modal">
    <div class="modalHead">
      <h3>Tetapan Portal</h3>
      <button class="iconBtn" id="btnCloseSettings" title="Tutup">‚úï</button>
    </div>

    <div class="modalBody">
      <div id="pinStep">
        <p class="sub" style="margin:0 0 10px;">
          Untuk kemaskini tetapan & menu sidebar, masukkan PIN.
        </p>
        <div class="row">
          <input class="field" id="pinInput" inputmode="numeric" placeholder="Masukkan PIN" style="min-width:220px">
          <button class="btn btnPrimary" id="btnPinOk">Masuk</button>
        </div>
        <div class="warnBox" id="pinWarn">PIN salah. Sila cuba lagi.</div>
      </div>

      <div id="settingsStep" style="display:none;">

        <div style="display:grid;gap:14px;grid-template-columns:1fr 1fr;">
          <div class="card" style="box-shadow:none">
            <div class="cardHead">
              <div>
                <h2>Identiti Portal</h2>
                <p class="sub">Nama/Moto/Footer/Logo</p>
              </div>
            </div>
            <input class="field" id="setSchoolName" placeholder="Nama Sekolah" style="width:100%;margin-top:6px">
            <input class="field" id="setSchoolMotto" placeholder="Moto Sekolah" style="width:100%;margin-top:10px">
            <input class="field" id="setFooter1" placeholder="Footer (Baris 1)" style="width:100%;margin-top:10px">
            <input class="field" id="setFooter2" placeholder="Footer (Baris 2)" style="width:100%;margin-top:10px">

            <div style="margin-top:12px">
              <div class="sub" style="font-weight:900">Logo Sekolah</div>
              <input class="field" id="setLogoFile" type="file" accept="image/*" style="width:100%;margin-top:6px">
              <p class="sub" style="margin-top:8px">Logo disimpan dalam browser (localStorage).</p>
            </div>

            <div style="margin-top:12px">
              <div class="sub" style="font-weight:900">Mod Sidebar (Desktop)</div>
              <div class="row" style="margin-top:8px">
                <button class="btn" id="btnSidebarOpen">Buka (Default)</button>
                <button class="btn" id="btnSidebarClose">Tutup (Icon Sahaja)</button>
              </div>
              <p class="sub" style="margin-top:8px">Mobile tetap guna drawer.</p>
            </div>
          </div>

          <div class="card" style="box-shadow:none">
            <div class="cardHead">
              <div>
                <h2>URL CSV</h2>
                <p class="sub">Kehadiran / Pengumuman / Ibu Bapa / Takwim</p>
              </div>
            </div>

            <div class="sub" style="font-weight:900;margin-top:6px">Kehadiran</div>
            <input class="field" id="setUrlAttendance" style="width:100%;margin-top:6px">

            <div class="sub" style="font-weight:900;margin-top:10px">Pengumuman</div>
            <input class="field" id="setUrlAnnouncements" style="width:100%;margin-top:6px">

            <div class="sub" style="font-weight:900;margin-top:10px">Ibu Bapa</div>
            <input class="field" id="setUrlParents" style="width:100%;margin-top:6px">

            <div class="sub" style="font-weight:900;margin-top:10px">Takwim (optional)</div>
            <input class="field" id="setUrlCalendar" style="width:100%;margin-top:6px" placeholder="(optional)">

            <div class="row" style="margin-top:12px">
              <button class="btn btnPrimary" id="btnSaveSettings">Simpan</button>
              <button class="btn" id="btnResetSettings">Reset</button>
              <button class="btn" id="btnLockSettings">Kunci Semula</button>
            </div>

            <p class="sub" style="margin-top:10px">Semua tetapan disimpan dalam browser (localStorage).</p>
          </div>
        </div>

        <div class="card" style="margin-top:14px;box-shadow:none">
          <div class="cardHead">
            <div>
              <h2>Pengurusan Menu Sidebar (Dinamik)</h2>
              <p class="sub">Tambah menu untuk CSV lain pada masa depan (Data CSV / Halaman / Pautan Luar).</p>
            </div>
            <button class="btn btnPrimary" id="btnAddMenu">+ Tambah Menu</button>
          </div>

          <div id="menuManagerList" style="display:flex;flex-direction:column;gap:10px;"></div>

          <p class="sub" style="margin-top:10px">
            Tip: Untuk ‚ÄúData CSV‚Äù, masukkan URL publish CSV (Google Sheet output=csv).
          </p>
        </div>

        <div class="card" style="margin-top:14px;box-shadow:none">
          <div class="cardHead">
            <div>
              <h2>Pemetaan Kolum Kehadiran</h2>
              <p class="sub">Jika nama kolum berubah, edit di sini.</p>
            </div>
          </div>

          <div style="display:grid;gap:12px;grid-template-columns:1fr 1fr;">
            <div>
              <div class="sub" style="font-weight:900">Tarikh</div>
              <input class="field" id="mapTarikh" style="width:100%;margin-top:6px" placeholder="Contoh: Tarikh">
            </div>
            <div>
              <div class="sub" style="font-weight:900">Kelas</div>
              <input class="field" id="mapKelas" style="width:100%;margin-top:6px" placeholder="Contoh: Kelas">
            </div>
            <div>
              <div class="sub" style="font-weight:900">Nama Murid</div>
              <input class="field" id="mapNama" style="width:100%;margin-top:6px" placeholder="Contoh: Nama Murid / Nama_Murid">
            </div>
            <div>
              <div class="sub" style="font-weight:900">Status</div>
              <input class="field" id="mapStatus" style="width:100%;margin-top:6px" placeholder="Contoh: Status">
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <button class="btn btnPrimary" id="btnSaveMapping">Simpan Pemetaan</button>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Modal: Add/Edit Menu -->
<div class="overlay" id="overlayMenuEdit">
  <div class="modal">
    <div class="modalHead">
      <h3 id="menuEditTitle">Tambah Menu</h3>
      <button class="iconBtn" id="btnCloseMenuEdit" title="Tutup">‚úï</button>
    </div>
    <div class="modalBody">
      <div class="row">
        <input class="field" id="mTitle" placeholder="Tajuk menu (contoh: Data PAJSK)" style="flex:1;min-width:260px">
        <input class="field" id="mIcon" placeholder="Ikon (emoji) contoh: üìä" style="min-width:200px">
      </div>

      <div class="row" style="margin-top:10px">
        <select class="field" id="mType" style="min-width:240px">
          <option value="page">Halaman</option>
          <option value="data">Data CSV</option>
          <option value="link">Pautan Luar</option>
        </select>
        <input class="field" id="mOrder" type="number" placeholder="Urutan (1..)" style="min-width:180px">
      </div>

      <div id="mPageWrap" style="margin-top:10px">
        <textarea class="field" id="mPageContent" rows="5" style="width:100%;min-width:0" placeholder="Kandungan halaman (ringkas)"></textarea>
      </div>

      <div id="mDataWrap" style="display:none;margin-top:10px">
        <input class="field" id="mCsvUrl" style="width:100%;min-width:0" placeholder="URL CSV (Google Sheet publish output=csv)">
        <p class="sub" style="margin-top:8px">Page ‚ÄúData‚Äù akan auto load CSV ini bila menu dipilih.</p>
      </div>

      <div id="mLinkWrap" style="display:none;margin-top:10px">
        <input class="field" id="mLinkUrl" style="width:100%;min-width:0" placeholder="URL Pautan Luar (https://...)">
      </div>

      <div class="row" style="margin-top:12px;justify-content:flex-end">
        <button class="btn" id="btnCancelMenuEdit">Batal</button>
        <button class="btn btnPrimary" id="btnSaveMenuEdit">Simpan</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   DEFAULTS + STORAGE
========================= */
const DEFAULTS = {
  schoolName: "SK Paya Resak",
  schoolMotto: "Moving Forward",
  footer1: "¬© 2025 NK.",
  footer2: "Hak Cipta Terpelihara.",
  mode: "light",
  pin: "5235",
  sidebarDefault: "open", // open | closed
  urls: {
    attendance: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTKhex5gcCHKoiLqRZpgVRMRfrGGvPtbgc3jo_Q-3FPL5OpcoWvyAnec0dTgykrpkYuS34iNJnEAkDU/pub?gid=880667725&single=true&output=csv",
    announcements: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQvKlO-LRGh8kj_-Be6NxZRR3Z38rjbC33jyvfhQvnR9L4LF7_dZRVXYGK3XO7bAoJwC9bJJmABjV6Z/pub?gid=946270411&single=true&output=csv",
    parents: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ_G1txQOE4Di1XsK6esbw8VgQtW2hcPsjzAmPH7V82JOeXegb7Kb_3Iz8CeHo-KvfvHe9x8BWtSfbB/pub?gid=1684744050&single=true&output=csv",
    calendar: ""
  },
  attendanceMap: {
    tarikh: "Tarikh",
    kelas: "Kelas",
    nama: "Nama Murid",
    status: "Status"
  },
  menus: [
    { id:"home",  title:"Laman Utama", icon:"üè†", type:"built", order:1 },
    { id:"att",   title:"Kehadiran",   icon:"üßæ", type:"built", order:2 },
    { id:"ann",   title:"Pengumuman",  icon:"üì¢", type:"built", order:3 },
    { id:"cal",   title:"Takwim",      icon:"üóìÔ∏è", type:"built", order:4 },
    { id:"par",   title:"Ibu Bapa",    icon:"üë®‚Äçüë©‚Äçüëß‚Äçüë¶", type:"built", order:5 },
  ]
};

const LS = {
  settings: "ppki_portal_settings_v3_one_sidebar",
  logo: "ppki_portal_logo_v3_one_sidebar"
};

function loadSettings(){
  try{
    const raw = localStorage.getItem(LS.settings);
    if(!raw) return structuredClone(DEFAULTS);
    const s = JSON.parse(raw);
    return {
      ...structuredClone(DEFAULTS),
      ...s,
      urls: {...structuredClone(DEFAULTS.urls), ...(s.urls||{})},
      attendanceMap: {...structuredClone(DEFAULTS.attendanceMap), ...(s.attendanceMap||{})},
      menus: Array.isArray(s.menus) && s.menus.length ? s.menus : structuredClone(DEFAULTS.menus)
    };
  }catch{
    return structuredClone(DEFAULTS);
  }
}
function saveSettings(s){ localStorage.setItem(LS.settings, JSON.stringify(s)); }
let SETTINGS = loadSettings();

/* =========================
   DOM
========================= */
const btnMenu = document.getElementById("btnMenu");
const btnMode = document.getElementById("btnMode");
const btnReload = document.getElementById("btnReload");
const btnSettings = document.getElementById("btnSettings");

const brandGoHome = document.getElementById("brandGoHome");
const sideLogo = document.getElementById("sideLogo");
const schoolNameSide = document.getElementById("schoolNameSide");
const schoolMottoSide = document.getElementById("schoolMottoSide");
const footerLine1Side = document.getElementById("footerLine1Side");
const footerLine2Side = document.getElementById("footerLine2Side");

const sbList = document.getElementById("sbList");

const pageTitle = document.getElementById("pageTitle");
const pageSub = document.getElementById("pageSub");
const bannerText = document.getElementById("bannerText");
const timeNow = document.getElementById("timeNow");

/* Stats home */
const vTodayA = document.getElementById("vTodayA");
const vTodayB = document.getElementById("vTodayB");
const vWeekA = document.getElementById("vWeekA");
const vWeekB = document.getElementById("vWeekB");
const vMonthA = document.getElementById("vMonthA");
const vMonthB = document.getElementById("vMonthB");
const vPctA = document.getElementById("vPctA");
const vPctB = document.getElementById("vPctB");

/* Stats attendance */
const vTodayA2 = document.getElementById("vTodayA2");
const vTodayB2 = document.getElementById("vTodayB2");
const vWeekA2 = document.getElementById("vWeekA2");
const vWeekB2 = document.getElementById("vWeekB2");
const vMonthA2 = document.getElementById("vMonthA2");
const vMonthB2 = document.getElementById("vMonthB2");
const vPctA2 = document.getElementById("vPctA2");
const vPctB2 = document.getElementById("vPctB2");

/* Attendance filter */
const btnReloadAttendance = document.getElementById("btnReloadAttendance");
const searchAttendance = document.getElementById("searchAttendance");
const filterClass = document.getElementById("filterClass");
const filterStatus = document.getElementById("filterStatus");
const dateFrom = document.getElementById("dateFrom");
const dateTo = document.getElementById("dateTo");
const btnApplyFilter = document.getElementById("btnApplyFilter");
const btnResetFilter = document.getElementById("btnResetFilter");
const attendanceHead = document.getElementById("attendanceHead");
const attendanceBody = document.getElementById("attendanceBody");
const attendanceMeta = document.getElementById("attendanceMeta");

/* Trend */
const trendMode = document.getElementById("trendMode");
const trendMonth = document.getElementById("trendMonth");
const trendYear = document.getElementById("trendYear");
const trendClass = document.getElementById("trendClass");
const trendChart = document.getElementById("trendChart");

/* Announcements */
const annCount = document.getElementById("annCount");
const annListHome = document.getElementById("annListHome");
const btnToAnnouncements = document.getElementById("btnToAnnouncements");
const annGrid = document.getElementById("annGrid");
const btnReloadAnnouncements = document.getElementById("btnReloadAnnouncements");

/* Parents */
const parentsGrid = document.getElementById("parentsGrid");
const btnReloadParents = document.getElementById("btnReloadParents");

/* Calendar */
const calendarArea = document.getElementById("calendarArea");

/* Data generic */
const dataTitle = document.getElementById("dataTitle");
const dataSub = document.getElementById("dataSub");
const btnReloadData = document.getElementById("btnReloadData");
const dataSearch = document.getElementById("dataSearch");
const dataColFilter = document.getElementById("dataColFilter");
const dataColValue = document.getElementById("dataColValue");
const btnApplyDataFilter = document.getElementById("btnApplyDataFilter");
const btnResetDataFilter = document.getElementById("btnResetDataFilter");
const dataHead = document.getElementById("dataHead");
const dataBody = document.getElementById("dataBody");
const dataMeta = document.getElementById("dataMeta");

/* Info modal */
const overlayInfo = document.getElementById("overlayInfo");
const btnCloseInfo = document.getElementById("btnCloseInfo");
const infoTitle = document.getElementById("infoTitle");
const infoBody = document.getElementById("infoBody");

/* Settings modal */
const overlaySettings = document.getElementById("overlaySettings");
const btnCloseSettings = document.getElementById("btnCloseSettings");
const pinStep = document.getElementById("pinStep");
const settingsStep = document.getElementById("settingsStep");
const pinInput = document.getElementById("pinInput");
const btnPinOk = document.getElementById("btnPinOk");
const pinWarn = document.getElementById("pinWarn");

const setSchoolName = document.getElementById("setSchoolName");
const setSchoolMotto = document.getElementById("setSchoolMotto");
const setFooter1 = document.getElementById("setFooter1");
const setFooter2 = document.getElementById("setFooter2");
const setLogoFile = document.getElementById("setLogoFile");

const setUrlAttendance = document.getElementById("setUrlAttendance");
const setUrlAnnouncements = document.getElementById("setUrlAnnouncements");
const setUrlParents = document.getElementById("setUrlParents");
const setUrlCalendar = document.getElementById("setUrlCalendar");

const btnSaveSettings = document.getElementById("btnSaveSettings");
const btnResetSettings = document.getElementById("btnResetSettings");
const btnLockSettings = document.getElementById("btnLockSettings");

const btnSidebarOpen = document.getElementById("btnSidebarOpen");
const btnSidebarClose = document.getElementById("btnSidebarClose");

const mapTarikh = document.getElementById("mapTarikh");
const mapKelas = document.getElementById("mapKelas");
const mapNama = document.getElementById("mapNama");
const mapStatus = document.getElementById("mapStatus");
const btnSaveMapping = document.getElementById("btnSaveMapping");

/* Menu manager */
const menuManagerList = document.getElementById("menuManagerList");
const btnAddMenu = document.getElementById("btnAddMenu");

/* Menu edit modal */
const overlayMenuEdit = document.getElementById("overlayMenuEdit");
const menuEditTitle = document.getElementById("menuEditTitle");
const btnCloseMenuEdit = document.getElementById("btnCloseMenuEdit");
const btnCancelMenuEdit = document.getElementById("btnCancelMenuEdit");
const btnSaveMenuEdit = document.getElementById("btnSaveMenuEdit");
const mTitle = document.getElementById("mTitle");
const mIcon = document.getElementById("mIcon");
const mType = document.getElementById("mType");
const mOrder = document.getElementById("mOrder");
const mPageWrap = document.getElementById("mPageWrap");
const mPageContent = document.getElementById("mPageContent");
const mDataWrap = document.getElementById("mDataWrap");
const mCsvUrl = document.getElementById("mCsvUrl");
const mLinkWrap = document.getElementById("mLinkWrap");
const mLinkUrl = document.getElementById("mLinkUrl");

/* =========================
   UTIL
========================= */
function escapeHtml(s){
  return String(s??"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function escapeAttr(s){ return escapeHtml(s); }

function normKey(s){
  return String(s||"").trim().toLowerCase().replace(/\s+/g,"").replace(/_/g,"").replace(/[^\p{L}\p{N}]/gu,"");
}
function pickCol(headers, desired){
  const want = normKey(desired);
  const idx = headers.findIndex(h => normKey(h) === want);
  if(idx !== -1) return headers[idx];
  return headers.find(h => normKey(h).includes(want) || want.includes(normKey(h))) || null;
}

function parseCSV(text){
  const rows = [];
  let row = [], cur = "", inQ = false;
  for(let i=0;i<text.length;i++){
    const ch = text[i], next = text[i+1];
    if(ch === '"'){
      if(inQ && next === '"'){ cur += '"'; i++; }
      else inQ = !inQ;
    } else if(ch === "," && !inQ){
      row.push(cur); cur="";
    } else if((ch === "\n" || ch === "\r") && !inQ){
      if(ch === "\r" && next === "\n") i++;
      row.push(cur);
      if(row.some(v => String(v).trim()!=="")) rows.push(row);
      row=[]; cur="";
    } else {
      cur += ch;
    }
  }
  row.push(cur);
  if(row.some(v => String(v).trim()!=="")) rows.push(row);

  if(!rows.length) return {headers:[], data:[]};
  const headers = rows[0].map(h=>String(h||"").trim());
  const data = rows.slice(1).map(r=>{
    const obj = {};
    headers.forEach((h,idx)=> obj[h] = (r[idx] ?? "").trim());
    return obj;
  });
  return {headers, data};
}

function parseDateDMY(s){
  if(!s) return null;
  const str = String(s).trim();
  if(/^\d{4}-\d{2}-\d{2}/.test(str)){
    const d = new Date(str + "T00:00:00");
    return isNaN(d) ? null : d;
  }
  const m = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if(!m) return null;
  const dd = +m[1], mm = +m[2], yy = +m[3];
  const d = new Date(yy, mm-1, dd, 0,0,0,0);
  if(d.getFullYear()!==yy || d.getMonth()!==mm-1 || d.getDate()!==dd) return null;
  return d;
}
function formatDMY(d){
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  return `${dd}/${mm}/${d.getFullYear()}`;
}
function startOfWeekMonday(d){
  const x = new Date(d); x.setHours(0,0,0,0);
  const day = x.getDay();
  const diff = (day === 0 ? -6 : (1 - day));
  x.setDate(x.getDate() + diff);
  return x;
}
function endOfWeekSunday(d){
  const s = startOfWeekMonday(d);
  const e = new Date(s); e.setDate(e.getDate()+6); e.setHours(23,59,59,999);
  return e;
}

async function fetchCSV(url){
  const res = await fetch(url, { cache:"no-store" });
  if(!res.ok) throw new Error("Gagal fetch CSV");
  return parseCSV(await res.text());
}

function fileToDataURL(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=> resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

function uid(){
  return "m_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}

function isMobile(){
  return window.matchMedia("(max-width: 900px)").matches;
}

/* =========================
   THEME + IDENTITY
========================= */
function applyMode(){
  document.documentElement.dataset.mode = SETTINGS.mode || "light";
  const isDark = document.documentElement.dataset.mode === "dark";
  btnMode.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
}
function applyIdentity(){
  schoolNameSide.textContent = SETTINGS.schoolName;
  schoolMottoSide.textContent = SETTINGS.schoolMotto;
  footerLine1Side.textContent = SETTINGS.footer1;
  footerLine2Side.textContent = SETTINGS.footer2;

  const logoData = localStorage.getItem(LS.logo);
  sideLogo.innerHTML = "";
  if(logoData){
    const img = document.createElement("img");
    img.src = logoData;
    sideLogo.appendChild(img);
  }else{
    sideLogo.innerHTML = "<span style='font-weight:900;'>üè´</span>";
  }
}
function applySidebarDefault(){
  // Desktop only: open/closed icon-mode
  if(isMobile()){
    document.body.classList.remove("sb-closed");
    return;
  }
  if((SETTINGS.sidebarDefault||"open")==="closed"){
    document.body.classList.add("sb-closed");
  }else{
    document.body.classList.remove("sb-closed");
  }
}

/* =========================
   SIDEBAR TOGGLE (ONE)
========================= */
function toggleSidebar(){
  if(isMobile()){
    document.body.classList.toggle("sb-open");
    return;
  }
  // desktop: toggle closed/open (icon only)
  document.body.classList.toggle("sb-closed");
  SETTINGS.sidebarDefault = document.body.classList.contains("sb-closed") ? "closed" : "open";
  saveSettings(SETTINGS);
}

btnMenu.addEventListener("click", toggleSidebar);

// close drawer when click outside (mobile)
document.addEventListener("click",(e)=>{
  if(!isMobile()) return;
  if(!document.body.classList.contains("sb-open")) return;
  if(e.target.closest("#sidebar") || e.target.closest("#btnMenu")) return;
  document.body.classList.remove("sb-open");
},{capture:true});

/* =========================
   CLOCK
========================= */
function tickClock(){
  const d = new Date();
  const days = ["Ahad","Isnin","Selasa","Rabu","Khamis","Jumaat","Sabtu"];
  const months = ["Januari","Februari","Mac","April","Mei","Jun","Julai","Ogos","September","Oktober","November","Disember"];
  const pad = n=> String(n).padStart(2,"0");
  const t = `${days[d.getDay()]}, ${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()} ¬∑ ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  timeNow.textContent = t;
}
setInterval(tickClock, 1000);

/* =========================
   PAGES
========================= */
let currentPage = "home";
function showPage(page, payload=null){
  currentPage = page;

  document.querySelectorAll(".page").forEach(p=>p.style.display="none");
  const el = document.getElementById("page-"+page);
  if(el) el.style.display = "block";

  const titles = {
    home: ["Laman Utama","Portal Rasmi PPKI"],
    attendance: ["Kehadiran","Dashboard & Analisis"],
    announcements: ["Pengumuman","Makluman Semasa"],
    calendar: ["Takwim","Aktiviti & Jadual"],
    parents: ["Ibu Bapa","Info & Pautan"],
    data: ["Data CSV","Paparan Data"]
  };
  pageTitle.textContent = titles[page]?.[0] || "Portal";
  pageSub.textContent = titles[page]?.[1] || "";

  // highlight sidebar
  document.querySelectorAll(".sbItem").forEach(x=>{
    x.classList.toggle("active", x.dataset.page===page && x.dataset.mid===String(payload?.mid||""));
  });

  if(isMobile()) document.body.classList.remove("sb-open");

  // If opening dynamic data
  if(page==="data" && payload && payload.menu){
    openDataMenu(payload.menu);
  }
}

brandGoHome.addEventListener("click", ()=> showPage("home"));

/* =========================
   SIDEBAR MENU RENDER
========================= */
function sortMenus(menus){
  return [...menus].sort((a,b)=> (Number(a.order||999)-Number(b.order||999)) || String(a.title||"").localeCompare(String(b.title||"")));
}
function menuMetaText(m){
  if(m.type==="built") return "Modul Portal";
  if(m.type==="data") return "Data CSV";
  if(m.type==="link") return "Pautan Luar";
  if(m.type==="page") return "Halaman";
  return "";
}
function renderSidebarMenus(){
  sbList.innerHTML = "";

  const menus = sortMenus(SETTINGS.menus || []);
  menus.forEach(m=>{
    const item = document.createElement("div");
    item.className = "sbItem";
    item.dataset.mid = m.id;

    // map built pages
    let page = "home";
    if(m.type==="built"){
      if(m.id==="home") page="home";
      else if(m.id==="att") page="attendance";
      else if(m.id==="ann") page="announcements";
      else if(m.id==="cal") page="calendar";
      else if(m.id==="par") page="parents";
    }else if(m.type==="data"){
      page="data";
    }else if(m.type==="page"){
      page="data"; // we reuse data page to show content card if page-type (simple & future-proof)
    }else if(m.type==="link"){
      page="home"; // no actual page, we open external
    }

    item.dataset.page = page;

    item.innerHTML = `
      <div class="sbIcon">${escapeHtml(m.icon||"üìÑ")}</div>
      <div class="sbLabel">${escapeHtml(m.title||"Menu")}</div>
    `;

    item.addEventListener("click", ()=>{
      if(m.type==="link"){
        if(m.url) window.open(m.url, "_blank", "noopener");
        return;
      }
      if(m.type==="page"){
        openSimplePage(m);
        return;
      }
      if(m.type==="data"){
        showPage("data",{menu:m, mid:m.id});
        return;
      }
      // built
      showPage(page);
    });

    sbList.appendChild(item);
  });

  // set active
  highlightActiveSidebar();
}
function highlightActiveSidebar(){
  document.querySelectorAll(".sbItem").forEach(x=>{
    const mid = x.dataset.mid;
    const m = (SETTINGS.menus||[]).find(mm=>mm.id===mid);
    if(!m) return;
    let should = false;
    if(m.type==="built"){
      if(currentPage==="home" && m.id==="home") should=true;
      if(currentPage==="attendance" && m.id==="att") should=true;
      if(currentPage==="announcements" && m.id==="ann") should=true;
      if(currentPage==="calendar" && m.id==="cal") should=true;
      if(currentPage==="parents" && m.id==="par") should=true;
    }else if(m.type==="data" && currentPage==="data"){
      // only active if this data menu was last opened
      should = (currentDataMenu && currentDataMenu.id===m.id);
    }else if(m.type==="page" && currentPage==="data"){
      should = (currentSimplePage && currentSimplePage.id===m.id);
    }
    x.classList.toggle("active", should);
  });
}

/* =========================
   MODE toggle
========================= */
function toggleMode(){
  SETTINGS.mode = (SETTINGS.mode === "dark") ? "light" : "dark";
  saveSettings(SETTINGS);
  applyMode();
  renderTrend();
}
btnMode.addEventListener("click", toggleMode);

/* =========================
   INFO MODAL
========================= */
function openInfoModal(title, html){
  infoTitle.textContent = title || "Butiran";
  infoBody.innerHTML = html;
  overlayInfo.classList.add("show");
}
btnCloseInfo.addEventListener("click", ()=> overlayInfo.classList.remove("show"));
overlayInfo.addEventListener("click",(e)=>{ if(e.target===overlayInfo) overlayInfo.classList.remove("show"); });

/* =========================
   DATA STATE
========================= */
let attendanceRaw = [];
let announcementsRaw = [];
let parentsRaw = [];
let calendarRaw = [];

/* Generic Data CSV state */
let currentDataMenu = null;
let currentDataHeaders = [];
let currentDataRows = [];
let filteredDataRows = [];
let currentSimplePage = null;

/* =========================
   NORMALIZE DATA
========================= */
function normalizeAttendance(parsed){
  const headers = parsed.headers;

  const colTarikh = pickCol(headers, SETTINGS.attendanceMap.tarikh) || pickCol(headers, "Tarikh");
  const colKelas  = pickCol(headers, SETTINGS.attendanceMap.kelas)  || pickCol(headers, "Kelas");
  const colNama   = pickCol(headers, SETTINGS.attendanceMap.nama)   || pickCol(headers, "Nama Murid") || pickCol(headers, "Nama_Murid");
  const colStatus = pickCol(headers, SETTINGS.attendanceMap.status) || pickCol(headers, "Status");

  const data = parsed.data.map(r=>{
    const tarikh = parseDateDMY(r[colTarikh]);
    const statusRaw = (r[colStatus]||"").trim().toUpperCase();
    const status = statusRaw.includes("TIDAK") ? "TIDAK HADIR" : (statusRaw ? "HADIR" : "");
    return {
      __tarikh: tarikh,
      Tarikh: r[colTarikh] || "",
      Kelas: r[colKelas] || "",
      "Nama Murid": r[colNama] || "",
      Status: status || (r[colStatus]||""),
    };
  }).filter(x=> x.__tarikh);

  data.sort((a,b)=> b.__tarikh - a.__tarikh);
  return data;
}

function normalizeAnnouncements(parsed){
  const H = parsed.headers;
  const colStart = pickCol(H,"TARIKH MULA") || pickCol(H,"Tarikh Mula");
  const colEnd   = pickCol(H,"TARIKH TAMAT") || pickCol(H,"Tarikh Tamat");
  const colTitle = pickCol(H,"TAJUK");
  const colBody  = pickCol(H,"ISI KANDUNGAN") || pickCol(H,"Isi Kandungan");
  const colUrl   = pickCol(H,"URL");
  const colPri   = pickCol(H,"KEUTAMAAN");
  const colAktif = pickCol(H,"AKTIF");

  const now = new Date(); now.setHours(0,0,0,0);

  const data = parsed.data.map(r=>{
    const start = parseDateDMY(r[colStart]);
    const end = parseDateDMY(r[colEnd]);
    const title = (r[colTitle]||"").trim();
    const body = (r[colBody]||"").trim();
    const url = (r[colUrl]||"").trim();
    const pri = (r[colPri]||"").trim().toUpperCase();
    const aktif = (r[colAktif]||"").trim().toUpperCase();

    let computedActive = false;
    if(start && title){
      computedActive = (start <= now) && (!end || end >= now);
    }
    let finalActive = computedActive;
    if(aktif === "YA") finalActive = true;
    if(aktif === "TIDAK") finalActive = false;

    return { start,end,title,body,url, pri: pri||"SEDERHANA", active: finalActive,
      startText: r[colStart]||"", endText:r[colEnd]||"" };
  });

  const rank = p => String(p||"").includes("TINGGI") ? 3 : (String(p||"").includes("SEDER") ? 2 : 1);
  data.sort((a,b)=> (rank(b.pri)-rank(a.pri)) || ((b.start?.getTime()||0)-(a.start?.getTime()||0)));
  return data;
}

function normalizeParents(parsed){
  const H = parsed.headers;
  const colTitle = pickCol(H,"TAJUK") || pickCol(H,"Tajuk");
  const colBody  = pickCol(H,"ISI KANDUNGAN") || pickCol(H,"Isi Kandungan") || pickCol(H,"Isi");
  const colUrl   = pickCol(H,"URL") || pickCol(H,"Pautan");
  const colMode  = pickCol(H,"MOD") || pickCol(H,"Mode") || pickCol(H,"TINDAKAN");

  return parsed.data.map(r=>({
    title:(r[colTitle]||"").trim(),
    body:(r[colBody]||"").trim(),
    url:(r[colUrl]||"").trim(),
    mode: ((r[colMode]||"POPUP").trim().toUpperCase())
  })).filter(x=>x.title);
}

/* =========================
   STATS (2-line: Hadir / Tidak Hadir)
========================= */
function computeStats(list){
  const now = new Date(); now.setHours(0,0,0,0);
  const weekStart = startOfWeekMonday(now);
  const weekEnd = endOfWeekSunday(now);

  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
  const monthEnd = new Date(now.getFullYear(), now.getMonth()+1, 0, 23,59,59,999);

  const isHadir = r => String(r.Status||"").toUpperCase()==="HADIR";
  const isTidak = r => String(r.Status||"").toUpperCase().includes("TIDAK");

  const todayList = list.filter(r => r.__tarikh && r.__tarikh.getTime()===now.getTime());
  const weekList  = list.filter(r => r.__tarikh && r.__tarikh>=weekStart && r.__tarikh<=weekEnd);
  const monthList = list.filter(r => r.__tarikh && r.__tarikh>=monthStart && r.__tarikh<=monthEnd);

  const todayH = todayList.filter(isHadir).length;
  const todayT = todayList.filter(isTidak).length;
  const todayN = todayList.length;

  const weekH = weekList.filter(isHadir).length;
  const weekT = weekList.filter(isTidak).length;
  const weekN = weekList.length;

  const monthH = monthList.filter(isHadir).length;
  const monthT = monthList.filter(isTidak).length;
  const monthN = monthList.length;

  const pct = monthN ? (monthH/monthN*100) : 0;

  return {todayH,todayT,weekH,weekT,monthH,monthT,pct};
}

function setStats2Line(prefix, stats){
  const set = (id, text)=> document.getElementById(id).textContent = text;

  set(prefix+"TodayA", `${stats.todayH} Hadir`);
  set(prefix+"TodayB", `${stats.todayT} Tidak Hadir`);

  set(prefix+"WeekA", `${stats.weekH} Hadir`);
  set(prefix+"WeekB", `${stats.weekT} Tidak Hadir`);

  set(prefix+"MonthA", `${stats.monthH} Hadir`);
  set(prefix+"MonthB", `${stats.monthT} Tidak Hadir`);

  set(prefix+"PctA", `${stats.pct.toFixed(1)}%`);
  set(prefix+"PctB", `Bulan semasa`);
}

/* =========================
   TREND CHART (SVG)
========================= */
function renderLineChartSVG({width=900,height=290,data=[],mode="hadir"}){
  const padL=46,padR=16,padT=14,padB=34;
  const W=width,H=height;
  const innerW=W-padL-padR, innerH=H-padT-padB;

  const ys = data.map(d=>d.y);
  const maxY = (mode==="pct") ? 100 : Math.max(1,...ys,1);
  const minY = 0;
  const range = (maxY-minY)||1;

  const minX = data.length ? Math.min(...data.map(d=>d.xValue)) : 1;
  const maxX = data.length ? Math.max(...data.map(d=>d.xValue)) : 31;
  const rx = (maxX-minX)||1;

  const xScale = x => padL + ((x-minX)/rx)*innerW;
  const yScale = y => padT + (1-((y-minY)/range))*innerH;

  const yTicks = (mode==="pct") ? [0,25,50,75,100] : (()=>{
    const t=4, step=Math.max(1, Math.round(maxY/t));
    const arr=[];
    for(let v=0; v<=maxY; v+=step) arr.push(v);
    if(arr[arr.length-1]!==maxY) arr.push(maxY);
    return arr.slice(0,6);
  })();

  const xTicks = [1,5,10,15,20,25,30,31];

  const pts = data.sort((a,b)=>a.xValue-b.xValue)
    .map(d=>`${xScale(d.xValue).toFixed(1)},${yScale(d.y).toFixed(1)}`).join(" ");

  const stroke = (document.documentElement.dataset.mode==="dark") ? "rgba(255,255,255,.92)" : "rgba(17,24,39,.92)";
  const grid = (document.documentElement.dataset.mode==="dark") ? "rgba(255,255,255,.12)" : "rgba(17,24,39,.10)";
  const area = (document.documentElement.dataset.mode==="dark") ? "rgba(31,111,74,.22)" : "rgba(31,111,74,.12)";
  const label = (document.documentElement.dataset.mode==="dark") ? "rgba(255,255,255,.65)" : "rgba(107,114,128,.95)";

  return `
  <svg viewBox="0 0 ${W} ${H}" width="100%" height="${H}">
    ${yTicks.map(v=>{
      const y=yScale(v);
      return `
        <line x1="${padL}" y1="${y}" x2="${W-padR}" y2="${y}" stroke="${grid}" stroke-width="1"/>
        <text x="${padL-8}" y="${y+4}" text-anchor="end" font-size="11" fill="${label}" font-weight="800">${v}${mode==="pct"?"%":""}</text>
      `;
    }).join("")}

    <line x1="${padL}" y1="${H-padB}" x2="${W-padR}" y2="${H-padB}" stroke="${grid}" stroke-width="1"/>
    <line x1="${padL}" y1="${padT}" x2="${padL}" y2="${H-padB}" stroke="${grid}" stroke-width="1"/>

    ${xTicks.map(v=>{
      if(!data.length) return "";
      if(v<minX || v>maxX) return "";
      const x=xScale(v);
      return `
        <line x1="${x}" y1="${H-padB}" x2="${x}" y2="${H-padB+5}" stroke="${grid}" stroke-width="1"/>
        <text x="${x}" y="${H-12}" text-anchor="middle" font-size="11" fill="${label}" font-weight="800">${v}</text>
      `;
    }).join("")}

    ${data.length ? `
      <path d="M ${padL} ${H-padB} L ${pts.replaceAll(" ", " L ")} L ${W-padR} ${H-padB} Z"
        fill="${area}" stroke="none" />
      <polyline points="${pts}" fill="none" stroke="${stroke}" stroke-width="3.2"
        stroke-linecap="round" stroke-linejoin="round"/>
    ` : `
      <text x="${W/2}" y="${H/2}" text-anchor="middle" font-size="13" fill="${label}" font-weight="800">
        Tiada data untuk pilihan ini
      </text>
    `}
  </svg>`;
}

function setupTrendSelectors(){
  const now = new Date();
  const months = ["Jan","Feb","Mac","Apr","Mei","Jun","Jul","Ogos","Sep","Okt","Nov","Dis"];
  trendMonth.innerHTML = months.map((m,i)=>`<option value="${i}">${m}</option>`).join("");
  trendMonth.value = String(now.getMonth());

  const y = now.getFullYear();
  trendYear.innerHTML = "";
  for(let i=y-2; i<=y+1; i++){
    trendYear.innerHTML += `<option value="${i}">${i}</option>`;
  }
  trendYear.value = String(y);

  trendMode.addEventListener("click",(e)=>{
    const p = e.target.closest(".pill");
    if(!p) return;
    trendMode.querySelectorAll(".pill").forEach(x=>x.classList.remove("active"));
    p.classList.add("active");
    renderTrend();
  });
  trendMonth.addEventListener("change", renderTrend);
  trendYear.addEventListener("change", renderTrend);
  trendClass.addEventListener("change", renderTrend);
}

function renderTrend(){
  if(!attendanceRaw.length){
    trendChart.innerHTML = renderLineChartSVG({data:[], mode:"hadir"});
    return;
  }
  const mode = trendMode.querySelector(".pill.active")?.dataset.mode || "hadir";
  const month = Number(trendMonth.value);
  const year = Number(trendYear.value);
  const kelas = trendClass.value;

  const filtered = attendanceRaw.filter(r=>{
    if(!r.__tarikh) return false;
    if(r.__tarikh.getFullYear()!==year) return false;
    if(r.__tarikh.getMonth()!==month) return false;
    if(kelas && String(r.Kelas||"")!==kelas) return false;
    return true;
  });

  const isHadir = r => String(r.Status||"").toUpperCase()==="HADIR";
  const isTidak = r => String(r.Status||"").toUpperCase().includes("TIDAK");

  const map = new Map();
  filtered.forEach(r=>{
    const day = r.__tarikh.getDate();
    if(!map.has(day)) map.set(day,{hadir:0,tidak:0,total:0});
    const o = map.get(day);
    o.total++;
    if(isHadir(r)) o.hadir++;
    if(isTidak(r)) o.tidak++;
  });

  const lastDay = new Date(year, month+1, 0).getDate();
  const series = [];
  for(let d=1; d<=lastDay; d++){
    const o = map.get(d) || {hadir:0,tidak:0,total:0};
    let y=0;
    if(mode==="hadir") y=o.hadir;
    if(mode==="tidak") y=o.tidak;
    if(mode==="pct") y=o.total ? +(o.hadir/o.total*100).toFixed(1) : 0;
    series.push({xValue:d,y});
  }

  trendChart.innerHTML = renderLineChartSVG({data:series, mode});
}

/* =========================
   ATTENDANCE TABLE + FILTER
========================= */
function populateClassOptions(){
  const classes = Array.from(new Set(attendanceRaw.map(r=>String(r.Kelas||"").trim()).filter(Boolean))).sort();
  filterClass.innerHTML = `<option value="">Kelas: Semua</option>` + classes.map(c=>`<option value="${escapeAttr(c)}">${escapeHtml(c)}</option>`).join("");
  trendClass.innerHTML = `<option value="">Semua Kelas</option>` + classes.map(c=>`<option value="${escapeAttr(c)}">${escapeHtml(c)}</option>`).join("");
}

function renderAttendanceTable(list){
  const cols = ["Tarikh","Kelas","Nama Murid","Status"];
  attendanceHead.innerHTML = cols.map(c=>`<th>${escapeHtml(c)}</th>`).join("");

  attendanceBody.innerHTML = list.map(r=>{
    const s = String(r.Status||"").toUpperCase();
    let badge = `<span class="badge">${escapeHtml(r.Status||"")}</span>`;
    if(s==="HADIR") badge = `<span class="badge bOk">‚úÖ HADIR</span>`;
    if(s.includes("TIDAK")) badge = `<span class="badge bNo">‚õî TIDAK HADIR</span>`;
    return `
      <tr>
        <td>${escapeHtml(r.Tarikh||"")}</td>
        <td>${escapeHtml(r.Kelas||"")}</td>
        <td>${escapeHtml(r["Nama Murid"]||"")}</td>
        <td>${badge}</td>
      </tr>
    `;
  }).join("");

  attendanceMeta.textContent = `Paparan: ${list.length} rekod`;
}

/* ‚úÖ FIX: filter updates stats + table */
function applyAttendanceFilter(){
  const q = (searchAttendance.value||"").trim().toLowerCase();
  const kelas = filterClass.value;
  const statusSel = filterStatus.value;

  const df = dateFrom.value ? new Date(dateFrom.value+"T00:00:00") : null;
  const dt = dateTo.value ? new Date(dateTo.value+"T23:59:59") : null;

  const filtered = attendanceRaw.filter(r=>{
    if(kelas && String(r.Kelas||"")!==kelas) return false;
    if(statusSel){
      if(statusSel==="HADIR" && String(r.Status||"").toUpperCase()!=="HADIR") return false;
      if(statusSel==="TIDAK HADIR" && !String(r.Status||"").toUpperCase().includes("TIDAK")) return false;
    }
    if(df && r.__tarikh < df) return false;
    if(dt && r.__tarikh > dt) return false;
    if(q){
      const hay = `${r.Tarikh} ${r.Kelas} ${r["Nama Murid"]} ${r.Status}`.toLowerCase();
      if(!hay.includes(q)) return false;
    }
    return true;
  });

  renderAttendanceTable(filtered);
  setStats2Line("v", computeStats(filtered));      // Home (optional)
  setStats2Line("v", computeStats(attendanceRaw)); // keep home correct? we'll handle below
  setAttendanceStats2(filtered);
}

function setAttendanceStats2(list){
  const s = computeStats(list);
  vTodayA2.textContent = `${s.todayH} Hadir`;
  vTodayB2.textContent = `${s.todayT} Tidak Hadir`;
  vWeekA2.textContent  = `${s.weekH} Hadir`;
  vWeekB2.textContent  = `${s.weekT} Tidak Hadir`;
  vMonthA2.textContent = `${s.monthH} Hadir`;
  vMonthB2.textContent = `${s.monthT} Tidak Hadir`;
  vPctA2.textContent   = `${s.pct.toFixed(1)}%`;
  vPctB2.textContent   = `Bulan semasa`;
}

/* Home stats */
function setHomeStats2(list){
  const s = computeStats(list);
  vTodayA.textContent = `${s.todayH} Hadir`;
  vTodayB.textContent = `${s.todayT} Tidak Hadir`;
  vWeekA.textContent  = `${s.weekH} Hadir`;
  vWeekB.textContent  = `${s.weekT} Tidak Hadir`;
  vMonthA.textContent = `${s.monthH} Hadir`;
  vMonthB.textContent = `${s.monthT} Tidak Hadir`;
  vPctA.textContent   = `${s.pct.toFixed(1)}%`;
  vPctB.textContent   = `Bulan semasa`;
}

btnApplyFilter.addEventListener("click", applyAttendanceFilter);
btnResetFilter.addEventListener("click", ()=>{
  searchAttendance.value="";
  filterClass.value="";
  filterStatus.value="";
  dateFrom.value="";
  dateTo.value="";
  renderAttendanceTable(attendanceRaw);
  setAttendanceStats2(attendanceRaw);
});
searchAttendance.addEventListener("input", applyAttendanceFilter);
filterClass.addEventListener("change", applyAttendanceFilter);
filterStatus.addEventListener("change", applyAttendanceFilter);
dateFrom.addEventListener("change", applyAttendanceFilter);
dateTo.addEventListener("change", applyAttendanceFilter);

/* =========================
   ANNOUNCEMENTS UI
========================= */
function renderAnnouncements(){
  const active = announcementsRaw.filter(a=>a.active);
  annCount.textContent = `${active.length} aktif`;

  annListHome.innerHTML = "";
  if(!active.length){
    annListHome.innerHTML = `<div class="sub">Tiada pengumuman aktif.</div>`;
  }else{
    active.slice(0,6).forEach(a=>{
      const pri = String(a.pri||"").toUpperCase();
      const priBadge = pri.includes("TINGGI") ? `<span class="badge bHi">üî• TINGGI</span>` : `<span class="badge">${escapeHtml(pri)}</span>`;
      const el = document.createElement("div");
      el.className = "annItem";
      el.innerHTML = `
        <div class="annTitle">${escapeHtml(a.title)}</div>
        <p class="annMeta">${escapeHtml(a.startText || (a.start?formatDMY(a.start):""))} ¬∑ ${priBadge}</p>
      `;
      el.addEventListener("click", ()=>{
        openInfoModal(a.title, `
          <div class="card" style="box-shadow:none">
            <div class="row" style="justify-content:space-between">
              <div class="sub" style="font-weight:900">Tarikh Mula: ${escapeHtml(a.startText || (a.start?formatDMY(a.start):"-"))}</div>
              <div class="sub" style="font-weight:900">Keutamaan: ${escapeHtml(a.pri||"-")}</div>
            </div>
            <div style="margin-top:12px;white-space:pre-wrap;line-height:1.75">${escapeHtml(a.body||"-")}</div>
            ${a.url ? `<div style="margin-top:12px"><a class="btn btnPrimary" href="${escapeAttr(a.url)}" target="_blank" rel="noopener">Buka Pautan</a></div>` : ""}
          </div>
        `);
      });
      annListHome.appendChild(el);
    });
  }

  annGrid.innerHTML = "";
  const list = active;
  if(!list.length){
    annGrid.innerHTML = `<div class="sub">Tiada pengumuman aktif.</div>`;
    return;
  }
  list.forEach(a=>{
    const pri = String(a.pri||"").toUpperCase();
    const priBadge = pri.includes("TINGGI") ? `<span class="badge bHi">üî• TINGGI</span>` : `<span class="badge">${escapeHtml(pri)}</span>`;
    const el = document.createElement("div");
    el.className = "card";
    el.style.cursor="pointer";
    el.innerHTML = `
      <div class="cardHead">
        <div>
          <h2 style="margin:0">${escapeHtml(a.title)}</h2>
          <p class="sub">${escapeHtml(a.startText || (a.start?formatDMY(a.start):""))}</p>
        </div>
        <div>${priBadge}</div>
      </div>
      <div class="sub" style="white-space:pre-wrap;line-height:1.75;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden">
        ${escapeHtml(a.body||"")}
      </div>
    `;
    el.addEventListener("click", ()=>{
      openInfoModal(a.title, `
        <div class="card" style="box-shadow:none">
          <div style="white-space:pre-wrap;line-height:1.75">${escapeHtml(a.body||"-")}</div>
          ${a.url ? `<div style="margin-top:12px"><a class="btn btnPrimary" href="${escapeAttr(a.url)}" target="_blank" rel="noopener">Buka Pautan</a></div>` : ""}
        </div>
      `);
    });
    annGrid.appendChild(el);
  });
}

/* =========================
   PARENTS UI
========================= */
function renderParents(){
  parentsGrid.innerHTML = "";
  if(!parentsRaw.length){
    parentsGrid.innerHTML = `<div class="sub">Tiada data.</div>`;
    return;
  }
  parentsRaw.forEach(item=>{
    const el = document.createElement("div");
    el.className = "card";
    el.style.cursor="pointer";
    const badge = item.url ? `<span class="badge">${item.mode==="TAB" ? "Buka Tab" : "Pop out"}</span>` : `<span class="badge">Pop out</span>`;
    el.innerHTML = `
      <div class="cardHead">
        <div><h2 style="margin:0">${escapeHtml(item.title)}</h2></div>
        ${badge}
      </div>
      <div class="sub" style="white-space:pre-wrap;line-height:1.75">${escapeHtml(item.body||"")}</div>
    `;
    el.addEventListener("click", ()=>{
      if(item.url && item.mode==="TAB"){
        window.open(item.url, "_blank", "noopener");
        return;
      }
      openInfoModal(item.title, `
        <div class="card" style="box-shadow:none">
          <div style="white-space:pre-wrap;line-height:1.75">${escapeHtml(item.body||"-")}</div>
          ${item.url ? `<div style="margin-top:12px"><a class="btn btnPrimary" href="${escapeAttr(item.url)}" target="_blank" rel="noopener">Buka Pautan</a></div>` : ""}
        </div>
      `);
    });
    parentsGrid.appendChild(el);
  });
}

/* =========================
   GENERIC DATA CSV PAGE
========================= */
async function openDataMenu(menu){
  currentDataMenu = menu;
  currentSimplePage = null;
  dataTitle.textContent = menu.title || "Data CSV";
  dataSub.textContent = "Paparan data daripada CSV menu ini. Anda boleh tapis & cari.";

  if(!menu.csvUrl){
    currentDataHeaders = [];
    currentDataRows = [];
    filteredDataRows = [];
    dataHead.innerHTML = "";
    dataBody.innerHTML = "";
    dataMeta.textContent = "Tiada URL CSV untuk menu ini.";
    return;
  }

  try{
    const parsed = await fetchCSV(menu.csvUrl);
    currentDataHeaders = parsed.headers || [];
    currentDataRows = parsed.data || [];
    filteredDataRows = [...currentDataRows];

    // fill dropdown columns
    dataColFilter.innerHTML = `<option value="">Filter Kolum: (pilih)</option>` +
      currentDataHeaders.map(h=>`<option value="${escapeAttr(h)}">${escapeHtml(h)}</option>`).join("");

    renderDataTable(filteredDataRows);
  }catch(e){
    console.error(e);
    dataMeta.textContent = "Gagal load CSV. Sila semak URL CSV.";
    dataHead.innerHTML = "";
    dataBody.innerHTML = "";
  }
}

function renderDataTable(rows){
  const headers = currentDataHeaders.slice(0, 30); // keep practical
  dataHead.innerHTML = headers.map(h=>`<th>${escapeHtml(h)}</th>`).join("");
  dataBody.innerHTML = rows.slice(0, 500).map(r=>{
    return `<tr>${headers.map(h=>`<td>${escapeHtml(r[h]||"")}</td>`).join("")}</tr>`;
  }).join("");
  dataMeta.textContent = `Paparan: ${rows.length} rekod (papar maks 500 row untuk laju).`;
}

function applyDataFilter(){
  const q = (dataSearch.value||"").trim().toLowerCase();
  const col = dataColFilter.value;
  const val = (dataColValue.value||"").trim().toLowerCase();

  filteredDataRows = currentDataRows.filter(r=>{
    if(q){
      const hay = currentDataHeaders.map(h=>String(r[h]||"")).join(" ").toLowerCase();
      if(!hay.includes(q)) return false;
    }
    if(col && val){
      const cell = String(r[col]||"").toLowerCase();
      if(!cell.includes(val)) return false;
    }
    return true;
  });
  renderDataTable(filteredDataRows);
}

btnApplyDataFilter.addEventListener("click", applyDataFilter);
btnResetDataFilter.addEventListener("click", ()=>{
  dataSearch.value="";
  dataColFilter.value="";
  dataColValue.value="";
  filteredDataRows = [...currentDataRows];
  renderDataTable(filteredDataRows);
});
dataSearch.addEventListener("input", applyDataFilter);

btnReloadData.addEventListener("click", ()=>{
  if(currentDataMenu) openDataMenu(currentDataMenu);
});

/* Simple page content uses Data page (card only) */
function openSimplePage(menu){
  currentSimplePage = menu;
  currentDataMenu = null;
  showPage("data",{menu:null, mid:menu.id});

  dataTitle.textContent = menu.title || "Halaman";
  dataSub.textContent = "Halaman ringkas (boleh edit dalam Tetapan ‚Üí Pengurusan Menu).";

  // render as 1 card (reuse table area as content)
  currentDataHeaders = [];
  currentDataRows = [];
  filteredDataRows = [];

  dataColFilter.innerHTML = `<option value="">Filter Kolum: (pilih)</option>`;
  dataHead.innerHTML = "";
  dataBody.innerHTML = `
    <tr><td style="padding:0;border-bottom:none">
      <div class="card" style="box-shadow:none;margin:10px">
        <div style="white-space:pre-wrap;line-height:1.75;font-weight:600">
          ${escapeHtml(menu.content || "Tiada kandungan.")}
        </div>
      </div>
    </td></tr>
  `;
  dataMeta.textContent = "";
  highlightActiveSidebar();
}

/* =========================
   LOADERS
========================= */
async function loadAttendance(){
  try{
    const parsed = await fetchCSV(SETTINGS.urls.attendance);
    attendanceRaw = normalizeAttendance(parsed);

    populateClassOptions();
    setHomeStats2(attendanceRaw);
    setAttendanceStats2(attendanceRaw);

    renderAttendanceTable(attendanceRaw);
    renderTrend();
  }catch(e){
    console.error(e);
    attendanceRaw = [];
    setHomeStats2([]);
    setAttendanceStats2([]);
    renderAttendanceTable([]);
    trendChart.innerHTML = renderLineChartSVG({data:[],mode:"hadir"});
  }
}

async function loadAnnouncements(){
  try{
    const parsed = await fetchCSV(SETTINGS.urls.announcements);
    announcementsRaw = normalizeAnnouncements(parsed);
    renderAnnouncements();
  }catch(e){
    console.error(e);
    announcementsRaw = [];
    annCount.textContent = "Gagal load";
    annListHome.innerHTML = `<div class="sub">Gagal load pengumuman. Sila semak URL CSV.</div>`;
    annGrid.innerHTML = `<div class="sub">Gagal load pengumuman.</div>`;
  }
}

async function loadParents(){
  try{
    const parsed = await fetchCSV(SETTINGS.urls.parents);
    parentsRaw = normalizeParents(parsed);
    renderParents();
  }catch(e){
    console.error(e);
    parentsRaw = [];
    parentsGrid.innerHTML = `<div class="sub">Gagal load data Ibu Bapa. Sila semak URL CSV.</div>`;
  }
}

async function loadCalendar(){
  if(!SETTINGS.urls.calendar){
    calendarRaw = [];
    calendarArea.textContent = "Belum disambungkan.";
    return;
  }
  try{
    const parsed = await fetchCSV(SETTINGS.urls.calendar);
    calendarRaw = parsed.data || [];
    calendarArea.textContent = `Loaded: ${calendarRaw.length} rekod (paparan ringkas belum diaktifkan).`;
  }catch(e){
    console.error(e);
    calendarRaw = [];
    calendarArea.textContent = "Gagal load. Semak URL CSV takwim.";
  }
}

async function loadAll(){
  await Promise.all([
    loadAttendance(),
    loadAnnouncements(),
    loadParents(),
    loadCalendar()
  ]);
}

/* =========================
   BUTTONS
========================= */
btnReload.addEventListener("click", loadAll);
btnReloadAttendance.addEventListener("click", loadAttendance);
btnReloadAnnouncements.addEventListener("click", loadAnnouncements);
btnReloadParents.addEventListener("click", loadParents);

btnToAnnouncements.addEventListener("click", ()=> showPage("announcements"));

/* =========================
   SETTINGS MODAL + PIN
========================= */
let settingsUnlocked = false;

function openSettings(){
  overlaySettings.classList.add("show");
  pinWarn.classList.remove("show");
  pinInput.value="";
  settingsUnlocked=false;
  pinStep.style.display="block";
  settingsStep.style.display="none";
}
function closeSettings(){
  overlaySettings.classList.remove("show");
}
btnSettings.addEventListener("click", openSettings);
btnCloseSettings.addEventListener("click", closeSettings);
overlaySettings.addEventListener("click",(e)=>{ if(e.target===overlaySettings) closeSettings(); });

btnPinOk.addEventListener("click", ()=>{
  const pin = String(pinInput.value||"").trim();
  if(pin !== SETTINGS.pin){
    pinWarn.classList.add("show");
    return;
  }
  pinWarn.classList.remove("show");
  settingsUnlocked=true;
  pinStep.style.display="none";
  settingsStep.style.display="block";

  // fill values
  setSchoolName.value = SETTINGS.schoolName;
  setSchoolMotto.value = SETTINGS.schoolMotto;
  setFooter1.value = SETTINGS.footer1;
  setFooter2.value = SETTINGS.footer2;

  setUrlAttendance.value = SETTINGS.urls.attendance;
  setUrlAnnouncements.value = SETTINGS.urls.announcements;
  setUrlParents.value = SETTINGS.urls.parents;
  setUrlCalendar.value = SETTINGS.urls.calendar || "";

  mapTarikh.value = SETTINGS.attendanceMap.tarikh;
  mapKelas.value = SETTINGS.attendanceMap.kelas;
  mapNama.value = SETTINGS.attendanceMap.nama;
  mapStatus.value = SETTINGS.attendanceMap.status;

  renderMenuManager();
});
pinInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter") btnPinOk.click(); });

btnSaveSettings.addEventListener("click", async ()=>{
  if(!settingsUnlocked) return;

  SETTINGS.schoolName = setSchoolName.value.trim() || DEFAULTS.schoolName;
  SETTINGS.schoolMotto = setSchoolMotto.value.trim() || DEFAULTS.schoolMotto;
  SETTINGS.footer1 = setFooter1.value.trim() || DEFAULTS.footer1;
  SETTINGS.footer2 = setFooter2.value.trim() || DEFAULTS.footer2;

  SETTINGS.urls.attendance = setUrlAttendance.value.trim() || DEFAULTS.urls.attendance;
  SETTINGS.urls.announcements = setUrlAnnouncements.value.trim() || DEFAULTS.urls.announcements;
  SETTINGS.urls.parents = setUrlParents.value.trim() || DEFAULTS.urls.parents;
  SETTINGS.urls.calendar = setUrlCalendar.value.trim();

  saveSettings(SETTINGS);
  applyIdentity();
  renderSidebarMenus();
  await loadAll();
  alert("Tetapan berjaya disimpan.");
});

btnResetSettings.addEventListener("click", ()=>{
  if(!settingsUnlocked) return;
  SETTINGS = structuredClone(DEFAULTS);
  saveSettings(SETTINGS);
  applyMode();
  applyIdentity();
  applySidebarDefault();
  renderSidebarMenus();
  alert("Tetapan telah reset.");
});

btnLockSettings.addEventListener("click", ()=>{
  settingsUnlocked=false;
  pinStep.style.display="block";
  settingsStep.style.display="none";
  pinInput.value="";
  pinWarn.classList.remove("show");
});

setLogoFile.addEventListener("change", async (e)=>{
  if(!settingsUnlocked) return;
  const file = e.target.files && e.target.files[0];
  if(!file) return;
  const dataUrl = await fileToDataURL(file);
  localStorage.setItem(LS.logo, dataUrl);
  applyIdentity();
});

btnSaveMapping.addEventListener("click", ()=>{
  if(!settingsUnlocked) return;
  SETTINGS.attendanceMap = {
    tarikh: mapTarikh.value.trim() || DEFAULTS.attendanceMap.tarikh,
    kelas: mapKelas.value.trim() || DEFAULTS.attendanceMap.kelas,
    nama: mapNama.value.trim() || DEFAULTS.attendanceMap.nama,
    status: mapStatus.value.trim() || DEFAULTS.attendanceMap.status
  };
  saveSettings(SETTINGS);
  alert("Pemetaan disimpan. Data kehadiran akan ikut kolum ini.");
  loadAttendance();
});

/* Sidebar default open/close */
btnSidebarOpen.addEventListener("click", ()=>{
  SETTINGS.sidebarDefault="open";
  saveSettings(SETTINGS);
  document.body.classList.remove("sb-closed");
  alert("Sidebar desktop: Buka (default).");
});
btnSidebarClose.addEventListener("click", ()=>{
  SETTINGS.sidebarDefault="closed";
  saveSettings(SETTINGS);
  document.body.classList.add("sb-closed");
  alert("Sidebar desktop: Tutup (icon sahaja) default.");
});

/* =========================
   MENU MANAGER (add/edit/delete)
========================= */
function renderMenuManager(){
  menuManagerList.innerHTML = "";

  const list = sortMenus(SETTINGS.menus||[]).filter(m=>m.type!=="built"); // only custom
  if(!list.length){
    menuManagerList.innerHTML = `<div class="sub">Belum ada menu custom. Tekan ‚Äú+ Tambah Menu‚Äù.</div>`;
    return;
  }

  list.forEach(m=>{
    const el = document.createElement("div");
    el.className = "menuCard";
    el.innerHTML = `
      <div class="menuLeft">
        <div class="menuIcon">${escapeHtml(m.icon||"üìÑ")}</div>
        <div class="menuText">
          <div class="menuTitle">${escapeHtml(m.title||"Menu")}</div>
          <div class="menuMeta">${escapeHtml(menuMetaText(m))} ¬∑ Urutan: ${escapeHtml(String(m.order||""))}</div>
        </div>
      </div>
      <div class="menuActions">
        <button class="btn" data-act="edit">Edit</button>
        <button class="btn" data-act="del">Padam</button>
      </div>
    `;
    el.querySelector('[data-act="edit"]').addEventListener("click", ()=> openMenuEdit(m));
    el.querySelector('[data-act="del"]').addEventListener("click", ()=>{
      if(!confirm(`Padam menu: ${m.title}?`)) return;
      SETTINGS.menus = (SETTINGS.menus||[]).filter(x=>x.id!==m.id);
      saveSettings(SETTINGS);
      renderMenuManager();
      renderSidebarMenus();
    });

    menuManagerList.appendChild(el);
  });
}

btnAddMenu.addEventListener("click", ()=> openMenuEdit(null));

let editingMenuId = null;

function openMenuEdit(menu){
  overlayMenuEdit.classList.add("show");
  editingMenuId = menu ? menu.id : null;

  menuEditTitle.textContent = menu ? "Edit Menu" : "Tambah Menu";
  mTitle.value = menu?.title || "";
  mIcon.value = menu?.icon || "";
  mType.value = menu?.type || "page";
  mOrder.value = menu?.order || (sortMenus(SETTINGS.menus||[]).length + 1);

  mPageContent.value = menu?.content || "";
  mCsvUrl.value = menu?.csvUrl || "";
  mLinkUrl.value = menu?.url || "";

  updateMenuEditUI();
}

function closeMenuEdit(){
  overlayMenuEdit.classList.remove("show");
  editingMenuId = null;
}
btnCloseMenuEdit.addEventListener("click", closeMenuEdit);
btnCancelMenuEdit.addEventListener("click", closeMenuEdit);
overlayMenuEdit.addEventListener("click",(e)=>{ if(e.target===overlayMenuEdit) closeMenuEdit(); });

function updateMenuEditUI(){
  const t = mType.value;
  mPageWrap.style.display = (t==="page") ? "block" : "none";
  mDataWrap.style.display = (t==="data") ? "block" : "none";
  mLinkWrap.style.display = (t==="link") ? "block" : "none";
}
mType.addEventListener("change", updateMenuEditUI);

btnSaveMenuEdit.addEventListener("click", ()=>{
  if(!settingsUnlocked) return;

  const title = (mTitle.value||"").trim();
  if(!title){
    alert("Sila isi tajuk menu.");
    return;
  }

  const icon = (mIcon.value||"").trim() || "üìÑ";
  const type = mType.value;
  const order = Number(mOrder.value||"999");

  const obj = {
    id: editingMenuId || uid(),
    title, icon, type, order
  };

  if(type==="page"){
    obj.content = (mPageContent.value||"").trim();
  }
  if(type==="data"){
    obj.csvUrl = (mCsvUrl.value||"").trim();
    if(!obj.csvUrl){
      alert("Sila isi URL CSV untuk menu Data CSV.");
      return;
    }
  }
  if(type==="link"){
    obj.url = (mLinkUrl.value||"").trim();
    if(!obj.url){
      alert("Sila isi URL untuk Pautan Luar.");
      return;
    }
  }

  // Prevent editing built menu types here
  const builtIds = new Set((DEFAULTS.menus||[]).filter(m=>m.type==="built").map(m=>m.id));
  if(builtIds.has(obj.id)){
    alert("Menu sistem (built-in) tidak boleh diubah di sini.");
    return;
  }

  const menus = [...(SETTINGS.menus||[])];
  const idx = menus.findIndex(x=>x.id===obj.id);
  if(idx>=0) menus[idx] = obj;
  else menus.push(obj);

  SETTINGS.menus = menus;
  saveSettings(SETTINGS);

  renderMenuManager();
  renderSidebarMenus();
  closeMenuEdit();
});

/* =========================
   NAV HELPERS
========================= */
function showBuiltHome(){ showPage("home"); }
function showBuiltAttendance(){ showPage("attendance"); }
function showBuiltAnnouncements(){ showPage("announcements"); }
function showBuiltCalendar(){ showPage("calendar"); }
function showBuiltParents(){ showPage("parents"); }

/* =========================
   INIT MENU
========================= */
function ensureBuiltMenus(){
  const built = structuredClone(DEFAULTS.menus);
  const existing = SETTINGS.menus || [];

  // ensure built exist
  built.forEach(b=>{
    if(!existing.some(x=>x.id===b.id)){
      existing.push(b);
    }else{
      // keep built type always "built"
      const i = existing.findIndex(x=>x.id===b.id);
      existing[i] = {...b, ...existing[i], type:"built"};
    }
  });

  SETTINGS.menus = existing;
  saveSettings(SETTINGS);
}

/* =========================
   LOAD ALL + PAGE ACTIONS
========================= */
btnReload.addEventListener("click", loadAll);
btnToAnnouncements.addEventListener("click", ()=> showBuiltAnnouncements());

btnReloadAttendance.addEventListener("click", loadAttendance);
btnReloadAnnouncements.addEventListener("click", loadAnnouncements);
btnReloadParents.addEventListener("click", loadParents);

/* =========================
   SETTINGS MODAL OPEN/CLOSE
========================= */
btnSettings.addEventListener("click", openSettings);

/* =========================
   STARTUP
========================= */
function init(){
  ensureBuiltMenus();
  applyMode();
  applyIdentity();
  applySidebarDefault();
  tickClock();
  setupTrendSelectors();
  renderSidebarMenus();
  showPage("home");
  loadAll();
}
init();
</script>
</body>
</html>
