<!doctype html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Portal PPKI SK Paya Resak</title>

  <!-- Chart.js (untuk line chart) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg: #EAF4EA;
      --bg2:#F6FBF6;
      --card:#FFFFFF;
      --text:#0B1220;
      --muted:#51606f;
      --line:#dbe7db;
      --primary:#1F4D3A;
      --accent:#2AA198;
      --danger:#d33;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius: 18px;
    }
    [data-theme="dark"]{
      --bg:#0B1220;
      --bg2:#0f1a2f;
      --card:#111827;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:#22304b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    /* Theme presets (warna primary/accent) */
    [data-preset="forest"] { --primary:#1F4D3A; --accent:#2AA198; }
    [data-preset="ocean"]  { --primary:#0b3b6e; --accent:#3aa0ff; }
    [data-preset="purple"] { --primary:#4c1d95; --accent:#a78bfa; }
    [data-preset="amber"]  { --primary:#92400e; --accent:#f59e0b; }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
      color: var(--text);
      min-height:100vh;
    }
    a{color:inherit}
    .app{display:flex; min-height:100vh;}
    .sidebar{
      width: 280px;
      background: var(--card);
      border-right: 1px solid var(--line);
      padding: 14px;
      position: sticky;
      top:0;
      height:100vh;
      overflow:auto;
      box-shadow: var(--shadow);
    }
    .sidebar.collapsed{
      width: 84px;
      padding: 14px 10px;
    }
    .brand{
      display:flex; gap:12px; align-items:center;
      padding: 10px;
      border-radius: var(--radius);
      background: linear-gradient(135deg, rgba(31,77,58,.12), rgba(42,161,152,.12));
      border: 1px solid var(--line);
    }
    .logoBox{
      width: 46px; height: 46px;
      border-radius: 14px;
      background: rgba(0,0,0,.06);
      overflow:hidden;
      display:grid; place-items:center;
      flex:0 0 auto;
    }
    .logoBox img{width:100%; height:100%; object-fit:cover}
    .brandText{min-width:0}
    .schoolName{
      font-weight: 800;
      font-size: 14.5px;
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .motto{
      color: var(--muted);
      font-size: 12px;
      margin-top: 3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .nav{
      margin-top: 14px;
      display:flex; flex-direction:column; gap:8px;
    }
    .navBtn{
      display:flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid transparent;
      cursor:pointer;
      user-select:none;
      transition: .15s;
    }
    .navBtn:hover{background: rgba(0,0,0,.04)}
    [data-theme="dark"] .navBtn:hover{background: rgba(255,255,255,.06)}
    .navBtn.active{
      background: linear-gradient(135deg, rgba(31,77,58,.14), rgba(42,161,152,.14));
      border-color: var(--line);
    }
    .icon{
      width: 38px; height: 38px;
      border-radius: 14px;
      display:grid; place-items:center;
      background: rgba(0,0,0,.05);
      flex:0 0 auto;
      font-size: 18px;
    }
    [data-theme="dark"] .icon{background: rgba(255,255,255,.06)}
    .label{
      font-weight: 700;
      font-size: 14px;
    }
    .sidebar.collapsed .brandText,
    .sidebar.collapsed .label,
    .sidebar.collapsed .motto,
    .sidebar.collapsed .schoolName{
      display:none;
    }

    .sidebarFooter{
      margin-top: 16px;
      padding: 12px 10px;
      border-top: 1px solid var(--line);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }

    .main{
      flex:1;
      display:flex;
      flex-direction:column;
      min-width: 0;
    }
    .header{
      position: sticky;
      top: 0;
      z-index: 5;
      background: rgba(255,255,255,.65);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
      padding: 12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    [data-theme="dark"] .header{background: rgba(17,24,39,.65)}
    .headerLeft{display:flex; align-items:center; gap:10px; min-width:0}
    .hamburger{
      width: 44px; height: 44px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: var(--card);
      cursor:pointer;
      display:grid; place-items:center;
      font-size: 18px;
      box-shadow: var(--shadow);
    }
    .pageTitle{
      font-weight: 900;
      font-size: 16px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .headerRight{display:flex; align-items:center; gap:10px}
    .chip{
      border: 1px solid var(--line);
      background: var(--card);
      border-radius: 999px;
      padding: 8px 12px;
      font-weight: 800;
      cursor:pointer;
      display:flex; align-items:center; gap:8px;
      box-shadow: var(--shadow);
    }
    .chip small{color:var(--muted); font-weight:700}
    .badge{
      background: var(--danger);
      color: #fff;
      font-size: 11px;
      font-weight: 900;
      padding: 2px 8px;
      border-radius: 999px;
    }

    .content{
      padding: 16px;
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
    }

    .banner{
      border-radius: var(--radius);
      border: 1px solid var(--line);
      background: linear-gradient(135deg, rgba(31,77,58,.16), rgba(42,161,152,.16));
      padding: 18px;
      box-shadow: var(--shadow);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .banner h2{margin:0; font-size: 18px; font-weight: 1000}
    .banner p{margin:6px 0 0; color: var(--muted); font-weight:700}
    .clock{
      font-weight: 1000;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: var(--card);
      box-shadow: var(--shadow);
      white-space: nowrap;
    }

    .grid{
      display:grid;
      gap: 12px;
      margin-top: 14px;
    }
    .grid.cards{grid-template-columns: repeat(4, minmax(0, 1fr));}
    @media (max-width: 1024px){
      .grid.cards{grid-template-columns: repeat(2, minmax(0, 1fr));}
    }
    @media (max-width: 520px){
      .grid.cards{grid-template-columns: 1fr;}
    }

    .card{
      border-radius: var(--radius);
      border: 1px solid var(--line);
      background: var(--card);
      box-shadow: var(--shadow);
      padding: 14px;
      min-width:0;
    }
    .statCard{
      cursor:pointer;
      transition:.15s;
    }
    .statCard:hover{transform: translateY(-1px)}
    .statTop{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .statTop .k{color: var(--muted); font-weight: 900; font-size: 12px}
    .statTop .i{font-size: 18px}
    .statVal{margin-top: 6px; font-size: 26px; font-weight: 1100}
    .statSub{margin-top: 6px; color: var(--muted); font-weight: 800; font-size: 12px}

    .sectionTitle{
      margin: 16px 0 10px;
      font-size: 14px;
      font-weight: 1000;
      color: var(--muted);
      letter-spacing: .02em;
      text-transform: uppercase;
    }

    .tableWrap{
      border-radius: var(--radius);
      overflow:hidden;
      border: 1px solid var(--line);
      background: var(--card);
      box-shadow: var(--shadow);
    }
    table{width:100%; border-collapse:collapse; font-size: 13px}
    th, td{padding: 10px 10px; border-bottom: 1px solid var(--line); vertical-align:top}
    th{background: rgba(0,0,0,.04); text-align:left; font-size: 12px; font-weight: 1000}
    [data-theme="dark"] th{background: rgba(255,255,255,.06)}
    tr:hover td{background: rgba(0,0,0,.02)}
    [data-theme="dark"] tr:hover td{background: rgba(255,255,255,.03)}

    .filters{
      display:grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 10px;
      margin: 12px 0;
    }
    @media (max-width: 1024px){ .filters{grid-template-columns: repeat(3, minmax(0, 1fr));} }
    @media (max-width: 520px){ .filters{grid-template-columns: 1fr;} }

    input, select, textarea{
      width:100%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: var(--card);
      color: var(--text);
      outline:none;
      font-weight: 800;
    }
    textarea{min-height: 90px; resize: vertical; font-weight: 700}
    .btn{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: var(--card);
      cursor:pointer;
      font-weight: 1000;
      box-shadow: var(--shadow);
    }
    .btn.primary{
      border-color: transparent;
      background: linear-gradient(135deg, rgba(31,77,58,.95), rgba(42,161,152,.95));
      color:#fff;
    }
    .btn.danger{
      background: rgba(211,51,51,.12);
      border-color: rgba(211,51,51,.35);
      color: var(--text);
    }
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1; min-width: 220px}

    /* Modals */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.45);
      display:none;
      z-index: 50;
      padding: 18px;
      overflow:auto;
    }
    .overlay.show{display:block}
    .modal{
      max-width: 760px;
      margin: 30px auto;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      gap: 12px;
    }
    .modalHeader h3{margin:0; font-size: 15px; font-weight: 1100}
    .modalBody{padding: 16px}
    .closeX{
      width: 42px; height: 42px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: var(--card);
      cursor:pointer;
      font-size: 18px;
      display:grid; place-items:center;
    }
    .warn{
      background: rgba(211,51,51,.12);
      border: 1px solid rgba(211,51,51,.35);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 900;
    }
    .muted{color:var(--muted); font-weight: 800}

    /* Mobile default: sidebar closed */
    @media (max-width: 860px){
      .sidebar{
        position: fixed;
        left: 0;
        top: 0;
        z-index: 30;
        transform: translateX(-110%);
        transition: .2s;
      }
      .sidebar.open{transform: translateX(0)}
      .sidebarBackdrop{
        display:none;
        position: fixed;
        inset:0;
        background: rgba(0,0,0,.38);
        z-index: 25;
      }
      .sidebarBackdrop.show{display:block}
      .content{padding: 14px}
    }
  </style>
</head>

<body data-theme="light" data-preset="forest">
  <div class="sidebarBackdrop" id="sidebarBackdrop"></div>

  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar collapsed" id="sidebar">
      <div class="brand" title="Portal PPKI">
        <div class="logoBox" id="logoBox">
          <span style="font-weight:1000;">ğŸ«</span>
        </div>
        <div class="brandText">
          <div class="schoolName" id="schoolName">SK Paya Resak</div>
          <div class="motto" id="schoolMotto">Moving Forward</div>
        </div>
      </div>

      <nav class="nav" id="nav">
        <div class="navBtn active" data-page="home">
          <div class="icon">ğŸ </div>
          <div class="label">Laman Utama</div>
        </div>

        <div class="navBtn" data-page="kehadiran">
          <div class="icon">ğŸ“‹</div>
          <div class="label">Kehadiran</div>
        </div>

        <div class="navBtn" data-page="pengumuman">
          <div class="icon">ğŸ“¢</div>
          <div class="label">
            Pengumuman
            <span id="annBadgeSide" class="badge" style="display:none; margin-left:8px;">0</span>
          </div>
        </div>

        <div class="navBtn" data-page="takwim">
          <div class="icon">ğŸ—“ï¸</div>
          <div class="label">Takwim</div>
        </div>

        <div class="navBtn" data-page="ibubapa">
          <div class="icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
          <div class="label">Ibu Bapa</div>
        </div>
      </nav>

      <div class="sidebarFooter">
        <div id="footerText">Â© 2025 NK. <br/>Hak Cipta Terpelihara.</div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <header class="header">
        <div class="headerLeft">
          <button class="hamburger" id="btnSidebar" title="Buka/Tutup Sidebar">â˜°</button>
          <div class="pageTitle" id="pageTitle">Laman Utama</div>
        </div>

        <div class="headerRight">
          <div class="chip" id="themeToggle" title="Tukar Light/Dark">
            <span id="themeIcon">ğŸŒ™</span>
            <span style="font-weight:1100;">Tema</span>
            <small id="themeLabel">Light</small>
          </div>

          <div class="chip" id="btnGear" title="Tetapan (Perlu PIN)">
            <span>âš™ï¸</span>
            <span style="font-weight:1100;">Tetapan</span>
          </div>

          <div class="chip" title="Pengumuman Aktif">
            <span>ğŸ””</span>
            <span id="annBadgeTop" class="badge">0</span>
          </div>
        </div>
      </header>

      <div class="content">
        <!-- HOME -->
        <section id="page-home">
          <div class="banner">
            <div>
              <h2 id="welcomeTitle">Selamat Datang ke Portal Rasmi PPKI SK Paya Resak</h2>
              <p class="muted">Maklumat ringkas & pantas untuk rujukan warga sekolah.</p>
            </div>
            <div class="clock" id="clock">--:--</div>
          </div>

          <div class="grid cards" style="margin-top:14px;">
            <div class="card statCard" id="cardToday" title="Klik untuk pergi ke Kehadiran">
              <div class="statTop">
                <div class="k">Kehadiran Hari Ini</div>
                <div class="i">âœ…</div>
              </div>
              <div class="statVal" id="vToday">-</div>
              <div class="statSub" id="sToday">Memuatkan...</div>
            </div>

            <div class="card statCard" id="cardWeek" title="Klik untuk pergi ke Kehadiran">
              <div class="statTop">
                <div class="k">Kehadiran Minggu Ini</div>
                <div class="i">ğŸ“†</div>
              </div>
              <div class="statVal" id="vWeek">-</div>
              <div class="statSub" id="sWeek">Memuatkan...</div>
            </div>

            <div class="card statCard" id="cardMonth" title="Klik untuk pergi ke Kehadiran">
              <div class="statTop">
                <div class="k">Kehadiran Bulan Ini</div>
                <div class="i">ğŸ—“ï¸</div>
              </div>
              <div class="statVal" id="vMonth">-</div>
              <div class="statSub" id="sMonth">Memuatkan...</div>
            </div>

            <div class="card statCard" id="cardPct" title="Klik untuk pergi ke Kehadiran">
              <div class="statTop">
                <div class="k">Peratus Kehadiran Bulanan</div>
                <div class="i">ğŸ“ˆ</div>
              </div>
              <div class="statVal" id="vPct">-</div>
              <div class="statSub" id="sPct">Memuatkan...</div>
            </div>
          </div>

          <div class="sectionTitle">Trend Kehadiran (Bulanan)</div>
          <div class="card">
            <canvas id="attChart" height="90"></canvas>
            <div class="muted" style="margin-top:10px; font-size:12px;">
              Paksi-X: Bulan â€¢ Paksi-Y: Bilangan â€œHadirâ€
            </div>
          </div>

          <div class="sectionTitle">Pengumuman Aktif</div>
          <div class="card statCard" id="cardAnn" title="Klik untuk pergi ke Pengumuman">
            <div class="statTop">
              <div class="k">Senarai Pengumuman Aktif</div>
              <div class="i">ğŸ“¢</div>
            </div>
            <div class="statVal"><span id="vAnnCount">0</span></div>
            <div class="statSub" id="annListShort">Memuatkan...</div>
          </div>
        </section>

        <!-- KEHADIRAN -->
        <section id="page-kehadiran" style="display:none;">
          <div class="banner" style="margin-bottom:14px;">
            <div>
              <h2>Dashboard Kehadiran</h2>
              <p class="muted">Penapisan mengikut kolum, carian, dan julat tarikh.</p>
            </div>
            <div class="row" style="gap:10px;">
              <button class="btn" id="btnReloadKehadiran">ğŸ”„ Muat Semula</button>
              <button class="btn" id="btnAdminCols" style="display:none;">ğŸ‘ï¸ Kolum Admin</button>
            </div>
          </div>

          <div class="grid cards">
            <div class="card statCard" id="cardToday2">
              <div class="statTop"><div class="k">Kehadiran Hari Ini</div><div class="i">âœ…</div></div>
              <div class="statVal" id="vToday2">-</div>
              <div class="statSub" id="sToday2">â€”</div>
            </div>
            <div class="card statCard" id="cardWeek2">
              <div class="statTop"><div class="k">Kehadiran Minggu Ini</div><div class="i">ğŸ“†</div></div>
              <div class="statVal" id="vWeek2">-</div>
              <div class="statSub" id="sWeek2">â€”</div>
            </div>
            <div class="card statCard" id="cardMonth2">
              <div class="statTop"><div class="k">Kehadiran Bulan Ini</div><div class="i">ğŸ—“ï¸</div></div>
              <div class="statVal" id="vMonth2">-</div>
              <div class="statSub" id="sMonth2">â€”</div>
            </div>
            <div class="card statCard" id="cardPct2">
              <div class="statTop"><div class="k">Peratus Kehadiran Bulanan</div><div class="i">ğŸ“ˆ</div></div>
              <div class="statVal" id="vPct2">-</div>
              <div class="statSub" id="sPct2">â€”</div>
            </div>
          </div>

          <div class="filters">
            <div>
              <div class="muted" style="font-size:12px; margin:0 0 6px;">Carian</div>
              <input id="fSearch" placeholder="Cari apa-apa (Nama/Kelas/Status...)" />
            </div>
            <div>
              <div class="muted" style="font-size:12px; margin:0 0 6px;">Tarikh Mula</div>
              <input id="fDateFrom" type="date" />
            </div>
            <div>
              <div class="muted" style="font-size:12px; margin:0 0 6px;">Tarikh Tamat</div>
              <input id="fDateTo" type="date" />
            </div>
            <div>
              <div class="muted" style="font-size:12px; margin:0 0 6px;">Filter Kelas</div>
              <input id="fKelas" placeholder="cth: 1 AL-FARABI" />
            </div>
            <div>
              <div class="muted" style="font-size:12px; margin:0 0 6px;">Filter Nama</div>
              <input id="fNama" placeholder="cth: Ali" />
            </div>
            <div>
              <div class="muted" style="font-size:12px; margin:0 0 6px;">Filter Status</div>
              <input id="fStatus" placeholder="cth: Hadir" />
            </div>
          </div>

          <div class="tableWrap">
            <table id="kehadiranTable">
              <thead id="kehadiranThead"></thead>
              <tbody id="kehadiranTbody"></tbody>
            </table>
          </div>

          <div class="muted" style="margin-top:10px; font-size:12px;">
            Nota: Kolum kehadiran dibaca secara â€œLOCK MAPPINGâ€ (Tarikh, Kelas, Nama Murid, Status, Jantina).
            Cikgu boleh guna `Nama Murid` atau `Nama_Murid`.
          </div>
        </section>

        <!-- PENGUMUMAN -->
        <section id="page-pengumuman" style="display:none;">
          <div class="banner" style="margin-bottom:14px;">
            <div>
              <h2>Pengumuman</h2>
              <p class="muted">Kad pengumuman boleh diklik untuk paparan detail.</p>
            </div>
            <button class="btn" id="btnReloadAnn">ğŸ”„ Muat Semula</button>
          </div>

          <div id="annContainer" class="grid" style="grid-template-columns: repeat(2, minmax(0, 1fr));"></div>
          <div class="muted" style="margin-top:12px; font-size:12px;">
            Pengumuman aktif ditapis automatik berdasarkan Tarikh Mula/Tamat & kolum AKTIF (YA/TIDAK).
          </div>
        </section>

        <!-- TAKWIM -->
        <section id="page-takwim" style="display:none;">
          <div class="banner" style="margin-bottom:14px;">
            <div>
              <h2>Takwim</h2>
              <p class="muted">Boleh disambungkan ke Google Sheet (CSV) melalui Tetapan (PIN).</p>
            </div>
            <button class="btn" id="btnReloadTakwim">ğŸ”„ Muat Semula</button>
          </div>

          <div class="card">
            <div class="muted" style="font-size:13px;">
              Buat masa ini URL Takwim belum diisi (cikgu boleh isi di Tetapan).
            </div>
            <div style="margin-top:12px;" class="tableWrap">
              <table id="takwimTable">
                <thead id="takwimThead"></thead>
                <tbody id="takwimTbody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- IBU BAPA -->
        <section id="page-ibubapa" style="display:none;">
          <div class="banner" style="margin-bottom:14px;">
            <div>
              <h2>Ibu Bapa</h2>
              <p class="muted">Kad makluman / pautan â€” boleh pilih pop-out atau buka tab baru (ikut data CSV).</p>
            </div>
            <button class="btn" id="btnReloadParents">ğŸ”„ Muat Semula</button>
          </div>

          <div id="parentsContainer" class="grid" style="grid-template-columns: repeat(2, minmax(0, 1fr));"></div>
          <div class="muted" style="margin-top:12px; font-size:12px;">
            Cadangan kolum: Tajuk, Isi Kandungan, URL, Mod (POPUP / TAB).
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- PIN MODAL -->
  <div class="overlay" id="pinOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <h3>Masukkan PIN Tetapan</h3>
        <button class="closeX" id="pinClose">âœ•</button>
      </div>
      <div class="modalBody">
        <div class="muted" style="margin-bottom:10px;">
          Hanya pemilik boleh kemaskini logo, nama sekolah, moto, footer, URL data & tema preset.
        </div>

        <div class="row">
          <div>
            <div class="muted" style="font-size:12px; margin:0 0 6px;">PIN</div>
            <input id="pinInput" type="password" placeholder="â€¢â€¢â€¢â€¢" inputmode="numeric" />
          </div>
          <div style="display:flex; align-items:end;">
            <button class="btn primary" id="pinSubmit">Buka Tetapan</button>
          </div>
        </div>

        <div id="pinWarn" class="warn" style="display:none; margin-top:12px;">
          PIN salah. Sila cuba lagi.
        </div>
      </div>
    </div>
  </div>

  <!-- SETTINGS MODAL -->
  <div class="overlay" id="settingsOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" style="max-width: 980px;">
      <div class="modalHeader">
        <h3>Tetapan Portal (Admin)</h3>
        <button class="closeX" id="settingsClose">âœ•</button>
      </div>
      <div class="modalBody">
        <div class="warn" style="margin-bottom:12px;">
          Perubahan disimpan dalam peranti (localStorage). Pengguna lain masih boleh tukar Light/Dark sahaja.
        </div>

        <div class="sectionTitle">Maklumat Portal</div>
        <div class="row">
          <div>
            <div class="muted" style="font-size:12px; margin:0 0 6px;">Nama Sekolah</div>
            <input id="setSchoolName" />
          </div>
          <div>
            <div class="muted" style="font-size:12px; margin:0 0 6px;">Moto</div>
            <input id="setMotto" />
          </div>
        </div>

        <div class="row">
          <div>
            <div class="muted" style="font-size:12px; margin:10px 0 6px;">URL Logo (gambar)</div>
            <input id="setLogoUrl" placeholder="cth: https://.../logo.png" />
            <div class="muted" style="font-size:12px; margin-top:6px;">
              Jika kosong, portal guna ikon ğŸ«.
            </div>
          </div>
          <div>
            <div class="muted" style="font-size:12px; margin:10px 0 6px;">Footer</div>
            <textarea id="setFooter"></textarea>
          </div>
        </div>

        <div class="sectionTitle">Tema</div>
        <div class="row">
          <div>
            <div class="muted" style="font-size:12px; margin:0 0 6px;">Preset Tema</div>
            <select id="setPreset">
              <option value="forest">Forest (Default)</option>
              <option value="ocean">Ocean</option>
              <option value="purple">Purple</option>
              <option value="amber">Amber</option>
            </select>
            <div class="muted" style="font-size:12px; margin-top:6px;">
              Semua pengguna boleh toggle Light/Dark di header.
            </div>
          </div>
          <div>
            <div class="muted" style="font-size:12px; margin:0 0 6px;">Mod Default</div>
            <select id="setDefaultTheme">
              <option value="light">Light</option>
              <option value="dark">Dark</option>
            </select>
          </div>
        </div>

        <div class="sectionTitle">URL Data (CSV)</div>
        <div class="row">
          <div>
            <div class="muted" style="font-size:12px; margin:0 0 6px;">Kehadiran (CSV)</div>
            <input id="setUrlKehadiran" />
          </div>
          <div>
            <div class="muted" style="font-size:12px; margin:0 0 6px;">Pengumuman (CSV)</div>
            <input id="setUrlAnn" />
          </div>
        </div>
        <div class="row">
          <div>
            <div class="muted" style="font-size:12px; margin:0 0 6px;">Ibu Bapa (CSV)</div>
            <input id="setUrlParents" />
          </div>
          <div>
            <div class="muted" style="font-size:12px; margin:0 0 6px;">Takwim (CSV)</div>
            <input id="setUrlTakwim" placeholder="(isi bila sudah ada sheet)" />
          </div>
        </div>

        <div class="sectionTitle">Kehadiran (Kolum Admin)</div>
        <div class="row">
          <div>
            <div class="muted" style="font-size:12px; margin:0 0 6px;">Sembunyikan kolum bila bukan admin</div>
            <input id="setHideCols" placeholder="cth: Jantina, (lain-lain)" />
            <div class="muted" style="font-size:12px; margin-top:6px;">
              Asingkan dengan koma. Contoh: <b>Jantina</b>
            </div>
          </div>
          <div>
            <div class="muted" style="font-size:12px; margin:0 0 6px;">PIN Admin (paparan sahaja)</div>
            <input value="5235" disabled />
            <div class="muted" style="font-size:12px; margin-top:6px;">
              PIN disimpan dalam kod. (Jika cikgu nak ubah, cari <b>ADMIN_PIN</b> dalam script.)
            </div>
          </div>
        </div>

        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px;">
          <button class="btn danger" id="btnReset">Reset Tetapan</button>
          <button class="btn primary" id="btnSave">Simpan</button>
        </div>
      </div>
    </div>
  </div>

  <!-- DETAIL MODAL (untuk Pengumuman/Ibu Bapa) -->
  <div class="overlay" id="detailOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <h3 id="detailTitle">Detail</h3>
        <button class="closeX" id="detailClose">âœ•</button>
      </div>
      <div class="modalBody">
        <div id="detailMeta" class="muted" style="margin-bottom:10px;"></div>
        <div id="detailBody" style="white-space:pre-wrap; font-weight:800; line-height:1.5;"></div>
        <div id="detailLinkWrap" style="margin-top:12px; display:none;">
          <a id="detailLink" class="btn primary" href="#" target="_blank" rel="noopener">Buka Pautan</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    /***********************
     *  CONFIG (DEFAULT)
     ***********************/
    const ADMIN_PIN = "5235";

    const DEFAULTS = {
      schoolName: "SK Paya Resak",
      motto: "Moving Forward",
      logoUrl: "",
      footer: "Â© 2025 NK.\nHak Cipta Terpelihara.",
      preset: "forest",
      theme: "light",

      urlKehadiran: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTKhex5gcCHKoiLqRZpgVRMRfrGGvPtbgc3jo_Q-3FPL5OpcoWvyAnec0dTgykrpkYuS34iNJnEAkDU/pub?gid=880667725&single=true&output=csv",
      urlAnn: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQvKlO-LRGh8kj_-Be6NxZRR3Z38rjbC33jyvfhQvnR9L4LF7_dZRVXYGK3XO7bAoJwC9bJJmABjV6Z/pub?gid=946270411&single=true&output=csv",
      urlParents: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ_G1txQOE4Di1XsK6esbw8VgQtW2hcPsjzAmPH7V82JOeXegb7Kb_3Iz8CeHo-KvfvHe9x8BWtSfbB/pub?gid=1684744050&single=true&output=csv",
      urlTakwim: "",

      hideColsNonAdmin: "Jantina"
    };

    const LS_KEY = "ppki_portal_settings_v1";
    const SS_ADMIN = "ppki_admin_unlocked_v1";

    const state = {
      settings: loadSettings(),
      adminUnlocked: sessionStorage.getItem(SS_ADMIN) === "1",
      page: "home",

      // data cache
      kehadiran: { headers: [], rows: [] },
      pengumuman: { headers: [], rows: [] },
      parents:   { headers: [], rows: [] },
      takwim:    { headers: [], rows: [] },

      chart: null,
      showAdminCols: false
    };

    applySettingsToUI();

    /***********************
     *  UTIL: CSV PARSER
     ***********************/
    function parseCSV(text){
      // Basic robust CSV parser (handles quotes)
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for (let i=0; i<text.length; i++){
        const c = text[i];
        const n = text[i+1];

        if (c === '"' ){
          if (inQuotes && n === '"'){ cur += '"'; i++; }
          else { inQuotes = !inQuotes; }
        } else if (c === ',' && !inQuotes){
          row.push(cur); cur = "";
        } else if ((c === '\n' || c === '\r') && !inQuotes){
          if (c === '\r' && n === '\n') i++;
          row.push(cur); cur = "";
          if (row.some(v => v.trim() !== "")) rows.push(row);
          row = [];
        } else {
          cur += c;
        }
      }
      // last cell
      row.push(cur);
      if (row.some(v => v.trim() !== "")) rows.push(row);

      // trim
      return rows.map(r => r.map(v => (v ?? "").trim()));
    }

    function rowsToObjects(headers, rows){
      return rows.map(r => {
        const o = {};
        headers.forEach((h, idx) => o[h] = (r[idx] ?? "").trim());
        return o;
      });
    }

    function normalizeHeader(h){
      return (h || "").trim();
    }

    /***********************
     *  UTIL: DATE PARSER
     ***********************/
    function parseDateSmart(s){
      const t = (s || "").trim();
      if (!t) return null;

      // try YYYY-MM-DD
      if (/^\d{4}-\d{2}-\d{2}$/.test(t)){
        const d = new Date(t + "T00:00:00");
        return isNaN(d.getTime()) ? null : d;
      }

      // try DD/MM/YYYY
      if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(t)){
        const [dd, mm, yyyy] = t.split("/").map(Number);
        const d = new Date(yyyy, mm-1, dd);
        return isNaN(d.getTime()) ? null : d;
      }

      // fallback
      const d = new Date(t);
      return isNaN(d.getTime()) ? null : d;
    }

    function isSameDay(a,b){
      return a && b &&
        a.getFullYear()===b.getFullYear() &&
        a.getMonth()===b.getMonth() &&
        a.getDate()===b.getDate();
    }
    function startOfWeek(d){
      // Monday as start
      const x = new Date(d);
      const day = (x.getDay()+6)%7; // Mon=0
      x.setDate(x.getDate() - day);
      x.setHours(0,0,0,0);
      return x;
    }
    function endOfWeek(d){
      const s = startOfWeek(d);
      const e = new Date(s);
      e.setDate(e.getDate()+6);
      e.setHours(23,59,59,999);
      return e;
    }

    function fmtDateMY(d){
      if (!d) return "-";
      const opts = { weekday:'short', year:'numeric', month:'short', day:'2-digit' };
      return d.toLocaleDateString('ms-MY', opts);
    }

    function monthKey(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      return `${y}-${m}`;
    }

    /***********************
     *  LOCKED COLUMN MAPPING (Kehadiran)
     ***********************/
    function getKehadiranColumns(headers){
      // ===== LOCKED COLUMN MAPPING =====
      const COL_TARIKH = "Tarikh";
      const COL_KELAS = "Kelas";
      const COL_NAMA  = headers.includes("Nama Murid") ? "Nama Murid" : "Nama_Murid"; // fallback
      const COL_STATUS = "Status";
      const COL_JANTINA = "Jantina";

      const missing = [];
      [COL_TARIKH, COL_KELAS, COL_NAMA, COL_STATUS].forEach(col=>{
        if (!headers.includes(col)) missing.push(col);
      });
      if (missing.length){
        console.warn("âŒ Kolum Kehadiran tidak dijumpai:", missing.join(", "));
      }

      return { tarikh: COL_TARIKH, kelas: COL_KELAS, nama: COL_NAMA, status: COL_STATUS, jantina: COL_JANTINA };
    }

    /***********************
     *  LOAD & SAVE SETTINGS
     ***********************/
    function loadSettings(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return {...DEFAULTS};
        const parsed = JSON.parse(raw);
        return { ...DEFAULTS, ...parsed };
      }catch{
        return {...DEFAULTS};
      }
    }
    function saveSettings(s){
      localStorage.setItem(LS_KEY, JSON.stringify(s));
    }

    function applySettingsToUI(){
      const s = state.settings;

      document.body.setAttribute("data-preset", s.preset);
      document.body.setAttribute("data-theme", s.theme);

      // Sidebar brand
      document.getElementById("schoolName").textContent = s.schoolName || DEFAULTS.schoolName;
      document.getElementById("schoolMotto").textContent = s.motto || DEFAULTS.motto;

      // Welcome
      document.getElementById("welcomeTitle").textContent =
        `Selamat Datang ke Portal Rasmi PPKI ${s.schoolName || DEFAULTS.schoolName}`;

      // Footer
      document.getElementById("footerText").innerText = s.footer || DEFAULTS.footer;

      // Logo
      const logoBox = document.getElementById("logoBox");
      logoBox.innerHTML = "";
      if (s.logoUrl && s.logoUrl.trim()){
        const img = document.createElement("img");
        img.src = s.logoUrl.trim();
        img.alt = "Logo Sekolah";
        img.onerror = () => {
          logoBox.innerHTML = "<span style='font-weight:1000;'>ğŸ«</span>";
        };
        logoBox.appendChild(img);
      } else {
        logoBox.innerHTML = "<span style='font-weight:1000;'>ğŸ«</span>";
      }

      // Theme label
      document.getElementById("themeLabel").textContent = s.theme === "dark" ? "Dark" : "Light";
      document.getElementById("themeIcon").textContent = s.theme === "dark" ? "â˜€ï¸" : "ğŸŒ™";

      // Admin btn columns visibility
      document.getElementById("btnAdminCols").style.display = state.adminUnlocked ? "inline-block" : "none";
    }

    /***********************
     *  CLOCK
     ***********************/
    function startClock(){
      const el = document.getElementById("clock");
      setInterval(()=>{
        const now = new Date();
        const t = now.toLocaleTimeString("ms-MY", { hour:'2-digit', minute:'2-digit', second:'2-digit' });
        const d = now.toLocaleDateString("ms-MY", { weekday:'short', year:'numeric', month:'short', day:'2-digit' });
        el.textContent = `${d} â€¢ ${t}`;
      }, 1000);
    }
    startClock();

    /***********************
     *  NAVIGATION
     ***********************/
    function setActivePage(page){
      state.page = page;
      const titles = {
        home:"Laman Utama",
        kehadiran:"Kehadiran",
        pengumuman:"Pengumuman",
        takwim:"Takwim",
        ibubapa:"Ibu Bapa"
      };
      document.getElementById("pageTitle").textContent = titles[page] || "Portal";

      // show/hide sections
      ["home","kehadiran","pengumuman","takwim","ibubapa"].forEach(p=>{
        document.getElementById("page-"+p).style.display = (p===page) ? "" : "none";
      });

      // nav active
      document.querySelectorAll(".navBtn").forEach(btn=>{
        btn.classList.toggle("active", btn.dataset.page === page);
      });

      // on mobile: close sidebar after click
      if (window.matchMedia("(max-width: 860px)").matches){
        closeMobileSidebar();
      }
    }

    document.getElementById("nav").addEventListener("click", (e)=>{
      const btn = e.target.closest(".navBtn");
      if (!btn) return;
      setActivePage(btn.dataset.page);
    });

    // Cards jump
    document.getElementById("cardToday").onclick = ()=> setActivePage("kehadiran");
    document.getElementById("cardWeek").onclick  = ()=> setActivePage("kehadiran");
    document.getElementById("cardMonth").onclick = ()=> setActivePage("kehadiran");
    document.getElementById("cardPct").onclick   = ()=> setActivePage("kehadiran");
    document.getElementById("cardToday2").onclick = ()=>{};
    document.getElementById("cardWeek2").onclick  = ()=>{};
    document.getElementById("cardMonth2").onclick = ()=>{};
    document.getElementById("cardPct2").onclick   = ()=>{};
    document.getElementById("cardAnn").onclick   = ()=> setActivePage("pengumuman");

    /***********************
     *  SIDEBAR TOGGLE
     ***********************/
    const sidebar = document.getElementById("sidebar");
    const backdrop = document.getElementById("sidebarBackdrop");

    function isMobile(){
      return window.matchMedia("(max-width: 860px)").matches;
    }

    function openMobileSidebar(){
      sidebar.classList.add("open");
      backdrop.classList.add("show");
    }
    function closeMobileSidebar(){
      sidebar.classList.remove("open");
      backdrop.classList.remove("show");
    }

    function toggleSidebar(){
      if (isMobile()){
        if (sidebar.classList.contains("open")) closeMobileSidebar();
        else openMobileSidebar();
      } else {
        sidebar.classList.toggle("collapsed");
      }
    }

    document.getElementById("btnSidebar").onclick = toggleSidebar;
    backdrop.onclick = closeMobileSidebar;

    // Mobile default: sidebar closed
    window.addEventListener("resize", ()=>{
      if (!isMobile()){
        closeMobileSidebar();
      } else {
        // keep default closed
      }
    });

    /***********************
     *  THEME TOGGLE (public)
     ***********************/
    document.getElementById("themeToggle").onclick = ()=>{
      state.settings.theme = (state.settings.theme === "dark") ? "light" : "dark";
      // semua orang boleh toggle; simpan supaya peranti itu ingat
      saveSettings(state.settings);
      applySettingsToUI();
      if (state.chart) state.chart.update();
    };

    /***********************
     *  PIN FLOW + SETTINGS
     *  - Klik gear => keluar PIN modal
     *  - PIN betul => buka settings modal
     ***********************/
    const pinOverlay = document.getElementById("pinOverlay");
    const settingsOverlay = document.getElementById("settingsOverlay");
    const detailOverlay = document.getElementById("detailOverlay");

    function show(el){ el.classList.add("show"); el.setAttribute("aria-hidden","false"); }
    function hide(el){ el.classList.remove("show"); el.setAttribute("aria-hidden","true"); }

    document.getElementById("btnGear").onclick = ()=>{
      // buka PIN modal sahaja
      document.getElementById("pinInput").value = "";
      document.getElementById("pinWarn").style.display = "none";
      show(pinOverlay);
      setTimeout(()=> document.getElementById("pinInput").focus(), 50);
    };
    document.getElementById("pinClose").onclick = ()=> hide(pinOverlay);

    document.getElementById("pinSubmit").onclick = ()=>{
      const val = document.getElementById("pinInput").value.trim();
      if (val !== ADMIN_PIN){
        document.getElementById("pinWarn").style.display = "";
        return;
      }
      // unlock
      state.adminUnlocked = true;
      sessionStorage.setItem(SS_ADMIN, "1");
      document.getElementById("btnAdminCols").style.display = "inline-block";
      hide(pinOverlay);
      openSettingsModal();
    };

    document.getElementById("settingsClose").onclick = ()=> hide(settingsOverlay);

    function openSettingsModal(){
      // fill inputs
      const s = state.settings;
      document.getElementById("setSchoolName").value = s.schoolName || "";
      document.getElementById("setMotto").value = s.motto || "";
      document.getElementById("setLogoUrl").value = s.logoUrl || "";
      document.getElementById("setFooter").value = s.footer || "";
      document.getElementById("setPreset").value = s.preset || "forest";
      document.getElementById("setDefaultTheme").value = s.theme || "light";
      document.getElementById("setUrlKehadiran").value = s.urlKehadiran || "";
      document.getElementById("setUrlAnn").value = s.urlAnn || "";
      document.getElementById("setUrlParents").value = s.urlParents || "";
      document.getElementById("setUrlTakwim").value = s.urlTakwim || "";
      document.getElementById("setHideCols").value = s.hideColsNonAdmin || "";
      show(settingsOverlay);
    }

    document.getElementById("btnSave").onclick = async ()=>{
      state.settings.schoolName = document.getElementById("setSchoolName").value.trim() || DEFAULTS.schoolName;
      state.settings.motto = document.getElementById("setMotto").value.trim() || DEFAULTS.motto;
      state.settings.logoUrl = document.getElementById("setLogoUrl").value.trim();
      state.settings.footer = document.getElementById("setFooter").value.trim() || DEFAULTS.footer;
      state.settings.preset = document.getElementById("setPreset").value;
      state.settings.theme = document.getElementById("setDefaultTheme").value;

      state.settings.urlKehadiran = document.getElementById("setUrlKehadiran").value.trim();
      state.settings.urlAnn = document.getElementById("setUrlAnn").value.trim();
      state.settings.urlParents = document.getElementById("setUrlParents").value.trim();
      state.settings.urlTakwim = document.getElementById("setUrlTakwim").value.trim();

      state.settings.hideColsNonAdmin = document.getElementById("setHideCols").value.trim();

      saveSettings(state.settings);
      applySettingsToUI();
      hide(settingsOverlay);

      // refresh data
      await loadAllData();
    };

    document.getElementById("btnReset").onclick = async ()=>{
      state.settings = {...DEFAULTS};
      saveSettings(state.settings);
      applySettingsToUI();
      hide(settingsOverlay);
      await loadAllData();
    };

    /***********************
     *  DETAIL MODAL
     ***********************/
    document.getElementById("detailClose").onclick = ()=> hide(detailOverlay);

    function openDetail({title, meta, body, url}){
      document.getElementById("detailTitle").textContent = title || "Detail";
      document.getElementById("detailMeta").textContent = meta || "";
      document.getElementById("detailBody").textContent = body || "";
      const wrap = document.getElementById("detailLinkWrap");
      const a = document.getElementById("detailLink");
      if (url && url.trim()){
        a.href = url.trim();
        wrap.style.display = "";
      } else {
        wrap.style.display = "none";
      }
      show(detailOverlay);
    }

    /***********************
     *  FETCH CSV
     ***********************/
    async function fetchCSV(url){
      if (!url) return { headers: [], rows: [] };
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("Gagal fetch CSV: " + res.status);
      const text = await res.text();
      const matrix = parseCSV(text);
      if (!matrix.length) return { headers: [], rows: [] };
      const headers = matrix[0].map(normalizeHeader);
      const rows = matrix.slice(1);
      return { headers, rows: rowsToObjects(headers, rows) };
    }

    /***********************
     *  KEHADIRAN: stats + table + chart
     ***********************/
    function calcAttendanceStats(rows, cols){
      const now = new Date();
      now.setHours(0,0,0,0);
      const weekStart = startOfWeek(now);
      const weekEnd = endOfWeek(now);

      const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
      const monthEnd = new Date(now.getFullYear(), now.getMonth()+1, 0);
      monthEnd.setHours(23,59,59,999);

      // normalization for "Hadir"
      const isHadir = (v)=> (v || "").toLowerCase().includes("hadir") && !(v || "").toLowerCase().includes("tidak");

      let todayH=0, todayT=0, weekH=0, weekT=0, monthH=0, monthT=0;

      const monthlyHadir = new Map(); // key YYYY-MM => count hadir

      for (const r of rows){
        const d = parseDateSmart(r[cols.tarikh]);
        if (!d) continue;
        d.setHours(0,0,0,0);

        const status = r[cols.status] || "";
        const hadir = isHadir(status);

        // month grouping (hadir only)
        const mk = monthKey(d);
        if (hadir) monthlyHadir.set(mk, (monthlyHadir.get(mk)||0)+1);

        // today
        if (isSameDay(d, now)){
          if (hadir) todayH++; else todayT++;
        }

        // week
        if (d >= weekStart && d <= weekEnd){
          if (hadir) weekH++; else weekT++;
        }

        // month
        if (d >= monthStart && d <= monthEnd){
          if (hadir) monthH++; else monthT++;
        }
      }

      const monthTotal = monthH + monthT;
      const pct = monthTotal ? Math.round((monthH / monthTotal) * 1000) / 10 : 0; // 1 decimal

      return {
        today: { hadir: todayH, total: todayH+todayT },
        week:  { hadir: weekH, total: weekH+weekT },
        month: { hadir: monthH, total: monthH+monthT },
        pct,
        monthlyHadir
      };
    }

    function setStatUI(prefix, label, stat){
      const vEl = document.getElementById(prefix);
      const sEl = document.getElementById(label);
      if (!vEl || !sEl) return;
      vEl.textContent = stat.hadir ?? "-";
      sEl.textContent = `Jumlah rekod: ${stat.total ?? 0}`;
    }

    function setPctUI(prefix, label, pct){
      const vEl = document.getElementById(prefix);
      const sEl = document.getElementById(label);
      if (!vEl || !sEl) return;
      vEl.textContent = (pct ?? 0) + "%";
      sEl.textContent = "Berdasarkan rekod bulan semasa";
    }

    function buildAttendanceChart(monthlyHadir){
      // sort keys
      const keys = Array.from(monthlyHadir.keys()).sort();
      const labels = keys.map(k=>{
        const [y,m] = k.split("-");
        const d = new Date(Number(y), Number(m)-1, 1);
        return d.toLocaleDateString("ms-MY", { month:"short", year:"numeric" });
      });
      const data = keys.map(k=> monthlyHadir.get(k) || 0);

      const ctx = document.getElementById("attChart");
      if (!ctx) return;

      if (state.chart){
        state.chart.data.labels = labels;
        state.chart.data.datasets[0].data = data;
        state.chart.update();
        return;
      }

      state.chart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "Bilangan Hadir",
            data,
            tension: 0.25,
            pointRadius: 3,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true }
          },
          scales: {
            x: {
              title: { display: true, text: "Bulan" }
            },
            y: {
              beginAtZero: true,
              title: { display: true, text: "Bilangan (Hadir)" },
              ticks: { precision: 0 }
            }
          }
        }
      });
    }

    function getHiddenColsNonAdmin(){
      const s = state.settings.hideColsNonAdmin || "";
      return s.split(",").map(x=>x.trim()).filter(Boolean);
    }

    function renderKehadiranTable(){
      const { headers, rows } = state.kehadiran;
      const thead = document.getElementById("kehadiranThead");
      const tbody = document.getElementById("kehadiranTbody");
      thead.innerHTML = "";
      tbody.innerHTML = "";

      if (!headers.length){
        thead.innerHTML = "<tr><th>Tiada data</th></tr>";
        return;
      }

      const cols = getKehadiranColumns(headers);

      // filters
      const search = document.getElementById("fSearch").value.trim().toLowerCase();
      const dateFrom = document.getElementById("fDateFrom").value ? new Date(document.getElementById("fDateFrom").value + "T00:00:00") : null;
      const dateTo = document.getElementById("fDateTo").value ? new Date(document.getElementById("fDateTo").value + "T23:59:59") : null;
      const fKelas = document.getElementById("fKelas").value.trim().toLowerCase();
      const fNama  = document.getElementById("fNama").value.trim().toLowerCase();
      const fStatus= document.getElementById("fStatus").value.trim().toLowerCase();

      const hidden = (!state.adminUnlocked && !state.showAdminCols) ? getHiddenColsNonAdmin() : [];
      const showHeaders = headers.filter(h => !hidden.includes(h));

      // header row
      const trh = document.createElement("tr");
      showHeaders.forEach(h=>{
        const th = document.createElement("th");
        th.textContent = h;
        trh.appendChild(th);
      });
      thead.appendChild(trh);

      // body rows (filtered)
      const filtered = rows.filter(r=>{
        // date range filter
        const d = parseDateSmart(r[cols.tarikh]);
        if (dateFrom || dateTo){
          if (!d) return false;
          const t = d.getTime();
          if (dateFrom && t < dateFrom.getTime()) return false;
          if (dateTo && t > dateTo.getTime()) return false;
        }

        // column filters
        if (fKelas && !(r[cols.kelas]||"").toLowerCase().includes(fKelas)) return false;
        if (fNama  && !(r[cols.nama]||"").toLowerCase().includes(fNama)) return false;
        if (fStatus&& !(r[cols.status]||"").toLowerCase().includes(fStatus)) return false;

        // global search
        if (search){
          const s = showHeaders.map(h=> (r[h]||"")).join(" ").toLowerCase();
          if (!s.includes(search)) return false;
        }
        return true;
      });

      if (!filtered.length){
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = showHeaders.length;
        td.textContent = "Tiada rekod sepadan dengan filter.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      filtered.forEach(r=>{
        const tr = document.createElement("tr");
        showHeaders.forEach(h=>{
          const td = document.createElement("td");
          td.textContent = r[h] ?? "";
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    function wireKehadiranFilters(){
      ["fSearch","fDateFrom","fDateTo","fKelas","fNama","fStatus"].forEach(id=>{
        document.getElementById(id).addEventListener("input", renderKehadiranTable);
        document.getElementById(id).addEventListener("change", renderKehadiranTable);
      });
    }
    wireKehadiranFilters();

    /***********************
     *  PENGUMUMAN
     *  Columns: TARIKH MULA, TARIKH TAMAT, TAJUK, ISI KANDUNGAN, URL, KEUTAMAAN, AKTIF
     ***********************/
    function getAnnCols(headers){
      const map = {
        mula: findAny(headers, ["TARIKH MULA","Tarikh Mula","Tarikh_Mula"]),
        tamat: findAny(headers, ["TARIKH TAMAT","Tarikh Tamat","Tarikh_Tamat"]),
        tajuk: findAny(headers, ["TAJUK","Tajuk"]),
        isi:   findAny(headers, ["ISI KANDUNGAN","Isi Kandungan","Isi_Kandungan","Isi"]),
        url:   findAny(headers, ["URL","Pautan","Link"]),
        prio:  findAny(headers, ["KEUTAMAAN","Keutamaan","Priority"]),
        aktif: findAny(headers, ["AKTIF","Aktif"])
      };
      return map;
    }
    function findAny(headers, candidates){
      for (const c of candidates){
        if (headers.includes(c)) return c;
      }
      return "";
    }
    function isYA(v){
      const t = (v||"").trim().toLowerCase();
      return t === "ya" || t === "yes" || t === "y" || t === "true" || t === "1";
    }

    function getActiveAnnouncements(){
      const { headers, rows } = state.pengumuman;
      const c = getAnnCols(headers);
      const now = new Date();
      now.setHours(0,0,0,0);

      let list = rows.map(r=>{
        const dm = parseDateSmart(r[c.mula]);
        const dt = parseDateSmart(r[c.tamat]);
        const pr = Number((r[c.prio]||"").trim()) || 0;

        const okDate =
          (!dm || dm <= now) &&
          (!dt || dt >= now);

        const okAktif = c.aktif ? isYA(r[c.aktif]) : okDate; // fallback jika tiada kolum aktif

        return {
          mula: dm,
          tamat: dt,
          tajuk: r[c.tajuk] || "(Tanpa Tajuk)",
          isi: r[c.isi] || "",
          url: r[c.url] || "",
          prio: pr,
          ok: okDate && okAktif
        };
      }).filter(x=>x.ok);

      // sort: keutamaan desc, mula desc
      list.sort((a,b)=>{
        if (b.prio !== a.prio) return b.prio - a.prio;
        return (b.mula?.getTime()||0) - (a.mula?.getTime()||0);
      });

      return list;
    }

    function renderAnnouncements(){
      const box = document.getElementById("annContainer");
      box.innerHTML = "";

      const list = getActiveAnnouncements();

      // badges
      document.getElementById("annBadgeTop").textContent = String(list.length);
      const side = document.getElementById("annBadgeSide");
      side.textContent = String(list.length);
      side.style.display = list.length ? "" : "none";

      document.getElementById("vAnnCount").textContent = String(list.length);

      if (!list.length){
        document.getElementById("annListShort").textContent = "Tiada pengumuman aktif.";
        box.innerHTML = `<div class="card"><div class="muted">Tiada pengumuman aktif buat masa ini.</div></div>`;
        return;
      }

      // short list on home
      const topTitles = list.slice(0,5).map((x,idx)=> `${idx+1}. ${x.tajuk}`).join(" â€¢ ");
      document.getElementById("annListShort").textContent = topTitles;

      // cards
      list.forEach((x, idx)=>{
        const card = document.createElement("div");
        card.className = "card statCard";
        card.innerHTML = `
          <div class="statTop">
            <div class="k">#${idx+1} â€¢ Keutamaan: ${x.prio}</div>
            <div class="i">ğŸ“¢</div>
          </div>
          <div style="margin-top:8px; font-weight:1100; font-size:15px;">${escapeHTML(x.tajuk)}</div>
          <div class="muted" style="margin-top:6px; font-size:12px;">
            ${x.mula ? "Mula: " + fmtDateMY(x.mula) : ""} ${x.tamat ? " â€¢ Tamat: " + fmtDateMY(x.tamat) : ""}
          </div>
          <div class="muted" style="margin-top:10px; font-size:12px; line-height:1.4;">
            ${escapeHTML((x.isi||"").slice(0,140))}${(x.isi||"").length>140 ? "..." : ""}
          </div>
        `;
        card.onclick = ()=>{
          openDetail({
            title: x.tajuk,
            meta: `${x.mula ? "Mula: "+fmtDateMY(x.mula) : ""}${x.tamat ? " â€¢ Tamat: "+fmtDateMY(x.tamat) : ""} â€¢ Keutamaan: ${x.prio}`,
            body: x.isi,
            url: x.url
          });
        };
        box.appendChild(card);
      });
    }

    function escapeHTML(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /***********************
     *  IBU BAPA
     ***********************/
    function renderParents(){
      const box = document.getElementById("parentsContainer");
      box.innerHTML = "";

      const { headers, rows } = state.parents;
      if (!headers.length){
        box.innerHTML = `<div class="card"><div class="muted">Tiada data ibu bapa.</div></div>`;
        return;
      }

      const cTajuk = findAny(headers, ["TAJUK","Tajuk","Title"]);
      const cIsi   = findAny(headers, ["ISI KANDUNGAN","Isi Kandungan","Isi_Kandungan","Isi","Kandungan","Catatan"]);
      const cUrl   = findAny(headers, ["URL","Pautan","Link"]);
      const cMod   = findAny(headers, ["MOD","Mod","Mode","TINDAKAN","Tindakan","Action"]);

      rows.forEach((r)=>{
        const tajuk = r[cTajuk] || "Makluman";
        const isi = r[cIsi] || "";
        const url = r[cUrl] || "";
        const mod = (r[cMod] || "").trim().toUpperCase(); // POPUP / TAB

        const card = document.createElement("div");
        card.className = "card statCard";
        card.innerHTML = `
          <div class="statTop">
            <div class="k">Ibu Bapa</div>
            <div class="i">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
          </div>
          <div style="margin-top:8px; font-weight:1100; font-size:15px;">${escapeHTML(tajuk)}</div>
          <div class="muted" style="margin-top:10px; font-size:12px; line-height:1.4;">
            ${escapeHTML(isi.slice(0,160))}${isi.length>160 ? "..." : ""}
          </div>
          ${url ? `<div class="muted" style="margin-top:10px; font-size:12px;">Pautan tersedia</div>` : ""}
        `;

        card.onclick = ()=>{
          if (url && mod === "TAB"){
            window.open(url, "_blank", "noopener");
            return;
          }
          openDetail({
            title: tajuk,
            meta: url ? "Ada pautan (klik butang di bawah jika perlu)" : "",
            body: isi,
            url
          });
        };

        box.appendChild(card);
      });
    }

    /***********************
     *  TAKWIM
     ***********************/
    function renderTakwim(){
      const { headers, rows } = state.takwim;
      const thead = document.getElementById("takwimThead");
      const tbody = document.getElementById("takwimTbody");
      thead.innerHTML = "";
      tbody.innerHTML = "";

      if (!headers.length){
        thead.innerHTML = "<tr><th>Tiada data</th></tr>";
        return;
      }
      const trh = document.createElement("tr");
      headers.forEach(h=>{
        const th = document.createElement("th");
        th.textContent = h;
        trh.appendChild(th);
      });
      thead.appendChild(trh);

      if (!rows.length){
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = headers.length;
        td.textContent = "Tiada rekod.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      rows.forEach(r=>{
        const tr = document.createElement("tr");
        headers.forEach(h=>{
          const td = document.createElement("td");
          td.textContent = r[h] ?? "";
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    /***********************
     *  LOAD ALL DATA
     ***********************/
    async function loadAllData(){
      // Kehadiran
      try{
        state.kehadiran = await fetchCSV(state.settings.urlKehadiran);
      }catch(err){
        console.warn(err);
        state.kehadiran = { headers: [], rows: [] };
      }

      // Pengumuman
      try{
        state.pengumuman = await fetchCSV(state.settings.urlAnn);
      }catch(err){
        console.warn(err);
        state.pengumuman = { headers: [], rows: [] };
      }

      // Parents
      try{
        state.parents = await fetchCSV(state.settings.urlParents);
      }catch(err){
        console.warn(err);
        state.parents = { headers: [], rows: [] };
      }

      // Takwim
      if (state.settings.urlTakwim){
        try{
          state.takwim = await fetchCSV(state.settings.urlTakwim);
        }catch(err){
          console.warn(err);
          state.takwim = { headers: [], rows: [] };
        }
      } else {
        state.takwim = { headers: [], rows: [] };
      }

      // Render everything
      renderEverything();
    }

    function renderEverything(){
      // stats kehadiran
      if (state.kehadiran.headers.length){
        const cols = getKehadiranColumns(state.kehadiran.headers);
        const st = calcAttendanceStats(state.kehadiran.rows, cols);

        // Home
        setStatUI("vToday","sToday", st.today);
        setStatUI("vWeek","sWeek", st.week);
        setStatUI("vMonth","sMonth", st.month);
        setPctUI("vPct","sPct", st.pct);

        // Kehadiran page
        setStatUI("vToday2","sToday2", st.today);
        setStatUI("vWeek2","sWeek2", st.week);
        setStatUI("vMonth2","sMonth2", st.month);
        setPctUI("vPct2","sPct2", st.pct);

        // chart
        buildAttendanceChart(st.monthlyHadir);
      } else {
        document.getElementById("sToday").textContent = "Gagal memuat data.";
        document.getElementById("sWeek").textContent = "Gagal memuat data.";
        document.getElementById("sMonth").textContent = "Gagal memuat data.";
        document.getElementById("sPct").textContent = "Gagal memuat data.";
      }

      // Table kehadiran
      renderKehadiranTable();

      // Ann
      renderAnnouncements();

      // Parents
      renderParents();

      // Takwim
      renderTakwim();
    }

    // Buttons reload
    document.getElementById("btnReloadKehadiran").onclick = loadAllData;
    document.getElementById("btnReloadAnn").onclick = loadAllData;
    document.getElementById("btnReloadParents").onclick = loadAllData;
    document.getElementById("btnReloadTakwim").onclick = loadAllData;

    // Admin columns toggle
    document.getElementById("btnAdminCols").onclick = ()=>{
      state.showAdminCols = !state.showAdminCols;
      document.getElementById("btnAdminCols").textContent = state.showAdminCols ? "ğŸ™ˆ Sembunyi Kolum Admin" : "ğŸ‘ï¸ Kolum Admin";
      renderKehadiranTable();
    };

    // First load
    loadAllData();

    // Default page
    setActivePage("home");
  </script>
</body>
</html>
