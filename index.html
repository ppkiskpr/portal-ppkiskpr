<!doctype html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Portal PPKI SK Paya Resak</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: Poppins, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .sidebar-transition { transition: all .25s ease-in-out; }
    .card-hover { transition: transform .2s ease, box-shadow .2s ease; cursor: pointer; }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 12px 24px rgba(0,0,0,.10); }
    .modal-backdrop { background: rgba(0,0,0,.65); backdrop-filter: blur(8px); }
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>

<body class="h-screen overflow-hidden bg-slate-100">
  <div id="app" class="h-full w-full"></div>

  <script>
    /***********************
     * 1) CONFIG
     ***********************/
    const CONFIG = {
      schoolName: "SK Paya Resak",
      schoolMotto: "Moving Forward",
      copyrightTop: "¬© 2025 NK.",
      copyrightBottom: "Hak Cipta Terpelihara.",
      headerColor: "#2563eb",     // blue-600
      sidebarColor: "#111827",    // gray-900
      bgColor: "#f1f5f9",         // slate-100
      cardColor: "#ffffff",
      textColor: "#0f172a",
      accentColor: "#10b981"      // emerald-500
    };

    // ‚úÖ Your Pengumuman CSV URL (embedded)
    const PENGUMUMAN_CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vQvKlO-LRGh8kj_-Be6NxZRR3Z38rjbC33jyvfhQvnR9L4LF7_dZRVXYGK3XO7bAoJwC9bJJmABjV6Z/pub?gid=946270411&single=true&output=csv";

    // (Optional) You can later add Takwim CSV URL here
    const TAKWIM_CSV_URL = ""; // letak nanti

    /***********************
     * 2) STATE
     ***********************/
    const state = {
      currentPage: "home",
      sidebarCollapsed: false,
      nowText: "",
      announcements: [],
      announcementsLoading: false,
      announcementsError: "",
      viewingAnnouncement: null,
      // placeholders for attendance stats (you can wire later)
      attendanceStats: {
        today: 0,
        week: 0,
        month: 0,
        monthPercent: 0
      }
    };

    const MENU_ITEMS = [
      { id: "home", label: "Laman Utama", icon: "üè†" },
      { id: "kehadiran", label: "Kehadiran", icon: "üìä" },
      { id: "pengumuman", label: "Pengumuman", icon: "üì¢" },
      { id: "takwim", label: "Takwim", icon: "üóìÔ∏è" },
      { id: "ibubapa", label: "Ibu Bapa", icon: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶" }
    ];

    /***********************
     * 3) UTIL
     ***********************/
    const DAYS_MS = ["Ahad","Isnin","Selasa","Rabu","Khamis","Jumaat","Sabtu"];
    const MONTHS_MS = ["Januari","Februari","Mac","April","Mei","Jun","Julai","Ogos","September","Oktober","November","Disember"];

    function formatNow() {
      const now = new Date();
      const day = DAYS_MS[now.getDay()];
      const date = now.getDate();
      const month = MONTHS_MS[now.getMonth()];
      const year = now.getFullYear();
      const hh = String(now.getHours()).padStart(2, "0");
      const mm = String(now.getMinutes()).padStart(2, "0");
      const ss = String(now.getSeconds()).padStart(2, "0");
      return `${day}, ${date} ${month} ${year} ‚Ä¢ ${hh}:${mm}:${ss}`;
    }

    function safeText(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;");
    }

    // Robust-ish CSV parser (handles commas + quotes)
    function parseCSV(csvText) {
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for (let i = 0; i < csvText.length; i++) {
        const ch = csvText[i];
        const next = csvText[i + 1];

        if (ch === '"' && inQuotes && next === '"') {
          cur += '"';
          i++;
          continue;
        }

        if (ch === '"') {
          inQuotes = !inQuotes;
          continue;
        }

        if (ch === "," && !inQuotes) {
          row.push(cur);
          cur = "";
          continue;
        }

        if ((ch === "\n" || ch === "\r") && !inQuotes) {
          if (ch === "\r" && next === "\n") i++;
          row.push(cur);
          cur = "";
          // only push non-empty (or if has any column)
          if (row.some(v => String(v).trim() !== "")) rows.push(row);
          row = [];
          continue;
        }

        cur += ch;
      }

      // last cell
      if (cur.length || row.length) {
        row.push(cur);
        if (row.some(v => String(v).trim() !== "")) rows.push(row);
      }

      return rows.map(r => r.map(c => String(c ?? "").trim()));
    }

    function normalizePriority(p) {
      const x = String(p || "").toUpperCase().trim();
      if (x === "TINGGI") return 0;
      if (x === "SEDERHANA") return 1;
      if (x === "RENDAH") return 2;
      return 3;
    }

    function parseDate(d) {
      // expects Google Sheet date in yyyy-mm-dd or dd/mm/yyyy (best effort)
      if (!d) return null;
      const s = String(d).trim();
      if (!s) return null;

      // yyyy-mm-dd
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
        const dt = new Date(s + "T00:00:00");
        return isNaN(dt.getTime()) ? null : dt;
      }

      // dd/mm/yyyy
      const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (m) {
        const dd = Number(m[1]);
        const mm = Number(m[2]) - 1;
        const yy = Number(m[3]);
        const dt = new Date(yy, mm, dd);
        return isNaN(dt.getTime()) ? null : dt;
      }

      const dt = new Date(s);
      return isNaN(dt.getTime()) ? null : dt;
    }

    function formatDateShort(d) {
      const dt = parseDate(d);
      if (!dt) return "";
      const day = dt.getDate();
      const month = MONTHS_MS[dt.getMonth()];
      const year = dt.getFullYear();
      return `${day} ${month} ${year}`;
    }

    /***********************
     * 4) DATA: Fetch Pengumuman CSV
     * Columns expected:
     * A: ID
     * B: TARIKH MULA
     * C: TARIKH TAMAT
     * D: TAJUK
     * E: ISI KANDUNGAN
     * F: URL
     * G: KEUTAMAAN
     * H: AKTIF
     ***********************/
    async function loadAnnouncements() {
      if (!PENGUMUMAN_CSV_URL) return;

      state.announcementsLoading = true;
      state.announcementsError = "";
      renderApp();

      try {
        const res = await fetch(PENGUMUMAN_CSV_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("Gagal fetch CSV: " + res.status);
        const text = await res.text();

        const rows = parseCSV(text);
        if (rows.length < 2) {
          state.announcements = [];
          state.announcementsLoading = false;
          renderApp();
          return;
        }

        const header = rows[0].map(h => h.toUpperCase());
        const idx = (name) => header.indexOf(name);

        const iID = idx("ID");
        const iMula = idx("TARIKH MULA");
        const iTamat = idx("TARIKH TAMAT");
        const iTajuk = idx("TAJUK");
        const iIsi = idx("ISI KANDUNGAN");
        const iUrl = idx("URL");
        const iKeut = idx("KEUTAMAAN");
        const iAktif = idx("AKTIF");

        const data = rows.slice(1).map((r) => {
          const obj = {
            id: r[iID] ?? "",
            tarikhMula: r[iMula] ?? "",
            tarikhTamat: r[iTamat] ?? "",
            tajuk: r[iTajuk] ?? "",
            isi: r[iIsi] ?? "",
            url: r[iUrl] ?? "",
            keutamaan: r[iKeut] ?? "",
            aktif: r[iAktif] ?? ""
          };
          return obj;
        })
        .filter(a => (a.tajuk || a.isi).trim() !== "")
        .filter(a => String(a.aktif).toUpperCase().trim() === "YA")
        .sort((a, b) => {
          const pa = normalizePriority(a.keutamaan);
          const pb = normalizePriority(b.keutamaan);
          if (pa !== pb) return pa - pb;
          // latest start date first
          const da = parseDate(a.tarikhMula)?.getTime() ?? 0;
          const db = parseDate(b.tarikhMula)?.getTime() ?? 0;
          return db - da;
        });

        state.announcements = data;
      } catch (err) {
        state.announcementsError = (err && err.message) ? err.message : "Ralat memuat pengumuman";
        state.announcements = [];
      } finally {
        state.announcementsLoading = false;
        renderApp();
      }
    }

    /***********************
     * 5) NAV / UI ACTIONS
     ***********************/
    function navigateTo(pageId) {
      state.currentPage = pageId;
      // auto close sidebar on mobile after click
      if (window.matchMedia("(max-width: 768px)").matches) {
        state.sidebarCollapsed = true;
      }
      renderApp();
    }

    function toggleSidebar() {
      state.sidebarCollapsed = !state.sidebarCollapsed;
      renderApp();
    }

    function openAnnouncementModal(item) {
      state.viewingAnnouncement = item;
      renderApp();
    }

    function closeAnnouncementModal() {
      state.viewingAnnouncement = null;
      renderApp();
    }

    /***********************
     * 6) RENDERERS
     ***********************/
    function renderHeaderTitle() {
      const m = MENU_ITEMS.find(x => x.id === state.currentPage);
      if (state.currentPage === "kehadiran") return "Dashboard Kehadiran";
      return m ? m.label : "Portal";
    }

    function renderSidebar() {
      return `
        <aside class="sidebar-transition flex-shrink-0 h-full"
          style="width: 280px; background-color: ${CONFIG.sidebarColor};">
          <div class="flex flex-col h-full">
            <div class="p-6 border-b border-white/10">
              <div class="flex items-center justify-center mb-4">
                <div class="w-20 h-20 rounded-full bg-white flex items-center justify-center text-4xl overflow-hidden">
                  üè´
                </div>
              </div>
              <h2 class="text-white text-center font-bold text-xl mb-1">${safeText(CONFIG.schoolName)}</h2>
              <p class="text-white/60 text-center text-sm">${safeText(CONFIG.schoolMotto)}</p>
            </div>

            <nav class="flex-1 overflow-y-auto py-4">
              ${MENU_ITEMS.map(item => `
                <div
                  onclick="navigateTo('${item.id}')"
                  class="flex items-center px-6 py-3 text-white cursor-pointer hover:bg-white/10 ${state.currentPage===item.id ? 'bg-white/10' : ''}">
                  <span class="text-2xl">${item.icon}</span>
                  <span class="ml-4 font-medium">${safeText(item.label)}</span>
                </div>
              `).join("")}
            </nav>

            <div class="p-4 border-t border-white/10">
              <p class="text-white/60 text-xs text-center">${safeText(CONFIG.copyrightTop)}</p>
              <p class="text-white/60 text-xs text-center">${safeText(CONFIG.copyrightBottom)}</p>
            </div>
          </div>
        </aside>
      `;
    }

    function renderHome() {
      const a = state.attendanceStats;
      const activeCount = state.announcements.length;

      return `
        <div class="p-6 md:p-8 overflow-auto h-full">
          <div class="max-w-7xl mx-auto">

            <!-- Banner -->
            <div class="rounded-2xl shadow-lg p-6 md:p-8 mb-8"
              style="background: linear-gradient(135deg, ${CONFIG.headerColor}, ${CONFIG.accentColor});">
              <div class="bg-white/90 rounded-2xl p-6 md:p-8">
                <h1 class="text-2xl md:text-3xl font-bold mb-3" style="color:${CONFIG.textColor}">
                  Selamat Datang ke Portal Rasmi PPKI SK Paya Resak
                </h1>
                <div class="mt-4 rounded-xl px-4 py-4 text-center text-white font-semibold"
                  style="background: rgba(15,23,42,.92);">
                  <div id="live-clock" class="text-lg md:text-2xl">${safeText(state.nowText)}</div>
                </div>
              </div>
            </div>

            <!-- Statistik Kehadiran -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
              ${renderStatCard("Kehadiran Hari Ini", a.today, "üìÖ", "kehadiran")}
              ${renderStatCard("Kehadiran Minggu Ini", a.week, "üóìÔ∏è", "kehadiran")}
              ${renderStatCard("Kehadiran Bulan Ini", a.month, "üìä", "kehadiran")}
              ${renderStatCard("Peratus Kehadiran Bulanan", (a.monthPercent || 0) + "%", "‚úÖ", "kehadiran")}
            </div>

            <!-- Kad Pengumuman ringkas -->
            <div class="rounded-2xl shadow-lg p-6"
              style="background-color: ${CONFIG.cardColor};">
              <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl md:text-2xl font-bold" style="color:${CONFIG.textColor}">
                  üì¢ Pengumuman Aktif
                </h2>
                <button onclick="navigateTo('pengumuman')" class="px-4 py-2 rounded-xl text-white font-semibold hover:opacity-90"
                  style="background-color:${CONFIG.headerColor}">
                  Lihat Semua
                </button>
              </div>

              ${state.announcementsLoading ? `
                <div class="py-8 text-center text-slate-500">Memuat pengumuman...</div>
              ` : state.announcementsError ? `
                <div class="py-8 text-center text-red-600">Ralat: ${safeText(state.announcementsError)}</div>
              ` : activeCount === 0 ? `
                <div class="py-8 text-center text-slate-500">Tiada pengumuman aktif buat masa ini.</div>
              ` : `
                <div class="text-sm text-slate-600 mb-3">
                  Jumlah pengumuman aktif: <b>${activeCount}</b>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  ${state.announcements.slice(0, 6).map((x, idx) => `
                    <div class="card-hover rounded-2xl p-5 border border-slate-100"
                      onclick="navigateTo('pengumuman')"
                      style="background:${CONFIG.bgColor}">
                      <div class="flex items-center justify-between mb-2">
                        <span class="text-xs font-semibold px-2 py-1 rounded-full text-white"
                          style="background:${badgeColor(x.keutamaan)}">
                          ${safeText((x.keutamaan || "SEDERHANA").toUpperCase())}
                        </span>
                        <span class="text-xs text-slate-500">#${idx+1}</span>
                      </div>
                      <div class="font-bold text-slate-900 line-clamp-2">${safeText(x.tajuk)}</div>
                      <div class="text-sm text-slate-600 mt-2 line-clamp-3">${safeText(x.isi)}</div>
                      <div class="text-xs text-slate-500 mt-3">
                        ${x.tarikhMula ? "Mula: " + safeText(formatDateShort(x.tarikhMula)) : ""}
                      </div>
                    </div>
                  `).join("")}
                </div>
              `}
            </div>

          </div>
        </div>
      `;
    }

    function badgeColor(p) {
      const x = String(p || "").toUpperCase().trim();
      if (x === "TINGGI") return "#ef4444";     // red-500
      if (x === "SEDERHANA") return "#f59e0b";  // amber-500
      if (x === "RENDAH") return "#10b981";     // emerald-500
      return "#3b82f6";                         // blue-500
    }

    function renderStatCard(title, value, icon, pageId) {
      return `
        <div class="card-hover rounded-2xl p-5"
          style="background-color:${CONFIG.cardColor}"
          onclick="navigateTo('${pageId}')">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm text-slate-500 font-medium">${safeText(title)}</div>
              <div class="text-2xl font-bold mt-1" style="color:${CONFIG.textColor}">
                ${safeText(value)}
              </div>
            </div>
            <div class="text-3xl">${icon}</div>
          </div>
        </div>
      `;
    }

    function renderKehadiran() {
      // Placeholder layout: you can later wire CSV attendance & filters
      const a = state.attendanceStats;
      return `
        <div class="p-6 md:p-8 overflow-auto h-full">
          <div class="max-w-7xl mx-auto">
            <h1 class="text-2xl md:text-3xl font-bold mb-6" style="color:${CONFIG.textColor}">
              Dashboard Kehadiran
            </h1>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
              ${renderStatCard("Kehadiran Hari Ini", a.today, "üìÖ", "kehadiran")}
              ${renderStatCard("Kehadiran Minggu Ini", a.week, "üóìÔ∏è", "kehadiran")}
              ${renderStatCard("Kehadiran Bulan Ini", a.month, "üìä", "kehadiran")}
              ${renderStatCard("Peratus Kehadiran Bulanan", (a.monthPercent || 0) + "%", "‚úÖ", "kehadiran")}
            </div>

            <div class="rounded-2xl shadow-lg p-6" style="background-color:${CONFIG.cardColor}">
              <div class="text-slate-700">
                (Sedia untuk sambung data kehadiran CSV + filter kolum + carian + date range.)
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderPengumuman() {
      const list = state.announcements;

      return `
        <div class="p-6 md:p-8 overflow-auto h-full">
          <div class="max-w-7xl mx-auto">
            <div class="flex items-center justify-between mb-6">
              <h1 class="text-2xl md:text-3xl font-bold" style="color:${CONFIG.textColor}">
                üì¢ Pengumuman
              </h1>
              <button onclick="loadAnnouncements()" class="px-4 py-2 rounded-xl text-white font-semibold hover:opacity-90"
                style="background-color:${CONFIG.headerColor}">
                Segarkan
              </button>
            </div>

            ${state.announcementsLoading ? `
              <div class="py-16 text-center text-slate-500">Memuat pengumuman...</div>
            ` : state.announcementsError ? `
              <div class="py-16 text-center text-red-600">Ralat: ${safeText(state.announcementsError)}</div>
            ` : list.length === 0 ? `
              <div class="py-16 text-center text-slate-500">Tiada pengumuman aktif buat masa ini.</div>
            ` : `
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                ${list.map(x => `
                  <div class="card-hover rounded-2xl p-5 border border-slate-100"
                    style="background-color:${CONFIG.cardColor}"
                    onclick='openAnnouncementModal(${JSON.stringify(x).replaceAll("'", "&apos;")})'>
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-xs font-semibold px-2 py-1 rounded-full text-white"
                        style="background:${badgeColor(x.keutamaan)}">
                        ${safeText((x.keutamaan || "SEDERHANA").toUpperCase())}
                      </span>
                      <span class="text-xs text-slate-500">${safeText(formatDateShort(x.tarikhMula))}</span>
                    </div>

                    <div class="text-lg font-bold" style="color:${CONFIG.textColor}">
                      ${safeText(x.tajuk)}
                    </div>
                    <div class="text-sm text-slate-600 mt-2 line-clamp-3">
                      ${safeText(x.isi)}
                    </div>

                    ${x.url ? `
                      <div class="mt-4 text-sm font-semibold" style="color:${CONFIG.headerColor}">
                        üîó Pautan tersedia
                      </div>
                    ` : ""}
                  </div>
                `).join("")}
              </div>
            `}
          </div>
        </div>
      `;
    }

    function renderTakwim() {
      return `
        <div class="p-6 md:p-8 overflow-auto h-full">
          <div class="max-w-7xl mx-auto">
            <h1 class="text-2xl md:text-3xl font-bold mb-6" style="color:${CONFIG.textColor}">
              üóìÔ∏è Takwim
            </h1>
            <div class="rounded-2xl shadow-lg p-6" style="background-color:${CONFIG.cardColor}">
              <div class="text-slate-700">
                (Sedia untuk sambung Google Sheet Takwim. Bila cikgu bagi URL CSV takwim, saya boleh masukkan terus.)
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderIbuBapa() {
      return `
        <div class="p-6 md:p-8 overflow-auto h-full">
          <div class="max-w-7xl mx-auto">
            <h1 class="text-2xl md:text-3xl font-bold mb-6" style="color:${CONFIG.textColor}">
              üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Ibu Bapa
            </h1>
            <div class="rounded-2xl shadow-lg p-6" style="background-color:${CONFIG.cardColor}">
              <div class="text-slate-700">
                (Modul kad: tajuk + isi + URL, pilihan buka popup atau buka tab baru ‚Äî boleh tambah bila cikgu sedia.)
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderPage() {
      if (state.currentPage === "home") return renderHome();
      if (state.currentPage === "kehadiran") return renderKehadiran();
      if (state.currentPage === "pengumuman") return renderPengumuman();
      if (state.currentPage === "takwim") return renderTakwim();
      if (state.currentPage === "ibubapa") return renderIbuBapa();
      return renderHome();
    }

    function renderModal() {
      const x = state.viewingAnnouncement;
      if (!x) return "";

      return `
        <div class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop"
          onclick="if(event.target===this) closeAnnouncementModal()">
          <div class="w-full max-w-3xl rounded-2xl shadow-2xl overflow-hidden"
            style="background:${CONFIG.cardColor}"
            onclick="event.stopPropagation()">

            <div class="p-6 border-b border-slate-100">
              <div class="flex items-start justify-between gap-4">
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-3">
                    <span class="text-xs font-semibold px-2 py-1 rounded-full text-white"
                      style="background:${badgeColor(x.keutamaan)}">
                      ${safeText((x.keutamaan || "SEDERHANA").toUpperCase())}
                    </span>
                    <span class="text-xs text-slate-500">
                      ${safeText(formatDateShort(x.tarikhMula))}
                      ${x.tarikhTamat ? " ‚Ä¢ Tamat: " + safeText(formatDateShort(x.tarikhTamat)) : ""}
                    </span>
                  </div>
                  <div class="text-2xl font-bold" style="color:${CONFIG.textColor}">
                    ${safeText(x.tajuk)}
                  </div>
                </div>

                <button class="text-slate-500 hover:text-slate-900 text-3xl leading-none"
                  onclick="closeAnnouncementModal()">√ó</button>
              </div>
            </div>

            <div class="p-6">
              <div class="text-slate-700 whitespace-pre-wrap leading-relaxed">
                ${safeText(x.isi)}
              </div>

              ${x.url ? `
                <div class="mt-6">
                  <a href="${safeText(x.url)}" target="_blank" rel="noopener"
                    class="inline-flex items-center gap-2 px-5 py-3 rounded-xl text-white font-semibold hover:opacity-90"
                    style="background:${CONFIG.headerColor}">
                    üîó Buka Pautan
                  </a>
                </div>
              ` : ""}

              <div class="mt-6 flex justify-end">
                <button onclick="closeAnnouncementModal()"
                  class="px-5 py-3 rounded-xl font-semibold text-white hover:opacity-90"
                  style="background:${CONFIG.headerColor}">
                  Tutup
                </button>
              </div>
            </div>

          </div>
        </div>
      `;
    }

    function renderApp() {
      const app = document.getElementById("app");
      app.innerHTML = `
        <div class="flex h-full" style="background-color:${CONFIG.bgColor}">
          ${state.sidebarCollapsed ? "" : renderSidebar()}

          <div class="flex-1 flex flex-col h-full overflow-hidden">
            <!-- Header -->
            <header class="flex-shrink-0 shadow-lg" style="background-color:${CONFIG.headerColor}">
              <div class="px-4 md:px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <button onclick="toggleSidebar()"
                    class="text-white p-2 rounded-xl hover:bg-white/10">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                  </button>

                  ${state.sidebarCollapsed ? `
                    <button onclick="navigateTo('home')"
                      class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-2xl hover:scale-105 transition">
                      üè´
                    </button>
                  ` : ""}

                  <div class="text-white font-bold text-lg md:text-xl">
                    ${safeText(renderHeaderTitle())}
                  </div>
                </div>

                <div class="flex items-center gap-2 md:gap-3">
                  <button onclick="navigateTo('pengumuman')"
                    class="text-white px-3 py-2 rounded-xl hover:bg-white/10 flex items-center gap-2">
                    <span class="text-lg">üì¢</span>
                    <span class="hidden md:inline font-semibold">Pengumuman</span>
                    ${state.announcements.length ? `
                      <span class="ml-1 bg-red-500 text-white text-xs rounded-full w-6 h-6 inline-flex items-center justify-center">
                        ${state.announcements.length}
                      </span>
                    ` : ""}
                  </button>
                </div>
              </div>
            </header>

            <!-- Main -->
            <main class="flex-1 overflow-hidden">
              ${renderPage()}
            </main>
          </div>
        </div>

        ${renderModal()}
      `;

      // Update clock live on DOM
      const clk = document.getElementById("live-clock");
      if (clk) clk.textContent = state.nowText;
    }

    /***********************
     * 7) INIT
     ***********************/
    function initMobileSidebarDefault() {
      // ‚úÖ sidebar default closed on mobile
      state.sidebarCollapsed = window.matchMedia("(max-width: 768px)").matches;
    }

    function startClock() {
      state.nowText = formatNow();
      renderApp();
      setInterval(() => {
        state.nowText = formatNow();
        const clk = document.getElementById("live-clock");
        if (clk) clk.textContent = state.nowText;
      }, 1000);
    }

    window.navigateTo = navigateTo;
    window.toggleSidebar = toggleSidebar;
    window.loadAnnouncements = loadAnnouncements;
    window.openAnnouncementModal = openAnnouncementModal;
    window.closeAnnouncementModal = closeAnnouncementModal;

    initMobileSidebarDefault();
    startClock();
    renderApp();
    loadAnnouncements();

    window.addEventListener("resize", () => {
      // keep mobile behavior nice
      if (window.matchMedia("(max-width: 768px)").matches) {
        // do not force close if user opened manually; but safe default:
        // state.sidebarCollapsed = true;
      }
    });
  </script>
</body>
</html>
