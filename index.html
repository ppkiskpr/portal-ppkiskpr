<!doctype html>
<html lang="ms" class="h-full">
<head>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portal Rasmi PPKI SK Paya Resak</title>
  <link rel="icon" type="image/png" href="SKPR 1.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

  <style>
    /* === CSS UTAMA (V27.19 - Fix All Data Loading) === */
    :root { --font-main: 'Poppins', sans-serif; --bg-body: #F2F4F7; --bg-sidebar: #FFFFFF; --bg-card: #FFFFFF; --bg-element: #F9FAFB; --border-color: #EAECF0; --text-main: #101828; --text-muted: #667085; --primary: #1F6F4A; --primary-light: #E8F5E9; --accent: #F79009; --shadow-sm: 0 1px 2px rgba(16, 24, 40, 0.05); --radius-card: 16px; --sidebar-w-full: 260px; --sidebar-w-mini: 74px; }
    html[data-mode="dark"] { --bg-body: #0F1115; --bg-sidebar: #161B22; --bg-card: #1C2128; --bg-element: #252B36; --border-color: #30363D; --text-main: #F0F6FC; --text-muted: #8B949E; --primary: #2EA043; --primary-light: rgba(46, 160, 67, 0.15); }
    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; font-family: var(--font-main); background: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; }
    .app-container { display: flex; height: 100%; width: 100%; }

    /* LOGIN SCREEN */
    #login-screen { position: fixed; inset: 0; z-index: 9999; background: #F2F4F7; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s ease; }
    .login-box { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 90%; }
    .login-btn-google { background: #4285F4; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; cursor: pointer; font-family: 'Poppins', sans-serif; display: flex; align-items: center; gap: 10px; margin: 20px auto 0; }

    /* LOADING SPINNER */
    #loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: none; place-items: center; backdrop-filter: blur(2px); }
    .spinner { width: 40px; height: 40px; border: 4px solid #fff; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* SIDEBAR */
    .sidebar { background: var(--bg-sidebar); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 20px 12px; transition: width 0.3s ease; z-index: 50; flex-shrink: 0; overflow-x: hidden; }
    @media (min-width: 769px) { .sidebar { width: var(--sidebar-w-full); } body.desktop-mini .sidebar { width: var(--sidebar-w-mini); } body.desktop-mini .brand-text, body.desktop-mini .nav-text, body.desktop-mini .sidebar-footer { opacity: 0; pointer-events: none; display: none; } body.desktop-mini .brand { justify-content: center; padding-left: 0; } body.desktop-mini .nav-item { justify-content: center; padding: 12px 0; } body.desktop-mini .nav-icon { margin-right: 0; } }
    @media (max-width: 768px) { .sidebar { position: fixed; left: -100%; top: 0; height: 100%; width: 260px; box-shadow: 5px 0 25px rgba(0,0,0,0.2); } body.mobile-active .sidebar { left: 0; } .backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; display: none; backdrop-filter: blur(2px); } body.mobile-active .backdrop { display: block; } }
    
    .brand { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; min-height: 45px; overflow: hidden; white-space: nowrap; }
    .brand-logo { width: 40px; height: 40px; border-radius: 8px; flex-shrink: 0; }
    .brand-logo img { width: 100%; height: 100%; object-fit: contain; }
    .brand-text h1 { margin: 0; font-size: 15px; font-weight: 700; }
    .brand-text p { margin: 0; font-size: 11px; color: var(--text-muted); }
    
    .nav-menu { flex: 1; display: flex; flex-direction: column; gap: 4px; overflow-y: auto; overflow-x: hidden; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 14px; border-radius: 10px; cursor: pointer; color: var(--text-muted); text-decoration: none; transition: all 0.2s; white-space: nowrap; font-size: 13px; font-weight: 500; }
    .nav-item:hover { background: var(--bg-element); color: var(--text-main); }
    .nav-item.active { background: var(--primary-light); color: var(--primary); font-weight: 600; }
    .nav-icon { font-size: 20px; display: flex; align-items: center; justify-content: center; min-width: 24px; }
    .nav-group-header { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; padding: 15px 14px 5px 14px; margin-top: 5px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .nav-group-header:hover { color: var(--primary); }
    .nav-group-header .toggle-icon { font-size: 16px; transition: transform 0.3s; }
    .nav-group-header.collapsed .toggle-icon { transform: rotate(-90deg); }
    .nav-child-container { overflow: hidden; transition: max-height 0.3s ease; }
    .nav-child-container.collapsed { max-height: 0; }
    
    .sidebar-footer { margin-top: auto; font-size: 11px; text-align: center; color: var(--text-muted); padding: 20px 10px; line-height: 1.4; border-top: 1px solid var(--border-color); }
    #userInfo { margin-bottom: 15px; font-weight: 600; font-size: 12px; white-space: normal; word-wrap: break-word; line-height: 1.4; }

    /* MAIN CONTENT */
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
    .top-bar { height: 64px; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; background: var(--bg-body); flex-shrink: 0; }
    .icon-btn { width: 40px; height: 40px; border-radius: 8px; border: none; background: transparent; color: var(--text-main); display: grid; place-items: center; cursor: pointer; font-size: 24px; }
    .icon-btn:hover { background: var(--bg-element); }
    .content-area { flex: 1; overflow-y: auto; padding: 10px 24px 40px 24px; }

    /* COMPONENTS */
    .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 24px; }
    .card { background: var(--bg-card); padding: 20px; border-radius: var(--radius-card); border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); }
    .stat-label { font-size: 13px; color: var(--text-muted); font-weight: 500; }
    .stat-val { font-size: 28px; font-weight: 700; margin: 5px 0; color: var(--text-main); }
    .stat-sub { font-size: 12px; display: flex; align-items: center; gap: 4px; color: var(--text-muted); }
    .stat-sub.red { color: #D92D20; font-weight: 600; }
    .clickable { cursor: pointer; transition: transform 0.2s, border-color 0.2s; }
    .clickable:hover { transform: translateY(-3px); border-color: var(--primary); }
    
    .page-banner { background: linear-gradient(135deg, var(--primary), #144d33); color: white; padding: 24px; border-radius: 16px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
    .banner-text h2 { margin: 0; font-size: 22px; font-weight: 700; }
    .banner-actions { display: flex; gap: 10px; }
    .btn-action { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 8px; transition: background 0.2s; }
    .btn-action:hover { background: rgba(255,255,255,0.3); }

    .filter-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .form-select, .form-input { background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-main); padding: 10px 12px; border-radius: 8px; font-family: inherit; font-size: 13px; width: 100%; }
    .btn { padding: 10px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 13px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-main); }
    
    .filter-panel { display: none; padding: 20px; background: var(--bg-element); border-radius: 12px; margin-top: 15px; border: 1px solid var(--border-color); }
    .filter-panel.open { display: block; }
    .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px; }
    .filter-label { font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block; color: var(--text-muted); }

    .table-wrap { overflow-x: auto; border-radius: 12px; border: 1px solid var(--border-color); }
    table { width: 100%; border-collapse: collapse; min-width: 800px; font-size: 13px; }
    th { text-align: left; padding: 14px 16px; background: var(--bg-element); color: var(--text-muted); font-weight: 600; text-transform: uppercase; white-space: nowrap; }
    td { padding: 14px 16px; border-top: 1px solid var(--border-color); color: var(--text-main); vertical-align: top; }
    
    .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; display: inline-block; }
    .b-green { background: #ECFDF3; color: #027A48; }
    .b-red { background: #FEF3F2; color: #B42318; }
    .b-blue { background: #EFF8FF; color: #175CD3; }
    .b-gray { background: #F2F4F7; color: #344054; }
    .b-purple { background: #F4F3FF; color: #5925DC; }

    .enrolmen-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-top: 10px; }
    .enrolmen-summary { display:flex; gap:10px; flex-direction:column; justify-content:center; }
    .enrolmen-item { display:flex; justify-content:space-between; align-items:center; padding:10px; background:var(--bg-element); border-radius:8px; border:1px solid var(--border-color); }
    .class-list-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap:10px; }
    .class-badge { background:var(--bg-element); border:1px solid var(--border-color); padding:8px; border-radius:8px; text-align:center; cursor:pointer; transition:all 0.2s; }
    .class-badge:hover { transform:translateY(-2px); border-color:var(--primary); }
    .class-badge.active { background:var(--primary); color:white; border-color:var(--primary); }
    .class-badge.active div { color:white !important; }
    @media (max-width: 768px) { .enrolmen-grid { grid-template-columns: 1fr; } }

    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; display: none; place-items: center; backdrop-filter: blur(2px); }
    .modal-overlay.active { display: grid; }
    .modal-content { width: 90%; max-width: 500px; background: var(--bg-card); border-radius: 16px; padding: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-height: 85vh; overflow-y: auto; }
    .menu-toggle-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 8px; }
    .menu-toggle-item input { width: 18px; height: 18px; accent-color: var(--primary); }

    .id-result-box { display:none; background: var(--bg-element); padding: 15px; border-radius: 10px; margin-top: 15px; border: 1px solid var(--border-color); }
    .id-result-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color); }
    .id-result-item:last-child { border-bottom: none; }
    .id-label { color: var(--text-muted); font-size: 12px; }
    .id-value-group { display: flex; align-items: center; gap: 8px; }
    .id-value { font-weight: 600; font-size: 14px; text-align: right; user-select: text; }
    .copy-btn { background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 4px; border-radius: 4px; transition: 0.2s; display: flex; }
    .copy-btn:hover { background: rgba(0,0,0,0.05); color: var(--primary); }

    @media print {
      @page { size: A4; margin: 1cm; }
      body { background: white; color: black; font-family: serif; }
      .sidebar, .top-bar, .page-banner, .dashboard-grid, .filter-row, .filter-panel, .btn, .icon-btn, .backdrop, .modal-overlay, #attCount, .search-bar-container, #login-screen, #loading-overlay { display: none !important; }
      .app-container, .main-content, .content-area { height: auto; width: 100%; margin: 0; padding: 0; overflow: visible; display: block; }
      .card { border: none; box-shadow: none; padding: 0; margin: 0; background: transparent; }
      .table-wrap { overflow: visible; border: none; }
      table { width: 100%; border: 1px solid black; font-size: 11pt; border-collapse: collapse; }
      th, td { border: 1px solid black; padding: 8px; color: black; font-family: serif; }
      th { background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; font-weight: bold; text-align: center; }
      td { text-align: left; }
      .badge { border: none; padding: 0; font-weight: normal; background: none !important; color: black !important; }
      .print-header { display: block !important; text-align: center; margin-bottom: 20px; }
      .print-header h2 { font-size: 16pt; margin: 0; font-weight: bold; text-transform: uppercase; }
      .print-header p { font-size: 12pt; margin: 5px 0 0; }
    }
    .print-header { display: none; }
    @media (max-width: 1024px) { .dashboard-grid { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 768px) { .dashboard-grid { grid-template-columns: 1fr; } .page-banner { flex-direction: column; align-items: flex-start; } }
  </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <div style="width:60px; height:60px; background:var(--primary); border-radius:12px; margin:0 auto 20px; display:grid; place-items:center;">
             <span class="material-icons-round" style="color:white; font-size:32px;">school</span>
        </div>
        <h2 style="margin:0 0 10px; color:var(--text-main);">Selamat Datang</h2>
        <p style="color:var(--text-muted); font-size:14px; margin:0 0 20px;">Portal Rasmi PPKI SK Paya Resak</p>
        <button id="btnLoginGoogle" class="login-btn-google"><span class="material-icons-round">login</span> Masuk dengan Google</button>
        <p id="loginStatus" style="font-size:12px; margin-top:20px; color:var(--text-muted);"></p>
    </div>
</div>

<div id="loading-overlay"><div class="spinner"></div></div>

<div class="backdrop" onclick="toggleSidebar()"></div>

<div class="app-container" id="appContainer" style="display:none;">
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <div class="brand-logo"><img src="https://i.ibb.co/Y7sp2wZg/SKPR-1.png" alt="Logo"></div>
      <div class="brand-text"><h1>SK Paya Resak</h1><p>Moving Forward</p></div>
    </div>
    <div class="nav-menu" id="sidebarMenu">
      </div>
    <div class="sidebar-footer">
      <div id="userInfo" style="display:none;"></div>
      <button id="authBtn" onclick="handleAuth()" class="btn btn-primary" style="width:100%; font-size:12px; margin-bottom:15px;">Log Masuk</button>
      <div>Â© 2025 NK.</div>
      <div>Hak Cipta Terpelihara.</div>
      <div style="font-size: 10px; color: var(--text-muted); margin-top: 5px;">Ver 27.19</div>
    </div>
  </aside>

  <main class="main-content">
    <header class="top-bar">
      <button class="icon-btn" onclick="toggleSidebar()"><span class="material-icons-round">menu</span></button>
      <div style="display:flex; gap:8px;">
        <button class="icon-btn" onclick="toggleTheme()" title="Tema"><span class="material-icons-round">dark_mode</span></button>
        <button class="icon-btn" id="btnSettings" onclick="openSettings()" title="Tetapan" style="display:none;"><span class="material-icons-round">settings</span></button>
      </div>
    </header>

    <div class="content-area">
      <div id="page-home" class="page-section">
        <div class="page-banner">
          <div class="banner-text"><h2>Dashboard</h2><p>Selamat Datang ke Portal Rasmi PPKI</p></div>
          <div class="banner-actions"><button class="btn-action" onclick="forceReload('all')"><span class="material-icons-round" style="font-size:16px">refresh</span> Reload Semua</button></div>
        </div>
        
        <div class="dashboard-grid">
          <div class="card stat-card att-card"><div class="stat-label">Kehadiran Hari Ini</div><div class="stat-val" id="dToday">-</div><div class="stat-sub red" id="dAbsent">- Tidak Hadir</div></div>
          <div class="card stat-card att-card"><div class="stat-label">Minggu Ini</div><div class="stat-val" id="dWeek">-</div><div class="stat-sub">Rekod Kehadiran</div></div>
          <div class="card stat-card att-card"><div class="stat-label">Hari Ini</div><div class="stat-val" id="dPct">-</div><div class="stat-sub">Peratus Kehadiran</div></div>
          <div class="card stat-card clickable" onclick="navTo('announcements')"><div class="stat-label">Pengumuman</div><div class="stat-val" id="dAnn">-</div><div class="stat-sub">Aktif</div></div>
        </div>

        <div class="card" style="margin-bottom:24px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <div>
                    <h3 style="margin:0; font-size:16px;">ðŸ‘¥ Analisis Enrolmen Murid</h3>
                    <p style="margin:2px 0 0; font-size:11px; color:var(--text-muted);" id="enrolSubTitle">KESELURUHAN SEKOLAH</p>
                </div>
                <span class="badge b-gray" id="totalStudentsBadge">0 Murid</span>
            </div>
            <div class="enrolmen-grid">
                <div class="enrolmen-summary">
                    <div class="enrolmen-item">
                        <span style="font-size:12px; font-weight:600; color:var(--text-muted);">LELAKI</span>
                        <span class="badge b-blue" id="countMale">0</span>
                    </div>
                    <div class="enrolmen-item">
                        <span style="font-size:12px; font-weight:600; color:var(--text-muted);">PEREMPUAN</span>
                        <span class="badge b-red" id="countFemale">0</span>
                    </div>
                </div>
                <div>
                    <div style="font-size:12px; font-weight:600; color:var(--text-muted); margin-bottom:10px;">PECAHAN MENGIKUT KELAS (KLIK UNTUK TAPIS)</div>
                    <div class="class-list-grid" id="classListStats">
                        <div style="color:var(--text-muted); font-size:12px;">Tiada data...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px; margin-bottom:20px;">
            <h3 style="margin:0; font-size:16px;">ðŸ“ˆ Trend Harian</h3>
            <div class="filter-row">
              <select class="form-select" style="width:auto" id="trendType" onchange="renderTrend()"><option value="hadir">Hadir</option><option value="tidak">Tidak Hadir</option><option value="pct">%</option></select>
              <select class="form-select" style="width:auto" id="trendMonth" onchange="renderTrend()"></select>
              <select class="form-select" style="width:auto" id="trendYear" onchange="renderTrend()"></select>
              <select class="form-select" style="width:auto" id="trendClass" onchange="renderTrend()"><option value="">Semua Kelas</option></select>
            </div>
          </div>
          <div id="chartContainer" style="height:280px; width:100%;"></div>
          <div style="text-align:center; margin-top:15px; font-size:10px; color:var(--text-muted);">
              Data dikemaskini pada: <span id="updateTime">-</span>
          </div>
        </div>
      </div>

      <div id="page-emailcheck" class="page-section" style="display:none;">
        <div class="page-banner">
            <div class="banner-text"><h2>Semakan ID Delima</h2><p>Semak Emel & Kata Laluan Murid</p></div>
            <div class="banner-actions"><button class="btn-action" onclick="forceReload('db')"><span class="material-icons-round" style="font-size:16px">refresh</span> Reload</button></div>
        </div>
        <div class="card" style="max-width:600px; margin:0 auto;">
            <div style="text-align:center; margin-bottom:20px;">
                <span class="material-icons-round" style="font-size:48px; color:var(--primary);">fingerprint</span>
                <p style="color:var(--text-muted); font-size:13px; margin-top:5px;">Sila masukkan No. Kad Pengenalan murid untuk semakan.</p>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <input id="inputIC" class="form-input" placeholder="Contoh: 123456789012" style="flex:1; text-align:center; letter-spacing:1px;">
                <button class="btn btn-primary" onclick="checkEmail()">Semak</button>
            </div>

            <div id="idResultContainer" class="id-result-box">
                <div class="id-result-item"><span class="id-label">NAMA MURID</span><span class="id-value" id="resNama">-</span></div>
                <div class="id-result-item"><span class="id-label">EMEL DELIMA</span><div class="id-value-group"><span class="id-value" id="resEmail" style="color:var(--primary);">-</span><button class="copy-btn" onclick="copyText('resEmail')" title="Salin"><span class="material-icons-round" style="font-size:16px;">content_copy</span></button></div></div>
                <div class="id-result-item"><span class="id-label">KATA LALUAN</span><div class="id-value-group"><span class="id-value" id="resPass" style="color:var(--accent);">-</span><button class="copy-btn" onclick="copyText('resPass')" title="Salin"><span class="material-icons-round" style="font-size:16px;">content_copy</span></button></div></div>
            </div>
            <p id="idError" style="text-align:center; color:#B42318; font-size:13px; display:none; margin-top:10px;"></p>
        </div>
      </div>

      <div id="page-attendance" class="page-section" style="display:none;">
        <div class="page-banner"><div class="banner-text"><h2>Analisis Kehadiran</h2><p>Rekod kehadiran & statistik</p></div><div class="banner-actions"><button class="btn-action" onclick="forceReload('att')"><span class="material-icons-round" style="font-size:16px">refresh</span> Reload</button><button class="btn-action" onclick="window.print()"><span class="material-icons-round" style="font-size:16px">print</span> Cetak</button></div></div>
        <div class="dashboard-grid">
          <div class="card"><div class="stat-label">Hadir (Tapis)</div><div class="stat-val" id="attStatHadir">-</div></div>
          <div class="card"><div class="stat-label">Tidak Hadir (Tapis)</div><div class="stat-val" id="attStatTidak">-</div></div>
          <div class="card"><div class="stat-label">Peratus (Tapis)</div><div class="stat-val" id="attStatPct">-</div></div>
          <div class="card"><div class="stat-label">Jumlah Rekod</div><div class="stat-val" id="attStatTotal">-</div></div>
        </div>
        <div class="card">
          <div class="search-bar-container" style="display:flex; gap:10px; margin-bottom:10px;">
            <input class="form-input" id="searchAtt" placeholder="Cari Nama Murid..." style="flex:1;">
            <button class="btn btn-outline" onclick="toggleFilterPanel('attFilters')"><span class="material-icons-round" style="font-size:16px; vertical-align:middle;">filter_list</span> Tapis Lanjutan</button>
            <button class="btn btn-primary" onclick="applyFilterAtt()">Cari</button>
          </div>
          <div id="attFilters" class="filter-panel">
            <div class="filter-grid">
              <div><label class="filter-label">Tarikh Mula</label><input type="date" class="form-input" id="filterDateStart"></div>
              <div><label class="filter-label">Tarikh Akhir</label><input type="date" class="form-input" id="filterDateEnd"></div>
              <div><label class="filter-label">Kelas</label><select class="form-select" id="filterClassAtt"><option value="">Semua Kelas</option></select></div>
              <div><label class="filter-label">Jantina</label><select class="form-select" id="filterGenderAtt"><option value="">Semua</option><option value="LELAKI">Lelaki</option><option value="PEREMPUAN">Perempuan</option></select></div>
              <div><label class="filter-label">Status</label><select class="form-select" id="filterStatusAtt"><option value="">Semua</option><option value="HADIR">Hadir</option><option value="TIDAK">Tidak Hadir</option></select></div>
            </div>
            <div style="text-align:right"><button class="btn btn-outline" onclick="resetFilterAtt()">Reset</button> <button class="btn btn-primary" onclick="applyFilterAtt()">Terapkan</button></div>
          </div>
          <div class="print-header"><h2>LAPORAN KEHADIRAN MURID PPKI</h2><p>SK PAYA RESAK</p></div>
          <div class="table-wrap"><table><thead><tr><th>Tarikh</th><th>Nama Murid</th><th>Kelas</th><th>Jantina</th><th>Status</th></tr></thead><tbody id="attBody"></tbody></table></div>
          <div style="margin-top:10px; font-size:12px; color:var(--text-muted);" id="attCount"></div>
        </div>
      </div>

      <div id="page-asnaf" class="page-section" style="display:none;">
          <div class="page-banner">
              <div class="banner-text"><h2>Rekod Murid Asnaf</h2><p>Bantuan Asnaf & Miskin</p></div>
              <div class="banner-actions"><button class="btn-action" onclick="forceReload('asnaf')"><span class="material-icons-round" style="font-size:16px">refresh</span> Reload</button><button class="btn-action" onclick="window.print()"><span class="material-icons-round" style="font-size:16px">print</span> Cetak</button></div>
          </div>
          <div class="card">
              <div class="search-bar-container" style="display:flex; gap:10px; margin-bottom:10px;">
                  <button class="btn btn-outline" onclick="toggleFilterPanel('asnafFilters')" style="width:100%"><span class="material-icons-round" style="font-size:16px; vertical-align:middle;">filter_list</span> Buka Tapisan Lanjutan</button>
              </div>
              <div id="asnafFilters" class="filter-panel">
                  <div class="filter-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                      <div><label class="filter-label">Tahun (Sesi)</label><select class="form-select" id="fAsnafTahun"><option value="">Semua</option></select></div>
                      <div><label class="filter-label">Kelas</label><select class="form-select" id="fAsnafKelas"><option value="">Semua</option></select></div>
                      <div><label class="filter-label">Nama Murid</label><input class="form-input" id="fAsnafNama" placeholder="Cari Nama..."></div>
                      <div><label class="filter-label">No. MyKid</label><input class="form-input" id="fAsnafMykid" placeholder="Cari MyKid..."></div>
                      <div><label class="filter-label">Nama Penjaga</label><input class="form-input" id="fAsnafPenjaga" placeholder="Cari Penjaga..."></div>
                      <div><label class="filter-label">No Tel</label><input class="form-input" id="fAsnafTel" placeholder="Cari No Tel..."></div>
                      <div><label class="filter-label">Pendapatan</label><select class="form-select" id="fAsnafGaji"><option value="">Semua</option></select></div>
                      <div><label class="filter-label">Bil Adik Beradik</label><select class="form-select" id="fAsnafAdik"><option value="">Semua</option></select></div>
                      <div><label class="filter-label">Perkapita</label><select class="form-select" id="fAsnafPerkapita"><option value="">Semua</option></select></div>
                  </div>
                  <div style="text-align:right; margin-top:10px;">
                      <button class="btn btn-outline" onclick="resetFilterAsnaf()">Reset</button> 
                      <button class="btn btn-primary" onclick="renderAsnafTable()">Cari & Tapis</button>
                  </div>
              </div>
              <div class="print-header"><h2>SENARAI MURID ASNAF & MISKIN</h2><p>SK PAYA RESAK</p></div>
              <div class="table-wrap">
                  <table id="asnafTable">
                      <thead>
                        <tr>
                            <th>Bil</th>
                            <th>Nama Murid</th>
                            <th>No. MyKid</th>
                            <th>Nama Penjaga</th>
                            <th>Pendapatan</th>
                            <th>Bil. Adik</th>
                            <th>Perkapita</th>
                            <th>No Tel</th>
                            <th>Kelas</th>
                        </tr>
                      </thead>
                      <tbody id="asnafBody"></tbody>
                  </table>
              </div>
              <div style="margin-top:10px; font-size:12px; color:var(--text-muted);" id="asnafCount"></div>
          </div>
      </div>

      <div id="page-yatim" class="page-section" style="display:none;">
          <div class="page-banner">
              <div class="banner-text"><h2>Rekod Murid Yatim</h2><p>Bantuan Anak Yatim</p></div>
              <div class="banner-actions"><button class="btn-action" onclick="forceReload('yatim')"><span class="material-icons-round" style="font-size:16px">refresh</span> Reload</button><button class="btn-action" onclick="window.print()"><span class="material-icons-round" style="font-size:16px">print</span> Cetak</button></div>
          </div>
          <div class="card">
              <div class="search-bar-container" style="display:flex; gap:10px; margin-bottom:10px;">
                  <button class="btn btn-outline" onclick="toggleFilterPanel('yatimFilters')" style="width:100%"><span class="material-icons-round" style="font-size:16px; vertical-align:middle;">filter_list</span> Buka Tapisan Lanjutan</button>
              </div>
              <div id="yatimFilters" class="filter-panel">
                  <div class="filter-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                      <div><label class="filter-label">Tahun (Sesi)</label><select class="form-select" id="fYatimTahun"><option value="">Semua</option></select></div>
                      <div><label class="filter-label">Kelas</label><select class="form-select" id="fYatimKelas"><option value="">Semua</option></select></div>
                      <div><label class="filter-label">Nama Murid</label><input class="form-input" id="fYatimNama" placeholder="Cari Nama..."></div>
                      <div><label class="filter-label">No. MyKid</label><input class="form-input" id="fYatimMykid" placeholder="Cari MyKid..."></div>
                      <div><label class="filter-label">Status Yatim</label><select class="form-select" id="fYatimStatus"><option value="">Semua</option></select></div>
                      <div><label class="filter-label">Nama Penjaga</label><input class="form-input" id="fYatimPenjaga" placeholder="Cari Penjaga..."></div>
                      <div><label class="filter-label">No Tel</label><input class="form-input" id="fYatimTel" placeholder="Cari No Tel..."></div>
                      <div><label class="filter-label">Pendapatan</label><select class="form-select" id="fYatimGaji"><option value="">Semua</option></select></div>
                      <div><label class="filter-label">Bil Adik Beradik</label><select class="form-select" id="fYatimAdik"><option value="">Semua</option></select></div>
                      <div><label class="filter-label">Perkapita</label><select class="form-select" id="fYatimPerkapita"><option value="">Semua</option></select></div>
                  </div>
                  <div style="text-align:right; margin-top:10px;">
                      <button class="btn btn-outline" onclick="resetFilterYatim()">Reset</button> 
                      <button class="btn btn-primary" onclick="renderYatimTable()">Cari & Tapis</button>
                  </div>
              </div>
              <div class="print-header"><h2>SENARAI MURID YATIM</h2><p>SK PAYA RESAK</p></div>
              <div class="table-wrap">
                  <table id="yatimTable">
                      <thead>
                        <tr>
                            <th>Bil</th>
                            <th>Nama Murid</th>
                            <th>No. MyKid</th>
                            <th>Status Yatim</th>
                            <th>Nama Penjaga</th>
                            <th>Pendapatan</th>
                            <th>Bil. Adik</th>
                            <th>Perkapita</th>
                            <th>No Tel</th>
                            <th>Kelas</th>
                        </tr>
                      </thead>
                      <tbody id="yatimBody"></tbody>
                  </table>
              </div>
              <div style="margin-top:10px; font-size:12px; color:var(--text-muted);" id="yatimCount"></div>
          </div>
      </div>

      <div id="page-pajsk" class="page-section" style="display:none;">
        <div class="page-banner"><div class="banner-text"><h2>Rekod PAJSK</h2><p>Pencapaian Kokurikulum</p></div><div class="banner-actions"><button class="btn-action" onclick="forceReload('pajsk')"><span class="material-icons-round" style="font-size:16px">refresh</span> Reload</button><button class="btn-action" onclick="window.print()"><span class="material-icons-round" style="font-size:16px">print</span> Cetak</button></div></div>
        <div class="card">
          <div class="search-bar-container" style="display:flex; gap:10px; margin-bottom:10px;">
            <input class="form-input" id="searchPajsk" placeholder="Cari Nama / Acara..." style="flex:1;">
            <button class="btn btn-outline" onclick="toggleFilterPanel('pajskFilters')"><span class="material-icons-round" style="font-size:16px; vertical-align:middle;">filter_list</span> Tapis Lanjutan</button>
            <button class="btn btn-primary" onclick="renderPajskTable()">Cari</button>
          </div>
          <div id="pajskFilters" class="filter-panel">
            <div class="filter-grid">
              <div><label class="filter-label">Tahun</label><select class="form-select" id="fPajskTahun"><option value="">Semua</option></select></div>
              <div><label class="filter-label">Tarikh</label><input type="date" class="form-input" id="fPajskDate"></div>
              <div><label class="filter-label">Unit</label><select class="form-select" id="fPajskUnit"><option value="">Semua</option></select></div>
              <div><label class="filter-label">Kelas</label><select class="form-select" id="fPajskKelas"><option value="">Semua</option></select></div>
              <div><label class="filter-label">Penglibatan</label><select class="form-select" id="fPajskLibat"><option value="">Semua</option></select></div>
              <div><label class="filter-label">Pencapaian</label><select class="form-select" id="fPajskCapai"><option value="">Semua</option></select></div>
            </div>
            <div style="text-align:right"><button class="btn btn-outline" onclick="resetPajskFilters()">Reset</button> <button class="btn btn-primary" onclick="renderPajskTable()">Terapkan</button></div>
          </div>
          <div class="print-header"><h2>LAPORAN PAJSK PPKI</h2><p>SK PAYA RESAK</p></div>
          <div class="table-wrap"><table><thead><tr><th>Tahun</th><th>Tarikh</th><th>Unit</th><th>Kelas</th><th>Nama Murid</th><th>Acara</th><th>Penglibatan</th><th>Pencapaian</th></tr></thead><tbody id="pajskBody"></tbody></table></div>
        </div>
      </div>

      <div id="page-announcements" class="page-section" style="display:none;">
        <div class="page-banner"><div class="banner-text"><h2>Pengumuman</h2><p>Info Terkini</p></div><div class="banner-actions"><button class="btn-action" onclick="forceReload('ann')"><span class="material-icons-round" style="font-size:16px">refresh</span> Reload</button></div></div>
        <div class="dashboard-grid" id="annGrid" style="grid-template-columns: 1fr 1fr;"></div>
        <div id="annEmpty" style="display:none; text-align:center; padding:40px; color:var(--text-muted);"><span class="material-icons-round" style="font-size:48px; opacity:0.5;">campaign</span><p>Tiada pengumuman aktif buat masa ini.</p></div>
      </div>

      <div id="page-calendar" class="page-section" style="display:none;">
        <div class="page-banner"><div class="banner-text"><h2>Takwim</h2><p>Jadual Aktiviti</p></div><div class="banner-actions"><button class="btn-action" onclick="forceReload('cal')"><span class="material-icons-round" style="font-size:16px">refresh</span> Reload</button></div></div>
        <div class="card">
          <div class="search-bar-container" style="display:flex; gap:10px; margin-bottom:10px;">
            <input id="searchCal" class="form-input" placeholder="Cari Aktiviti..." style="flex:1;">
            <button class="btn btn-outline" onclick="toggleFilterPanel('calFilters')"><span class="material-icons-round" style="font-size:16px; vertical-align:middle;">filter_list</span> Tapis Lanjutan</button>
            <button class="btn btn-primary" onclick="renderCalendarTable()">Cari</button>
          </div>
          <div id="calFilters" class="filter-panel">
            <div class="filter-grid">
              <div><label class="filter-label">Bulan</label><select class="form-select" id="fCalBulan"><option value="">Semua</option></select></div>
              <div><label class="filter-label">Tarikh</label><input type="date" class="form-input" id="fCalTarikh"></div>
              <div><label class="filter-label">Tindakan</label><select class="form-select" id="fCalTindakan"><option value="">Semua</option></select></div>
              <div><label class="filter-label">Kategori</label><select class="form-select" id="fCalKategori"><option value="">Semua</option></select></div>
            </div>
            <div style="text-align:right"><button class="btn btn-outline" onclick="resetCalFilters()">Reset</button> <button class="btn btn-primary" onclick="renderCalendarTable()">Terapkan</button></div>
          </div>
          <div class="table-wrap"><table><thead><tr><th>BULAN</th><th>TARIKH / TEMPOH</th><th>AKTIVITI</th><th>TINDAKAN</th><th>KATEGORI</th></tr></thead><tbody id="calBody"></tbody></table></div>
        </div>
      </div>
      
      <div id="page-opr" class="page-section" style="display:none;">
          <div class="page-banner">
            <div class="banner-text"><h2>One Page Report (OPR)</h2><p>Laporan & Dokumentasi Tahunan</p></div>
          </div>
          <div class="dashboard-grid" id="oprGrid"></div>
      </div>

      <div id="page-parents" class="page-section" style="display:none;">
        <div class="page-banner"><div class="banner-text"><h2>Info Ibu Bapa</h2><p>Pautan & Dokumen</p></div><div class="banner-actions"><button class="btn-action" onclick="forceReload('par')"><span class="material-icons-round" style="font-size:16px">refresh</span> Reload</button></div></div>
        <div class="dashboard-grid" id="parentsGrid"></div>
      </div>
    </div>
  </main>
</div>

<div class="modal-overlay" id="infoModal">
  <div class="modal-content">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3 style="margin:0" id="infoTitle">Tajuk</h3>
        <button class="icon-btn" onclick="document.getElementById('infoModal').classList.remove('active')"><span class="material-icons-round">close</span></button>
    </div>
    <div id="infoBody" style="line-height:1.6; font-size:14px; color:var(--text-main);"></div>
    <div id="infoLinkContainer" style="margin-top:20px; display:none; text-align:right;">
        <button id="infoLinkBtn" class="btn btn-primary">
            Buka Pautan <span class="material-icons-round" style="font-size:14px; margin-left:5px; vertical-align:middle;">open_in_new</span>
        </button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="settingsModal"><div class="modal-content"><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;"><h3 style="margin:0">Tetapan Portal</h3><button class="icon-btn" onclick="closeSettings()"><span class="material-icons-round">close</span></button></div><div id="pinStep"><input type="password" id="pinInput" class="form-input" placeholder="PIN Keselamatan" style="width:100%; text-align:center; font-size:18px; letter-spacing:4px; margin-bottom:15px;"><button class="btn btn-primary" onclick="checkPin()" style="width:100%">Sahkan</button></div><div id="settingStep" style="display:none;"><label style="font-weight:600; font-size:12px; display:block; margin-top:10px;">Nama Sekolah</label><input id="setName" class="form-input" style="width:100%"><div style="margin:20px 0 10px; border-bottom:1px solid var(--border-color); font-weight:700; font-size:13px;">Paparan Menu</div><div id="menuManagerList"></div><button class="btn btn-primary" onclick="saveSettings()" style="width:100%; margin-top:20px;">Simpan Perubahan</button></div></div></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const ADMIN_EMAILS = [
    "naimullahkhalid@gmail.com",
    "g-84398229@moe-dl.edu.my",
    "g-48397926@moe-dl.edu.my",
    "g-82398222@moe-dl.edu.my",
    "g-04388130@moe-dl.edu.my",
    "g-32398244@moe-dl.edu.my",
    "g-23319047@moe-dl.edu.my",
    "g-42398215@moe-dl.edu.my",
    "g-30397592@moe-dl.edu.my",
    "g-58397586@moe-dl.edu.my",
    "g-35298209@moe-dl.edu.my"
  ];
  const firebaseConfig = {
    apiKey: "AIzaSyDdDlLNMjcOfi-6tfeaS_PcicQcnsqxaOk",
    authDomain: "portalppkiskpr-ecd1c.firebaseapp.com",
    projectId: "portalppkiskpr-ecd1c",
    storageBucket: "portalppkiskpr-ecd1c.firebasestorage.app",
    messagingSenderId: "643002702082",
    appId: "1:643002702082:web:7bac296fa189fa2f41ca1b"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();
  
  const OPR_DATA = [
      { title: "OPR 2025", url: "#", icon: "folder_open", desc: "Laporan Aktiviti Tahun 2025" },
      { title: "OPR 2026", url: "#", icon: "folder_open", desc: "Laporan Aktiviti Tahun 2026" }
  ];

  const DEFAULTS = {
    schoolName: "SK Paya Resak",
    pin: "5235",
    urls: {
      attendance: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQWi_5VfDz43sMFydp926q062CCPLyRnNUZyAGtlSk_9xv3gI0Xo0I7VMGSlj-llcpYCFHggVP289Ja/pub?gid=944218320&single=true&output=csv",
      pajsk: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQoRKdkGyefQ6iSz1HVsXTEenUDbSKjC_XXlq8qQLFYg6IjnSkaixKsg0ajT88VvfnnjkGaDNtxvvD7/pub?gid=1208025171&single=true&output=csv",
      announcements: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQvKlO-LRGh8kj_-Be6NxZRR3Z38rjbC33jyvfhQvnR9L4LF7_dZRVXYGK3XO7bAoJwC9bJJmABjV6Z/pub?gid=946270411&single=true&output=csv",
      parents: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ_G1txQOE4Di1XsK6esbw8VgQtW2hcPsjzAmPH7V82JOeXegb7Kb_3Iz8CeHo-KvfvHe9x8BWtSfbB/pub?gid=1684744050&single=true&output=csv",
      calendar: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQvKlO-LRGh8kj_-Be6NxZRR3Z38rjbC33jyvfhQvnR9L4LF7_dZRVXYGK3XO7bAoJwC9bJJmABjV6Z/pub?gid=1430230642&single=true&output=csv",
      database: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQN1zKkJFojiuyR1EGgdRJiS_ohrrWgxc12rC9dXRfnIR9WGC1Xdh6zdkSVLHzmqn89UHsJsSLaattG/pub?gid=630662258&single=true&output=csv",
      asnaf: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqXBgq99xruYi-J-st-Rz9CF4UcgZZLvqWJM26C2J51oWXdYy2O1z-x7e6U8To8OSBpgQuYXCS-lTv/pub?gid=877457981&single=true&output=csv",
      yatim: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqXBgq99xruYi-J-st-Rz9CF4UcgZZLvqWJM26C2J51oWXdYy2O1z-x7e6U8To8OSBpgQuYXCS-lTv/pub?gid=1167967580&single=true&output=csv"
    },
    menus: [
      {id:'home', label:'Dashboard', icon:'dashboard', hidden:false, role:'public'},
      {id:'attendance', label:'Kehadiran', icon:'analytics', hidden:false, role:'admin'},
      {id:'asnaf', label:'Rekod Asnaf Miskin', icon:'rice_bowl', hidden:false, role:'admin'}, 
      {id:'yatim', label:'Rekod Murid Yatim', icon:'volunteer_activism', hidden:false, role:'admin'},
      {id:'pajsk', label:'Rekod PAJSK', icon:'emoji_events', hidden:false, role:'admin'},
      {id:'announcements', label:'Pengumuman', icon:'campaign', hidden:false, role:'public'},
      {id:'opr', label:'Laporan OPR', icon:'description', hidden:false, role:'public'},
      {id:'calendar', label:'Takwim Tahunan', icon:'calendar_month', hidden:false, role:'public'},
      {id:'parents', label:'Info Ibu Bapa', icon:'diversity_3', hidden:false, role:'public'},
      {id:'emailcheck', label:'Semakan ID', icon:'password', hidden:false, role:'family'}, 
    ]
  };

  let CONFIG = JSON.parse(localStorage.getItem('portalConfig')) || DEFAULTS;
  let STATS_CACHE = { overall: {m:0, f:0, t:0}, classes: {} };
  let ACTIVE_CLASS = null;
  
  // === AUTO-FIX & HARD RESET (V27.19) ===
  const CURRENT_VERSION = '27.19';
  const savedVer = localStorage.getItem('portalVersion');
  
  if(savedVer !== CURRENT_VERSION) {
      console.log("New version detected. Clearing cache...");
      localStorage.clear();
      localStorage.setItem('portalVersion', CURRENT_VERSION);
      location.reload(); 
  }

  let DATA = { att: [], pajsk: [], ann: [], cal: [], par: [], db: [], asnaf: [], yatim: [] };
  let DATA_ATT_CLEAN = [];
  let USER_ROLE = 'public';

  window.init = function() {
    applyTheme();
    setupTrendSelectors();
    loadAllData();
    renderOPR();
    document.querySelector('.brand-text h1').textContent = CONFIG.schoolName ? CONFIG.schoolName : DEFAULTS.schoolName;
  }

  window.handleAuth = function() {
    if (auth.currentUser) {
      if(confirm("Adakah anda pasti untuk log keluar?")) {
          signOut(auth).then(() => { location.reload(); });
      }
    } else {
      signInWithPopup(auth, provider).catch(e => alert(e.message));
    }
  }

  onAuthStateChanged(auth, (user) => {
    const btn = document.getElementById('authBtn');
    const info = document.getElementById('userInfo');
    const gear = document.getElementById('btnSettings');
    const loginScreen = document.getElementById('login-screen');
    const appContainer = document.getElementById('appContainer');

    if (user) {
      if (ADMIN_EMAILS.includes(user.email)) USER_ROLE = 'admin';
      else USER_ROLE = 'family';
      btn.textContent = "Log Keluar";
      btn.style.background = "#B42318";
      info.style.display = "block";
      info.innerHTML = `<div>${user.displayName.toUpperCase()}</div><div style="color:var(--primary); font-size:10px">${USER_ROLE.toUpperCase()}</div>`;
      if(USER_ROLE === 'admin') gear.style.display = 'grid';
      loginScreen.style.opacity = '0';
      setTimeout(() => { loginScreen.style.display = 'none'; appContainer.style.display = 'flex'; init(); }, 500);
    } else {
      USER_ROLE = 'public';
      btn.textContent = "Log Masuk";
      btn.style.background = "var(--primary)";
      info.style.display = "none";
      gear.style.display = "none";
      loginScreen.style.display = 'none';
      appContainer.style.display = 'flex';
      init();
    }
    
    document.querySelectorAll('.att-card').forEach(el => {
        if(USER_ROLE === 'admin') {
            el.classList.add('clickable');
            el.onclick = () => navTo('attendance');
        } else {
            el.classList.remove('clickable');
            el.onclick = null;
        }
    });

    renderSidebar();
    const activePage = document.querySelector('.page-section[style*="block"]');
    if (activePage && activePage.id !== 'page-home') {
       const menu = CONFIG.menus.find(m => 'page-'+m.id === activePage.id);
       if (menu && (menu.role === 'admin' && USER_ROLE !== 'admin')) window.navTo('home');
       if (menu && (menu.role === 'family' && USER_ROLE === 'public')) window.navTo('home');
    }
  });

  window.toggleSidebar = function() {
    const body = document.body;
    if (window.innerWidth > 768) body.classList.toggle('desktop-mini');
    else body.classList.toggle('mobile-active');
  }

  window.renderSidebar = function() {
    const nav = document.getElementById('sidebarMenu');
    nav.innerHTML = '';
    
    const NAV_GROUPS = [
        { type: 'single', id: 'home' },
        { type: 'group', label: 'PENGURUSAN HEM', id: 'grp_hem', items: ['attendance', 'asnaf', 'yatim', 'emailcheck', 'parents'] },
        { type: 'group', label: 'PENGURUSAN KOKURIKULUM', id: 'grp_koko', items: ['pajsk'] },
        { type: 'group', label: 'PENTADBIRAN & HEBAHAN', id: 'grp_admin', items: ['announcements', 'opr', 'calendar'] }
    ];

    NAV_GROUPS.forEach(group => {
        if(group.type === 'single') {
            const m = CONFIG.menus.find(x => x.id === group.id);
            if(m && !m.hidden) {
                if(m.role === 'admin' && USER_ROLE !== 'admin') return;
                if(m.role === 'family' && (USER_ROLE !== 'family' && USER_ROLE !== 'admin')) return;
                const a = document.createElement('a');
                a.className = `nav-item ${m.id==='home'?'active':''}`;
                a.id = `nav-${m.id}`;
                a.innerHTML = `<span class="nav-icon material-icons-round">${m.icon}</span> ${m.label}`;
                a.onclick = () => window.navTo(m.id);
                nav.appendChild(a);
            }
        } else if (group.type === 'group') {
            const accessibleItems = group.items.filter(itemId => {
                const m = CONFIG.menus.find(x => x.id === itemId);
                if(!m || m.hidden) return false;
                if(m.role === 'admin' && USER_ROLE !== 'admin') return false;
                if(m.role === 'family' && (USER_ROLE !== 'family' && USER_ROLE !== 'admin')) return false;
                return true;
            });

            if(accessibleItems.length > 0) {
                const header = document.createElement('div');
                header.className = 'nav-group-header';
                header.innerHTML = `${group.label} <span class="material-icons-round toggle-icon">expand_more</span>`;
                header.onclick = () => toggleGroup(group.id);
                nav.appendChild(header);

                const container = document.createElement('div');
                container.id = `group-${group.id}`;
                container.className = 'nav-child-container';
                const activePageId = document.querySelector('.page-section[style*="block"]')?.id?.replace('page-', '');
                if(!group.items.includes(activePageId)) {
                   container.classList.add('collapsed');
                   header.classList.add('collapsed');
                }

                accessibleItems.forEach(itemId => {
                    const m = CONFIG.menus.find(x => x.id === itemId);
                    const a = document.createElement('a');
                    a.className = 'nav-item';
                    a.id = `nav-${m.id}`;
                    a.style.paddingLeft = '24px'; 
                    a.style.fontSize = '12px';
                    a.innerHTML = `<span class="nav-icon material-icons-round" style="font-size:18px">${m.icon}</span> ${m.label}`;
                    a.onclick = () => window.navTo(m.id);
                    container.appendChild(a);
                });
                nav.appendChild(container);
            }
        }
    });
  }

  window.toggleGroup = function(groupId) {
      const container = document.getElementById(`group-${groupId}`);
      const header = container.previousElementSibling;
      container.classList.toggle('collapsed');
      header.classList.toggle('collapsed');
  }

  window.navTo = function(id) {
    document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
    const el = document.getElementById(`nav-${id}`);
    if(el) el.classList.add('active');
    document.querySelectorAll('.page-section').forEach(e => e.style.display='none');
    document.getElementById(`page-${id}`).style.display='block';
    if(window.innerWidth <= 768) document.body.classList.remove('mobile-active');
  }

  window.toggleFilterPanel = function(id) { document.getElementById(id).classList.toggle('open'); }

  // === UPDATED FETCH LOGIC: SEPARATE SMART PARSER FOR ASNAF/YATIM ===
  async function fetchCSV(url, isSmart = false) {
    if(!url) return [];
    try {
      const fetchWithRetry = async (retries = 2) => {
         try {
           const res = await fetch(url + (url.includes('?')?'&':'?') + 't=' + Date.now() + Math.random());
           if(!res.ok) throw new Error("Status " + res.status);
           return await res.text();
         } catch(err) {
           if(retries > 0) return await fetchWithRetry(retries - 1);
           throw err;
         }
      };
      const text = await fetchWithRetry();
      return isSmart ? smartParseCSV(text) : parseCSV(text); 
    } catch(e) {
        console.error("Gagal muat data:", url, e);
        return null;
    }
  }

  // === SMART CSV PARSER (For Asnaf & Yatim ONLY) ===
  function smartParseCSV(text) {
      if (!text) return [];
      const lines = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n").split("\n");
      
      let headerIndex = -1;
      for(let i=0; i<Math.min(lines.length, 20); i++) {
          const upper = lines[i].toUpperCase();
          if(upper.includes("NAMA MURID") && (upper.includes("MYKID") || upper.includes("NO.MYKID"))) {
              headerIndex = i;
              break;
          }
      }
      
      if(headerIndex === -1) return []; 

      const splitCSV = (line) => {
          const row = [];
          let cur = "";
          let inQ = false;
          for(let c of line) {
              if(c === '"') { inQ = !inQ; continue; }
              if(c === ',' && !inQ) { row.push(cur.trim()); cur = ""; continue; }
              cur += c;
          }
          row.push(cur.trim());
          return row;
      };

      const headers = splitCSV(lines[headerIndex]).map(h => h.toUpperCase().trim());
      
      const rows = [];
      for(let i = headerIndex + 1; i < lines.length; i++) {
          if(!lines[i].trim()) continue;
          const rawRow = splitCSV(lines[i]);
          if(rawRow.every(c => c === "")) continue;

          const obj = {};
          rawRow.forEach((val, idx) => {
              let key = headers[idx];
              if ((!key || key === "") && (val === '2025' || val === '2026')) {
                  key = "TAHUN";
              }
              if (key) obj[key] = val;
          });
          
          if (!obj['TAHUN']) {
               const lastVal = rawRow[rawRow.length - 1];
               if (lastVal === '2025' || lastVal === '2026') obj['TAHUN'] = lastVal;
          }

          rows.push(obj);
      }
      return rows;
  }

  // === STANDARD CSV PARSER (For Attendance, PAJSK, etc.) ===
  function parseCSV(text) {
    if (!text) return [];
    text = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;
    for (let i = 0; i < text.length; i++) {
      const ch = text[i];
      const next = text[i + 1];
      if (ch === '"') {
        if (inQuotes && next === '"') { cur += '"'; i++; }
        else { inQuotes = !inQuotes; }
        continue;
      }
      if (ch === "," && !inQuotes) { row.push(cur); cur = ""; continue; }
      if (ch === "\n" && !inQuotes) { row.push(cur); rows.push(row); row = []; cur = ""; continue; }
      cur += ch;
    }
    row.push(cur);
    rows.push(row);
    while (rows.length && rows[rows.length - 1].every(c => (c || "").trim() === "")) { rows.pop(); }
    if (!rows.length) return [];
    const headers = rows[0].map(h => (h || "").trim().toUpperCase());
    return rows.slice(1).map(r => {
      const obj = {};
      headers.forEach((h, idx) => { obj[h] = (r[idx] ?? "").trim(); });
      return obj;
    });
  }

  function getVal(row, keyPart) {
    const key = Object.keys(row).find(k => k.includes(keyPart.toUpperCase()));
    return key ? row[key] : "";
  }

  function parseDateStr(dStr) {
    if(!dStr) return null;
    dStr = dStr.trim();
    if(dStr.match(/^\d{1,2}\/\d{1,2}\/\d{4}/)) {
      const p = dStr.split('/');
      return `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
    }
    if(dStr.match(/^\d{4}-\d{1,2}-\d{1,2}/)) { return dStr.split('T')[0]; }
    return dStr;
  }

  async function loadAllData() {
    document.getElementById('loading-overlay').style.display = 'grid';
    // Use isSmart=true ONLY for Asnaf and Yatim
    const results = await Promise.all([
      fetchCSV(CONFIG.urls.attendance, false),
      fetchCSV(CONFIG.urls.pajsk, false),
      fetchCSV(CONFIG.urls.announcements, false),
      fetchCSV(CONFIG.urls.calendar, false),
      fetchCSV(CONFIG.urls.parents, false),
      fetchCSV(CONFIG.urls.database, false),
      fetchCSV(CONFIG.urls.asnaf, true), // Smart
      fetchCSV(CONFIG.urls.yatim, true)  // Smart
    ]);
    if(results[0]) DATA.att = results[0];
    if(results[1]) DATA.pajsk = results[1];
    if(results[2]) DATA.ann = results[2];
    if(results[3]) DATA.cal = results[3];
    if(results[4]) DATA.par = results[4];
    if(results[5]) DATA.db = results[5];
    if(results[6]) DATA.asnaf = results[6];
    if(results[7]) DATA.yatim = results[7];

    const now = new Date();
    document.getElementById('updateTime').innerText = now.toLocaleString('ms-MY', { hour12: true });

    enrichBantuanData(); 
    processAttendance();
    renderAnn();
    initPajsk();
    renderParents();
    initCalendar();
    renderCalendarTable();
    renderStudentStats(); 
    
    // Init Filters
    initFilters();

    // Default Render
    renderAsnafTable();
    renderYatimTable();

    document.getElementById('loading-overlay').style.display = 'none';
  }

  window.forceReload = async function(type) {
    document.getElementById('loading-overlay').style.display = 'grid';
    let url = '';
    let isSmart = false;

    if(type === 'all') { await loadAllData(); return; }

    if(type === 'att') url = CONFIG.urls.attendance;
    else if(type === 'pajsk') url = CONFIG.urls.pajsk;
    else if(type === 'ann') url = CONFIG.urls.announcements;
    else if(type === 'cal') url = CONFIG.urls.calendar;
    else if(type === 'par') url = CONFIG.urls.parents;
    else if(type === 'db') url = CONFIG.urls.database;
    else if(type === 'asnaf') { url = CONFIG.urls.asnaf; isSmart = true; }
    else if(type === 'yatim') { url = CONFIG.urls.yatim; isSmart = true; }

    const data = await fetchCSV(url, isSmart);
    if(data) {
        if(type === 'att') { DATA.att = data; processAttendance(); }
        else if(type === 'pajsk') { DATA.pajsk = data; initPajsk(); }
        else if(type === 'ann') { DATA.ann = data; renderAnn(); }
        else if(type === 'cal') { DATA.cal = data; initCalendar(); renderCalendarTable(); }
        else if(type === 'par') { DATA.par = data; renderParents(); }
        else if(type === 'db') { DATA.db = data; alert('Pangkalan Data Dikemaskini'); renderStudentStats(); enrichBantuanData(); renderAsnafTable(); renderYatimTable(); } 
        else if(type === 'asnaf') { DATA.asnaf = data; enrichBantuanData(); initFilters(); renderAsnafTable(); alert('Asnaf Dikemaskini'); }
        else if(type === 'yatim') { DATA.yatim = data; enrichBantuanData(); initFilters(); renderYatimTable(); alert('Yatim Dikemaskini'); }
        
        const now = new Date();
        document.getElementById('updateTime').innerText = now.toLocaleString('ms-MY', { hour12: true });
    }
    document.getElementById('loading-overlay').style.display = 'none';
  }

  // === DATA ENRICHMENT (ASNAF & YATIM) ===
  function enrichBantuanData() {
      const injectInfo = (row) => {
          const name = (getVal(row, 'NAMA') || '').toUpperCase().trim();
          if(DATA.db && DATA.db.length) {
              const dbRow = DATA.db.find(db => (getVal(db, 'NAMA') || '').toUpperCase().trim() === name);
              if (dbRow) {
                if (!getVal(row, 'KELAS')) row['KELAS'] = getVal(dbRow, 'KELAS');
              }
          }
          // Default Year if missing
          if (!getVal(row, 'TAHUN')) row['TAHUN'] = '2026';
          return row;
      };

      if(DATA.asnaf) DATA.asnaf.forEach(r => injectInfo(r));
      if(DATA.yatim) DATA.yatim.forEach(r => injectInfo(r));
  }

  function populateColumnFilter(dataSet, keyList, elemId, defaultVal) {
      if(!dataSet) return;
      const vals = [...new Set(dataSet.map(r => {
          for(let k of keyList) {
             const v = getVal(r, k);
             if(v) return v.toUpperCase().trim();
          }
          return null;
      }))].filter(Boolean).sort().reverse(); // Reverse for year usually
      
      const sel = document.getElementById(elemId);
      if(sel) {
          sel.innerHTML = '<option value="">Semua</option>' + vals.map(c => `<option value="${c}">${c}</option>`).join('');
          if(defaultVal && vals.includes(defaultVal)) sel.value = defaultVal;
      }
  }

  function initFilters() {
      // Asnaf Filters
      populateColumnFilter(DATA.asnaf, ['TAHUN'], 'fAsnafTahun', '2026'); // Default 2026
      populateColumnFilter(DATA.asnaf, ['KELAS', 'CLASS'], 'fAsnafKelas');
      populateColumnFilter(DATA.asnaf, ['PENDAPATAN', 'GAJI'], 'fAsnafGaji');
      populateColumnFilter(DATA.asnaf, ['BIL', 'ADIK'], 'fAsnafAdik');
      populateColumnFilter(DATA.asnaf, ['PERKAPITA'], 'fAsnafPerkapita');

      // Yatim Filters
      populateColumnFilter(DATA.yatim, ['TAHUN'], 'fYatimTahun', '2026'); // Default 2026
      populateColumnFilter(DATA.yatim, ['KELAS', 'CLASS'], 'fYatimKelas');
      populateColumnFilter(DATA.yatim, ['YATIM', 'STATUS', 'JENIS'], 'fYatimStatus');
      populateColumnFilter(DATA.yatim, ['PENDAPATAN', 'GAJI'], 'fYatimGaji');
      populateColumnFilter(DATA.yatim, ['BIL', 'ADIK'], 'fYatimAdik');
      populateColumnFilter(DATA.yatim, ['PERKAPITA'], 'fYatimPerkapita');
  }

  // === RENDER ASNAF ===
  window.renderAsnafTable = function() {
      if(!DATA.asnaf || DATA.asnaf.length === 0) { 
          document.getElementById('asnafBody').innerHTML = '<tr><td colspan="9">Tiada data dijumpai.</td></tr>'; 
          return; 
      }

      const fTahun = document.getElementById('fAsnafTahun').value;
      const fNama = document.getElementById('fAsnafNama').value.toLowerCase();
      const fMykid = document.getElementById('fAsnafMykid').value.toLowerCase();
      const fKelas = document.getElementById('fAsnafKelas').value;
      const fPenjaga = document.getElementById('fAsnafPenjaga').value.toLowerCase();
      const fGaji = document.getElementById('fAsnafGaji').value;
      const fAdik = document.getElementById('fAsnafAdik').value;
      const fPerkapita = document.getElementById('fAsnafPerkapita').value;
      const fTel = document.getElementById('fAsnafTel').value.toLowerCase();

      const filtered = DATA.asnaf.filter(r => {
          const nama = (getVal(r, 'NAMA') || '').toUpperCase();
          if (nama === 'BIL' || nama === 'NAMA MURID' || nama.length < 3) return false;

          const tahun = (getVal(r, 'TAHUN') || '').toUpperCase();
          const kp = (getVal(r, 'KP') || getVal(r, 'NO') || getVal(r, 'MYKID') || '').toLowerCase();
          const kelas = (getVal(r, 'KELAS') || getVal(r, 'CLASS') || '').toUpperCase(); 
          const penjaga = (getVal(r, 'PENJAGA') || getVal(r, 'BAPA') || '').toLowerCase();
          const gaji = (getVal(r, 'PENDAPATAN') || getVal(r, 'GAJI') || '').toUpperCase();
          const adik = (getVal(r, 'BIL') || getVal(r, 'ADIK') || '').toUpperCase();
          const perkapita = (getVal(r, 'PERKAPITA') || '').toUpperCase();
          const tel = (getVal(r, 'TEL') || getVal(r, 'HP') || '').toLowerCase();

          return (!fTahun || tahun === fTahun) &&
                 (!fNama || nama.toLowerCase().includes(fNama)) &&
                 (!fMykid || kp.includes(fMykid)) &&
                 (!fKelas || kelas === fKelas) &&
                 (!fPenjaga || penjaga.includes(fPenjaga)) &&
                 (!fGaji || gaji === fGaji) &&
                 (!fAdik || adik === fAdik) &&
                 (!fPerkapita || perkapita === fPerkapita) &&
                 (!fTel || tel.includes(fTel));
      });

      document.getElementById('asnafBody').innerHTML = filtered.map((r, i) => {
          return `<tr>
              <td>${i + 1}</td>
              <td><strong>${getVal(r, 'NAMA')}</strong></td>
              <td>${getVal(r, 'KP') || getVal(r, 'MYKID')}</td>
              <td>${getVal(r, 'PENJAGA') || getVal(r, 'BAPA') || '-'}</td>
              <td>${getVal(r, 'PENDAPATAN') || getVal(r, 'GAJI') || '-'}</td>
              <td>${getVal(r, 'ADIK') || getVal(r, 'BIL') || '-'}</td>
              <td>${getVal(r, 'PERKAPITA') || '-'}</td>
              <td>${getVal(r, 'TEL') || getVal(r, 'HP')}</td>
              <td>${getVal(r, 'KELAS') || '-'}</td>
          </tr>`;
      }).join('');
      document.getElementById('asnafCount').innerText = `Jumlah: ${filtered.length} rekod (Tahun ${fTahun || 'Semua'}).`;
  }

  window.resetFilterAsnaf = function() {
      document.querySelectorAll('#asnafFilters input').forEach(i => i.value='');
      document.querySelectorAll('#asnafFilters select').forEach(i => i.value='');
      document.getElementById('fAsnafTahun').value = '2026';
      renderAsnafTable();
  }

  // === RENDER YATIM ===
  window.renderYatimTable = function() {
      if(!DATA.yatim || DATA.yatim.length === 0) { 
          document.getElementById('yatimBody').innerHTML = '<tr><td colspan="10">Tiada data dijumpai.</td></tr>'; 
          return; 
      }

      const fTahun = document.getElementById('fYatimTahun').value;
      const fNama = document.getElementById('fYatimNama').value.toLowerCase();
      const fMykid = document.getElementById('fYatimMykid').value.toLowerCase();
      const fStatus = document.getElementById('fYatimStatus').value;
      const fKelas = document.getElementById('fYatimKelas').value;
      const fPenjaga = document.getElementById('fYatimPenjaga').value.toLowerCase();
      const fGaji = document.getElementById('fYatimGaji').value;
      const fAdik = document.getElementById('fYatimAdik').value;
      const fPerkapita = document.getElementById('fYatimPerkapita').value;
      const fTel = document.getElementById('fYatimTel').value.toLowerCase();

      const filtered = DATA.yatim.filter(r => {
          const nama = (getVal(r, 'NAMA') || '').toUpperCase();
          if (nama === 'BIL' || nama === 'NAMA MURID' || nama.length < 3) return false;

          const tahun = (getVal(r, 'TAHUN') || '').toUpperCase();
          const kp = (getVal(r, 'KP') || getVal(r, 'NO') || getVal(r, 'MYKID') || '').toLowerCase();
          const status = (getVal(r, 'YATIM') || getVal(r, 'STATUS') || getVal(r, 'JENIS') || '').toUpperCase();
          const kelas = (getVal(r, 'KELAS') || getVal(r, 'CLASS') || '').toUpperCase(); 
          const penjaga = (getVal(r, 'PENJAGA') || getVal(r, 'BAPA') || '').toLowerCase();
          const gaji = (getVal(r, 'PENDAPATAN') || getVal(r, 'GAJI') || '').toUpperCase();
          const adik = (getVal(r, 'BIL') || getVal(r, 'ADIK') || '').toUpperCase();
          const perkapita = (getVal(r, 'PERKAPITA') || '').toUpperCase();
          const tel = (getVal(r, 'TEL') || getVal(r, 'HP') || '').toLowerCase();

          return (!fTahun || tahun === fTahun) &&
                 (!fNama || nama.toLowerCase().includes(fNama)) &&
                 (!fMykid || kp.includes(fMykid)) &&
                 (!fStatus || status === fStatus) &&
                 (!fKelas || kelas === fKelas) &&
                 (!fPenjaga || penjaga.includes(fPenjaga)) &&
                 (!fGaji || gaji === fGaji) &&
                 (!fAdik || adik === fAdik) &&
                 (!fPerkapita || perkapita === fPerkapita) &&
                 (!fTel || tel.includes(fTel));
      });

      document.getElementById('yatimBody').innerHTML = filtered.map((r, i) => {
          return `<tr>
              <td>${i + 1}</td>
              <td><strong>${getVal(r, 'NAMA')}</strong></td>
              <td>${getVal(r, 'KP') || getVal(r, 'MYKID')}</td>
              <td><span class="badge b-purple">${getVal(r, 'YATIM') || getVal(r, 'STATUS') || '-'}</span></td>
              <td>${getVal(r, 'PENJAGA') || getVal(r, 'BAPA') || '-'}</td>
              <td>${getVal(r, 'PENDAPATAN') || getVal(r, 'GAJI') || '-'}</td>
              <td>${getVal(r, 'ADIK') || getVal(r, 'BIL') || '-'}</td>
              <td>${getVal(r, 'PERKAPITA') || '-'}</td>
              <td>${getVal(r, 'TEL') || getVal(r, 'HP')}</td>
              <td>${getVal(r, 'KELAS') || '-'}</td>
          </tr>`;
      }).join('');
      document.getElementById('yatimCount').innerText = `Jumlah: ${filtered.length} rekod (Tahun ${fTahun || 'Semua'}).`;
  }

  window.resetFilterYatim = function() {
      document.querySelectorAll('#yatimFilters input').forEach(i => i.value='');
      document.querySelectorAll('#yatimFilters select').forEach(i => i.value='');
      document.getElementById('fYatimTahun').value = '2026';
      renderYatimTable();
  }

  init();
</script>
</body>
</html>
