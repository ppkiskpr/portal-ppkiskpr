<!doctype html>
<html lang="ms" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Portal Sekolah</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Poppins:wght@300;400;600;700&family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body, * { box-sizing: border-box; }
    .sidebar-transition { transition: all .25s ease-in-out; }
    .menu-item-hover { transition: all .18s ease; }
    .menu-item-hover:hover { transform: translateX(4px); }
    .toast-enter { animation: slideInRight .25s ease-out; }
    .toast-exit { animation: slideOutRight .25s ease-in; }
    @keyframes slideInRight { from{transform:translateX(100%);opacity:0} to{transform:translateX(0);opacity:1} }
    @keyframes slideOutRight { from{transform:translateX(0);opacity:1} to{transform:translateX(100%);opacity:0} }
    .modal-backdrop { background: rgba(0,0,0,.55); backdrop-filter: blur(6px); }
    .gradient-clock { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .line-clamp-3 { display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden; }
    .card-hover { transition: all .25s ease; cursor:pointer; }
    .card-hover:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,.15); }
  </style>
</head>

<body class="h-full overflow-hidden">
  <div id="app" class="h-full w-full flex flex-col"></div>

<script>
/* =========================
   1) CONFIG & STORAGE
========================= */
const STORAGE_KEY = "PORTAL_NK_STATE_V1";

const defaultState = {
  config: {
    school_name: "PPKI SK Paya Resak",
    school_motto: "Cemerlang, Gemilang, Terbilang",
    copyright_text: "Â© 2026 NK. Hak Cipta Terpelihara.",
    header_color: "#2563eb",
    bg_color: "#f3f4f6",
    sidebar_color: "#1f2937",
    card_color: "#ffffff",
    text_color: "#111827",
    font_family: "Poppins",
    banner_title: "Selamat Datang ke Portal Sekolah",
    banner_description: "Sistem pengurusan sekolah moden untuk maklumat & kemas kini.",
    banner_show_clock: true
  },
  ui: {
    sidebarCollapsed: false,
    currentPage: "home",
    settingsOpen: false
  },
  menus: [
    { id: "dashboard", icon: "ğŸ ", label: "Dashboard", page: "home" },
    { id: "data", icon: "ğŸ“Š", label: "Data", page: "data" }
  ],
  cards: [
    {
      id: crypto.randomUUID(),
      type: "announcement",
      title: "Pengumuman Contoh",
      content: "Ini contoh kad pengumuman. Cikgu boleh edit/padam di Panel Ringkas.",
      date: new Date().toISOString().slice(0,10),
      priority: "medium",
      visible: true,
      author: "Portal"
    }
  ]
};

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return structuredClone(defaultState);
    const s = JSON.parse(raw);
    // fallback merge simple
    return {
      ...structuredClone(defaultState),
      ...s,
      config: {...defaultState.config, ...(s.config||{})},
      ui: {...defaultState.ui, ...(s.ui||{})},
      menus: Array.isArray(s.menus) ? s.menus : defaultState.menus,
      cards: Array.isArray(s.cards) ? s.cards : defaultState.cards,
    };
  }catch(e){
    return structuredClone(defaultState);
  }
}
function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

let state = loadState();

/* =========================
   2) UTIL
========================= */
const DAYS_MS = ['Ahad','Isnin','Selasa','Rabu','Khamis','Jumaat','Sabtu'];
const MONTHS_MS = ['Januari','Februari','Mac','April','Mei','Jun','Julai','Ogos','September','Oktober','November','Disember'];

function nowText(){
  const now = new Date();
  const day = DAYS_MS[now.getDay()];
  const date = now.getDate();
  const month = MONTHS_MS[now.getMonth()];
  const year = now.getFullYear();
  const hh = String(now.getHours()).padStart(2,'0');
  const mm = String(now.getMinutes()).padStart(2,'0');
  const ss = String(now.getSeconds()).padStart(2,'0');
  return `${day}, ${date} ${month} ${year}, ${hh}:${mm}:${ss}`;
}
function formatDateShort(d){
  const date = new Date(d);
  const day = date.getDate();
  const month = MONTHS_MS[date.getMonth()];
  const year = date.getFullYear();
  return `${day} ${month} ${year}`;
}
function toast(msg, type="info"){
  const c = document.getElementById("toast-container");
  if(!c) return;
  const el = document.createElement("div");
  const bg = type==="success" ? "bg-emerald-600" : type==="error" ? "bg-red-600" : "bg-sky-600";
  el.className = `toast-enter px-5 py-3 rounded-xl shadow-lg text-white ${bg} max-w-sm`;
  el.textContent = msg;
  c.appendChild(el);
  setTimeout(()=>{
    el.classList.remove("toast-enter");
    el.classList.add("toast-exit");
    setTimeout(()=>el.remove(), 250);
  }, 2500);
}

/* =========================
   3) ACTIONS
========================= */
function toggleSidebar(){
  state.ui.sidebarCollapsed = !state.ui.sidebarCollapsed;
  saveState(); render();
}
function navigate(page){
  state.ui.currentPage = page;
  state.ui.settingsOpen = false;
  saveState(); render();
}
function toggleSettings(){
  state.ui.settingsOpen = !state.ui.settingsOpen;
  saveState(); render();
}
function closeSettings(){
  state.ui.settingsOpen = false;
  saveState(); render();
}
function updateConfig(patch){
  state.config = {...state.config, ...patch};
  saveState(); render();
}
function addCard(){
  const title = prompt("Tajuk kad?");
  if(!title) return;
  const content = prompt("Kandungan ringkas?");
  if(!content) return;
  state.cards.unshift({
    id: crypto.randomUUID(),
    type: "announcement",
    title, content,
    date: new Date().toISOString().slice(0,10),
    priority: "medium",
    visible: true,
    author: "Admin"
  });
  saveState(); render();
  toast("Kad ditambah", "success");
}
function deleteCard(id){
  if(!confirm("Padam kad ini?")) return;
  state.cards = state.cards.filter(c=>c.id!==id);
  saveState(); render();
  toast("Kad dipadam", "success");
}

/* =========================
   4) RENDER PARTS
========================= */
function renderHeaderTitle(){
  const p = state.ui.currentPage;
  if(p==="home") return "Laman Utama";
  if(p==="data") return "Data";
  if(p==="settings") return "Tetapan";
  return "Portal Sekolah";
}

function renderCards(){
  const cfg = state.config;
  const cards = (state.cards||[])
    .filter(c=>c.visible)
    .sort((a,b)=> new Date(b.date) - new Date(a.date))
    .slice(0,6);

  if(!cards.length){
    return `
      <div class="text-center py-10 text-slate-500">
        <div class="text-5xl mb-3">ğŸ“­</div>
        Tiada kad lagi. Tambah melalui Panel Ringkas.
      </div>`;
  }

  return `
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      ${cards.map(c=>`
        <div class="card-hover rounded-lg shadow-lg overflow-hidden"
             style="background-color:${cfg.card_color}; border-radius:14px;">
          <div class="p-6">
            <div class="flex items-center justify-between mb-3">
              <span class="px-3 py-1 rounded-full text-white text-sm font-semibold"
                    style="background-color:#2563eb;">ğŸ“¢ Pengumuman</span>
              <span class="text-xs text-slate-500">ğŸ“… ${formatDateShort(c.date)}</span>
            </div>
            <h3 class="text-xl font-bold mb-2" style="color:${cfg.text_color};">${c.title}</h3>
            <p class="text-sm text-slate-600 line-clamp-3 whitespace-pre-wrap">${c.content}</p>

            <div class="mt-4 flex gap-2">
              <button onclick="alert(${JSON.stringify(c.content).replace(/"/g,'&quot;')})"
                      class="flex-1 px-4 py-2 bg-sky-600 text-white rounded-lg hover:opacity-90">
                Buka
              </button>
              <button onclick="deleteCard('${c.id}')"
                      class="px-4 py-2 bg-red-600 text-white rounded-lg hover:opacity-90">
                Padam
              </button>
            </div>
          </div>
        </div>
      `).join("")}
    </div>
  `;
}

function renderHome(){
  const cfg = state.config;
  const clock = cfg.banner_show_clock ? `
    <div class="gradient-clock text-white text-center py-5 rounded-xl mb-4">
      <div class="live-clock text-xl font-semibold">${nowText()}</div>
    </div>` : "";

  return `
    <div class="p-8 overflow-auto h-full" style="font-family:${cfg.font_family}, sans-serif;">
      <div class="max-w-7xl mx-auto">

        <div class="rounded-2xl shadow-lg p-8 mb-8" style="background-color:${cfg.card_color};">
          <h1 class="text-3xl font-bold mb-3" style="color:${cfg.text_color};">${cfg.banner_title}</h1>
          <p class="mb-6 text-slate-600">${cfg.banner_description}</p>
          ${clock}
          <div class="flex flex-wrap gap-3">
            <button onclick="addCard()" class="px-5 py-3 text-white rounded-xl hover:opacity-90"
                    style="background-color:${cfg.header_color};">
              â• Tambah Kad
            </button>
            <button onclick="navigate('data')" class="px-5 py-3 bg-slate-900 text-white rounded-xl hover:opacity-90">
              ğŸ“Š Pergi ke Data
            </button>
          </div>
        </div>

        <div class="flex items-center justify-between mb-5">
          <h2 class="text-2xl font-bold" style="color:${cfg.text_color};">ğŸ“Œ Kemas Kini Terkini</h2>
          <button onclick="navigate('settings')" class="px-4 py-2 rounded-xl bg-slate-200 hover:bg-slate-300">
            âš™ï¸ Tetapan
          </button>
        </div>

        ${renderCards()}
      </div>
    </div>
  `;
}

function renderData(){
  const cfg = state.config;
  return `
    <div class="p-8 overflow-auto h-full" style="font-family:${cfg.font_family}, sans-serif;">
      <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold mb-4" style="color:${cfg.text_color};">ğŸ“Š Data</h1>
        <div class="rounded-2xl shadow-lg p-6" style="background-color:${cfg.card_color};">
          <p class="text-slate-600 mb-3">
            Ini placeholder untuk modul Data (CSV/Google Sheet). Bila cikgu dah set link CSV,
            kita sambung modul table + filter + dashboard kehadiran.
          </p>
          <div class="text-sm text-slate-500">
            Tip: GitHub Pages sesuai untuk â€œdashboard viewâ€. Data boleh tarik dari CSV (public).
          </div>
        </div>
      </div>
    </div>
  `;
}

function renderSettingsPanel(){
  const cfg = state.config;
  return `
    <div class="p-8 overflow-auto h-full" style="font-family:${cfg.font_family}, sans-serif;">
      <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6" style="color:${cfg.text_color};">âš™ï¸ Tetapan</h1>

        <div class="rounded-2xl shadow-lg p-6 mb-6" style="background-color:${cfg.card_color};">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold mb-2" style="color:${cfg.text_color};">Nama Sekolah</label>
              <input id="sname" class="w-full px-4 py-3 rounded-xl border" value="${cfg.school_name}">
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2" style="color:${cfg.text_color};">Moto</label>
              <input id="smotto" class="w-full px-4 py-3 rounded-xl border" value="${cfg.school_motto}">
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-semibold mb-2" style="color:${cfg.text_color};">Tajuk Banner</label>
              <input id="btitle" class="w-full px-4 py-3 rounded-xl border" value="${cfg.banner_title}">
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-semibold mb-2" style="color:${cfg.text_color};">Deskripsi Banner</label>
              <textarea id="bdesc" class="w-full px-4 py-3 rounded-xl border" rows="3">${cfg.banner_description}</textarea>
            </div>

            <div class="flex items-center gap-3">
              <input id="bclock" type="checkbox" ${cfg.banner_show_clock ? "checked":""} class="w-5 h-5">
              <label class="text-sm font-semibold" style="color:${cfg.text_color};">Papar Jam</label>
            </div>

            <div>
              <label class="block text-sm font-semibold mb-2" style="color:${cfg.text_color};">Font</label>
              <select id="ffont" class="w-full px-4 py-3 rounded-xl border">
                ${["Poppins","Roboto","Open Sans","Verdana"].map(f=>`<option ${cfg.font_family===f?"selected":""}>${f}</option>`).join("")}
              </select>
            </div>

            <div>
              <label class="block text-sm font-semibold mb-2" style="color:${cfg.text_color};">Warna Header</label>
              <input id="cheader" type="color" value="${cfg.header_color}" class="w-16 h-12 rounded-lg border">
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2" style="color:${cfg.text_color};">Warna Sidebar</label>
              <input id="cside" type="color" value="${cfg.sidebar_color}" class="w-16 h-12 rounded-lg border">
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2" style="color:${cfg.text_color};">Warna Latar</label>
              <input id="cbg" type="color" value="${cfg.bg_color}" class="w-16 h-12 rounded-lg border">
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2" style="color:${cfg.text_color};">Warna Teks</label>
              <input id="ctext" type="color" value="${cfg.text_color}" class="w-16 h-12 rounded-lg border">
            </div>
          </div>

          <div class="mt-6 flex gap-3">
            <button onclick="saveSettingsFromUI()" class="px-6 py-3 rounded-xl text-white hover:opacity-90"
                    style="background-color:${cfg.header_color};">
              ğŸ’¾ Simpan
            </button>
            <button onclick="resetAll()" class="px-6 py-3 rounded-xl bg-slate-200 hover:bg-slate-300">
              ğŸ”„ Reset
            </button>
          </div>
        </div>

        <div class="rounded-2xl shadow-lg p-6" style="background-color:${cfg.card_color};">
          <h2 class="text-xl font-bold mb-3" style="color:${cfg.text_color};">ğŸ§© Panel Ringkas</h2>
          <p class="text-slate-600 mb-4">Tambah kad & urus data ringkas (localStorage).</p>
          <div class="flex flex-wrap gap-3">
            <button onclick="addCard()" class="px-5 py-3 bg-sky-600 text-white rounded-xl hover:opacity-90">â• Tambah Kad</button>
            <button onclick="exportJSON()" class="px-5 py-3 bg-slate-900 text-white rounded-xl hover:opacity-90">â¬‡ï¸ Export JSON</button>
            <button onclick="importJSON()" class="px-5 py-3 bg-slate-200 rounded-xl hover:bg-slate-300">â¬†ï¸ Import JSON</button>
          </div>
        </div>
      </div>
    </div>
  `;
}

/* =========================
   5) MAIN RENDER
========================= */
function render(){
  const cfg = state.config;
  const app = document.getElementById("app");

  const sidebarCollapsed = state.ui.sidebarCollapsed;
  const current = state.ui.currentPage;

  const mainContent =
    current==="home" ? renderHome()
    : current==="data" ? renderData()
    : current==="settings" ? renderSettingsPanel()
    : renderHome();

  app.innerHTML = `
    <div class="flex h-full" style="font-family:${cfg.font_family},sans-serif;">
      ${!sidebarCollapsed ? `
      <aside class="sidebar-transition flex-shrink-0" style="width:280px; background-color:${cfg.sidebar_color};">
        <div class="flex flex-col h-full">
          <div class="p-6 border-b border-white/10">
            <div onclick="navigate('home')" class="flex justify-center mb-4 cursor-pointer hover:scale-110 transition-transform">
              <div class="w-20 h-20 rounded-full bg-white flex items-center justify-center text-4xl">ğŸ«</div>
            </div>
            <h2 class="text-white text-center font-bold text-xl mb-1">${cfg.school_name}</h2>
            <p class="text-white/60 text-center text-sm">${cfg.school_motto}</p>
          </div>

          <nav class="flex-1 overflow-y-auto py-4">
            ${state.menus.map(m=>`
              <div onclick="navigate('${m.page}')" class="menu-item-hover flex items-center px-6 py-3 text-white cursor-pointer ${current===m.page ? 'bg-white/15' : 'hover:bg-white/10'}">
                <span class="text-2xl">${m.icon}</span>
                <span class="ml-4 font-medium">${m.label}</span>
              </div>
            `).join("")}

            <div onclick="navigate('settings')" class="menu-item-hover flex items-center px-6 py-3 text-white cursor-pointer ${current==='settings' ? 'bg-white/15' : 'hover:bg-white/10'}">
              <span class="text-2xl">âš™ï¸</span>
              <span class="ml-4 font-medium">Tetapan</span>
            </div>
          </nav>

          <div class="p-4 border-t border-white/10">
            <p class="text-white/60 text-xs text-center">${cfg.copyright_text}</p>
          </div>
        </div>
      </aside>
      ` : ''}

      <div class="flex-1 flex flex-col h-full overflow-hidden">
        <header class="flex-shrink-0 shadow-lg" style="background-color:${cfg.header_color};">
          <div class="px-6 py-4 flex items-center justify-between">
            <div class="flex items-center">
              <button onclick="toggleSidebar()" class="text-white p-2 hover:bg-white/15 rounded-lg mr-4">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
              </button>

              ${sidebarCollapsed ? `
                <div onclick="navigate('home')" class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-2xl mr-3 cursor-pointer hover:scale-110 transition-transform">
                  ğŸ«
                </div>
              ` : ''}

              <h1 class="text-white text-xl font-bold">${renderHeaderTitle()}</h1>
            </div>

            <div class="flex items-center gap-3">
              <button onclick="navigate('home')" class="text-white px-3 py-2 rounded-lg hover:bg-white/15">ğŸ </button>

              <div class="relative">
                <button onclick="toggleSettings()" class="text-white p-2 hover:bg-white/15 rounded-lg">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  </svg>
                </button>

                ${state.ui.settingsOpen ? `
                  <div class="absolute right-0 mt-2 w-56 rounded-xl shadow-lg py-2 z-50"
                       style="background-color:${cfg.card_color};">
                    <a onclick="navigate('settings')" class="block px-4 py-2 hover:bg-slate-100 cursor-pointer"
                       style="color:${cfg.text_color};">âš™ï¸ Tetapan Portal</a>
                    <a onclick="addCard(); closeSettings()" class="block px-4 py-2 hover:bg-slate-100 cursor-pointer"
                       style="color:${cfg.text_color};">â• Tambah Kad</a>
                  </div>
                ` : ''}
              </div>

              <div class="w-9 h-9 rounded-full bg-white flex items-center justify-center font-bold"
                   style="color:${cfg.header_color};">NK</div>
            </div>
          </div>
        </header>

        <main class="flex-1 overflow-hidden" style="background-color:${cfg.bg_color};">
          ${mainContent}
        </main>
      </div>
    </div>

    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
  `;

  // update live clock
  updateClock();
}

function updateClock(){
  const els = document.querySelectorAll(".live-clock");
  els.forEach(el=> el.textContent = nowText());
}
setInterval(updateClock, 1000);

/* =========================
   6) SETTINGS HELPERS
========================= */
function saveSettingsFromUI(){
  const sname = document.getElementById("sname")?.value ?? state.config.school_name;
  const smotto= document.getElementById("smotto")?.value ?? state.config.school_motto;
  const btitle= document.getElementById("btitle")?.value ?? state.config.banner_title;
  const bdesc = document.getElementById("bdesc")?.value ?? state.config.banner_description;
  const bclock= document.getElementById("bclock")?.checked ?? state.config.banner_show_clock;
  const ffont = document.getElementById("ffont")?.value ?? state.config.font_family;

  const cheader = document.getElementById("cheader")?.value ?? state.config.header_color;
  const cside   = document.getElementById("cside")?.value ?? state.config.sidebar_color;
  const cbg     = document.getElementById("cbg")?.value ?? state.config.bg_color;
  const ctext   = document.getElementById("ctext")?.value ?? state.config.text_color;

  updateConfig({
    school_name: sname,
    school_motto: smotto,
    banner_title: btitle,
    banner_description: bdesc,
    banner_show_clock: bclock,
    font_family: ffont,
    header_color: cheader,
    sidebar_color: cside,
    bg_color: cbg,
    text_color: ctext
  });
  toast("Tetapan disimpan", "success");
}

function resetAll(){
  if(!confirm("Reset portal ke default?")) return;
  state = structuredClone(defaultState);
  saveState(); render();
  toast("Reset berjaya", "success");
}

function exportJSON(){
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "portal_state.json";
  a.click();
  URL.revokeObjectURL(url);
  toast("Export siap", "success");
}

function importJSON(){
  const input = document.createElement("input");
  input.type="file";
  input.accept="application/json";
  input.onchange = () => {
    const file = input.files?.[0];
    if(!file) return;
    const r = new FileReader();
    r.onload = () => {
      try{
        const imported = JSON.parse(r.result);
        state = {
          ...structuredClone(defaultState),
          ...imported,
          config:{...defaultState.config, ...(imported.config||{})},
          ui:{...defaultState.ui, ...(imported.ui||{})}
        };
        saveState(); render();
        toast("Import berjaya", "success");
      }catch(e){
        toast("Fail JSON tidak sah", "error");
      }
    };
    r.readAsText(file);
  };
  input.click();
}

/* =========================
   7) CLICK OUTSIDE (close dropdown)
========================= */
document.addEventListener("click", (e)=>{
  // close settings dropdown if click outside
  const isBtn = e.target.closest("button[onclick*='toggleSettings']");
  const isDrop= e.target.closest("div.absolute.right-0");
  if(!isBtn && !isDrop && state.ui.settingsOpen){
    state.ui.settingsOpen = false;
    saveState(); render();
  }
});

/* INIT */
render();
</script>
</body>
</html>
