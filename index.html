<!doctype html>
<html lang="ms" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portal Rasmi PPKI SK Paya Resak</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

  <style>
    :root {
      --font-main: 'Poppins', sans-serif;
      --bg-body: #F2F4F7;
      --bg-sidebar: #FFFFFF;
      --bg-card: #FFFFFF;
      --bg-element: #F9FAFB;
      --border-color: #EAECF0;
      --text-main: #101828;
      --text-muted: #667085;
      
      --primary: #1F6F4A; 
      --primary-light: #E8F5E9;
      --accent: #F79009;
      
      --shadow-sm: 0 1px 2px rgba(16, 24, 40, 0.05);
      --radius-card: 16px;
      
      --sidebar-w-full: 260px;
      --sidebar-w-mini: 74px;
    }

    html[data-mode="dark"] {
      --bg-body: #0F1115;
      --bg-sidebar: #161B22;
      --bg-card: #1C2128;
      --bg-element: #252B36;
      --border-color: #30363D;
      --text-main: #F0F6FC;
      --text-muted: #8B949E;
      --primary: #2EA043;
      --primary-light: rgba(46, 160, 67, 0.15);
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; font-family: var(--font-main); background: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; }
    .app-container { display: flex; height: 100%; width: 100%; }

    /* ===== SIDEBAR ===== */
    .sidebar {
      background: var(--bg-sidebar);
      border-right: 1px solid var(--border-color);
      display: flex; flex-direction: column;
      padding: 20px 12px;
      transition: width 0.3s ease;
      z-index: 50; flex-shrink: 0; overflow-x: hidden;
    }

    @media (min-width: 769px) {
      .sidebar { width: var(--sidebar-w-full); }
      body.desktop-mini .sidebar { width: var(--sidebar-w-mini); }
      body.desktop-mini .brand-text, body.desktop-mini .nav-text, body.desktop-mini .sidebar-footer { opacity: 0; pointer-events: none; display: none; }
      body.desktop-mini .brand { justify-content: center; padding-left: 0; }
      body.desktop-mini .nav-item { justify-content: center; padding: 12px 0; }
      body.desktop-mini .nav-icon { margin-right: 0; }
    }

    @media (max-width: 768px) {
      .sidebar { position: fixed; left: -100%; top: 0; height: 100%; width: 260px; box-shadow: 5px 0 25px rgba(0,0,0,0.2); }
      body.mobile-active .sidebar { left: 0; }
      .backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; display: none; backdrop-filter: blur(2px); }
      body.mobile-active .backdrop { display: block; }
    }

    .brand { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; min-height: 45px; overflow: hidden; white-space: nowrap; }
    .brand-logo { width: 40px; height: 40px; border-radius: 8px; flex-shrink: 0; }
    .brand-logo img { width: 100%; height: 100%; object-fit: contain; }
    .brand-text h1 { margin: 0; font-size: 15px; font-weight: 700; }
    .brand-text p { margin: 0; font-size: 11px; color: var(--text-muted); }

    .nav-menu { flex: 1; display: flex; flex-direction: column; gap: 6px; overflow-y: auto; overflow-x: hidden; }
    .nav-item {
      display: flex; align-items: center; gap: 12px; padding: 12px 14px;
      border-radius: 10px; cursor: pointer; color: var(--text-muted);
      text-decoration: none; transition: all 0.2s; white-space: nowrap;
    }
    .nav-item:hover { background: var(--bg-element); color: var(--text-main); }
    .nav-item.active { background: var(--primary-light); color: var(--primary); font-weight: 600; }
    .nav-icon { font-size: 22px; display: flex; align-items: center; justify-content: center; }

    .sidebar-footer { margin-top: auto; font-size: 11px; text-align: center; color: var(--text-muted); white-space: nowrap; padding-top: 20px; line-height: 1.4; }

    /* ===== MAIN ===== */
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
    .top-bar {
      height: 64px; display: flex; align-items: center; justify-content: space-between;
      padding: 0 24px; background: var(--bg-body); flex-shrink: 0;
    }
    .icon-btn {
      width: 40px; height: 40px; border-radius: 8px; border: none; background: transparent;
      color: var(--text-main); display: grid; place-items: center; cursor: pointer; font-size: 24px;
    }
    .icon-btn:hover { background: var(--bg-element); }

    .content-area { flex: 1; overflow-y: auto; padding: 10px 24px 40px 24px; }

    .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 24px; }
    .card { background: var(--bg-card); padding: 20px; border-radius: var(--radius-card); border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); }
    
    .stat-label { font-size: 13px; color: var(--text-muted); font-weight: 500; }
    .stat-val { font-size: 28px; font-weight: 700; margin: 5px 0; color: var(--text-main); }
    .stat-sub { font-size: 12px; display: flex; align-items: center; gap: 4px; color: var(--text-muted); }
    .stat-sub.red { color: #D92D20; font-weight: 600; }

    .clickable { cursor: pointer; transition: transform 0.2s, border-color 0.2s; }
    .clickable:hover { transform: translateY(-3px); border-color: var(--primary); }

    .page-banner {
      background: linear-gradient(135deg, var(--primary), #144d33); color: white;
      padding: 24px; border-radius: 16px; margin-bottom: 24px;
      display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;
    }
    .banner-text h2 { margin: 0; font-size: 22px; font-weight: 700; }
    .banner-actions { display: flex; gap: 10px; } 
    .btn-action {
      background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);
      padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px;
      display: flex; align-items: center; gap: 8px; transition: background 0.2s;
    }
    .btn-action:hover { background: rgba(255,255,255,0.3); }

    .filter-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .form-select, .form-input {
      background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-main);
      padding: 10px 12px; border-radius: 8px; font-family: inherit; font-size: 13px; width: 100%;
    }
    .btn { padding: 10px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 13px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-main); }

    .filter-panel {
      display: none; padding: 20px; background: var(--bg-element); 
      border-radius: 12px; margin-top: 15px; border: 1px solid var(--border-color);
    }
    .filter-panel.open { display: block; }
    .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
    .filter-label { font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block; color: var(--text-muted); }

    .table-wrap { overflow-x: auto; border-radius: 12px; border: 1px solid var(--border-color); }
    table { width: 100%; border-collapse: collapse; min-width: 800px; font-size: 13px; }
    th { text-align: left; padding: 14px 16px; background: var(--bg-element); color: var(--text-muted); font-weight: 600; text-transform: uppercase; white-space: nowrap; }
    td { padding: 14px 16px; border-top: 1px solid var(--border-color); color: var(--text-main); vertical-align: top; }
    .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; display: inline-block; }
    .b-green { background: #ECFDF3; color: #027A48; }
    .b-red { background: #FEF3F2; color: #B42318; }
    .b-blue { background: #EFF8FF; color: #175CD3; }

    .link-card { cursor: pointer; transition: transform 0.2s; height: 100%; }
    .link-card:hover { transform: translateY(-4px); border-color: var(--primary); }

    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100;
      display: none; place-items: center; backdrop-filter: blur(2px);
    }
    .modal-overlay.active { display: grid; }
    .modal-content {
      width: 90%; max-width: 500px; background: var(--bg-card);
      border-radius: 16px; padding: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      max-height: 85vh; overflow-y: auto;
    }

    .menu-toggle-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 8px; }
    .menu-toggle-item input { width: 18px; height: 18px; accent-color: var(--primary); }

    @media (max-width: 1024px) { .dashboard-grid { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 768px) { 
      .dashboard-grid { grid-template-columns: 1fr; }
      .page-banner { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>

<div class="backdrop" onclick="toggleSidebar()"></div>

<div class="app-container">
  
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <div class="brand-logo">
        <img src="https://i.ibb.co/Y7sp2wZg/SKPR-1.png" alt="Logo">
      </div>
      <div class="brand-text">
        <h1>SK Paya Resak</h1>
        <p>Moving Forward</p>
      </div>
    </div>
    
    <nav class="nav-menu" id="sidebarMenu">
      </nav>

    <div class="sidebar-footer">
      <div>Â© 2025 NK.</div>
      <div>Hak Cipta Terpelihara.</div>
    </div>
  </aside>

  <main class="main-content">
    <header class="top-bar">
      <button class="icon-btn" onclick="toggleSidebar()">
        <span class="material-icons-round">menu</span>
      </button>
      
      <div style="display:flex; gap:8px;">
        <button class="icon-btn" onclick="toggleTheme()" title="Tema">
          <span class="material-icons-round">dark_mode</span>
        </button>
        <button class="icon-btn" onclick="openSettings()" title="Tetapan">
          <span class="material-icons-round">settings</span>
        </button>
      </div>
    </header>

    <div class="content-area">
      
      <div id="page-home" class="page-section">
        <div class="page-banner">
          <div class="banner-text">
            <h2>Dashboard</h2>
            <p>Selamat Datang ke Portal Rasmi PPKI</p>
          </div>
        </div>

        <div class="dashboard-grid">
          <div class="card stat-card clickable" onclick="navTo('attendance')">
            <div class="stat-label">Kehadiran Hari Ini</div>
            <div class="stat-val" id="dToday">-</div>
            <div class="stat-sub red" id="dAbsent">- Tidak Hadir</div>
          </div>
          <div class="card stat-card clickable" onclick="navTo('attendance')">
            <div class="stat-label">Minggu Ini</div>
            <div class="stat-val" id="dWeek">-</div>
            <div class="stat-sub">Rekod Kehadiran</div>
          </div>
          <div class="card stat-card clickable" onclick="navTo('attendance')">
            <div class="stat-label">Bulan Ini</div>
            <div class="stat-val" id="dPct">-</div>
            <div class="stat-sub">Peratus Kehadiran</div>
          </div>
          <div class="card stat-card clickable" onclick="navTo('announcements')">
            <div class="stat-label">Pengumuman</div>
            <div class="stat-val" id="dAnn">-</div>
            <div class="stat-sub">Aktif</div>
          </div>
        </div>

        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px; margin-bottom:20px;">
            <h3 style="margin:0; font-size:16px;">ðŸ“ˆ Trend Harian</h3>
            <div class="filter-row">
              <select class="form-select" style="width:auto" id="trendType" onchange="renderTrend()">
                <option value="hadir">Hadir</option><option value="tidak">Tidak Hadir</option><option value="pct">%</option>
              </select>
              <select class="form-select" style="width:auto" id="trendMonth" onchange="renderTrend()"></select>
              <select class="form-select" style="width:auto" id="trendYear" onchange="renderTrend()"></select>
              <select class="form-select" style="width:auto" id="trendClass" onchange="renderTrend()"><option value="">Semua Kelas</option></select>
            </div>
          </div>
          <div id="chartContainer" style="height:280px; width:100%;"></div>
        </div>
      </div>

      <div id="page-attendance" class="page-section" style="display:none;">
        <div class="page-banner">
          <div class="banner-text">
            <h2>Analisis Kehadiran</h2>
            <p>Rekod kehadiran & statistik</p>
          </div>
          <div class="banner-actions">
            <button class="btn-action" onclick="loadAttendance(true)"><span class="material-icons-round" style="font-size:16px">refresh</span> Reload</button>
            <button class="btn-action" onclick="window.print()"><span class="material-icons-round" style="font-size:16px">print</span> Cetak</button>
          </div>
        </div>

        <div class="dashboard-grid">
          <div class="card"><div class="stat-label">Hadir (Tapis)</div><div class="stat-val" id="attStatHadir">-</div></div>
          <div class="card"><div class="stat-label">Tidak Hadir (Tapis)</div><div class="stat-val" id="attStatTidak">-</div></div>
          <div class="card"><div class="stat-label">Peratus (Tapis)</div><div class="stat-val" id="attStatPct">-</div></div>
          <div class="card"><div class="stat-label">Jumlah Rekod</div><div class="stat-val" id="attStatTotal">-</div></div>
        </div>

        <div class="card">
          <div style="display:flex; gap:10px; margin-bottom:10px;">
            <input class="form-input" id="searchAtt" placeholder="Cari Nama Murid..." style="flex:1;">
            <button class="btn btn-outline" onclick="toggleFilterPanel('attFilters')">
              <span class="material-icons-round" style="font-size:16px; vertical-align:middle;">filter_list</span> Tapis Lanjutan
            </button>
            <button class="btn btn-primary" onclick="applyFilterAtt()">Cari</button>
          </div>

          <div id="attFilters" class="filter-panel">
            <div class="filter-grid">
              <div><label class="filter-label">Tarikh Mula</label><input type="date" class="form-input" id="filterDateStart"></div>
              <div><label class="filter-label">Tarikh Akhir</label><input type="date" class="form-input" id="filterDateEnd"></div>
              <div><label class="filter-label">Kelas</label><select class="form-select" id="filterClassAtt"><option value="">Semua Kelas</option></select></div>
              <div><label class="filter-label">Jantina</label><select class="form-select" id="filterGenderAtt">
                <option value="">Semua</option><option value="LELAKI">Lelaki</option><option value="PEREMPUAN">Perempuan</option>
              </select></div>
              <div><label class="filter-label">Status</label><select class="form-select" id="filterStatusAtt">
                <option value="">Semua</option><option value="HADIR">Hadir</option><option value="TIDAK">Tidak Hadir</option>
              </select></div>
            </div>
            <div style="text-align:right">
              <button class="btn btn-outline" onclick="resetFilterAtt()">Reset Filter</button>
              <button class="btn btn-primary" onclick="applyFilterAtt()">Terapkan</button>
            </div>
          </div>

          <div class="table-wrap">
            <table>
              <thead><tr><th>Tarikh</th><th>Nama Murid</th><th>Kelas</th><th>Jantina</th><th>Status</th></tr></thead>
              <tbody id="attBody"></tbody>
            </table>
          </div>
          <div style="margin-top:10px; font-size:12px; color:var(--text-muted);" id="attCount"></div>
        </div>
      </div>

      <div id="page-pajsk" class="page-section" style="display:none;">
        <div class="page-banner">
          <div class="banner-text">
            <h2>Rekod PAJSK</h2>
            <p>Pencapaian Kokurikulum</p>
          </div>
          <div class="banner-actions">
            <button class="btn-action" onclick="loadPajsk(true)"><span class="material-icons-round" style="font-size:16px">refresh</span> Reload</button>
            <button class="btn-action" onclick="window.print()"><span class="material-icons-round" style="font-size:16px">print</span> Cetak</button>
          </div>
        </div>

        <div class="card">
          <div style="display:flex; gap:10px; margin-bottom:10px;">
            <input class="form-input" id="searchPajsk" placeholder="Cari Nama / Acara..." style="flex:1;">
            <button class="btn btn-outline" onclick="toggleFilterPanel('pajskFilters')">
              <span class="material-icons-round" style="font-size:16px; vertical-align:middle;">filter_list</span> Tapis Lanjutan
            </button>
            <button class="btn btn-primary" onclick="renderPajskTable()">Cari</button>
          </div>

          <div id="pajskFilters" class="filter-panel">
            <div class="filter-grid">
              <div><label class="filter-label">Tarikh (Single)</label><input type="date" class="form-input" id="fPajskDate"></div>
              <div><label class="filter-label">Unit</label><select class="form-select" id="fPajskUnit"><option value="">Semua</option></select></div>
              <div><label class="filter-label">Kelas</label><select class="form-select" id="fPajskKelas"><option value="">Semua</option></select></div>
              <div><label class="filter-label">Penglibatan</label><select class="form-select" id="fPajskLibat"><option value="">Semua</option></select></div>
              <div><label class="filter-label">Pencapaian</label><select class="form-select" id="fPajskCapai"><option value="">Semua</option></select></div>
            </div>
            <div style="text-align:right">
              <button class="btn btn-outline" onclick="resetPajskFilters()">Reset Filter</button>
              <button class="btn btn-primary" onclick="renderPajskTable()">Terapkan</button>
            </div>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Tarikh</th><th>Unit</th><th>Kelas</th><th>Nama Murid</th>
                  <th>Acara</th><th>Penglibatan</th><th>Pencapaian</th>
                </tr>
              </thead>
              <tbody id="pajskBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="page-announcements" class="page-section" style="display:none;">
        <div class="page-banner">
          <div class="banner-text"><h2>Pengumuman</h2><p>Info Terkini</p></div>
          <div class="banner-actions">
            <button class="btn-action" onclick="loadAnnouncements(true)"><span class="material-icons-round" style="font-size:16px">refresh</span> Reload</button>
          </div>
        </div>
        <div class="dashboard-grid" id="annGrid" style="grid-template-columns: 1fr 1fr;"></div>
      </div>

      <div id="page-calendar" class="page-section" style="display:none;">
        <div class="page-banner">
          <div class="banner-text"><h2>Takwim</h2><p>Jadual Aktiviti</p></div>
        </div>
        <div class="card">
          <div class="table-wrap"><table><thead id="calHead"></thead><tbody id="calBody"></tbody></table></div>
        </div>
      </div>

      <div id="page-parents" class="page-section" style="display:none;">
        <div class="page-banner">
          <div class="banner-text"><h2>Info Ibu Bapa</h2><p>Pautan & Dokumen</p></div>
        </div>
        <div class="dashboard-grid" id="parentsGrid"></div>
      </div>

    </div>
  </main>
</div>

<div class="modal-overlay" id="infoModal">
  <div class="modal-content">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
      <h3 style="margin:0" id="infoTitle">Tajuk</h3>
      <button class="icon-btn" onclick="document.getElementById('infoModal').classList.remove('active')"><span class="material-icons-round">close</span></button>
    </div>
    <div id="infoBody" style="line-height:1.6; font-size:14px; color:var(--text-main);"></div>
  </div>
</div>

<div class="modal-overlay" id="settingsModal">
  <div class="modal-content">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h3 style="margin:0">Tetapan Portal</h3>
      <button class="icon-btn" onclick="closeSettings()"><span class="material-icons-round">close</span></button>
    </div>

    <div id="pinStep">
      <input type="password" id="pinInput" class="form-input" placeholder="PIN Keselamatan" style="width:100%; text-align:center; font-size:18px; letter-spacing:4px; margin-bottom:15px;">
      <button class="btn btn-primary" onclick="checkPin()" style="width:100%">Sahkan</button>
    </div>

    <div id="settingStep" style="display:none;">
      <label style="font-weight:600; font-size:12px; display:block; margin-top:10px;">Nama Sekolah</label>
      <input id="setName" class="form-input" style="width:100%">

      <div style="margin:20px 0 10px; border-bottom:1px solid var(--border-color); font-weight:700; font-size:13px;">Paparan Menu</div>
      <div id="menuManagerList"></div>

      <div style="margin:20px 0 10px; border-bottom:1px solid var(--border-color); font-weight:700; font-size:13px;">Pautan CSV</div>
      <input id="setUrlAtt" class="form-input" style="width:100%; margin-bottom:8px;" placeholder="URL Kehadiran">
      <input id="setUrlPajsk" class="form-input" style="width:100%; margin-bottom:8px;" placeholder="URL PAJSK">
      <input id="setUrlAnn" class="form-input" style="width:100%; margin-bottom:8px;" placeholder="URL Pengumuman">

      <button class="btn btn-primary" onclick="saveSettings()" style="width:100%; margin-top:20px;">Simpan Perubahan</button>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const DEFAULTS = {
  schoolName: "SK Paya Resak",
  pin: "5235", 
  urls: {
    attendance: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTKhex5gcCHKoiLqRZpgVRMRfrGGvPtbgc3jo_Q-3FPL5OpcoWvyAnec0dTgykrpkYuS34iNJnEAkDU/pub?gid=880667725&single=true&output=csv",
    pajsk: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRGcqw1v5SRbEL_2LMhX9I_X8uIo5CTQRzOpY5nTlbSc8_6Q4cx56LWtTI3-I5D9pJYeS20nEgADikT/pub?gid=0&single=true&output=csv",
    announcements: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQvKlO-LRGh8kj_-Be6NxZRR3Z38rjbC33jyvfhQvnR9L4LF7_dZRVXYGK3XO7bAoJwC9bJJmABjV6Z/pub?gid=946270411&single=true&output=csv",
    parents: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ_G1txQOE4Di1XsK6esbw8VgQtW2hcPsjzAmPH7V82JOeXegb7Kb_3Iz8CeHo-KvfvHe9x8BWtSfbB/pub?gid=1684744050&single=true&output=csv",
    calendar: ""
  },
  menus: [
    {id:'home', label:'Dashboard', icon:'dashboard', hidden:false},
    {id:'attendance', label:'Kehadiran', icon:'analytics', hidden:false},
    {id:'pajsk', label:'PAJSK', icon:'emoji_events', hidden:false},
    {id:'announcements', label:'Pengumuman', icon:'campaign', hidden:false},
    {id:'calendar', label:'Takwim', icon:'calendar_month', hidden:false},
    {id:'parents', label:'Ibu Bapa', icon:'diversity_3', hidden:false}
  ]
};

let CONFIG = JSON.parse(localStorage.getItem('portalConfig')) || DEFAULTS;
let DATA = { att: [], pajsk: [], ann: [], cal: [], par: [] };
let DATA_ATT_CLEAN = [];

function init() {
  applyTheme();
  renderSidebar();
  setupTrendSelectors();
  loadAllData();
  document.querySelector('.brand-text h1').textContent = CONFIG.schoolName;
}

/* ================= UI LOGIC ================= */
function toggleSidebar() {
  const body = document.body;
  if (window.innerWidth > 768) body.classList.toggle('desktop-mini');
  else body.classList.toggle('mobile-active');
}

function renderSidebar() {
  const nav = document.getElementById('sidebarMenu');
  nav.innerHTML = '';
  CONFIG.menus.forEach(m => {
    if(m.hidden) return;
    const a = document.createElement('a');
    a.className = `nav-item ${m.id==='home'?'active':''}`;
    a.id = `nav-${m.id}`;
    a.innerHTML = `<span class="nav-icon material-icons-round">${m.icon}</span> <span class="nav-text">${m.label}</span>`;
    a.onclick = () => navTo(m.id);
    nav.appendChild(a);
  });
}

function navTo(id) {
  document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
  document.getElementById(`nav-${id}`).classList.add('active');
  document.querySelectorAll('.page-section').forEach(e => e.style.display='none');
  document.getElementById(`page-${id}`).style.display='block';
  if(window.innerWidth <= 768) document.body.classList.remove('mobile-active');
}

function toggleFilterPanel(id) {
  document.getElementById(id).classList.toggle('open');
}

/* ================= DATA PARSING ================= */
async function fetchCSV(url) {
  if(!url) return [];
  try {
    const res = await fetch(url + (url.includes('?')?'&':'?') + 't=' + Date.now());
    const text = await res.text();
    return parseCSV(text);
  } catch(e) { console.error(e); return []; }
}

function parseCSV(text) {
  const rows = text.split('\n').map(r => r.split(','));
  const headers = rows[0].map(h => h.trim().toUpperCase());
  return rows.slice(1).filter(r => r.length === headers.length).map(row => {
    let obj = {};
    headers.forEach((h, i) => obj[h] = row[i]?.trim());
    return obj;
  });
}

function getVal(row, keyPart) {
  const key = Object.keys(row).find(k => k.includes(keyPart.toUpperCase()));
  return key ? row[key] : "";
}

// Convert DD/MM/YYYY to YYYY-MM-DD (ISO)
function parseDateStr(dStr) {
  if(!dStr) return null;
  dStr = dStr.trim();
  // Match DD/MM/YYYY
  if(dStr.match(/^\d{1,2}\/\d{1,2}\/\d{4}/)) {
    const p = dStr.split('/');
    const day = p[0].padStart(2, '0');
    const month = p[1].padStart(2, '0');
    return `${p[2]}-${month}-${day}`; 
  }
  return dStr;
}

async function loadAllData() {
  const [att, pajsk, ann, cal, par] = await Promise.all([
    fetchCSV(CONFIG.urls.attendance),
    fetchCSV(CONFIG.urls.pajsk),
    fetchCSV(CONFIG.urls.announcements),
    fetchCSV(CONFIG.urls.calendar),
    fetchCSV(CONFIG.urls.parents)
  ]);
  DATA = { att, pajsk, ann, cal, par };
  processAttendance();
  renderAnn();
  initPajsk();
  renderParents();
  renderCalendar();
}

/* ================= ATTENDANCE ================= */
function processAttendance() {
  if(!DATA.att.length) return;
  
  DATA_ATT_CLEAN = DATA.att.map(r => {
    const dStr = getVal(r, 'TARIKH');
    const isoDate = parseDateStr(dStr);
    
    return {
      date: dStr, 
      isoDate: isoDate, // YYYY-MM-DD
      rawDate: new Date(isoDate),
      name: getVal(r, 'NAMA'),
      kelas: getVal(r, 'KELAS'),
      gender: getVal(r, 'JANTINA') || '-',
      status: getVal(r, 'STATUS').toUpperCase()
    };
  }).filter(r => r.isoDate && !isNaN(r.rawDate));

  DATA_ATT_CLEAN.sort((a,b) => b.rawDate - a.rawDate);

  // Global Stats (Today)
  const todayStr = new Date().toISOString().split('T')[0];
  const todayRecs = DATA_ATT_CLEAN.filter(r => r.isoDate === todayStr);
  const present = todayRecs.filter(r => r.status === 'HADIR').length;
  const absent = todayRecs.filter(r => r.status.includes('TIDAK')).length;
  
  document.getElementById('dToday').innerText = present;
  document.getElementById('dAbsent').innerText = `${absent} Tidak Hadir`;
  document.getElementById('dWeek').innerText = DATA_ATT_CLEAN.length;
  document.getElementById('dPct').innerText = DATA_ATT_CLEAN.length ? Math.round((present/(todayRecs.length||1))*100) + "%" : "0%";

  populateAttSelectors();
  renderAttTable(DATA_ATT_CLEAN);
  updateAttStats(DATA_ATT_CLEAN);
  renderTrend();
}

function renderAttTable(data) {
  const tb = document.getElementById('attBody');
  tb.innerHTML = data.slice(0,100).map(r => `
    <tr>
      <td>${r.date}</td><td><strong>${r.name}</strong></td><td>${r.kelas}</td><td>${r.gender}</td>
      <td><span class="badge ${r.status==='HADIR'?'b-green':'b-red'}">${r.status}</span></td>
    </tr>`).join('');
  document.getElementById('attCount').innerText = `Papar: ${Math.min(data.length,100)} / ${data.length} rekod.`;
}

function updateAttStats(data) {
  const p = data.filter(r => r.status==='HADIR').length;
  const a = data.filter(r => r.status.includes('TIDAK')).length;
  const t = data.length;
  document.getElementById('attStatHadir').innerText = p;
  document.getElementById('attStatTidak').innerText = a;
  document.getElementById('attStatTotal').innerText = t;
  document.getElementById('attStatPct').innerText = t ? Math.round((p/t)*100)+"%" : "0%";
}

function applyFilterAtt() {
  const q = document.getElementById('searchAtt').value.toLowerCase();
  const c = document.getElementById('filterClassAtt').value;
  const s = document.getElementById('filterStatusAtt').value;
  const g = document.getElementById('filterGenderAtt').value;
  const start = document.getElementById('filterDateStart').value;
  const end = document.getElementById('filterDateEnd').value;

  const filtered = DATA_ATT_CLEAN.filter(r => {
    let dOk = true;
    if(start && end) {
      dOk = r.isoDate >= start && r.isoDate <= end;
    }
    return dOk && (!q || r.name.toLowerCase().includes(q)) &&
           (!c || r.kelas === c) && (!g || r.gender.toUpperCase() === g) &&
           (!s || (s==='HADIR'?r.status==='HADIR':r.status.includes('TIDAK')));
  });
  renderAttTable(filtered);
  updateAttStats(filtered);
}

function resetFilterAtt() {
  document.getElementById('searchAtt').value = '';
  document.getElementById('filterClassAtt').value = '';
  document.getElementById('filterStatusAtt').value = '';
  document.getElementById('filterGenderAtt').value = '';
  document.getElementById('filterDateStart').value = '';
  document.getElementById('filterDateEnd').value = '';
  renderAttTable(DATA_ATT_CLEAN);
  updateAttStats(DATA_ATT_CLEAN);
}

function populateAttSelectors() {
  const classes = [...new Set(DATA_ATT_CLEAN.map(r => r.kelas))].sort();
  const opts = '<option value="">Semua Kelas</option>' + classes.map(c=>`<option value="${c}">${c}</option>`).join('');
  document.getElementById('filterClassAtt').innerHTML = opts;
  document.getElementById('trendClass').innerHTML = opts;
}

/* ================= PAJSK ================= */
function initPajsk() {
  // Clean empty rows first
  const cleanPajsk = DATA.pajsk.filter(r => getVal(r,'NAMA') || getVal(r,'TARIKH'));
  DATA.pajsk = cleanPajsk;

  const pop = (id, key) => {
    const vals = [...new Set(DATA.pajsk.map(r => getVal(r, key)))].filter(Boolean).sort();
    document.getElementById(id).innerHTML = '<option value="">Semua</option>' + vals.map(v=>`<option>${v}</option>`).join('');
  };
  pop('fPajskUnit', 'UNIT');
  pop('fPajskKelas', 'KELAS');
  pop('fPajskLibat', 'PENGLIBATAN');
  pop('fPajskCapai', 'PENCAPAIAN');
  renderPajskTable();
}

function renderPajskTable() {
  if(!DATA.pajsk.length) { document.getElementById('pajskBody').innerHTML='<tr><td colspan="7">Tiada Data.</td></tr>'; return; }
  
  const q = document.getElementById('searchPajsk').value.toLowerCase();
  const fDate = document.getElementById('fPajskDate').value;
  const fUnit = document.getElementById('fPajskUnit').value;
  const fKelas = document.getElementById('fPajskKelas').value;
  const fLibat = document.getElementById('fPajskLibat').value;
  const fCapai = document.getElementById('fPajskCapai').value;

  const filtered = DATA.pajsk.filter(r => {
    const name = (getVal(r, 'NAMA')||"").toLowerCase();
    const acara = (getVal(r, 'ACARA')||"").toLowerCase();
    const searchMatch = !q || name.includes(q) || acara.includes(q);
    
    // Parse CSV Date
    const dStr = getVal(r, 'TARIKH');
    const iso = parseDateStr(dStr); 
    
    return searchMatch &&
           (!fDate || iso === fDate) &&
           (!fUnit || getVal(r,'UNIT') === fUnit) &&
           (!fKelas || getVal(r,'KELAS') === fKelas) &&
           (!fLibat || getVal(r,'PENGLIBATAN') === fLibat) &&
           (!fCapai || getVal(r,'PENCAPAIAN') === fCapai);
  });

  document.getElementById('pajskBody').innerHTML = filtered.map(r => `
    <tr>
      <td>${getVal(r,'TARIKH')}</td>
      <td>${getVal(r,'UNIT')}</td>
      <td>${getVal(r,'KELAS')}</td>
      <td><strong>${getVal(r,'NAMA')}</strong></td>
      <td>${getVal(r,'ACARA')}</td>
      <td>${getVal(r,'PENGLIBATAN')}</td>
      <td><span class="badge b-green">${getVal(r,'PENCAPAIAN')}</span></td>
    </tr>
  `).join('');
}

function resetPajskFilters() {
  document.getElementById('searchPajsk').value = '';
  document.getElementById('fPajskDate').value = '';
  document.querySelectorAll('#pajskFilters select').forEach(s => s.value='');
  renderPajskTable();
}

/* ================= ANNOUNCEMENT & DASHBOARD ================= */
function renderAnn() {
  const today = new Date().toISOString().split('T')[0];
  const list = DATA.ann.filter(a => {
    // If user inputs 28/12/2025, convert to 2025-12-28
    const start = parseDateStr(getVal(a, 'MULA'));
    const end = parseDateStr(getVal(a, 'TAMAT'));
    const title = getVal(a, 'TAJUK');
    if(!title) return false;
    
    // Logic: Active if today >= start AND (no end date OR today <= end)
    if(start && today < start) return false;
    if(end && today > end) return false;
    return true;
  });

  document.getElementById('dAnn').innerText = list.length;

  document.getElementById('annGrid').innerHTML = list.map(a => {
    const t = getVal(a, 'TAJUK') || 'Info';
    const c = getVal(a, 'KANDUNGAN') || '-';
    const date = getVal(a, 'TARIKH') || getVal(a, 'MULA') || '';
    
    return `<div class="card clickable" onclick="openInfoModal('${escapeHtml(t)}', '${escapeHtml(c)}')">
      <div style="display:flex; justify-content:space-between; margin-bottom:10px">
        <span class="badge b-blue">INFO</span>
        <span style="font-size:11px; color:var(--text-muted)">${date}</span>
      </div>
      <h4 style="margin:0 0 10px;">${t}</h4>
      <p style="font-size:13px; color:var(--text-muted); display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden;">${c}</p>
    </div>`;
  }).join('');
}

/* ================= PARENTS & OTHERS ================= */
function renderParents() {
  document.getElementById('parentsGrid').innerHTML = DATA.par.map(p => {
    const url = getVal(p, 'PAUTAN') || getVal(p, 'URL');
    return `<div class="card clickable" onclick="window.open('${url||'#'}', '_blank')">
      <h4 style="margin:0 0 10px 0; color:var(--primary)">${getVal(p,'TAJUK')||'Info'}</h4>
      <p style="font-size:13px; color:var(--text-muted); margin:0;">${getVal(p,'KANDUNGAN')}</p>
      ${url?'<div style="margin-top:15px; font-size:12px; color:var(--accent); font-weight:600;">Klik untuk buka &nearr;</div>':''}
    </div>`;
  }).join('');
}

function renderCalendar() {
  if(!DATA.cal.length) return;
  const k=Object.keys(DATA.cal[0]);
  document.getElementById('calHead').innerHTML=`<tr>${k.map(x=>`<th>${x}</th>`).join('')}</tr>`;
  document.getElementById('calBody').innerHTML=DATA.cal.map(r=>`<tr>${k.map(x=>`<td>${r[x]}</td>`).join('')}</tr>`).join('');
}

function renderTrend() {
  if(!DATA_ATT_CLEAN.length) return;
  const mode = document.getElementById('trendType').value;
  const mo = parseInt(document.getElementById('trendMonth').value);
  const yr = parseInt(document.getElementById('trendYear').value);
  const cl = document.getElementById('trendClass').value;

  const filtered = DATA_ATT_CLEAN.filter(r => r.rawDate.getMonth()===mo && r.rawDate.getFullYear()===yr && (!cl || r.kelas===cl));
  const daysInMonth = new Date(yr, mo+1, 0).getDate();
  let points = [];
  let maxVal = 0;

  for(let d=1; d<=daysInMonth; d++) {
    const dayRecs = filtered.filter(r => r.rawDate.getDate()===d);
    let val = 0;
    if(mode==='hadir') val = dayRecs.filter(r=>r.status==='HADIR').length;
    else if(mode==='tidak') val = dayRecs.filter(r=>r.status.includes('TIDAK')).length;
    else { if(dayRecs.length) val = (dayRecs.filter(r=>r.status==='HADIR').length / dayRecs.length) * 100; }
    if(val > maxVal) maxVal = val;
    points.push({x:d, y:val});
  }
  if(mode==='pct') maxVal = 100;
  if(maxVal===0) maxVal = 10;

  const W=900, H=280, Pad=30;
  const innerW = W - Pad*2;
  const innerH = H - Pad*2;
  const path = points.map((p,i) => {
    const px = Pad + (i * (innerW / (daysInMonth-1)));
    const py = (H - Pad) - (p.y / maxVal) * innerH;
    return `${px},${py}`;
  }).join(' ');

  document.getElementById('chartContainer').innerHTML = `
    <svg viewBox="0 0 ${W} ${H}" width="100%" height="100%" style="background:var(--bg-card); border-radius:12px;">
      <polyline points="${path}" fill="none" stroke="var(--primary)" stroke-width="3" />
      <text x="${Pad}" y="20" fill="var(--text-muted)" font-size="12">Max: ${Math.round(maxVal)}</text>
    </svg>`;
}

function setupTrendSelectors() {
  const m = ["Jan","Feb","Mac","Apr","Mei","Jun","Jul","Ogos","Sep","Okt","Nov","Dis"];
  document.getElementById('trendMonth').innerHTML = m.map((n,i)=>`<option value="${i}">${n}</option>`).join('');
  document.getElementById('trendMonth').value = new Date().getMonth();
  const y = new Date().getFullYear();
  document.getElementById('trendYear').innerHTML = `<option value="${y-1}">${y-1}</option><option value="${y}" selected>${y}</option>`;
}

/* ================= MODAL & SETTINGS ================= */
function openInfoModal(title, body) {
  document.getElementById('infoTitle').innerText = title;
  document.getElementById('infoBody').innerText = body;
  document.getElementById('infoModal').classList.add('active');
}

function openSettings() {
  document.getElementById('settingsModal').classList.add('active');
  document.getElementById('pinInput').value = '';
  document.getElementById('pinStep').style.display = 'block';
  document.getElementById('settingStep').style.display = 'none';
}
function closeSettings() { document.getElementById('settingsModal').classList.remove('active'); }
function checkPin() {
  if(document.getElementById('pinInput').value === CONFIG.pin) {
    document.getElementById('pinStep').style.display = 'none';
    document.getElementById('settingStep').style.display = 'block';
    populateSettings();
  } else alert('Salah PIN');
}
function populateSettings() {
  document.getElementById('setName').value = CONFIG.schoolName;
  document.getElementById('setUrlAtt').value = CONFIG.urls.attendance;
  document.getElementById('setUrlPajsk').value = CONFIG.urls.pajsk;
  document.getElementById('setUrlAnn').value = CONFIG.urls.announcements;
  document.getElementById('menuManagerList').innerHTML = CONFIG.menus.map((m,i) => `
    <div class="menu-toggle-item">
      <span>${m.label}</span>
      <input type="checkbox" ${!m.hidden?'checked':''} id="menu_${i}">
    </div>
  `).join('');
}
function saveSettings() {
  CONFIG.schoolName = document.getElementById('setName').value;
  CONFIG.urls.attendance = document.getElementById('setUrlAtt').value;
  CONFIG.urls.pajsk = document.getElementById('setUrlPajsk').value;
  CONFIG.urls.announcements = document.getElementById('setUrlAnn').value;
  CONFIG.menus.forEach((m,i) => m.hidden = !document.getElementById(`menu_${i}`).checked);
  localStorage.setItem('portalConfig', JSON.stringify(CONFIG));
  location.reload();
}

function loadAttendance(m){ if(m)alert('Loading...'); fetchCSV(CONFIG.urls.attendance).then(d=>{DATA.att=d;processAttendance();}); }
function loadPajsk(m){ if(m)alert('Loading...'); fetchCSV(CONFIG.urls.pajsk).then(d=>{DATA.pajsk=d;initPajsk();}); }
function loadAnnouncements(m){ if(m)alert('Loading...'); fetchCSV(CONFIG.urls.announcements).then(d=>{DATA.ann=d;renderAnn();}); }

function toggleTheme() {
  const n = document.documentElement.getAttribute('data-mode')==='dark'?'light':'dark';
  document.documentElement.setAttribute('data-mode', n);
  localStorage.setItem('theme', n);
  renderTrend();
}
function applyTheme() { document.documentElement.setAttribute('data-mode', localStorage.getItem('theme')||'light'); }
function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }

init();
</script>
</body>
</html>
