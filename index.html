<!doctype html>
<html lang="ms" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portal Rasmi PPKI SK Paya Resak</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

  <style>
    /* === CSS UTAMA === */
    :root {
      --font-main: 'Poppins', sans-serif;
      --bg-body: #F2F4F7;
      --bg-sidebar: #FFFFFF;
      --bg-card: #FFFFFF;
      --border-color: #EAECF0;
      --text-main: #101828;
      --text-muted: #667085;
      --primary: #1F6F4A; 
      --primary-light: #E8F5E9;
      --accent: #F79009;
      --radius-card: 16px;
      --sidebar-w-full: 260px;
    }

    /* Dark Mode */
    html[data-mode="dark"] {
      --bg-body: #0F1115;
      --bg-sidebar: #161B22;
      --bg-card: #1C2128;
      --border-color: #30363D;
      --text-main: #F0F6FC;
      --text-muted: #8B949E;
      --primary: #2EA043;
      --primary-light: rgba(46, 160, 67, 0.15);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; font-family: var(--font-main); background: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; }
    .app-container { display: flex; height: 100%; width: 100%; }

    /* Sidebar */
    .sidebar {
      background: var(--bg-sidebar); border-right: 1px solid var(--border-color);
      display: flex; flex-direction: column; padding: 20px 12px;
      transition: width 0.3s ease; z-index: 50; flex-shrink: 0; overflow-x: hidden;
      width: var(--sidebar-w-full);
    }
    @media (max-width: 768px) {
      .sidebar { position: fixed; left: -100%; top: 0; height: 100%; width: 260px; box-shadow: 5px 0 25px rgba(0,0,0,0.2); }
      body.mobile-active .sidebar { left: 0; }
      .backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; display: none; }
      body.mobile-active .backdrop { display: block; }
    }

    /* Branding */
    .brand { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; min-height: 45px; }
    .brand-logo img { width: 40px; height: 40px; border-radius: 8px; object-fit: contain; }
    .brand-text h1 { margin: 0; font-size: 15px; font-weight: 700; }
    .brand-text p { margin: 0; font-size: 11px; color: var(--text-muted); }

    /* Menu Navigation */
    .nav-menu { flex: 1; display: flex; flex-direction: column; gap: 6px; overflow-y: auto; }
    .nav-item {
      display: flex; align-items: center; gap: 12px; padding: 12px 14px;
      border-radius: 10px; cursor: pointer; color: var(--text-muted);
      text-decoration: none; transition: all 0.2s; white-space: nowrap;
    }
    .nav-item:hover { background: var(--bg-card); color: var(--text-main); }
    .nav-item.active { background: var(--primary-light); color: var(--primary); font-weight: 600; }
    .nav-icon { font-size: 22px; }

    /* Login Button Sidebar */
    .btn-login-sidebar {
      width: 100%; background: var(--primary); color: white; border: none; padding: 10px;
      border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; 
      align-items: center; justify-content: center; gap: 8px; margin-bottom: 10px;
    }
    .btn-login-sidebar:hover { background: #145c3c; }

    /* Main Area */
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
    .top-bar {
      height: 64px; display: flex; align-items: center; justify-content: space-between;
      padding: 0 24px; background: var(--bg-body); flex-shrink: 0;
    }
    .icon-btn {
      width: 40px; height: 40px; border-radius: 8px; border: none; background: transparent;
      color: var(--text-main); display: grid; place-items: center; cursor: pointer; font-size: 24px;
    }
    .icon-btn:hover { background: rgba(0,0,0,0.05); }

    .content-area { flex: 1; overflow-y: auto; padding: 10px 24px 40px 24px; }
    
    /* Cards & Grids */
    .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 24px; }
    .card { background: var(--bg-card); padding: 20px; border-radius: var(--radius-card); border: 1px solid var(--border-color); }
    .stat-val { font-size: 28px; font-weight: 700; margin: 5px 0; color: var(--text-main); }
    .stat-label { font-size: 13px; color: var(--text-muted); }
    .clickable { cursor: pointer; transition: transform 0.2s; }
    .clickable:hover { transform: translateY(-3px); border-color: var(--primary); }

    .page-banner {
      background: linear-gradient(135deg, var(--primary), #144d33); color: white;
      padding: 24px; border-radius: 16px; margin-bottom: 24px;
      display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;
    }
    .btn-action {
      background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);
      padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px;
    }

    /* Tables & Badges */
    .table-wrap { overflow-x: auto; border-radius: 12px; border: 1px solid var(--border-color); }
    table { width: 100%; border-collapse: collapse; min-width: 800px; font-size: 13px; }
    th { text-align: left; padding: 14px 16px; background: rgba(0,0,0,0.02); color: var(--text-muted); font-weight: 600; }
    td { padding: 14px 16px; border-top: 1px solid var(--border-color); color: var(--text-main); }
    .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
    .b-green { background: #ECFDF3; color: #027A48; }
    .b-red { background: #FEF3F2; color: #B42318; }
    .b-blue { background: #EFF8FF; color: #175CD3; }

    /* Modals */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100;
      display: none; place-items: center; backdrop-filter: blur(2px);
    }
    .modal-overlay.active { display: grid; }
    .modal-content {
      width: 90%; max-width: 500px; background: var(--bg-card);
      border-radius: 16px; padding: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    .form-select, .form-input {
      background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-main);
      padding: 10px 12px; border-radius: 8px; width: 100%; margin-bottom: 10px;
    }
    .btn-primary { background: var(--primary); color: white; padding: 10px 16px; border-radius: 8px; border: none; cursor: pointer; width: 100%; }

    /* Responsive */
    @media (max-width: 1024px) { .dashboard-grid { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 768px) { .dashboard-grid { grid-template-columns: 1fr; } }

    /* PRINT (Surat Rasmi) */
    @media print {
      .sidebar, .top-bar, .page-banner, .btn-action, .search-bar-container, .modal-overlay { display: none !important; }
      .app-container, .main-content, .content-area { display: block; height: auto; overflow: visible; padding: 0; margin: 0; }
      .card { border: none; padding: 0; }
      table { border: 1px solid black; font-size: 12pt; width: 100%; }
      th, td { border: 1px solid black; color: black; padding: 5px; }
      .print-header { display: block !important; text-align: center; margin-bottom: 20px; }
    }
    .print-header { display: none; }
  </style>
</head>
<body>

<div class="backdrop" onclick="toggleSidebar()"></div>

<div class="app-container" id="appContainer">
  
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <div class="brand-logo"><img src="https://i.ibb.co/Y7sp2wZg/SKPR-1.png" alt="Logo"></div>
      <div class="brand-text"><h1>SK Paya Resak</h1><p>Moving Forward</p></div>
    </div>
    
    <nav class="nav-menu" id="sidebarMenu"></nav>

    <div style="margin-top:auto; text-align:center;">
      <div id="authSection"></div> <div style="font-size:10px; color:var(--text-muted); margin-top:10px;">Â© 2025 Portal PPKI</div>
    </div>
  </aside>

  <main class="main-content">
    <header class="top-bar">
      <button class="icon-btn" onclick="toggleSidebar()"><span class="material-icons-round">menu</span></button>
      <div style="display:flex; gap:8px;">
        <button class="icon-btn" onclick="toggleTheme()"><span class="material-icons-round">dark_mode</span></button>
        <button class="icon-btn" id="btnSettings" onclick="openSettings()" style="display:none;"><span class="material-icons-round">settings</span></button>
      </div>
    </header>

    <div class="content-area">
      
      <div id="page-home" class="page-section">
        <div class="page-banner">
          <div class="banner-text"><h2>Dashboard</h2><p>Selamat Datang ke Portal Rasmi PPKI</p></div>
        </div>
        <div class="dashboard-grid">
          <div class="card clickable" onclick="navTo('attendance')">
            <div class="stat-label">Kehadiran Hari Ini</div>
            <div class="stat-val" id="dToday">-</div>
            <div style="font-size:12px; color:#D92D20; font-weight:600;" id="dAbsent">0 Tidak Hadir</div>
          </div>
          <div class="card clickable" onclick="navTo('announcements')">
            <div class="stat-label">Pengumuman Aktif</div>
            <div class="stat-val" id="dAnn">-</div>
            <div class="stat-label">Info Terkini</div>
          </div>
          <div class="card clickable" onclick="navTo('calendar')">
             <div class="stat-label">Takwim</div>
             <div class="stat-val"><span class="material-icons-round" style="font-size:32px">calendar_month</span></div>
             <div class="stat-label">Aktiviti Sekolah</div>
          </div>
        </div>
        
        <div class="card">
           <h3 style="font-size:16px; margin-top:0;">ðŸ“ˆ Trend Kehadiran</h3>
           <div id="chartContainer" style="height:200px; width:100%;"></div>
        </div>
      </div>

      <div id="page-attendance" class="page-section" style="display:none;">
        <div class="page-banner">
          <div class="banner-text"><h2>Kehadiran</h2><p>Rekod Kedatangan Murid</p></div>
          <button class="btn-action" onclick="window.print()">Cetak</button>
        </div>
        <div class="card">
          <div class="print-header"><h2>Laporan Kehadiran</h2><p>SK Paya Resak</p></div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>Tarikh</th><th>Nama</th><th>Kelas</th><th>Status</th></tr></thead>
              <tbody id="attBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="page-announcements" class="page-section" style="display:none;">
        <div class="page-banner"><div class="banner-text"><h2>Pengumuman</h2><p>Info Terkini</p></div></div>
        <div class="dashboard-grid" id="annGrid" style="grid-template-columns: 1fr 1fr;"></div>
      </div>

       <div id="page-pajsk" class="page-section" style="display:none;">
        <div class="page-banner">
            <div class="banner-text"><h2>PAJSK</h2><p>Pencapaian Kokurikulum</p></div>
            <button class="btn-action" onclick="window.print()">Cetak</button>
        </div>
        <div class="card">
            <div class="print-header"><h2>Laporan PAJSK</h2></div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Tarikh</th><th>Nama</th><th>Acara</th><th>Pencapaian</th></tr></thead>
                    <tbody id="pajskBody"></tbody>
                </table>
            </div>
        </div>
      </div>

      <div id="page-calendar" class="page-section" style="display:none;">
        <div class="page-banner"><div class="banner-text"><h2>Takwim</h2></div></div>
        <div class="card"><div class="table-wrap"><table><thead id="calHead"></thead><tbody id="calBody"></tbody></table></div></div>
      </div>

      <div id="page-parents" class="page-section" style="display:none;">
        <div class="page-banner"><div class="banner-text"><h2>Info Ibu Bapa</h2></div></div>
        <div class="dashboard-grid" id="parentsGrid"></div>
      </div>

    </div>
  </main>
</div>

<div class="modal-overlay" id="loginModal">
  <div class="modal-content" style="text-align:center;">
    <div style="display:flex; justify-content:flex-end;"><button class="icon-btn" onclick="document.getElementById('loginModal').classList.remove('active')">close</button></div>
    <span class="material-icons-round" style="font-size:48px; color:var(--primary);">lock</span>
    <h3>Log Masuk Portal</h3>
    <p style="color:var(--text-muted);">Khas untuk Guru & Ibu Bapa</p>
    <button id="btnLoginGoogle" class="btn-primary" style="margin-top:10px;">Login dengan Google</button>
  </div>
</div>

<div class="modal-overlay" id="infoModal">
  <div class="modal-content">
    <div style="display:flex; justify-content:space-between;"><h3 id="infoTitle" style="margin:0"></h3><button class="icon-btn" onclick="document.getElementById('infoModal').classList.remove('active')">close</button></div>
    <div id="infoBody" style="margin-top:15px; color:var(--text-main);"></div>
  </div>
</div>

<div class="modal-overlay" id="settingsModal">
  <div class="modal-content">
    <h3>Tetapan Portal</h3>
    <label style="font-size:12px; font-weight:bold;">Nama Sekolah</label>
    <input id="setName" class="form-input">
    <button onclick="saveSettings()" class="btn-primary">Simpan</button>
    <button onclick="document.getElementById('settingsModal').classList.remove('active')" class="btn-primary" style="background:transparent; color:red; margin-top:10px;">Tutup</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  // 1. CONFIG FIREBASE 
  const firebaseConfig = {
    apiKey: "AIzaSyDdDlLNMjcOfi-6tfeaS_PcicQcnsqxaOk",
    authDomain: "portalppkiskpr-ecd1c.firebaseapp.com",
    projectId: "portalppkiskpr-ecd1c",
    storageBucket: "portalppkiskpr-ecd1c.firebasestorage.app",
    messagingSenderId: "643002702082",
    appId: "1:643002702082:web:7bac296fa189fa2f41ca1b"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  // 2. SENARAI ADMIN
  const adminEmails = ["naimullahkhalid@gmail.com", "cikgu_disiplin232@gmail.com"];

  let currentUserRole = 'public'; // Default: Tetamu

  // 3. LOGIC LOGIN & ROLE
  const btnSettings = document.getElementById('btnSettings');
  const authSection = document.getElementById('authSection');

  onAuthStateChanged(auth, (user) => {
    if (user) {
        // Jika Login Berjaya
        if (adminEmails.includes(user.email)) {
            currentUserRole = 'admin';
            btnSettings.style.display = 'grid'; // Admin nampak butang setting
        } else {
            currentUserRole = 'parent';
            btnSettings.style.display = 'none';
        }
        
        // Tukar paparan di Sidebar
        authSection.innerHTML = `
            <div style="font-weight:600; font-size:12px;">Hai, ${user.displayName.split(' ')[0]}</div>
            <div style="font-size:10px; color:var(--primary);">Akses: ${currentUserRole.toUpperCase()}</div>
            <button onclick="window.doLogout()" style="background:none; border:none; color:red; cursor:pointer; font-size:11px; margin-top:5px;">Log Keluar</button>
        `;
        document.getElementById('loginModal').classList.remove('active');
    } else {
        // Jika Tetamu (Public)
        currentUserRole = 'public';
        btnSettings.style.display = 'none';
        authSection.innerHTML = `<button class="btn-login-sidebar" onclick="document.getElementById('loginModal').classList.add('active')">Log Masuk</button>`;
    }
    
    // Render semula menu ikut role baru
    renderSidebar();
    
    // Jika Public cuba masuk page Parent (cth: Kehadiran), tendang ke home
    if(currentUserRole === 'public') window.navTo('home');
  });

  document.getElementById('btnLoginGoogle').addEventListener('click', () => {
    signInWithPopup(auth, provider).catch(e => alert("Error: " + e.message));
  });

  window.doLogout = function() {
    if(confirm("Log keluar?")) signOut(auth).then(() => location.reload());
  }

  // 4. CONFIG DATA (Menu & CSV Links)
  const DEFAULTS = {
    schoolName: "SK Paya Resak",
    urls: {
      attendance: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTKhex5gcCHKoiLqRZpgVRMRfrGGvPtbgc3jo_Q-3FPL5OpcoWvyAnec0dTgykrpkYuS34iNJnEAkDU/pub?gid=880667725&single=true&output=csv",
      pajsk: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRGcqw1v5SRbEL_2LMhX9I_X8uIo5CTQRzOpY5nTlbSc8_6Q4cx56LWtTI3-I5D9pJYeS20nEgADikT/pub?gid=0&single=true&output=csv",
      announcements: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQvKlO-LRGh8kj_-Be6NxZRR3Z38rjbC33jyvfhQvnR9L4LF7_dZRVXYGK3XO7bAoJwC9bJJmABjV6Z/pub?gid=946270411&single=true&output=csv",
      parents: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ_G1txQOE4Di1XsK6esbw8VgQtW2hcPsjzAmPH7V82JOeXegb7Kb_3Iz8CeHo-KvfvHe9x8BWtSfbB/pub?gid=1684744050&single=true&output=csv",
      calendar: ""
    },
    // TETAPKAN SIAPA BOLEH TENGOK MENU MANA
    menus: [
      {id:'home', label:'Dashboard', icon:'dashboard', roles:['public','parent','admin']},
      {id:'attendance', label:'Kehadiran', icon:'analytics', roles:['parent','admin']}, // Khas Parent & Admin
      {id:'pajsk', label:'PAJSK', icon:'emoji_events', roles:['parent','admin']}, // Khas Parent & Admin
      {id:'announcements', label:'Pengumuman', icon:'campaign', roles:['public','parent','admin']},
      {id:'calendar', label:'Takwim', icon:'calendar_month', roles:['public','parent','admin']},
      {id:'parents', label:'Ibu Bapa', icon:'diversity_3', roles:['parent','admin']} // Khas Parent & Admin
    ]
  };

  let CONFIG = JSON.parse(localStorage.getItem('portalConfig')) || DEFAULTS;
  let DATA = { att:[], pajsk:[], ann:[], cal:[], par:[] };

  // 5. FUNGSI UI & DATA
  window.navTo = function(id) {
    document.querySelectorAll('.page-section').forEach(e => e.style.display='none');
    const target = document.getElementById(`page-${id}`);
    if(target) target.style.display='block';
    
    document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
    const navBtn = document.getElementById(`nav-${id}`);
    if(navBtn) navBtn.classList.add('active');
    
    if(window.innerWidth <= 768) document.body.classList.remove('mobile-active');
  }

  function renderSidebar() {
    const nav = document.getElementById('sidebarMenu');
    nav.innerHTML = '';
    
    CONFIG.menus.forEach(m => {
      // Check Adakah Role sekarang dibenarkan?
      let allowed = false;
      if(currentUserRole === 'admin') allowed = true; // Admin sapu semua
      else if(m.roles.includes(currentUserRole)) allowed = true;
      else if(currentUserRole === 'parent' && m.roles.includes('public')) allowed = true;

      if(allowed) {
          const div = document.createElement('div');
          div.className = `nav-item ${m.id==='home'?'active':''}`;
          div.id = `nav-${m.id}`;
          div.innerHTML = `<span class="material-icons-round nav-icon">${m.icon}</span> ${m.label}`;
          div.onclick = () => window.navTo(m.id);
          nav.appendChild(div);
      }
    });
  }

  // Fetch Data CSV
  async function loadData() {
    const fetchC = async (u) => { try { const r = await fetch(u); const t = await r.text(); return parseCSV(t); } catch(e){ return []; } };
    
    const [att, pajsk, ann, cal, par] = await Promise.all([
        fetchC(CONFIG.urls.attendance), fetchC(CONFIG.urls.pajsk), 
        fetchC(CONFIG.urls.announcements), fetchC(CONFIG.urls.calendar), fetchC(CONFIG.urls.parents)
    ]);
    DATA = { att, pajsk, ann, cal, par };
    
    // Render Tables
    renderTable('attBody', DATA.att, ['TARIKH','NAMA','KELAS','STATUS']);
    renderTable('pajskBody', DATA.pajsk, ['TARIKH','NAMA','ACARA','PENCAPAIAN']);
    renderTable('calBody', DATA.cal, Object.keys(DATA.cal[0]||{}));
    
    // Render Stats
    const hadir = DATA.att.filter(r=> (r['STATUS']||'').toUpperCase() === 'HADIR').length;
    document.getElementById('dToday').innerText = hadir;
    document.getElementById('dAnn').innerText = DATA.ann.length;
    
    // Render Grid
    document.getElementById('annGrid').innerHTML = DATA.ann.map(a => 
      `<div class="card clickable" onclick="alert('${a['KANDUNGAN']||''}')"><h4>${a['TAJUK']}</h4><small>${a['TARIKH']}</small></div>`
    ).join('');

    document.getElementById('parentsGrid').innerHTML = DATA.par.map(p => 
      `<div class="card clickable" onclick="window.open('${p['URL']||'#'}')"><h4>${p['TAJUK']}</h4><small>${p['KANDUNGAN']}</small></div>`
    ).join('');
    
    renderGraph();
  }

  function parseCSV(text) {
    const rows = text.split('\n').map(r => r.split(','));
    const h = rows[0].map(x => x.trim().toUpperCase());
    return rows.slice(1).map(row => {
      let obj = {}; h.forEach((k, i) => obj[k] = (row[i]||'').trim()); return obj;
    });
  }

  function renderTable(id, data, cols) {
    const tb = document.getElementById(id);
    if(!data.length) { tb.innerHTML='<tr><td colspan="4">Tiada Data</td></tr>'; return; }
    tb.innerHTML = data.slice(0,50).map(r => 
      `<tr>${cols.map(c => `<td>${r[c]||'-'}</td>`).join('')}</tr>`
    ).join('');
  }

  function renderGraph() {
     const container = document.getElementById('chartContainer');
     container.innerHTML = `<svg width="100%" height="100%" viewBox="0 0 400 100">
        <polyline points="0,100 50,20 100,40 150,10 200,50 250,30 300,80 350,10 400,90" 
        style="fill:none;stroke:var(--primary);stroke-width:3" />
     </svg>`;
  }

  // UI Helpers
  window.toggleSidebar = () => {
    const b = document.body;
    if(window.innerWidth > 768) b.classList.toggle('desktop-mini');
    else b.classList.toggle('mobile-active');
  }
  window.toggleTheme = () => {
     const mode = document.documentElement.getAttribute('data-mode')==='dark'?'light':'dark';
     document.documentElement.setAttribute('data-mode', mode);
  }
  window.openSettings = () => document.getElementById('settingsModal').classList.add('active');
  window.saveSettings = () => {
      CONFIG.schoolName = document.getElementById('setName').value;
      localStorage.setItem('portalConfig', JSON.stringify(CONFIG));
      location.reload();
  }

  // INIT
  loadData();
  document.querySelector('.brand-text h1').textContent = CONFIG.schoolName;
  document.getElementById('setName').value = CONFIG.schoolName;

</script>
</body>
</html>
