<!doctype html>
<html lang="ms" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portal Rasmi PPKI SK Paya Resak</title>

  <style>
    :root{
      --bg: #0b1220;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --border: rgba(255,255,255,.12);
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --accent: #2AA198;
      --accent2:#1F4D3A;
      --danger:#ef4444;
      --warn:#f59e0b;
      --ok:#22c55e;
      --chip: rgba(255,255,255,.07);
      --chip2: rgba(255,255,255,.10);
      --focus: rgba(42,161,152,.35);
      --radius: 18px;
      --radius2: 22px;
      --sidebarW: 292px;
      --sidebarWC: 86px; /* (kekal untuk masa depan, tapi kita tak guna collapsed icons lagi) */
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    /* Light theme variables */
    html[data-mode="light"]{
      --bg: #eaf4ea;
      --panel: rgba(255,255,255,.75);
      --panel2: rgba(255,255,255,.92);
      --text: rgba(17,24,39,.92);
      --muted: rgba(17,24,39,.60);
      --border: rgba(17,24,39,.12);
      --shadow: 0 14px 40px rgba(17,24,39,.12);
      --chip: rgba(17,24,39,.06);
      --chip2: rgba(17,24,39,.10);
      --focus: rgba(42,161,152,.25);
    }

    /* Preset accents */
    html[data-preset="forest"]{ --accent2:#1F4D3A; --accent:#2AA198; }
    html[data-preset="ocean"]{ --accent2:#0b3d91; --accent:#22a3d6; }
    html[data-preset="sunset"]{ --accent2:#7c2d12; --accent:#f97316; }
    html[data-preset="violet"]{ --accent2:#4c1d95; --accent:#a78bfa; }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      background:
        radial-gradient(1100px 700px at 20% -10%, rgba(42,161,152,.25), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(31,77,58,.25), transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    a{ color:inherit; text-decoration:none; }
    button,input,select,textarea{ font-family:inherit; }

    /* Layout */
    .app{ display:flex; min-height:100vh; }

    .sidebar{
      width: var(--sidebarW);
      background: linear-gradient(180deg, rgba(0,0,0,.25), transparent 42%),
                  rgba(255,255,255,.04);
      border-right: 1px solid var(--border);
      padding: 16px 14px;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow: hidden;
      transition: width .22s ease, transform .22s ease, opacity .15s ease;
      backdrop-filter: blur(10px);
    }
    html[data-mode="light"] .sidebar{ background: rgba(255,255,255,.55); }

    /* ‚úÖ Desktop "hide totally" (no mini icons, no collapsed sidebar) */
    body.sidebar-hidden .sidebar{
      display:none !important;
    }

    .brand{
      display:flex; gap:12px; align-items:center;
      padding: 10px 10px;
      border-radius: var(--radius);
      background: var(--chip);
      border:1px solid var(--border);
      cursor:pointer;
      user-select:none;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(255,255,255,.22), rgba(255,255,255,.06));
      border:1px solid var(--border);
      overflow:hidden;
      display:grid; place-items:center;
      flex: 0 0 auto;
    }
    .logo img{ width:100%; height:100%; object-fit:cover; display:block; }
    .brandText{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .brandText .name{ font-weight:800; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .brandText .motto{ font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .nav{ margin-top:14px; display:flex; flex-direction:column; gap:8px; }
    .navBtn{
      display:flex; align-items:center; gap:12px;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text);
      cursor: pointer;
      transition: background .15s ease, border-color .15s ease, transform .04s ease;
      text-align:left;
    }
    .navBtn:hover{ background: var(--chip); border-color: var(--border); }
    .navBtn:active{ transform: translateY(1px); }
    .navBtn.active{
      background: linear-gradient(135deg, rgba(42,161,152,.18), rgba(255,255,255,.06));
      border-color: rgba(42,161,152,.35);
    }
    .navIcon{
      width:34px; height:34px;
      border-radius: 12px;
      display:grid; place-items:center;
      background: var(--chip);
      border:1px solid var(--border);
      flex:0 0 auto;
    }
    .navLabel{ font-weight:700; letter-spacing:.1px; }

    .sidebarFooter{
      position:absolute; left:14px; right:14px; bottom:14px;
      padding: 10px 10px;
      border-radius: var(--radius);
      background: var(--chip);
      border:1px solid var(--border);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.4;
    }

    .main{ flex:1; padding: 18px 18px 30px; min-width:0; }

    /* Header */
    .header{
      display:flex; align-items:center; justify-content:space-between;
      gap: 12px;
      padding: 14px 14px;
      border-radius: var(--radius2);
      background: var(--panel);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      position: sticky;
      top: 10px;
      z-index: 20;
      backdrop-filter: blur(10px);
    }
    .headerLeft{ display:flex; align-items:center; gap:10px; min-width:0; }
    .iconBtn{
      width:42px; height:42px; border-radius: 14px;
      border:1px solid var(--border);
      background: var(--chip);
      color: var(--text);
      cursor:pointer;
      display:grid; place-items:center;
      transition: transform .04s ease, background .15s ease;
      user-select:none;
    }
    .iconBtn:hover{ background: var(--chip2); }
    .iconBtn:active{ transform: translateY(1px); }
    .pageTitleWrap{ display:flex; align-items:center; gap:10px; min-width:0; }
    .miniLogo{
      width:38px;height:38px;border-radius:14px;
      border:1px solid var(--border);
      overflow:hidden;
      background: var(--chip);
      display:none;
      cursor:pointer;
      user-select:none;
    }
    .miniLogo img{ width:100%; height:100%; object-fit:cover; display:block; }
    .pageTitle{
      font-weight:900;
      letter-spacing: .2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .headerRight{ display:flex; align-items:center; gap:10px; }
    select.preset{
      border:1px solid var(--border);
      background: transparent;
      color: var(--text);
      border-radius: 12px;
      padding: 8px 10px;
      outline:none;
    }
    .toggleBtn{
      width:42px; height:42px; border-radius: 14px;
      border:1px solid var(--border);
      background: linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      cursor:pointer;
      display:grid; place-items:center;
      user-select:none;
    }

    /* Content */
    .content{ margin-top: 16px; }
    .grid{ display:grid; gap:14px; }
    .grid.cols2{ grid-template-columns: 1.35fr .65fr; }
    .card{
      border-radius: var(--radius2);
      background: var(--panel);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 14px;
      backdrop-filter: blur(10px);
      min-width:0;
    }
    .cardTitle{
      display:flex; align-items:flex-end; justify-content:space-between;
      gap:10px;
      margin-bottom: 8px;
    }
    .cardTitle h2{
      margin:0;
      font-size: 16px;
      letter-spacing:.2px;
    }
    .sub{ color: var(--muted); font-size: 13px; margin: 0; }
    .banner{
      border-radius: var(--radius2);
      padding: 16px;
      background: linear-gradient(135deg, rgba(31,77,58,.65), rgba(42,161,152,.45));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    html[data-mode="light"] .banner{
      background: linear-gradient(135deg, rgba(31,77,58,.16), rgba(42,161,152,.16));
      border:1px solid rgba(17,24,39,.10);
    }
    .banner h1{ margin:0 0 6px 0; font-size: 18px; letter-spacing:.2px; }
    .banner .time{ margin:0; font-size: 14px; color: rgba(255,255,255,.88); font-weight:800; }
    html[data-mode="light"] .banner .time{ color: rgba(17,24,39,.85); }

    .stats{ display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 12px; margin-top: 12px; }
    .stat{
      padding: 12px;
      border-radius: 18px;
      border:1px solid var(--border);
      background: linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      cursor:pointer;
      transition: transform .05s ease, background .15s ease;
      min-width:0;
    }
    .stat:hover{ background: linear-gradient(135deg, rgba(42,161,152,.12), rgba(255,255,255,.04)); }
    .stat:active{ transform: translateY(1px); }
    .stat .k{ font-size: 12px; color: var(--muted); font-weight:800; }
    .stat .v{ font-size: 26px; font-weight:950; margin-top: 6px; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .stat .s{ font-size: 12px; color: var(--muted); margin-top: 2px; }

    .chips{ display:flex; gap:10px; flex-wrap:wrap; }
    .chip{
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: var(--chip);
      cursor:pointer;
      font-weight:900;
      color: var(--muted);
      transition: background .15s ease, transform .04s ease;
      user-select:none;
    }
    .chip.active{ background: rgba(42,161,152,.18); border-color: rgba(42,161,152,.35); color: var(--text); }
    .chip:active{ transform: translateY(1px); }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .field{
      border:1px solid var(--border);
      background: var(--chip);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      outline:none;
      min-width: 170px;
    }
    .field:focus{ box-shadow: 0 0 0 3px var(--focus); }

    /* Table */
    .tableWrap{ overflow:auto; border-radius: 18px; border:1px solid var(--border); }
    table{ border-collapse: separate; border-spacing: 0; width:100%; min-width: 880px; }
    th,td{ padding: 10px 10px; border-bottom:1px solid var(--border); vertical-align:top; }
    th{ position:sticky; top:0; background: var(--panel2); text-align:left; font-size: 12px; color: var(--muted); letter-spacing:.3px; z-index:1; }
    td{ font-size: 13px; }
    tr:hover td{ background: rgba(255,255,255,.03); }
    html[data-mode="light"] tr:hover td{ background: rgba(17,24,39,.03); }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: var(--chip);
      font-weight:900;
      font-size:12px;
    }
    .b-ok{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12); }
    .b-no{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.12); }
    .b-hi{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.12); }

    /* Modal */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      z-index: 60;
      padding: 14px;
      overflow:auto;
    }
    .overlay.show{ display:block; }
    .modal{
      width:min(980px, 100%);
      margin: 40px auto;
      border-radius: 22px;
      background: var(--panel2);
      border:1px solid var(--border);
      box-shadow: 0 22px 70px rgba(0,0,0,.45);
      overflow:hidden;
      max-height: calc(100vh - 80px);
      display:flex;
      flex-direction:column;
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px;
      padding: 14px 14px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(135deg, rgba(255,255,255,.05), transparent);
    }
    .modalHead h3{ margin:0; font-size: 15px; letter-spacing:.2px; }
    .modalBody{
      padding: 14px;
      overflow:auto;
    }
    .modalGrid{
      display:grid;
      gap: 14px;
      grid-template-columns: 1fr 1fr;
    }
    .help{ font-size:12px; color:var(--muted); margin: 6px 0 0; }
    .btn{
      border:1px solid var(--border);
      background: var(--chip);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight:900;
      user-select:none;
    }
    .btnPrimary{
      border-color: rgba(42,161,152,.35);
      background: rgba(42,161,152,.18);
    }
    .btnDanger{
      border-color: rgba(239,68,68,.35);
      background: rgba(239,68,68,.16);
    }
    .warnBox{
      border:1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.10);
      border-radius: 16px;
      padding: 10px 12px;
      color: var(--text);
      font-weight:900;
      display:none;
      margin-top: 10px;
    }
    .warnBox.show{ display:block; }

    /* Chart */
    .chartWrap{
      border:1px solid var(--border);
      border-radius: 18px;
      background: linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      padding: 10px;
      overflow:hidden;
    }
    .chartCaption{ margin: 8px 0 0; font-size: 12px; color: var(--muted); }

    /* Mobile */
    .mobileTopRow{ display:none; }
    @media (max-width: 980px){
      .grid.cols2{ grid-template-columns: 1fr; }
      .stats{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media (max-width: 860px){
      /* Mobile: sidebar slide-out (off-canvas) */
      .sidebar{
        position: fixed;
        left: 0; top: 0;
        transform: translateX(-105%);
        z-index: 80;
        box-shadow: 0 25px 70px rgba(0,0,0,.55);
        display:block !important; /* ignore desktop hide on mobile layout */
      }
      body.sidebar-hidden .sidebar{
        /* desktop hide tak terpakai; mobile tetap guna slide-out */
        display:block !important;
      }
      .sidebar.open{ transform: translateX(0); }
      .main{ padding: 14px; }
      .mobileTopRow{ display:flex; gap:10px; }
      .miniLogo{ display:block; }
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="brand" id="brandGoHome" title="Klik untuk ke Laman Utama">
        <div class="logo" id="sidebarLogo">
          <span style="font-weight:1000;">üè´</span>
        </div>
        <div class="brandText">
          <div class="name" id="schoolNameSide">SK Paya Resak</div>
          <div class="motto" id="schoolMottoSide">Moving Forward</div>
        </div>
      </div>

      <nav class="nav" id="nav">
        <button class="navBtn active" data-page="home">
          <span class="navIcon">üè†</span><span class="navLabel">Laman Utama</span>
        </button>
        <button class="navBtn" data-page="attendance">
          <span class="navIcon">üßæ</span><span class="navLabel">Kehadiran</span>
        </button>
        <button class="navBtn" data-page="announcements">
          <span class="navIcon">üì¢</span><span class="navLabel">Pengumuman</span>
        </button>
        <button class="navBtn" data-page="calendar">
          <span class="navIcon">üóìÔ∏è</span><span class="navLabel">Takwim</span>
        </button>
        <button class="navBtn" data-page="parents">
          <span class="navIcon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span><span class="navLabel">Ibu Bapa</span>
        </button>
      </nav>

      <div class="sidebarFooter">
        <div id="footerLine1Side">¬© 2025 NK.</div>
        <div id="footerLine2Side">Hak Cipta Terpelihara.</div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main" id="main">
      <!-- Header -->
      <header class="header">
        <div class="headerLeft">
          <button class="iconBtn" id="btnMenu" title="Menu">‚ò∞</button>

          <div class="pageTitleWrap">
            <div class="miniLogo" id="miniLogo" title="Kembali ke Laman Utama">
              <img id="miniLogoImg" alt="" style="display:none;">
              <div id="miniLogoFallback" style="width:100%;height:100%;display:grid;place-items:center;">üè´</div>
            </div>
            <div class="pageTitle" id="pageTitle">Laman Utama</div>
          </div>
        </div>

        <div class="headerRight">
          <select class="preset" id="presetSelect" title="Tema preset">
            <option value="forest">Forest (Hijau)</option>
            <option value="ocean">Ocean (Biru)</option>
            <option value="sunset">Sunset (Oren)</option>
            <option value="violet">Violet (Ungu)</option>
          </select>

          <button class="toggleBtn" id="btnMode" title="Tukar Light/Dark">üåô</button>
          <button class="iconBtn" id="btnSettings" title="Tetapan">‚öôÔ∏è</button>
        </div>
      </header>

      <section class="content" id="content">
        <!-- HOME -->
        <div class="page" id="page-home">
          <div class="grid cols2">
            <div class="card">
              <div class="banner">
                <h1 id="bannerText">Selamat Datang ke Portal Rasmi PPKI SK Paya Resak</h1>
                <p class="time" id="timeNow">--:--:--</p>
              </div>

              <div class="stats">
                <div class="stat" id="statToday" data-jump="today">
                  <div class="k">Kehadiran Hari Ini</div>
                  <div class="v" id="vToday">-</div>
                  <div class="s" id="sToday">‚Äî</div>
                </div>
                <div class="stat" id="statWeek" data-jump="week">
                  <div class="k">Kehadiran Minggu Ini</div>
                  <div class="v" id="vWeek">-</div>
                  <div class="s" id="sWeek">‚Äî</div>
                </div>
                <div class="stat" id="statMonth" data-jump="month">
                  <div class="k">Kehadiran Bulan Ini</div>
                  <div class="v" id="vMonth">-</div>
                  <div class="s" id="sMonth">‚Äî</div>
                </div>
                <div class="stat" id="statPct" data-jump="pct">
                  <div class="k">Peratus Kehadiran Bulanan</div>
                  <div class="v" id="vPct">-</div>
                  <div class="s" id="sPct">Bulan semasa</div>
                </div>
              </div>

              <div style="margin-top:14px" class="card">
                <div class="cardTitle">
                  <h2>Trend Harian (Bulan Dipilih)</h2>
                  <div class="sub">Pilih Bulan + Kelas dan mod paparan.</div>
                </div>

                <div class="row" style="justify-content:space-between; gap:12px; margin:10px 0 10px;">
                  <div class="chips" id="trendMode">
                    <div class="chip active" data-mode="hadir">Hadir</div>
                    <div class="chip" data-mode="tidak">Tidak Hadir</div>
                    <div class="chip" data-mode="pct">%</div>
                  </div>

                  <div class="row" style="gap:10px;">
                    <select class="field" id="trendMonth"></select>
                    <select class="field" id="trendYear"></select>
                    <select class="field" id="trendClass"><option value="">Semua Kelas</option></select>
                  </div>
                </div>

                <div class="chartWrap">
                  <div id="trendChart"></div>
                </div>
                <p class="chartCaption">*Graf ringkas berdasarkan data kehadiran (Tarikh dd/mm/yyyy).</p>
              </div>
            </div>

            <div class="card">
              <div class="cardTitle">
                <h2>üì¢ Pengumuman Aktif</h2>
                <div class="sub" id="annCount">‚Äî</div>
              </div>
              <div id="annListHome" style="display:flex; flex-direction:column; gap:10px;"></div>
            </div>
          </div>
        </div>

        <!-- ATTENDANCE -->
        <div class="page" id="page-attendance" style="display:none;">
          <div class="card">
            <div class="cardTitle">
              <div>
                <h2>Dashboard Kehadiran</h2>
                <p class="sub">Data daripada CSV kehadiran. Filter kolum + carian + date range.</p>
              </div>
              <div class="row">
                <button class="btn" id="btnReloadAttendance">Segar Semula</button>
              </div>
            </div>

            <div class="stats">
              <div class="stat" data-jump="today">
                <div class="k">Kehadiran Hari Ini</div>
                <div class="v" id="vToday2">-</div>
                <div class="s" id="sToday2">‚Äî</div>
              </div>
              <div class="stat" data-jump="week">
                <div class="k">Kehadiran Minggu Ini</div>
                <div class="v" id="vWeek2">-</div>
                <div class="s" id="sWeek2">‚Äî</div>
              </div>
              <div class="stat" data-jump="month">
                <div class="k">Kehadiran Bulan Ini</div>
                <div class="v" id="vMonth2">-</div>
                <div class="s" id="sMonth2">‚Äî</div>
              </div>
              <div class="stat" data-jump="pct">
                <div class="k">Peratus Kehadiran Bulanan</div>
                <div class="v" id="vPct2">-</div>
                <div class="s" id="sPct2">Bulan semasa</div>
              </div>
            </div>

            <div class="card" style="margin-top:14px;">
              <div class="row" style="gap:10px; justify-content:space-between;">
                <div class="row" style="gap:10px; flex:1; min-width:0;">
                  <input class="field" id="searchAttendance" placeholder="Carian (nama/kelas/status...)" style="flex:1; min-width:220px;">
                  <select class="field" id="filterClass"><option value="">Kelas: Semua</option></select>
                  <select class="field" id="filterStatus">
                    <option value="">Status: Semua</option>
                    <option value="HADIR">Hadir</option>
                    <option value="TIDAK HADIR">Tidak Hadir</option>
                  </select>
                </div>

                <div class="row" style="gap:10px;">
                  <input class="field" id="dateFrom" type="date" title="Tarikh mula">
                  <input class="field" id="dateTo" type="date" title="Tarikh hingga">
                  <button class="btn btnPrimary" id="btnApplyFilter">Tapis</button>
                  <button class="btn" id="btnResetFilter">Reset</button>
                </div>
              </div>

              <div style="margin-top:12px;" class="tableWrap">
                <table id="attendanceTable">
                  <thead><tr id="attendanceHead"></tr></thead>
                  <tbody id="attendanceBody"></tbody>
                </table>
              </div>

              <p class="help" id="attendanceMeta">‚Äî</p>
            </div>
          </div>
        </div>

        <!-- ANNOUNCEMENTS -->
        <div class="page" id="page-announcements" style="display:none;">
          <div class="card">
            <div class="cardTitle">
              <div>
                <h2>Pengumuman</h2>
                <p class="sub">Klik kad untuk lihat butiran penuh (pop out).</p>
              </div>
              <div class="row">
                <button class="btn" id="btnReloadAnnouncements">Segar Semula</button>
              </div>
            </div>

            <div id="annGrid" class="grid" style="grid-template-columns: repeat(2, minmax(0,1fr));"></div>
          </div>
        </div>

        <!-- CALENDAR -->
        <div class="page" id="page-calendar" style="display:none;">
          <div class="card">
            <div class="cardTitle">
              <div>
                <h2>Takwim</h2>
                <p class="sub">Pautan CSV takwim boleh ditambah dalam Tetapan (PIN diperlukan).</p>
              </div>
            </div>
            <div id="calendarArea" class="sub">Belum disambungkan.</div>
          </div>
        </div>

        <!-- PARENTS -->
        <div class="page" id="page-parents" style="display:none;">
          <div class="card">
            <div class="cardTitle">
              <div>
                <h2>Ibu Bapa</h2>
                <p class="sub">Kad info (pilih: pop out atau buka URL tab baru).</p>
              </div>
              <div class="row">
                <button class="btn" id="btnReloadParents">Segar Semula</button>
              </div>
            </div>

            <div id="parentsGrid" class="grid" style="grid-template-columns: repeat(2, minmax(0,1fr));"></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal: Announcement Detail -->
  <div class="overlay" id="overlayAnn">
    <div class="modal">
      <div class="modalHead">
        <h3 id="annModalTitle">Butiran Pengumuman</h3>
        <button class="iconBtn" id="btnCloseAnn" title="Tutup">‚úï</button>
      </div>
      <div class="modalBody" id="annModalBody"></div>
    </div>
  </div>

  <!-- Modal: Settings (PIN gate) -->
  <div class="overlay" id="overlaySettings">
    <div class="modal">
      <div class="modalHead">
        <h3>Tetapan Portal</h3>
        <button class="iconBtn" id="btnCloseSettings" title="Tutup">‚úï</button>
      </div>

      <div class="modalBody">
        <!-- PIN STEP -->
        <div id="pinStep">
          <p class="sub" style="margin:0 0 10px;">
            Untuk kemaskini (logo/nama/moto/footer/URL CSV), masukkan PIN.
            <br><span style="font-weight:900;color:var(--muted);">Tema preset & light/dark boleh diubah tanpa PIN.</span>
          </p>

          <div class="row" style="gap:10px;">
            <input class="field" id="pinInput" inputmode="numeric" placeholder="Masukkan PIN" style="min-width:240px;">
            <button class="btn btnPrimary" id="btnPinOk">Masuk</button>
          </div>

          <div class="warnBox" id="pinWarn">PIN salah. Sila cuba lagi.</div>

          <div style="margin-top:14px;">
            <p class="help" style="margin:0;">
              Nota: Jika cikgu hanya nak tukar tema, guna dropdown preset di header dan butang üåô.
            </p>
          </div>
        </div>

        <!-- SETTINGS STEP -->
        <div id="settingsStep" style="display:none;">
          <div class="modalGrid">
            <div class="card">
              <div class="cardTitle">
                <h2>Identiti Portal</h2>
                <div class="sub">Kemaskini nama/moto/footer/logo</div>
              </div>

              <input class="field" id="setSchoolName" placeholder="Nama Sekolah" style="width:100%; margin-top:8px;">
              <input class="field" id="setSchoolMotto" placeholder="Moto Sekolah" style="width:100%; margin-top:10px;">
              <input class="field" id="setFooter1" placeholder="Footer (Baris 1)" style="width:100%; margin-top:10px;">
              <input class="field" id="setFooter2" placeholder="Footer (Baris 2)" style="width:100%; margin-top:10px;">

              <!-- ‚úÖ NEW: Sidebar controls -->
              <div style="margin-top:12px;">
                <label class="sub" style="font-weight:900;">Paparan Sidebar (Desktop)</label>

                <div class="row" style="gap:10px; margin-top:8px;">
                  <input type="checkbox" id="setSidebarHidden" style="width:18px;height:18px; accent-color: var(--accent);" />
                  <span class="sub">Sembunyikan sidebar secara default</span>
                </div>

                <div class="row" style="gap:10px; margin-top:8px;">
                  <input type="checkbox" id="setAutoHideSidebar" style="width:18px;height:18px; accent-color: var(--accent);" />
                  <span class="sub">Auto-hide bila klik luar sidebar</span>
                </div>

                <p class="help">Tip: Tekan butang ‚ò∞ untuk buka/tutup sidebar. Jika auto-hide ON, klik mana-mana content akan tutup sidebar.</p>
              </div>

              <div style="margin-top:10px;">
                <label class="sub" style="font-weight:900;">Logo Sekolah</label>
                <input class="field" id="setLogoFile" type="file" accept="image/*" style="width:100%; margin-top:6px;">
                <p class="help">Logo disimpan dalam pelayar (localStorage). Untuk pindah komputer, perlu upload semula.</p>
              </div>
            </div>

            <div class="card">
              <div class="cardTitle">
                <h2>URL CSV</h2>
                <div class="sub">Kehadiran / Pengumuman / Ibu Bapa / Takwim</div>
              </div>

              <label class="sub" style="font-weight:900; margin-top:6px;">Kehadiran</label>
              <input class="field" id="setUrlAttendance" style="width:100%; margin-top:6px;">

              <label class="sub" style="font-weight:900; margin-top:10px;">Pengumuman</label>
              <input class="field" id="setUrlAnnouncements" style="width:100%; margin-top:6px;">

              <label class="sub" style="font-weight:900; margin-top:10px;">Ibu Bapa</label>
              <input class="field" id="setUrlParents" style="width:100%; margin-top:6px;">

              <label class="sub" style="font-weight:900; margin-top:10px;">Takwim (optional)</label>
              <input class="field" id="setUrlCalendar" style="width:100%; margin-top:6px;" placeholder="(optional)">

              <div class="row" style="gap:10px; margin-top:12px;">
                <button class="btn btnPrimary" id="btnSaveSettings">Simpan</button>
                <button class="btn" id="btnResetSettings">Segar Semula</button>
                <button class="btn btnDanger" id="btnLogoutSettings" title="Keluar tetapan (PIN akan diminta semula)">Kunci Semula</button>
              </div>
              <p class="help">Kesemua tetapan disimpan dalam browser (localStorage).</p>
            </div>
          </div>

          <div class="card" style="margin-top:14px;">
            <div class="cardTitle">
              <h2>Pemetaan Kolum Kehadiran</h2>
              <div class="sub">Jika nama kolum berubah, edit di sini (tanpa ubah kod).</div>
            </div>

            <div class="modalGrid" style="grid-template-columns: 1fr 1fr;">
              <div>
                <label class="sub" style="font-weight:900;">Tarikh</label>
                <input class="field" id="mapTarikh" style="width:100%; margin-top:6px;" placeholder="Contoh: Tarikh">
                <p class="help">Terima: Tarikh / TARIKH / tarikh</p>
              </div>
              <div>
                <label class="sub" style="font-weight:900;">Kelas</label>
                <input class="field" id="mapKelas" style="width:100%; margin-top:6px;" placeholder="Contoh: Kelas">
              </div>
              <div>
                <label class="sub" style="font-weight:900;">Nama Murid</label>
                <input class="field" id="mapNama" style="width:100%; margin-top:6px;" placeholder="Contoh: Nama Murid / Nama_Murid">
                <p class="help">Contoh: <b>Nama Murid</b> atau <b>Nama_Murid</b></p>
              </div>
              <div>
                <label class="sub" style="font-weight:900;">Status</label>
                <input class="field" id="mapStatus" style="width:100%; margin-top:6px;" placeholder="Contoh: Status">
              </div>
              <div>
                <label class="sub" style="font-weight:900;">Jantina</label>
                <input class="field" id="mapJantina" style="width:100%; margin-top:6px;" placeholder="Contoh: Jantina">
              </div>
            </div>

            <div class="row" style="gap:10px; margin-top:12px;">
              <button class="btn btnPrimary" id="btnSaveMapping">Simpan Pemetaan</button>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * DEFAULT CONFIG
     ***********************/
    const DEFAULTS = {
      schoolName: "SK Paya Resak",
      schoolMotto: "Moving Forward",
      footer1: "¬© 2025 NK.",
      footer2: "Hak Cipta Terpelihara.",
      preset: "forest",
      mode: "dark",
      pin: "5235",

      // ‚úÖ NEW: sidebar preferences
      sidebarHidden: false,      // sembunyi sidebar secara default (desktop)
      autoHideSidebar: true,     // auto-hide bila klik luar sidebar

      urls: {
        attendance: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTKhex5gcCHKoiLqRZpgVRMRfrGGvPtbgc3jo_Q-3FPL5OpcoWvyAnec0dTgykrpkYuS34iNJnEAkDU/pub?gid=880667725&single=true&output=csv",
        announcements: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQvKlO-LRGh8kj_-Be6NxZRR3Z38rjbC33jyvfhQvnR9L4LF7_dZRVXYGK3XO7bAoJwC9bJJmABjV6Z/pub?gid=946270411&single=true&output=csv",
        parents: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ_G1txQOE4Di1XsK6esbw8VgQtW2hcPsjzAmPH7V82JOeXegb7Kb_3Iz8CeHo-KvfvHe9x8BWtSfbB/pub?gid=1684744050&single=true&output=csv",
        calendar: ""
      },
      attendanceMap: {
        tarikh: "Tarikh",
        kelas: "Kelas",
        nama: "Nama Murid",
        status: "Status",
        jantina: "Jantina"
      }
    };

    const LS = {
      settings: "ppki_portal_settings_v1",
      logo: "ppki_portal_logo_v1"
    };

    function loadSettings(){
      try{
        const raw = localStorage.getItem(LS.settings);
        if(!raw) return structuredClone(DEFAULTS);
        const s = JSON.parse(raw);
        return {
          ...structuredClone(DEFAULTS),
          ...s,
          urls: { ...structuredClone(DEFAULTS.urls), ...(s.urls||{}) },
          attendanceMap: { ...structuredClone(DEFAULTS.attendanceMap), ...(s.attendanceMap||{}) }
        };
      }catch(e){
        return structuredClone(DEFAULTS);
      }
    }
    function saveSettings(s){
      localStorage.setItem(LS.settings, JSON.stringify(s));
    }
    let SETTINGS = loadSettings();

    /***********************
     * DOM REFS
     ***********************/
    const sidebar = document.getElementById("sidebar");
    const btnMenu = document.getElementById("btnMenu");
    const pageTitle = document.getElementById("pageTitle");
    const nav = document.getElementById("nav");
    const main = document.getElementById("main");
    const brandGoHome = document.getElementById("brandGoHome");

    const schoolNameSide = document.getElementById("schoolNameSide");
    const schoolMottoSide = document.getElementById("schoolMottoSide");
    const footerLine1Side = document.getElementById("footerLine1Side");
    const footerLine2Side = document.getElementById("footerLine2Side");

    const miniLogo = document.getElementById("miniLogo");
    const miniLogoImg = document.getElementById("miniLogoImg");
    const miniLogoFallback = document.getElementById("miniLogoFallback");

    const presetSelect = document.getElementById("presetSelect");
    const btnMode = document.getElementById("btnMode");

    const overlaySettings = document.getElementById("overlaySettings");
    const btnSettings = document.getElementById("btnSettings");
    const btnCloseSettings = document.getElementById("btnCloseSettings");

    const pinStep = document.getElementById("pinStep");
    const settingsStep = document.getElementById("settingsStep");
    const pinInput = document.getElementById("pinInput");
    const btnPinOk = document.getElementById("btnPinOk");
    const pinWarn = document.getElementById("pinWarn");

    // Settings fields
    const setSchoolName = document.getElementById("setSchoolName");
    const setSchoolMotto = document.getElementById("setSchoolMotto");
    const setFooter1 = document.getElementById("setFooter1");
    const setFooter2 = document.getElementById("setFooter2");
    const setLogoFile = document.getElementById("setLogoFile");

    const setUrlAttendance = document.getElementById("setUrlAttendance");
    const setUrlAnnouncements = document.getElementById("setUrlAnnouncements");
    const setUrlParents = document.getElementById("setUrlParents");
    const setUrlCalendar = document.getElementById("setUrlCalendar");

    const btnSaveSettings = document.getElementById("btnSaveSettings");
    const btnResetSettings = document.getElementById("btnResetSettings");
    const btnLogoutSettings = document.getElementById("btnLogoutSettings");

    // ‚úÖ NEW: sidebar settings controls
    const setSidebarHidden = document.getElementById("setSidebarHidden");
    const setAutoHideSidebar = document.getElementById("setAutoHideSidebar");

    // Mapping
    const mapTarikh = document.getElementById("mapTarikh");
    const mapKelas = document.getElementById("mapKelas");
    const mapNama = document.getElementById("mapNama");
    const mapStatus = document.getElementById("mapStatus");
    const mapJantina = document.getElementById("mapJantina");
    const btnSaveMapping = document.getElementById("btnSaveMapping");

    // Home stats
    const timeNow = document.getElementById("timeNow");
    const vToday = document.getElementById("vToday");
    const sToday = document.getElementById("sToday");
    const vWeek = document.getElementById("vWeek");
    const sWeek = document.getElementById("sWeek");
    const vMonth = document.getElementById("vMonth");
    const sMonth = document.getElementById("sMonth");
    const vPct = document.getElementById("vPct");

    const vToday2 = document.getElementById("vToday2");
    const sToday2 = document.getElementById("sToday2");
    const vWeek2 = document.getElementById("vWeek2");
    const sWeek2 = document.getElementById("sWeek2");
    const vMonth2 = document.getElementById("vMonth2");
    const sMonth2 = document.getElementById("sMonth2");
    const vPct2 = document.getElementById("vPct2");

    // Trend chart controls
    const trendMode = document.getElementById("trendMode");
    const trendMonth = document.getElementById("trendMonth");
    const trendYear = document.getElementById("trendYear");
    const trendClass = document.getElementById("trendClass");
    const trendChart = document.getElementById("trendChart");

    // Attendance page controls
    const btnReloadAttendance = document.getElementById("btnReloadAttendance");
    const searchAttendance = document.getElementById("searchAttendance");
    const filterClass = document.getElementById("filterClass");
    const filterStatus = document.getElementById("filterStatus");
    const dateFrom = document.getElementById("dateFrom");
    const dateTo = document.getElementById("dateTo");
    const btnApplyFilter = document.getElementById("btnApplyFilter");
    const btnResetFilter = document.getElementById("btnResetFilter");
    const attendanceHead = document.getElementById("attendanceHead");
    const attendanceBody = document.getElementById("attendanceBody");
    const attendanceMeta = document.getElementById("attendanceMeta");

    // Announcements
    const annCount = document.getElementById("annCount");
    const annListHome = document.getElementById("annListHome");
    const annGrid = document.getElementById("annGrid");
    const btnReloadAnnouncements = document.getElementById("btnReloadAnnouncements");

    const overlayAnn = document.getElementById("overlayAnn");
    const btnCloseAnn = document.getElementById("btnCloseAnn");
    const annModalTitle = document.getElementById("annModalTitle");
    const annModalBody = document.getElementById("annModalBody");

    // Parents
    const parentsGrid = document.getElementById("parentsGrid");
    const btnReloadParents = document.getElementById("btnReloadParents");

    // Calendar
    const calendarArea = document.getElementById("calendarArea");

    /***********************
     * UTIL
     ***********************/
    function normKey(s){
      return String(s||"")
        .trim()
        .toLowerCase()
        .replace(/\s+/g,"")
        .replace(/_/g,"")
        .replace(/[^\p{L}\p{N}]/gu,"");
    }
    function pickCol(headers, desired){
      const want = normKey(desired);
      const idx = headers.findIndex(h => normKey(h) === want);
      if(idx !== -1) return headers[idx];

      const aliases = {
        tarikh: ["tarikh","date","tanggal"],
        kelas: ["kelas","class"],
        namamurid: ["namamurid","nama","murid","name","namastudent","namamurid"],
        status: ["status","kehadiran","attendancestatus"],
        jantina: ["jantina","gender","sex"]
      };
      const key = normKey(desired);
      const list = aliases[key] || [];
      for(const a of list){
        const j = headers.findIndex(h => normKey(h) === a);
        if(j !== -1) return headers[j];
      }
      const part = headers.find(h => normKey(h).includes(want) || want.includes(normKey(h)));
      return part || null;
    }

    function parseCSV(text){
      const rows = [];
      let row = [], cur = "", inQ = false;
      for(let i=0;i<text.length;i++){
        const ch = text[i];
        const next = text[i+1];
        if(ch === '"'){
          if(inQ && next === '"'){ cur += '"'; i++; }
          else inQ = !inQ;
        } else if(ch === "," && !inQ){
          row.push(cur); cur="";
        } else if((ch === "\n" || ch === "\r") && !inQ){
          if(ch === "\r" && next === "\n"){ i++; }
          row.push(cur);
          if(row.some(v => String(v).trim()!=="")) rows.push(row);
          row = []; cur="";
        } else {
          cur += ch;
        }
      }
      row.push(cur);
      if(row.some(v => String(v).trim()!=="")) rows.push(row);

      if(rows.length === 0) return { headers: [], data: [] };
      const headers = rows[0].map(h => String(h||"").trim());
      const data = rows.slice(1).map(r => {
        const obj = {};
        headers.forEach((h,idx)=> obj[h] = (r[idx] ?? "").trim());
        return obj;
      });
      return { headers, data };
    }

    function parseDateDMY(s){
      if(!s) return null;
      const str = String(s).trim();
      if(/^\d{4}-\d{2}-\d{2}/.test(str)){
        const d = new Date(str + "T00:00:00");
        return isNaN(d) ? null : d;
      }
      const m = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if(!m) return null;
      const dd = Number(m[1]), mm = Number(m[2]), yy = Number(m[3]);
      const d = new Date(yy, mm-1, dd, 0,0,0,0);
      if(d.getFullYear()!==yy || d.getMonth()!==mm-1 || d.getDate()!==dd) return null;
      return d;
    }
    function formatDMY(d){
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yy = d.getFullYear();
      return `${dd}/${mm}/${yy}`;
    }
    function startOfWeekMonday(d){
      const x = new Date(d); x.setHours(0,0,0,0);
      const day = x.getDay();
      const diff = (day === 0 ? -6 : (1 - day));
      x.setDate(x.getDate() + diff);
      return x;
    }
    function endOfWeekSunday(d){
      const s = startOfWeekMonday(d);
      const e = new Date(s); e.setDate(e.getDate()+6); e.setHours(23,59,59,999);
      return e;
    }

    /***********************
     * THEME + IDENTITY
     ***********************/
    function applyTheme(){
      document.documentElement.dataset.preset = SETTINGS.preset || "forest";
      document.documentElement.dataset.mode = SETTINGS.mode || "dark";
      presetSelect.value = document.documentElement.dataset.preset;
      btnMode.textContent = (document.documentElement.dataset.mode === "dark") ? "üåô" : "‚òÄÔ∏è";
    }

    function applyIdentity(){
      schoolNameSide.textContent = SETTINGS.schoolName;
      schoolMottoSide.textContent = SETTINGS.schoolMotto;
      footerLine1Side.textContent = SETTINGS.footer1;
      footerLine2Side.textContent = SETTINGS.footer2;

      const logoData = localStorage.getItem(LS.logo);
      const sidebarLogo = document.getElementById("sidebarLogo");
      sidebarLogo.innerHTML = "";
      if(logoData){
        const img = document.createElement("img");
        img.src = logoData;
        sidebarLogo.appendChild(img);

        miniLogoImg.src = logoData;
        miniLogoImg.style.display = "block";
        miniLogoFallback.style.display = "none";
      }else{
        sidebarLogo.innerHTML = "<span style='font-weight:1000;'>üè´</span>";
        miniLogoImg.style.display = "none";
        miniLogoFallback.style.display = "grid";
      }
    }

    /***********************
     * SIDEBAR OPEN/CLOSE (NEW RULE)
     * - Desktop: hidden totally (no mini icons)
     * - Mobile: slide-out open/close
     ***********************/
    function isMobile(){
      return window.matchMedia("(max-width: 860px)").matches;
    }
    function hideSidebar(){
      if(isMobile()){
        sidebar.classList.remove("open");
        return;
      }
      document.body.classList.add("sidebar-hidden");
      SETTINGS.sidebarHidden = true;
      saveSettings(SETTINGS);
    }
    function showSidebar(){
      if(isMobile()){
        sidebar.classList.add("open");
        return;
      }
      document.body.classList.remove("sidebar-hidden");
      SETTINGS.sidebarHidden = false;
      saveSettings(SETTINGS);
    }
    function toggleSidebar(){
      if(isMobile()){
        sidebar.classList.toggle("open");
        return;
      }
      document.body.classList.toggle("sidebar-hidden");
      SETTINGS.sidebarHidden = document.body.classList.contains("sidebar-hidden");
      saveSettings(SETTINGS);
    }
    function initSidebarState(){
      // Desktop apply from settings
      if(!isMobile()){
        if(SETTINGS.sidebarHidden) document.body.classList.add("sidebar-hidden");
        else document.body.classList.remove("sidebar-hidden");
        sidebar.classList.remove("open");
      }else{
        // Mobile default: closed
        sidebar.classList.remove("open");
        document.body.classList.remove("sidebar-hidden");
      }
    }

    btnMenu.addEventListener("click", ()=> toggleSidebar());

    // Click logo / miniLogo go home (and for mobile close sidebar)
    function goHome(){
      showPage("home");
      if(isMobile()) sidebar.classList.remove("open");
    }
    miniLogo.addEventListener("click", goHome);
    brandGoHome.addEventListener("click", goHome);

    // Auto-hide when click outside (if enabled)
    function setupAutoHideSidebar(){
      document.addEventListener("click", (e)=>{
        if(isMobile()){
          // On mobile: if sidebar open and click outside -> close
          if(sidebar.classList.contains("open")){
            if(!e.target.closest("#sidebar") && !e.target.closest("#btnMenu")){
              // Ignore clicks inside overlays/modals (biar user interaksi modal)
              if(e.target.closest(".overlay") || e.target.closest(".modal")) return;
              sidebar.classList.remove("open");
            }
          }
          return;
        }

        // Desktop:
        if(!SETTINGS.autoHideSidebar) return;
        if(document.body.classList.contains("sidebar-hidden")) return;

        // do not hide on sidebar or menu button
        if(e.target.closest("#sidebar")) return;
        if(e.target.closest("#btnMenu")) return;

        // do not hide when interacting overlays/modals
        if(e.target.closest(".overlay") || e.target.closest(".modal")) return;

        hideSidebar();
      }, { capture: true });
    }

    window.addEventListener("resize", initSidebarState);

    /***********************
     * PAGES NAVIGATION
     ***********************/
    function showPage(page){
      document.querySelectorAll(".page").forEach(p => p.style.display="none");
      const el = document.getElementById("page-"+page);
      if(el) el.style.display="block";

      document.querySelectorAll(".navBtn").forEach(b => b.classList.toggle("active", b.dataset.page===page));
      const titles = {
        home: "Laman Utama",
        attendance: "Kehadiran",
        announcements: "Pengumuman",
        calendar: "Takwim",
        parents: "Ibu Bapa"
      };
      pageTitle.textContent = titles[page] || "Portal";

      // close sidebar on mobile after select
      if(isMobile()){
        sidebar.classList.remove("open");
      }
    }

    nav.addEventListener("click", (e)=>{
      const btn = e.target.closest(".navBtn");
      if(!btn) return;
      showPage(btn.dataset.page);
    });

    /***********************
     * HEADER THEME CONTROLS (NO PIN)
     ***********************/
    presetSelect.addEventListener("change", ()=>{
      SETTINGS.preset = presetSelect.value;
      saveSettings(SETTINGS);
      applyTheme();
      renderTrend();
    });

    btnMode.addEventListener("click", ()=>{
      SETTINGS.mode = (SETTINGS.mode === "dark") ? "light" : "dark";
      saveSettings(SETTINGS);
      applyTheme();
      renderTrend();
    });

    /***********************
     * SETTINGS MODAL (PIN GATE)
     ***********************/
    let settingsUnlocked = false;

    function openSettings(){
      overlaySettings.classList.add("show");
      pinWarn.classList.remove("show");
      pinInput.value = "";
      settingsUnlocked = false;
      pinStep.style.display = "block";
      settingsStep.style.display = "none";
    }
    function closeSettings(){
      overlaySettings.classList.remove("show");
    }

    btnSettings.addEventListener("click", openSettings);
    btnCloseSettings.addEventListener("click", closeSettings);
    overlaySettings.addEventListener("click", (e)=>{
      if(e.target === overlaySettings) closeSettings();
    });

    btnPinOk.addEventListener("click", ()=>{
      const pin = String(pinInput.value||"").trim();
      if(pin !== SETTINGS.pin){
        pinWarn.classList.add("show");
        return;
      }
      pinWarn.classList.remove("show");
      settingsUnlocked = true;
      pinStep.style.display = "none";
      settingsStep.style.display = "block";

      setSchoolName.value = SETTINGS.schoolName;
      setSchoolMotto.value = SETTINGS.schoolMotto;
      setFooter1.value = SETTINGS.footer1;
      setFooter2.value = SETTINGS.footer2;

      setUrlAttendance.value = SETTINGS.urls.attendance;
      setUrlAnnouncements.value = SETTINGS.urls.announcements;
      setUrlParents.value = SETTINGS.urls.parents;
      setUrlCalendar.value = SETTINGS.urls.calendar || "";

      // ‚úÖ load sidebar toggles
      setSidebarHidden.checked = !!SETTINGS.sidebarHidden;
      setAutoHideSidebar.checked = !!SETTINGS.autoHideSidebar;

      mapTarikh.value = SETTINGS.attendanceMap.tarikh;
      mapKelas.value = SETTINGS.attendanceMap.kelas;
      mapNama.value = SETTINGS.attendanceMap.nama;
      mapStatus.value = SETTINGS.attendanceMap.status;
      mapJantina.value = SETTINGS.attendanceMap.jantina;
    });

    pinInput.addEventListener("keydown",(e)=>{
      if(e.key==="Enter") btnPinOk.click();
    });

    btnSaveSettings.addEventListener("click", ()=>{
      if(!settingsUnlocked) return;

      SETTINGS.schoolName = setSchoolName.value.trim() || DEFAULTS.schoolName;
      SETTINGS.schoolMotto = setSchoolMotto.value.trim() || DEFAULTS.schoolMotto;
      SETTINGS.footer1 = setFooter1.value.trim() || DEFAULTS.footer1;
      SETTINGS.footer2 = setFooter2.value.trim() || DEFAULTS.footer2;

      SETTINGS.urls.attendance = setUrlAttendance.value.trim() || DEFAULTS.urls.attendance;
      SETTINGS.urls.announcements = setUrlAnnouncements.value.trim() || DEFAULTS.urls.announcements;
      SETTINGS.urls.parents = setUrlParents.value.trim() || DEFAULTS.urls.parents;
      SETTINGS.urls.calendar = setUrlCalendar.value.trim();

      // ‚úÖ save sidebar toggles
      SETTINGS.sidebarHidden = !!setSidebarHidden.checked;
      SETTINGS.autoHideSidebar = !!setAutoHideSidebar.checked;

      saveSettings(SETTINGS);
      applyIdentity();

      // apply sidebar immediately (desktop)
      initSidebarState();

      loadAll();
      alert("Tetapan berjaya disimpan.");
    });

    btnResetSettings.addEventListener("click", ()=>{
      if(!settingsUnlocked) return;
      SETTINGS = loadSettings();
      applyTheme();
      applyIdentity();

      setSchoolName.value = SETTINGS.schoolName;
      setSchoolMotto.value = SETTINGS.schoolMotto;
      setFooter1.value = SETTINGS.footer1;
      setFooter2.value = SETTINGS.footer2;

      setUrlAttendance.value = SETTINGS.urls.attendance;
      setUrlAnnouncements.value = SETTINGS.urls.announcements;
      setUrlParents.value = SETTINGS.urls.parents;
      setUrlCalendar.value = SETTINGS.urls.calendar || "";

      // ‚úÖ reset sidebar toggles
      setSidebarHidden.checked = !!SETTINGS.sidebarHidden;
      setAutoHideSidebar.checked = !!SETTINGS.autoHideSidebar;

      mapTarikh.value = SETTINGS.attendanceMap.tarikh;
      mapKelas.value = SETTINGS.attendanceMap.kelas;
      mapNama.value = SETTINGS.attendanceMap.nama;
      mapStatus.value = SETTINGS.attendanceMap.status;
      mapJantina.value = SETTINGS.attendanceMap.jantina;

      initSidebarState();
      alert("Tetapan disegar semula.");
    });

    btnLogoutSettings.addEventListener("click", ()=>{
      settingsUnlocked = false;
      pinStep.style.display = "block";
      settingsStep.style.display = "none";
      pinInput.value = "";
      pinWarn.classList.remove("show");
    });

    setLogoFile.addEventListener("change", async (e)=>{
      if(!settingsUnlocked) return;
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      const dataUrl = await fileToDataURL(file);
      localStorage.setItem(LS.logo, dataUrl);
      applyIdentity();
    });

    btnSaveMapping.addEventListener("click", ()=>{
      if(!settingsUnlocked) return;
      SETTINGS.attendanceMap = {
        tarikh: mapTarikh.value.trim() || DEFAULTS.attendanceMap.tarikh,
        kelas: mapKelas.value.trim() || DEFAULTS.attendanceMap.kelas,
        nama: mapNama.value.trim() || DEFAULTS.attendanceMap.nama,
        status: mapStatus.value.trim() || DEFAULTS.attendanceMap.status,
        jantina: mapJantina.value.trim() || DEFAULTS.attendanceMap.jantina
      };
      saveSettings(SETTINGS);
      alert("Pemetaan disimpan. Data akan dikira ikut kolum ini.");
      loadAttendance();
    });

    function fileToDataURL(file){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = ()=> resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    /***********************
     * LIVE CLOCK
     ***********************/
    function tickClock(){
      const d = new Date();
      const pad = n => String(n).padStart(2,"0");
      timeNow.textContent = `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    setInterval(tickClock, 1000);

    /***********************
     * DATA STATE
     ***********************/
    let attendanceRaw = [];
    let attendanceHeaders = [];
    let announcementsRaw = [];
    let parentsRaw = [];
    let calendarRaw = [];

    /***********************
     * FETCH + NORMALIZE
     ***********************/
    async function fetchCSV(url){
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) throw new Error(`Gagal fetch CSV (${res.status})`);
      const txt = await res.text();
      return parseCSV(txt);
    }

    function normalizeAttendance(parsed){
      const headers = parsed.headers;
      attendanceHeaders = headers;

      const colTarikh = pickCol(headers, SETTINGS.attendanceMap.tarikh) || pickCol(headers, "Tarikh");
      const colKelas  = pickCol(headers, SETTINGS.attendanceMap.kelas)  || pickCol(headers, "Kelas");
      const colNama   = pickCol(headers, SETTINGS.attendanceMap.nama)   || pickCol(headers, "Nama Murid") || pickCol(headers, "Nama_Murid");
      const colStatus = pickCol(headers, SETTINGS.attendanceMap.status) || pickCol(headers, "Status");
      const colJantina= pickCol(headers, SETTINGS.attendanceMap.jantina)|| pickCol(headers, "Jantina");

      const data = parsed.data.map(r=>{
        const tarikh = parseDateDMY(r[colTarikh]);
        const statusRaw = (r[colStatus]||"").trim().toUpperCase();
        const status = statusRaw.includes("TIDAK") ? "TIDAK HADIR" : (statusRaw ? "HADIR" : "");
        return {
          __tarikh: tarikh,
          Tarikh: r[colTarikh] || "",
          Kelas: r[colKelas] || "",
          "Nama Murid": r[colNama] || "",
          Status: status || (r[colStatus]||""),
          Jantina: r[colJantina] || "",
          __raw: r
        };
      }).filter(x=> x.__tarikh);

      data.sort((a,b)=> b.__tarikh - a.__tarikh);
      return data;
    }

    function normalizeAnnouncements(parsed){
      const H = parsed.headers;

      const colStart = pickCol(H,"TARIKH MULA") || pickCol(H,"Tarikh Mula");
      const colEnd   = pickCol(H,"TARIKH TAMAT") || pickCol(H,"Tarikh Tamat");
      const colTitle = pickCol(H,"TAJUK");
      const colBody  = pickCol(H,"ISI KANDUNGAN") || pickCol(H,"Isi Kandungan");
      const colUrl   = pickCol(H,"URL");
      const colPri   = pickCol(H,"KEUTAMAAN");
      const colAktif = pickCol(H,"AKTIF");

      const now = new Date(); now.setHours(0,0,0,0);

      const data = parsed.data.map(r=>{
        const start = parseDateDMY(r[colStart]);
        const end = parseDateDMY(r[colEnd]);
        const title = (r[colTitle]||"").trim();
        const body = (r[colBody]||"").trim();
        const url = (r[colUrl]||"").trim();
        const pri = (r[colPri]||"").trim().toUpperCase();
        const aktif = (r[colAktif]||"").trim().toUpperCase();

        let computedActive = false;
        if(start && title){
          computedActive = (start <= now) && (!end || end >= now);
        }
        let finalActive = computedActive;
        if(aktif === "YA") finalActive = true;
        if(aktif === "TIDAK") finalActive = false;

        return {
          start, end,
          title, body, url,
          pri: pri || "SEDERHANA",
          active: finalActive,
          startText: r[colStart] || "",
          endText: r[colEnd] || ""
        };
      });

      const priRank = (p)=>{
        p = String(p||"").toUpperCase();
        if(p.includes("TINGGI")) return 3;
        if(p.includes("SEDER")) return 2;
        return 1;
      };
      data.sort((a,b)=>{
        const pr = priRank(b.pri)-priRank(a.pri);
        if(pr!==0) return pr;
        return (b.start?.getTime()||0) - (a.start?.getTime()||0);
      });

      return data;
    }

    function normalizeParents(parsed){
      const H = parsed.headers;
      const colTitle = pickCol(H,"TAJUK") || pickCol(H,"Tajuk");
      const colBody  = pickCol(H,"ISI KANDUNGAN") || pickCol(H,"Isi Kandungan") || pickCol(H,"Isi");
      const colUrl   = pickCol(H,"URL") || pickCol(H,"Pautan");
      const colMode  = pickCol(H,"MOD") || pickCol(H,"Mode") || pickCol(H,"TINDAKAN");

      return parsed.data
        .map(r=>({
          title: (r[colTitle]||"").trim(),
          body: (r[colBody]||"").trim(),
          url: (r[colUrl]||"").trim(),
          mode: ((r[colMode]||"POPUP").trim().toUpperCase())
        }))
        .filter(x=>x.title);
    }

    function normalizeCalendar(parsed){
      return parsed.data;
    }

    /***********************
     * COMPUTE ATTENDANCE STATS
     ***********************/
    function computeStats(list){
      const now = new Date(); now.setHours(0,0,0,0);
      const weekStart = startOfWeekMonday(now);
      const weekEnd = endOfWeekSunday(now);

      const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
      const monthEnd = new Date(now.getFullYear(), now.getMonth()+1, 0, 23,59,59,999);

      const isHadir = (r)=> String(r.Status||"").toUpperCase().includes("HADIR") && !String(r.Status||"").toUpperCase().includes("TIDAK");

      const todayList = list.filter(r => r.__tarikh && r.__tarikh.getTime()===now.getTime());
      const weekList  = list.filter(r => r.__tarikh && r.__tarikh>=weekStart && r.__tarikh<=weekEnd);
      const monthList = list.filter(r => r.__tarikh && r.__tarikh>=monthStart && r.__tarikh<=monthEnd);

      const todayHadir = todayList.filter(isHadir).length;
      const todayTotal = todayList.length;

      const weekHadir = weekList.filter(isHadir).length;
      const weekTotal = weekList.length;

      const monthHadir = monthList.filter(isHadir).length;
      const monthTotal = monthList.length;

      const pct = monthTotal ? (monthHadir/monthTotal*100) : 0;

      return {
        now, weekStart, weekEnd, monthStart, monthEnd,
        todayHadir, todayTotal,
        weekHadir, weekTotal,
        monthHadir, monthTotal,
        pct
      };
    }

    function setStatUI(stats){
      vToday.textContent = stats.todayHadir;
      sToday.textContent = `${stats.todayHadir} / ${stats.todayTotal}`;
      vWeek.textContent = stats.weekHadir;
      sWeek.textContent = `${stats.weekHadir} / ${stats.weekTotal}`;
      vMonth.textContent = stats.monthHadir;
      sMonth.textContent = `${stats.monthHadir} / ${stats.monthTotal}`;
      vPct.textContent = `${stats.pct.toFixed(1)}%`;

      vToday2.textContent = stats.todayHadir;
      sToday2.textContent = `${stats.todayHadir} / ${stats.todayTotal}`;
      vWeek2.textContent = stats.weekHadir;
      sWeek2.textContent = `${stats.weekHadir} / ${stats.weekTotal}`;
      vMonth2.textContent = stats.monthHadir;
      sMonth2.textContent = `${stats.monthHadir} / ${stats.monthTotal}`;
      vPct2.textContent = `${stats.pct.toFixed(1)}%`;
    }

    /***********************
     * LINE CHART SVG (WITH AXIS)
     ***********************/
    function renderLineChartSVG(opts){
      const {
        width=780, height=260,
        data=[],
        yMax=null,
        yMin=0,
        yLabel="",
        xLabel="Hari",
        mode="hadir"
      } = opts;

      const padL = 44, padR = 16, padT = 14, padB = 34;
      const W = width, H = height;
      const innerW = W - padL - padR;
      const innerH = H - padT - padB;

      const ys = data.map(d=>d.y);
      const maxY = (yMax!==null) ? yMax : Math.max(1, ...ys, 1);
      const minY = (yMin!==null) ? yMin : 0;
      const range = (maxY - minY) || 1;

      function xScale(x){
        const minX = data.length ? Math.min(...data.map(d=>d.xValue)) : 1;
        const maxX = data.length ? Math.max(...data.map(d=>d.xValue)) : 31;
        const rx = (maxX - minX) || 1;
        return padL + ((x - minX)/rx) * innerW;
      }
      function yScale(y){
        const t = (y - minY)/range;
        return padT + (1 - t) * innerH;
      }

      const yTicks = (mode==="pct") ? [0,25,50,75,100] : (()=>{
        const t = 4;
        const step = Math.max(1, Math.round(maxY / t));
        const arr = [];
        for(let v=0; v<=maxY; v+=step) arr.push(v);
        if(arr[arr.length-1] !== maxY) arr.push(maxY);
        return arr.slice(0,6);
      })();

      const xTicks = [1,5,10,15,20,25,30,31];

      const pts = data
        .sort((a,b)=>a.xValue-b.xValue)
        .map(d=> `${xScale(d.xValue).toFixed(1)},${yScale(d.y).toFixed(1)}`)
        .join(" ");

      const svg = `
        <svg viewBox="0 0 ${W} ${H}" width="100%" height="${H}" style="color: var(--text);">
          ${yTicks.map(v=>{
            const y = yScale(v);
            return `
              <line x1="${padL}" y1="${y}" x2="${W-padR}" y2="${y}" stroke="var(--border)" stroke-width="1" />
              <text x="${padL-8}" y="${y+4}" text-anchor="end" font-size="11" fill="var(--muted)" font-weight="800">${v}${mode==="pct" ? "%" : ""}</text>
            `;
          }).join("")}

          <line x1="${padL}" y1="${H-padB}" x2="${W-padR}" y2="${H-padB}" stroke="var(--border)" stroke-width="1" />
          <line x1="${padL}" y1="${padT}" x2="${padL}" y2="${H-padB}" stroke="var(--border)" stroke-width="1" />

          ${xTicks.map(v=>{
            if(!data.length) return "";
            const minX = Math.min(...data.map(d=>d.xValue));
            const maxX = Math.max(...data.map(d=>d.xValue));
            if(v<minX || v>maxX) return "";
            const x = xScale(v);
            return `
              <line x1="${x}" y1="${H-padB}" x2="${x}" y2="${H-padB+5}" stroke="var(--border)" stroke-width="1" />
              <text x="${x}" y="${H-12}" text-anchor="middle" font-size="11" fill="var(--muted)" font-weight="800">${v}</text>
            `;
          }).join("")}

          ${data.length ? `
            <path d="M ${padL} ${H-padB} L ${pts.replaceAll(" ", " L ")} L ${W-padR} ${H-padB} Z"
              fill="rgba(42,161,152,.10)" stroke="none" />
          ` : ""}

          ${data.length ? `
            <polyline points="${pts}" fill="none" stroke="currentColor" stroke-width="3.2"
              stroke-linecap="round" stroke-linejoin="round" />
          ` : `
            <text x="${W/2}" y="${H/2}" text-anchor="middle" font-size="13" fill="var(--muted)" font-weight="900">
              Tiada data untuk pilihan ini
            </text>
          `}

          ${data.length ? (()=> {
            const last = data.slice().sort((a,b)=>a.xValue-b.xValue).at(-1);
            const cx = xScale(last.xValue);
            const cy = yScale(last.y);
            return `<circle cx="${cx}" cy="${cy}" r="5.4" fill="currentColor" />`;
          })() : ""}

          <text x="${W/2}" y="${H-2}" text-anchor="middle" font-size="11" fill="var(--muted)" font-weight="900">${xLabel}</text>
          <text x="12" y="${H/2}" text-anchor="middle" font-size="11" fill="var(--muted)" font-weight="900" transform="rotate(-90 12 ${H/2})">${yLabel}</text>
        </svg>
      `;
      return svg;
    }

    /***********************
     * TREND CHART
     ***********************/
    function setupTrendSelectors(){
      const now = new Date();
      const monthNames = ["Jan","Feb","Mac","Apr","Mei","Jun","Jul","Ogos","Sep","Okt","Nov","Dis"];

      trendMonth.innerHTML = "";
      monthNames.forEach((m,idx)=>{
        const opt = document.createElement("option");
        opt.value = String(idx);
        opt.textContent = m;
        trendMonth.appendChild(opt);
      });
      trendMonth.value = String(now.getMonth());

      trendYear.innerHTML = "";
      const y = now.getFullYear();
      for(let i=y-2; i<=y+1; i++){
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = String(i);
        trendYear.appendChild(opt);
      }
      trendYear.value = String(y);

      trendMonth.addEventListener("change", renderTrend);
      trendYear.addEventListener("change", renderTrend);
      trendClass.addEventListener("change", renderTrend);

      trendMode.addEventListener("click",(e)=>{
        const chip = e.target.closest(".chip");
        if(!chip) return;
        trendMode.querySelectorAll(".chip").forEach(c=>c.classList.remove("active"));
        chip.classList.add("active");
        renderTrend();
      });
    }

    function renderTrend(){
      if(!attendanceRaw.length){
        trendChart.innerHTML = renderLineChartSVG({ data:[], mode:"hadir" });
        return;
      }
      const mode = trendMode.querySelector(".chip.active")?.dataset.mode || "hadir";
      const month = Number(trendMonth.value);
      const year = Number(trendYear.value);
      const kelas = trendClass.value;

      const filtered = attendanceRaw.filter(r=>{
        if(!r.__tarikh) return false;
        if(r.__tarikh.getFullYear() !== year) return false;
        if(r.__tarikh.getMonth() !== month) return false;
        if(kelas && String(r.Kelas||"") !== kelas) return false;
        return true;
      });

      const isHadir = (r)=> String(r.Status||"").toUpperCase()==="HADIR";
      const isTidak = (r)=> String(r.Status||"").toUpperCase().includes("TIDAK");

      const map = new Map();
      filtered.forEach(r=>{
        const day = r.__tarikh.getDate();
        if(!map.has(day)) map.set(day, {hadir:0, tidak:0, total:0});
        const o = map.get(day);
        o.total++;
        if(isHadir(r)) o.hadir++;
        if(isTidak(r)) o.tidak++;
      });

      const lastDay = new Date(year, month+1, 0).getDate();
      const series = [];
      for(let d=1; d<=lastDay; d++){
        const o = map.get(d) || {hadir:0, tidak:0, total:0};
        let yVal = 0;
        if(mode==="hadir") yVal = o.hadir;
        if(mode==="tidak") yVal = o.tidak;
        if(mode==="pct"){
          yVal = o.total ? (o.hadir/o.total*100) : 0;
          yVal = Number(yVal.toFixed(1));
        }
        series.push({ xValue:d, xLabel:String(d), y: yVal });
      }

      const yLabel = (mode==="pct") ? "Peratus (%)" : "Bilangan";
      const svg = renderLineChartSVG({
        width: 860,
        height: 260,
        data: series,
        yMax: (mode==="pct") ? 100 : null,
        yMin: 0,
        yLabel,
        xLabel: "Hari",
        mode
      });

      trendChart.innerHTML = svg;
    }

    /***********************
     * ATTENDANCE TABLE + FILTER
     ***********************/
    function populateClassOptions(){
      const classes = Array.from(new Set(attendanceRaw.map(r=>String(r.Kelas||"").trim()).filter(Boolean))).sort();
      filterClass.innerHTML = `<option value="">Kelas: Semua</option>` + classes.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
      trendClass.innerHTML = `<option value="">Semua Kelas</option>` + classes.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
    }

    function renderAttendanceTable(list){
      const cols = ["Tarikh","Kelas","Nama Murid","Status","Jantina"];
      attendanceHead.innerHTML = cols.map(c=>`<th>${escapeHtml(c)}</th>`).join("");

      attendanceBody.innerHTML = list.map(r=>{
        const s = String(r.Status||"").toUpperCase();
        let badge = `<span class="badge">${escapeHtml(r.Status||"")}</span>`;
        if(s==="HADIR") badge = `<span class="badge b-ok">‚úÖ HADIR</span>`;
        if(s.includes("TIDAK")) badge = `<span class="badge b-no">‚õî TIDAK HADIR</span>`;
        return `
          <tr>
            <td>${escapeHtml(r.Tarikh||"")}</td>
            <td>${escapeHtml(r.Kelas||"")}</td>
            <td>${escapeHtml(r["Nama Murid"]||"")}</td>
            <td>${badge}</td>
            <td>${escapeHtml(r.Jantina||"")}</td>
          </tr>
        `;
      }).join("");

      attendanceMeta.textContent = `Paparan: ${list.length} rekod`;
    }

    function applyAttendanceFilter(){
      const q = (searchAttendance.value||"").trim().toLowerCase();
      const kelas = filterClass.value;
      const statusSel = filterStatus.value;

      const df = dateFrom.value ? new Date(dateFrom.value+"T00:00:00") : null;
      const dt = dateTo.value ? new Date(dateTo.value+"T23:59:59") : null;

      const filtered = attendanceRaw.filter(r=>{
        if(kelas && String(r.Kelas||"") !== kelas) return false;
        if(statusSel){
          if(statusSel==="HADIR" && String(r.Status||"").toUpperCase()!=="HADIR") return false;
          if(statusSel==="TIDAK HADIR" && !String(r.Status||"").toUpperCase().includes("TIDAK")) return false;
        }
        if(df && r.__tarikh < df) return false;
        if(dt && r.__tarikh > dt) return false;

        if(q){
          const hay = `${r.Tarikh} ${r.Kelas} ${r["Nama Murid"]} ${r.Status} ${r.Jantina}`.toLowerCase();
          if(!hay.includes(q)) return false;
        }
        return true;
      });

      renderAttendanceTable(filtered);
    }

    btnApplyFilter.addEventListener("click", applyAttendanceFilter);
    btnResetFilter.addEventListener("click", ()=>{
      searchAttendance.value = "";
      filterClass.value = "";
      filterStatus.value = "";
      dateFrom.value = "";
      dateTo.value = "";
      renderAttendanceTable(attendanceRaw);
    });
    searchAttendance.addEventListener("input", applyAttendanceFilter);
    filterClass.addEventListener("change", applyAttendanceFilter);
    filterStatus.addEventListener("change", applyAttendanceFilter);
    dateFrom.addEventListener("change", applyAttendanceFilter);
    dateTo.addEventListener("change", applyAttendanceFilter);

    btnReloadAttendance.addEventListener("click", loadAttendance);

    /***********************
     * ANNOUNCEMENTS UI
     ***********************/
    function renderAnnouncements(){
      const active = announcementsRaw.filter(a=>a.active);

      annCount.textContent = `${active.length} aktif`;
      annListHome.innerHTML = "";

      if(!active.length){
        annListHome.innerHTML = `<div class="sub">Tiada pengumuman aktif.</div>`;
      }else{
        active.slice(0,10).forEach((a,idx)=>{
          const pri = String(a.pri||"").toUpperCase();
          const badge = pri.includes("TINGGI")
            ? `<span class="badge b-hi">üî• TINGGI</span>`
            : `<span class="badge">${escapeHtml(pri)}</span>`;

          const card = document.createElement("div");
          card.className = "stat";
          card.style.cursor = "pointer";
          card.innerHTML = `
            <div class="k">#${idx+1} ${badge}</div>
            <div class="v" style="font-size:15px; margin-top:8px;">${escapeHtml(a.title)}</div>
            <div class="s">${escapeHtml(a.startText || (a.start?formatDMY(a.start):""))}</div>
          `;
          card.addEventListener("click", ()=>{
            showPage("announcements");
            openAnnouncementModal(a);
          });
          annListHome.appendChild(card);
        });
      }

      annGrid.innerHTML = "";
      const list = announcementsRaw.filter(a=>a.active);
      if(!list.length){
        annGrid.innerHTML = `<div class="sub">Tiada pengumuman aktif.</div>`;
        return;
      }
      list.forEach(a=>{
        const pri = String(a.pri||"").toUpperCase();
        const badge = pri.includes("TINGGI")
          ? `<span class="badge b-hi">üî• TINGGI</span>`
          : `<span class="badge">${escapeHtml(pri)}</span>`;

        const el = document.createElement("div");
        el.className = "card";
        el.style.cursor="pointer";
        el.innerHTML = `
          <div class="cardTitle">
            <h2 style="font-size:15px; margin:0;">${escapeHtml(a.title)}</h2>
            <div>${badge}</div>
          </div>
          <p class="sub" style="margin:0 0 10px;">
            ${escapeHtml(a.startText || (a.start?formatDMY(a.start):""))}
          </p>
          <div class="sub" style="display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;">
            ${escapeHtml(a.body || "")}
          </div>
        `;
        el.addEventListener("click", ()=> openAnnouncementModal(a));
        annGrid.appendChild(el);
      });
    }

    function openAnnouncementModal(a){
      annModalTitle.textContent = a.title || "Butiran Pengumuman";
      const body = `
        <div class="card" style="margin:0;">
          <div class="row" style="justify-content:space-between;">
            <div class="sub" style="font-weight:900;">
              Tarikh Mula: ${escapeHtml(a.startText || (a.start?formatDMY(a.start):"-"))}
            </div>
            <div class="sub" style="font-weight:900;">
              Keutamaan: ${escapeHtml(a.pri || "-")}
            </div>
          </div>

          <div style="margin-top:10px; white-space:pre-wrap; line-height:1.6;">
            ${escapeHtml(a.body || "-")}
          </div>

          ${a.url ? `
            <div style="margin-top:12px;">
              <a class="btn btnPrimary" href="${escapeAttr(a.url)}" target="_blank" rel="noopener">Buka Pautan</a>
            </div>
          `: ``}
        </div>
      `;
      annModalBody.innerHTML = body;
      overlayAnn.classList.add("show");
    }

    btnCloseAnn.addEventListener("click", ()=> overlayAnn.classList.remove("show"));
    overlayAnn.addEventListener("click", (e)=>{
      if(e.target === overlayAnn) overlayAnn.classList.remove("show");
    });
    btnReloadAnnouncements.addEventListener("click", loadAnnouncements);

    /***********************
     * PARENTS UI
     ***********************/
    function renderParents(){
      parentsGrid.innerHTML = "";
      if(!parentsRaw.length){
        parentsGrid.innerHTML = `<div class="sub">Tiada data.</div>`;
        return;
      }
      parentsRaw.forEach(item=>{
        const el = document.createElement("div");
        el.className = "card";
        el.style.cursor="pointer";

        const hasUrl = !!item.url;
        const actionText = !hasUrl ? "Pop out" : (item.mode==="TAB" ? "Buka Tab Baru" : "Pop out");
        el.innerHTML = `
          <div class="cardTitle">
            <h2 style="font-size:15px; margin:0;">${escapeHtml(item.title)}</h2>
            <span class="badge">${escapeHtml(actionText)}</span>
          </div>
          <div class="sub" style="white-space:pre-wrap; line-height:1.6;">
            ${escapeHtml(item.body || "")}
          </div>
        `;

        el.addEventListener("click", ()=>{
          if(hasUrl && item.mode==="TAB"){
            window.open(item.url, "_blank", "noopener");
            return;
          }
          annModalTitle.textContent = item.title;
          annModalBody.innerHTML = `
            <div class="card" style="margin:0;">
              <div style="white-space:pre-wrap; line-height:1.6;">
                ${escapeHtml(item.body || "-")}
              </div>
              ${hasUrl ? `
                <div style="margin-top:12px;">
                  <a class="btn btnPrimary" href="${escapeAttr(item.url)}" target="_blank" rel="noopener">Buka Pautan</a>
                </div>
              `:``}
            </div>
          `;
          overlayAnn.classList.add("show");
        });

        parentsGrid.appendChild(el);
      });
    }
    btnReloadParents.addEventListener("click", loadParents);

    /***********************
     * CALENDAR UI
     ***********************/
    function renderCalendar(){
      if(!SETTINGS.urls.calendar){
        calendarArea.textContent = "Belum disambungkan.";
        return;
      }
      if(!calendarRaw.length){
        calendarArea.textContent = "Tiada data.";
        return;
      }
      calendarArea.innerHTML = `
        <div class="tableWrap">
          <table>
            <thead>
              <tr>${Object.keys(calendarRaw[0]).map(h=>`<th>${escapeHtml(h)}</th>`).join("")}</tr>
            </thead>
            <tbody>
              ${calendarRaw.slice(0,50).map(r=>`
                <tr>${Object.keys(calendarRaw[0]).map(h=>`<td>${escapeHtml(r[h]||"")}</td>`).join("")}</tr>
              `).join("")}
            </tbody>
          </table>
        </div>
        <p class="help">Paparan ringkas (maks 50 rekod). Jika cikgu nak versi takwim cantik (grid bulan), saya boleh upgrade.</p>
      `;
    }

    /***********************
     * ESCAPE
     ***********************/
    function escapeHtml(s){
      return String(s??"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(s){ return escapeHtml(s); }

    /***********************
     * LOADERS
     ***********************/
    async function loadAttendance(){
      try{
        const parsed = await fetchCSV(SETTINGS.urls.attendance);
        attendanceRaw = normalizeAttendance(parsed);

        populateClassOptions();
        renderAttendanceTable(attendanceRaw);

        const stats = computeStats(attendanceRaw);
        setStatUI(stats);

        renderTrend();
      }catch(err){
        console.error(err);
        attendanceRaw = [];
        attendanceHead.innerHTML = "";
        attendanceBody.innerHTML = `<tr><td colspan="5">Gagal load data kehadiran. Sila semak URL CSV.</td></tr>`;
        attendanceMeta.textContent = "‚Äî";
        trendChart.innerHTML = renderLineChartSVG({ data:[], mode:"hadir" });
      }
    }

    async function loadAnnouncements(){
      try{
        const parsed = await fetchCSV(SETTINGS.urls.announcements);
        announcementsRaw = normalizeAnnouncements(parsed);
        renderAnnouncements();
      }catch(err){
        console.error(err);
        announcementsRaw = [];
        annCount.textContent = "Gagal load";
        annListHome.innerHTML = `<div class="sub">Gagal load pengumuman. Sila semak URL CSV.</div>`;
        annGrid.innerHTML = `<div class="sub">Gagal load pengumuman.</div>`;
      }
    }

    async function loadParents(){
      try{
        const parsed = await fetchCSV(SETTINGS.urls.parents);
        parentsRaw = normalizeParents(parsed);
        renderParents();
      }catch(err){
        console.error(err);
        parentsRaw = [];
        parentsGrid.innerHTML = `<div class="sub">Gagal load data Ibu Bapa. Sila semak URL CSV.</div>`;
      }
    }

    async function loadCalendar(){
      if(!SETTINGS.urls.calendar){
        calendarRaw = [];
        renderCalendar();
        return;
      }
      try{
        const parsed = await fetchCSV(SETTINGS.urls.calendar);
        calendarRaw = normalizeCalendar(parsed);
        renderCalendar();
      }catch(err){
        console.error(err);
        calendarRaw = [];
        renderCalendar();
      }
    }

    async function loadAll(){
      await Promise.all([
        loadAttendance(),
        loadAnnouncements(),
        loadParents(),
        loadCalendar()
      ]);
    }

    /***********************
     * HOME STAT CARDS NAV
     ***********************/
    document.getElementById("statToday").addEventListener("click", ()=>{ showPage("attendance"); filterStatus.value="HADIR"; applyAttendanceFilter(); });
    document.getElementById("statWeek").addEventListener("click", ()=>{ showPage("attendance"); });
    document.getElementById("statMonth").addEventListener("click", ()=>{ showPage("attendance"); });
    document.getElementById("statPct").addEventListener("click", ()=>{ showPage("attendance"); });

    document.querySelectorAll('[data-jump]').forEach(el=>{
      el.addEventListener("click", ()=>{ showPage("attendance"); });
    });

    /***********************
     * INIT
     ***********************/
    function init(){
      applyTheme();
      applyIdentity();
      initSidebarState();
      setupAutoHideSidebar();

      tickClock();
      setupTrendSelectors();

      showPage("home");
      loadAll();
    }
    init();
  </script>
</body>
</html>
