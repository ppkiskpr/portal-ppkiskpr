<!doctype html>
<html lang="ms" class="h-full">
<head>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portal Rasmi PPKI SK Paya Resak</title>
  <link rel="icon" type="image/png" href="SKPR 1.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

  <style>
    /* === CSS UTAMA (V28.24 - Security Patch) === */
    :root { --font-main: 'Poppins', sans-serif; --bg-body: #F2F4F7; --bg-sidebar: #FFFFFF; --bg-card: #FFFFFF; --bg-element: #F9FAFB; --border-color: #EAECF0; --text-main: #101828; --text-muted: #667085; --primary: #1F6F4A; --primary-light: #E8F5E9; --accent: #F79009; --shadow-sm: 0 1px 2px rgba(16, 24, 40, 0.05); --radius-card: 16px; --sidebar-w-full: 260px; --sidebar-w-mini: 74px; }
    html[data-mode="dark"] { --bg-body: #0F1115; --bg-sidebar: #161B22; --bg-card: #1C2128; --bg-element: #252B36; --border-color: #30363D; --text-main: #F0F6FC; --text-muted: #8B949E; --primary: #2EA043; --primary-light: rgba(46, 160, 67, 0.15); }
    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; font-family: var(--font-main); background: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; }
    .app-container { display: flex; height: 100%; width: 100%; overflow: hidden; }

    /* LOGIN SCREEN */
    #login-screen { position: fixed; inset: 0; z-index: 9999; background: #F2F4F7; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s ease; }
    .login-box { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 90%; }
    .login-btn-google { background: #4285F4; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; cursor: pointer; font-family: 'Poppins', sans-serif; display: flex; align-items: center; gap: 10px; margin: 20px auto 0; }
    .login-btn-google:hover { background: #3367d6; }

    /* LOADING SPINNER */
    #loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: none; place-items: center; backdrop-filter: blur(2px); }
    .spinner { width: 40px; height: 40px; border: 4px solid #fff; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* SIDEBAR WITH SCROLL */
    .sidebar { 
        background: var(--bg-sidebar); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 20px 12px; transition: width 0.3s ease; z-index: 50; flex-shrink: 0; overflow: hidden; height: 100%; max-height: 100vh;
    }
    @media (min-width: 769px) { .sidebar { width: var(--sidebar-w-full); } body.desktop-mini .sidebar { width: var(--sidebar-w-mini); } body.desktop-mini .brand-text, body.desktop-mini .nav-text, body.desktop-mini .sidebar-footer { opacity: 0; pointer-events: none; display: none; } body.desktop-mini .brand { justify-content: center; padding-left: 0; } body.desktop-mini .nav-item { justify-content: center; padding: 12px 0; } body.desktop-mini .nav-icon { margin-right: 0; } }
    @media (max-width: 768px) { .sidebar { position: fixed; left: -100%; top: 0; height: 100%; width: 260px; box-shadow: 5px 0 25px rgba(0,0,0,0.2); } body.mobile-active .sidebar { left: 0; } .backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; display: none; backdrop-filter: blur(2px); } body.mobile-active .backdrop { display: block; } }
    
    .brand { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; min-height: 45px; overflow: hidden; white-space: nowrap; flex-shrink: 0; }
    .brand-logo { width: 40px; height: 40px; border-radius: 8px; flex-shrink: 0; }
    .brand-logo img { width: 100%; height: 100%; object-fit: contain; }
    .brand-text h1 { margin: 0; font-size: 15px; font-weight: 700; }
    .brand-text p { margin: 0; font-size: 11px; color: var(--text-muted); }
    
    .nav-menu { flex: 1; display: flex; flex-direction: column; gap: 4px; overflow-y: auto; overflow-x: hidden; padding-bottom: 40px; min-height: 0; }
    .nav-menu::-webkit-scrollbar { width: 5px; }
    .nav-menu::-webkit-scrollbar-track { background: transparent; }
    .nav-menu::-webkit-scrollbar-thumb { background: #d0d5dd; border-radius: 10px; }
    
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 14px; border-radius: 10px; cursor: pointer; color: var(--text-muted); text-decoration: none; transition: all 0.2s; white-space: nowrap; font-size: 13px; font-weight: 500; flex-shrink: 0; }
    .nav-item:hover { background: var(--bg-element); color: var(--text-main); }
    .nav-item.active { background: var(--primary-light); color: var(--primary); font-weight: 600; }
    .nav-icon { font-size: 20px; display: flex; align-items: center; justify-content: center; min-width: 24px; }
    
    .nav-group-header { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; padding: 15px 14px 5px 14px; margin-top: 5px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; flex-shrink: 0; }
    .nav-group-header .toggle-icon { font-size: 16px; transition: transform 0.3s; }
    .nav-group-header.collapsed .toggle-icon { transform: rotate(-90deg); }
    .nav-child-container { overflow: hidden; transition: max-height 0.3s ease; flex-shrink: 0; }
    .nav-child-container.collapsed { max-height: 0; }
    
    /* FOOTER & USER INFO WRAPPING */
    .sidebar-footer { margin-top: auto; font-size: 11px; text-align: center; color: var(--text-muted); padding-top: 20px; line-height: 1.4; border-top: 1px solid var(--border-color); flex-shrink: 0; background: var(--bg-sidebar); }
    #userInfo { margin-bottom: 10px; font-weight: 600; font-size: 12px; display: none; white-space: normal; word-wrap: break-word; overflow-wrap: break-word; line-height: 1.3; text-align: center; padding: 0 5px; }

    /* MAIN CONTENT */
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; height: 100%; }
    .top-bar { height: 64px; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; background: var(--bg-body); flex-shrink: 0; }
    .icon-btn { width: 40px; height: 40px; border-radius: 8px; border: none; background: transparent; color: var(--text-main); display: grid; place-items: center; cursor: pointer; font-size: 24px; }
    .content-area { flex: 1; overflow-y: auto; padding: 10px 24px 40px 24px; }

    /* COMPONENTS */
    .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 24px; }
    .card { background: var(--bg-card); padding: 20px; border-radius: var(--radius-card); border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); }
    .stat-label { font-size: 13px; color: var(--text-muted); font-weight: 500; }
    .stat-val { font-size: 28px; font-weight: 700; margin: 5px 0; color: var(--text-main); }
    .stat-sub { font-size: 12px; display: flex; align-items: center; gap: 4px; color: var(--text-muted); }
    .stat-sub.red { color: #D92D20; font-weight: 600; }
    .clickable { cursor: pointer; transition: transform 0.2s, border-color 0.2s; }
    .clickable:hover { transform: translateY(-3px); border-color: var(--primary); }
    
    /* ENROLMEN */
    .enrol-grid { display: flex; gap: 30px; align-items: center; flex-wrap: wrap; }
    .chart-box { flex: 0 0 240px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
    .chart-center-text { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none; }
    .chart-number { font-size: 28px; font-weight: 800; line-height: 1; color: var(--text-main); }
    .nav-card-btn { margin-top: 25px; background: var(--primary); color: white; padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; width: 100%; text-align: center; border: none; transition: transform 0.2s; }
    .class-list-box { flex: 1; min-width: 250px; }
    .class-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    .class-card-mini { background: var(--bg-element); padding: 15px; border-radius: 12px; border: 1px solid var(--border-color); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 12px; }
    .class-card-mini:hover, .class-card-mini.active { background: var(--primary-light); border-color: var(--primary); transform: translateY(-2px); }
    .cc-icon-box { width: 36px; height: 36px; background: #D1FADF; border-radius: 8px; display: grid; place-items: center; color: var(--primary); }
    .cc-info { flex: 1; }
    .cc-name { font-weight: 700; font-size: 12px; color: var(--text-main); margin-bottom: 2px; text-transform: uppercase; }
    .cc-count { font-size: 11px; color: var(--text-muted); display: flex; gap: 8px; font-weight: 500; }

    .page-banner { background: linear-gradient(135deg, var(--primary), #144d33); color: white; padding: 24px; border-radius: 16px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
    .banner-text h2 { margin: 0; font-size: 22px; font-weight: 700; }
    .btn-action { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 8px; transition: background 0.2s; }

    .filter-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .form-select, .form-input { background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-main); padding: 0 12px; border-radius: 8px; font-family: inherit; font-size: 13px; width: 100%; height: 42px; box-sizing: border-box; }
    .btn { padding: 0 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 13px; height: 42px; display: inline-flex; align-items: center; justify-content: center; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-main); }
    
    .filter-panel { display: none; padding: 20px; background: var(--bg-element); border-radius: 12px; margin-top: 15px; border: 1px solid var(--border-color); }
    .filter-panel.open { display: block; }
    .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
    .filter-label { font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block; color: var(--text-muted); }

    .table-wrap { overflow-x: auto; border-radius: 12px; border: 1px solid var(--border-color); }
    table { width: 100%; border-collapse: collapse; min-width: 800px; font-size: 13px; }
    th { text-align: left; padding: 14px 16px; background: var(--bg-element); color: var(--text-muted); font-weight: 600; text-transform: uppercase; white-space: nowrap; }
    td { padding: 14px 16px; border-top: 1px solid var(--border-color); color: var(--text-main); vertical-align: top; }
    
    .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; display: inline-block; }
    .b-green { background: #ECFDF3; color: #027A48; }
    .b-red { background: #FEF3F2; color: #B42318; }
    .b-blue { background: #EFF8FF; color: #175CD3; }

    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; display: none; place-items: center; backdrop-filter: blur(2px); }
    .modal-overlay.active { display: grid; }
    .modal-content { width: 90%; max-width: 500px; background: var(--bg-card); border-radius: 16px; padding: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-height: 85vh; overflow-y: auto; }

    .id-result-box { display:none; background: var(--bg-element); padding: 15px; border-radius: 10px; margin-top: 15px; border: 1px solid var(--border-color); }
    .id-result-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color); }
    .id-value { font-weight: 600; }
    .copy-btn { background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 4px; transition: 0.2s; }

    @media (max-width: 1024px) { .dashboard-grid { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 768px) { .dashboard-grid { grid-template-columns: 1fr; } .page-banner { flex-direction: column; align-items: flex-start; } }
  </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <div style="width:60px; height:60px; background:var(--primary); border-radius:12px; margin:0 auto 20px; display:grid; place-items:center;">
             <span class="material-icons-round" style="color:white; font-size:32px;">school</span>
        </div>
        <h2 style="margin:0 0 10px; color:var(--text-main);">Selamat Datang</h2>
        <p style="color:var(--text-muted); font-size:14px; margin:0 0 20px;">Portal Rasmi PPKI SK Paya Resak</p>
        <button id="btnLoginGoogle" class="login-btn-google" onclick="handleAuth()"><span class="material-icons-round">login</span> Masuk dengan Google</button>
        <p id="loginStatus" style="font-size:12px; margin-top:20px; color:var(--text-muted);"></p>
    </div>
</div>

<div id="loading-overlay"><div class="spinner"></div></div>

<div class="backdrop" onclick="toggleSidebar()"></div>

<div class="app-container" id="appContainer" style="display:none;">
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <div class="brand-logo"><img src="https://i.ibb.co/Y7sp2wZg/SKPR-1.png" alt="Logo"></div>
      <div class="brand-text"><h1>SK Paya Resak</h1><p>Moving Forward</p></div>
    </div>
    <div class="nav-menu" id="sidebarMenu"></div>
    <div class="sidebar-footer">
      <div id="userInfo"></div>
      <button id="authBtn" onclick="handleAuth()" class="btn btn-primary" style="width:100%; font-size:12px; margin-bottom:15px;">Log Masuk</button>
      <div>Â© 2025 NK.</div>
      <div style="font-size: 10px; color: var(--text-muted); margin-top: 5px;">Ver 28.24</div>
    </div>
  </aside>

  <main class="main-content">
    <header class="top-bar">
      <button class="icon-btn" onclick="toggleSidebar()"><span class="material-icons-round">menu</span></button>
      <div style="display:flex; gap:8px;">
        <button class="icon-btn" onclick="toggleTheme()" title="Tema"><span class="material-icons-round">dark_mode</span></button>
        <button class="icon-btn" id="btnSettings" onclick="openSettings()" title="Tetapan" style="display:none;"><span class="material-icons-round">settings</span></button>
      </div>
    </header>

    <div class="content-area">
      <div id="page-home" class="page-section">
        <div class="page-banner">
          <div class="banner-text"><h2>Dashboard</h2><p>Selamat Datang ke Portal Rasmi PPKI</p></div>
          <div class="banner-actions"><button class="btn-action" onclick="forceReload('all')"><span class="material-icons-round" style="font-size:16px">refresh</span> Reload Semua</button></div>
        </div>
        
        <div class="dashboard-grid">
          <div class="card stat-card att-card"><div class="stat-label">Kehadiran Hari Ini</div><div class="stat-val" id="dToday">-</div><div class="stat-sub red" id="dAbsent">- Tidak Hadir</div></div>
          <div class="card stat-card att-card"><div class="stat-label">Minggu Ini</div><div class="stat-val" id="dWeek">-</div><div class="stat-sub">Rekod Kehadiran</div></div>
          <div class="card stat-card att-card"><div class="stat-label">Hari Ini</div><div class="stat-val" id="dPct">-</div><div class="stat-sub">Peratus Kehadiran</div></div>
          <div class="card stat-card clickable" onclick="navTo('announcements')"><div class="stat-label">Pengumuman</div><div class="stat-val" id="dAnn">-</div><div class="stat-sub">Aktif</div></div>
        </div>

        <div class="card" style="margin-bottom: 24px; padding: 24px;">
            <h3 style="margin:0 0 20px; font-size:16px;">ðŸŽ“ Enrolmen Murid</h3>
            <div class="enrol-grid">
                <div class="chart-box">
                    <div style="height: 220px; width: 220px; position:relative;">
                        <canvas id="genderChart"></canvas>
                        <div class="chart-center-text"><div class="chart-number" id="centerCount">-</div></div>
                    </div>
                    <button id="navCardBtn" class="nav-card-btn" onclick="navTo('student_list')" style="display:none;">SEMUA MURID</button>
                </div>
                <div class="class-list-box"><div class="class-grid" id="classGrid"></div></div>
            </div>
        </div>

        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px; margin-bottom:20px;">
            <h3 style="margin:0; font-size:16px;">ðŸ“ˆ Trend Harian</h3>
            <div class="filter-row">
              <select class="form-select" style="width:auto" id="trendType"><option value="hadir">Hadir</option><option value="tidak">Tidak Hadir</option><option value="pct">%</option></select>
              <select class="form-select" style="width:auto" id="trendMonth"></select>
              <select class="form-select" style="width:auto" id="trendYear"></select>
              <select class="form-select" style="width:auto" id="trendClass"><option value="">Semua Kelas</option></select>
              <button class="btn btn-primary" onclick="renderTrend()"><span class="material-icons-round">search</span></button>
            </div>
          </div>
          <div id="chartContainer" style="height:280px; width:100%;"></div>
        </div>
      </div>

      <div id="page-student_list" class="page-section" style="display:none;">
          <div class="page-banner"><div class="banner-text"><h2>Senarai Nama Murid</h2><p>Rekod Penuh Enrolmen</p></div><div class="banner-actions"><button class="btn-action" onclick="forceReload('stulist')"><span class="material-icons-round" style="font-size:16px">refresh</span> Reload</button></div></div>
          <div class="card">
              <div style="margin-bottom:15px; display:flex; gap:10px;"><input class="form-input" id="searchStuList" placeholder="Cari Nama Murid..." style="flex:1;"><button class="btn btn-primary" onclick="renderStudentList()">Cari</button></div>
              <div class="filter-row" style="margin-bottom:15px; background:var(--bg-element); padding:15px; border-radius:10px;"><div style="flex:1"><label class="filter-label">Filter Pintar</label><select class="form-select" id="fStuSmart"><option value="">Semua Data</option></select></div><div><button class="btn btn-outline" onclick="resetStudentList()">Reset</button></div></div>
              <div class="table-wrap"><table id="stuTable"><thead><tr><th>NAMA MURID</th><th>NO. KP</th><th>KELAS</th><th>JANTINA</th></tr></thead><tbody id="stuBody"></tbody></table></div>
              <div style="margin-top:10px; font-size:12px; color:var(--text-muted);" id="stuCount"></div>
          </div>
      </div>

      <div id="page-emailcheck" class="page-section" style="display:none;">
        <div class="page-banner"><div class="banner-text"><h2>Semakan ID Delima</h2><p>Semak Emel & Kata Laluan Murid</p></div></div>
        <div class="card" style="max-width:600px; margin:0 auto;">
            <div style="text-align:center; margin-bottom:20px;"><span class="material-icons-round" style="font-size:48px; color:var(--primary);">fingerprint</span><p style="color:var(--text-muted); font-size:13px;">Masukkan No. Kad Pengenalan murid.</p></div>
            <div style="display:flex; gap:10px; margin-bottom:10px;"><input id="inputIC" class="form-input" placeholder="Contoh: 123456789012" style="flex:1; text-align:center;"><button class="btn btn-primary" onclick="checkEmail()">Semak</button></div>
            <div id="idResultContainer" class="id-result-box">
                <div class="id-result-item"><span class="id-label">NAMA MURID</span><span class="id-value" id="resNama">-</span></div>
                <div class="id-result-item"><span class="id-label">EMEL DELIMA</span><div class="id-value-group"><span class="id-value" id="resEmail">-</span><button class="copy-btn" onclick="copyText('resEmail')"><span class="material-icons-round">content_copy</span></button></div></div>
                <div class="id-result-item"><span class="id-label">KATA LALUAN</span><div class="id-value-group"><span class="id-value" id="resPass">-</span><button class="copy-btn" onclick="copyText('resPass')"><span class="material-icons-round">content_copy</span></button></div></div>
            </div>
            <p id="idError" style="text-align:center; color:#B42318; font-size:13px; display:none;"></p>
        </div>
      </div>

      <div id="page-attendance" class="page-section" style="display:none;">
        <div class="page-banner"><div class="banner-text"><h2>Analisis Kehadiran</h2><p>Rekod kehadiran & statistik</p></div><div class="banner-actions"><button class="btn-action" onclick="forceReload('att')"><span class="material-icons-round" style="font-size:16px">refresh</span> Reload</button></div></div>
        <div class="dashboard-grid">
          <div class="card"><div class="stat-label">Hadir (Tapis)</div><div class="stat-val" id="attStatHadir">-</div></div>
          <div class="card"><div class="stat-label">Tidak Hadir (Tapis)</div><div class="stat-val" id="attStatTidak">-</div></div>
          <div class="card"><div class="stat-label">Peratus (Tapis)</div><div class="stat-val" id="attStatPct">-</div></div>
          <div class="card"><div class="stat-label">Jumlah Rekod</div><div class="stat-val" id="attStatTotal">-</div></div>
        </div>
        <div class="card">
            <div style="display:flex; gap:10px; margin-bottom:10px;"><input class="form-input" id="searchAtt" placeholder="Cari Nama Murid..." style="flex:1;"><button class="btn btn-primary" onclick="applyFilterAtt()">Cari</button></div>
            <div class="table-wrap"><table><thead><tr><th>Tarikh</th><th>Nama Murid</th><th>Kelas</th><th>Status</th></tr></thead><tbody id="attBody"></tbody></table></div>
        </div>
      </div>

      <div id="page-asnaf" class="page-section" style="display:none;">
          <div class="page-banner"><div class="banner-text"><h2>Rekod Murid Asnaf</h2><p>Bantuan & Kebajikan</p></div></div>
          <div class="card">
              <div class="table-wrap"><table><thead><tr><th>NAMA MURID</th><th>KELAS</th><th>PENDAPATAN</th></tr></thead><tbody id="asnafBody"></tbody></table></div>
          </div>
      </div>

      <div id="page-yatim" class="page-section" style="display:none;">
          <div class="page-banner"><div class="banner-text"><h2>Rekod Murid Yatim</h2><p>Bantuan & Kebajikan</p></div></div>
          <div class="card">
              <div class="table-wrap"><table><thead><tr><th>NAMA MURID</th><th>KELAS</th><th>PENDAPATAN</th></tr></thead><tbody id="yatimBody"></tbody></table></div>
          </div>
      </div>

      <div id="page-pajsk" class="page-section" style="display:none;">
        <div class="page-banner"><div class="banner-text"><h2>Rekod PAJSK</h2><p>Pencapaian Kokurikulum</p></div></div>
        <div class="card">
            <div class="table-wrap"><table><thead><tr><th>Tahun</th><th>Tarikh</th><th>Unit</th><th>Nama Murid</th><th>Acara</th><th>Pencapaian</th></tr></thead><tbody id="pajskBody"></tbody></table></div>
        </div>
      </div>

      <div id="page-announcements" class="page-section" style="display:none;">
        <div class="page-banner"><div class="banner-text"><h2>Pengumuman</h2><p>Info Terkini</p></div></div>
        <div class="dashboard-grid" id="annGrid"></div>
        <div id="annEmpty" style="display:none; text-align:center; padding:40px; color:var(--text-muted);"><p>Tiada pengumuman aktif.</p></div>
      </div>

      <div id="page-calendar" class="page-section" style="display:none;">
        <div class="page-banner"><div class="banner-text"><h2>Takwim</h2><p>Jadual Aktiviti</p></div></div>
        <div class="card">
            <div class="table-wrap"><table><thead><tr><th>BULAN</th><th>TARIKH</th><th>AKTIVITI</th><th>TINDAKAN</th></tr></thead><tbody id="calBody"></tbody></table></div>
        </div>
      </div>
      
      <div id="page-opr" class="page-section" style="display:none;">
          <div class="page-banner"><div class="banner-text"><h2>One Page Report (OPR)</h2><p>Laporan & Dokumentasi Tahunan</p></div></div>
          <div class="dashboard-grid" id="oprGrid"></div>
      </div>

      <div id="page-parents" class="page-section" style="display:none;">
        <div class="page-banner"><div class="banner-text"><h2>Info Ibu Bapa</h2><p>Pautan & Dokumen</p></div></div>
        <div class="dashboard-grid" id="parentsGrid"></div>
      </div>
    </div>
  </main>
</div>

<div class="modal-overlay" id="infoModal"><div class="modal-content"><h3 id="infoTitle"></h3><div id="infoBody" style="margin:15px 0;"></div><div id="infoLinkContainer" style="display:none; text-align:right;"><button id="infoLinkBtn" class="btn btn-primary">Buka Pautan</button></div><button class="btn btn-outline" style="width:100%; margin-top:15px;" onclick="document.getElementById('infoModal').classList.remove('active')">Tutup</button></div></div>
<div class="modal-overlay" id="settingsModal"><div class="modal-content"><h3>Tetapan Portal</h3><div id="pinStep"><input type="password" id="pinInput" class="form-input" placeholder="PIN"><button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="checkPin()">Sahkan</button></div><div id="settingStep" style="display:none;"><label>Nama Sekolah</label><input id="setName" class="form-input"><div id="menuManagerList"></div><button class="btn btn-primary" onclick="saveSettings()" style="width:100%; margin-top:20px;">Simpan</button></div></div></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const ADMIN_EMAILS = ["naimullahkhalid@gmail.com", "g-84398229@moe-dl.edu.my", "g-48397926@moe-dl.edu.my", "g-82398222@moe-dl.edu.my", "g-04388130@moe-dl.edu.my", "g-32398244@moe-dl.edu.my", "g-23319047@moe-dl.edu.my", "g-42398215@moe-dl.edu.my", "g-30397592@moe-dl.edu.my", "g-58397586@moe-dl.edu.my", "g-35298209@moe-dl.edu.my"];
  const firebaseConfig = { apiKey: "AIzaSyDdDlLNMjcOfi-6tfeaS_PcicQcnsqxaOk", authDomain: "portalppkiskpr-ecd1c.firebaseapp.com", projectId: "portalppkiskpr-ecd1c", storageBucket: "portalppkiskpr-ecd1c.firebasestorage.app", messagingSenderId: "643002702082", appId: "1:643002702082:web:7bac296fa189fa2f41ca1b" };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();
  
  const OPR_DATA = [{ title: "OPR 2025", url: "#", icon: "folder_open", desc: "Laporan Aktiviti Tahun 2025" }, { title: "OPR 2026", url: "#", icon: "folder_open", desc: "Laporan Aktiviti Tahun 2026" }];

  const DEFAULTS = {
    schoolName: "SK Paya Resak", pin: "5235",
    urls: {
      attendance: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQWi_5VfDz43sMFydp926q062CCPLyRnNUZyAGtlSk_9xv3gI0Xo0I7VMGSlj-llcpYCFHggVP289Ja/pub?gid=944218320&single=true&output=csv",
      pajsk: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQoRKdkGyefQ6iSz1HVsXTEenUDbSKjC_XXlq8qQLFYg6IjnSkaixKsg0ajT88VvfnnjkGaDNtxvvD7/pub?gid=1208025171&single=true&output=csv",
      announcements: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQvKlO-LRGh8kj_-Be6NxZRR3Z38rjbC33jyvfhQvnR9L4LF7_dZRVXYGK3XO7bAoJwC9bJJmABjV6Z/pub?gid=946270411&single=true&output=csv",
      parents: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ_G1txQOE4Di1XsK6esbw8VgQtW2hcPsjzAmPH7V82JOeXegb7Kb_3Iz8CeHo-KvfvHe9x8BWtSfbB/pub?gid=1684744050&single=true&output=csv",
      calendar: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQvKlO-LRGh8kj_-Be6NxZRR3Z38rjbC33jyvfhQvnR9L4LF7_dZRVXYGK3XO7bAoJwC9bJJmABjV6Z/pub?gid=1430230642&single=true&output=csv",
      database: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQN1zKkJFojiuyR1EGgdRJiS_ohrrWgxc12rC9dXRfnIR9WGC1Xdh6zdkSVLHzmqn89UHsJsSLaattG/pub?gid=630662258&single=true&output=csv",
      student_list: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQN1zKkJFojiuyR1EGgdRJiS_ohrrWgxc12rC9dXRfnIR9WGC1Xdh6zdkSVLHzmqn89UHsJsSLaattG/pub?gid=1759925919&single=true&output=csv",
      asnaf: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqXBgq99xruYi-J-st-Rz9CF4UcgZZLvqWJM26C2J51oWXdYy2O1z-x7e6U8To8OSBpgQuYXCS-lTv/pub?gid=877457981&single=true&output=csv", 
      yatim: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqXBgq99xruYi-J-st-Rz9CF4UcgZZLvqWJM26C2J51oWXdYy2O1z-x7e6U8To8OSBpgQuYXCS-lTv/pub?gid=1167967580&single=true&output=csv",
      delima: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQvKlO-LRGh8kj_-Be6NxZRR3Z38rjbC33jyvfhQvnR9L4LF7_dZRVXYGK3XO7bAoJwC9bJJmABjV6Z/pub?gid=1752164570&single=true&output=csv"
    },
    menus: [
      {id:'home', label:'Dashboard', icon:'dashboard', hidden:false, role:'public'},
      {id:'attendance', label:'Kehadiran', icon:'analytics', hidden:false, role:'admin'},
      {id:'student_list', label:'Senarai Nama Murid', icon:'groups', hidden:false, role:'admin'}, 
      {id:'asnaf', label:'Rekod Asnaf', icon:'volunteer_activism', hidden:false, role:'admin'},
      {id:'yatim', label:'Rekod Yatim', icon:'child_care', hidden:false, role:'admin'},
      {id:'pajsk', label:'Rekod PAJSK', icon:'emoji_events', hidden:false, role:'admin'},
      {id:'announcements', label:'Pengumuman', icon:'campaign', hidden:false, role:'public'},
      {id:'opr', label:'Laporan OPR', icon:'description', hidden:false, role:'public'},
      {id:'calendar', label:'Takwim Tahunan', icon:'calendar_month', hidden:false, role:'public'},
      {id:'parents', label:'Info Ibu Bapa', icon:'diversity_3', hidden:false, role:'public'},
      {id:'emailcheck', label:'Semakan ID', icon:'password', hidden:false, role:'family'}, 
    ]
  };

  let CONFIG = JSON.parse(localStorage.getItem('portalConfig')) || DEFAULTS;
  let DATA = { att: [], pajsk: [], ann: [], cal: [], par: [], db: [], asnaf: [], yatim: [], stu: [], delima: [] };
  let DATA_ATT_CLEAN = [];
  let USER_ROLE = 'public';
  let chartInstance = null;

  Chart.register(ChartDataLabels);

  window.init = function() {
    applyTheme();
    setupTrendSelectors();
    loadAllData();
    renderOPR();
    document.querySelector('.brand-text h1').textContent = CONFIG.schoolName;
  }

  // === SECURE NAVIGATION (GATEKEEPER) ===
  window.navTo = function(id) {
    // 1. Check Security Clearance First!
    const menu = CONFIG.menus.find(m => m.id === id);
    if(menu) {
        if(menu.role === 'admin' && USER_ROLE !== 'admin') {
            alert("Akses Disekat: Anda tiada kebenaran.");
            // Reset URL hash to home to prevent loop
            history.pushState(null, null, '#home');
            navTo('home');
            return;
        }
        if(menu.role === 'family' && USER_ROLE === 'public') {
            alert("Sila Log Masuk untuk akses.");
            history.pushState(null, null, '#home');
            navTo('home');
            return;
        }
    }

    // 2. Proceed if Allowed
    document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
    const el = document.getElementById(`nav-${id}`);
    if(el) el.classList.add('active');
    
    document.querySelectorAll('.page-section').forEach(e => e.style.display='none');
    const target = document.getElementById(`page-${id}`);
    if(target) target.style.display='block';
    
    if(id === 'asnaf') renderAsnafTable();
    if(id === 'yatim') renderYatimTable();
    if(id === 'student_list') renderStudentList();
    
    if(window.innerWidth <= 768) document.body.classList.remove('mobile-active');

    // 3. Update URL (Safe to update now)
    if(window.location.hash !== '#' + id) {
        history.pushState(null, null, '#' + id);
    }
  }

  window.addEventListener('popstate', function() {
      const hash = window.location.hash.substring(1);
      if(hash && document.getElementById('page-' + hash)) navTo(hash);
      else navTo('home');
  });

  window.handleAuth = function() {
    if (auth.currentUser) { if(confirm("Log keluar?")) signOut(auth).then(() => location.reload()); }
    else signInWithPopup(auth, provider).catch(e => alert(e.message));
  }

  onAuthStateChanged(auth, (user) => {
    const btn = document.getElementById('authBtn');
    const info = document.getElementById('userInfo');
    const gear = document.getElementById('btnSettings');
    const loginScreen = document.getElementById('login-screen');
    const appContainer = document.getElementById('appContainer');

    if (user) {
      USER_ROLE = ADMIN_EMAILS.includes(user.email) ? 'admin' : 'family';
      btn.textContent = "Log Keluar"; btn.style.background = "#B42318";
      info.style.display = "block";
      info.innerHTML = `<div>${user.displayName}</div><div style="color:var(--primary); font-size:10px;">${USER_ROLE.toUpperCase()}</div>`;
      if(USER_ROLE === 'admin') gear.style.display = 'grid';
      loginScreen.style.display = 'none'; appContainer.style.display = 'flex';
      init();
    } else {
      USER_ROLE = 'public';
      btn.textContent = "Log Masuk"; info.style.display = "none"; gear.style.display = "none";
      loginScreen.style.display = 'none'; appContainer.style.display = 'flex';
      init();
    }
    
    const enrolBtn = document.getElementById('navCardBtn');
    if(enrolBtn) enrolBtn.style.display = (USER_ROLE === 'admin') ? 'block' : 'none';

    renderSidebar();

    // === DEEP LINKING ON LOAD ===
    // We run this inside onAuthStateChanged to ensure USER_ROLE is ready
    const initialHash = window.location.hash.substring(1);
    if (initialHash && document.getElementById('page-' + initialHash)) {
        // Attempt to navigate (navTo checks security)
        navTo(initialHash);
    } else {
        navTo('home');
    }
  });

  window.renderSidebar = function() {
    const nav = document.getElementById('sidebarMenu'); nav.innerHTML = '';
    const GROUPS = [
        { type: 'single', id: 'home' }, 
        { type: 'group', label: 'HEM', id: 'grp_hem', items: ['attendance', 'student_list', 'asnaf', 'yatim', 'emailcheck', 'parents'] },
        { type: 'group', label: 'KOKURIKULUM', id: 'grp_koko', items: ['pajsk'] },
        { type: 'group', label: 'PENTADBIRAN', id: 'grp_admin', items: ['announcements', 'opr', 'calendar'] }
    ];

    GROUPS.forEach(g => {
        if(g.type === 'single') {
            const m = CONFIG.menus.find(x => x.id === g.id);
            if(m && !m.hidden && (m.role === 'public' || USER_ROLE === 'admin' || (m.role === 'family' && USER_ROLE === 'family'))) {
                const a = document.createElement('a');
                a.className = `nav-item ${window.location.hash === '#'+m.id ? 'active' : ''}`;
                a.id = `nav-${m.id}`; a.innerHTML = `<span class="nav-icon material-icons-round">${m.icon}</span> ${m.label}`;
                a.onclick = () => navTo(m.id); nav.appendChild(a);
            }
        } else {
            const items = g.items.filter(id => {
                const m = CONFIG.menus.find(x => x.id === id);
                return m && !m.hidden && (m.role === 'public' || USER_ROLE === 'admin' || (m.role === 'family' && USER_ROLE === 'family'));
            });
            if(items.length) {
                const h = document.createElement('div'); h.className = 'nav-group-header';
                h.innerHTML = `${g.label} <span class="material-icons-round toggle-icon">expand_more</span>`;
                h.onclick = () => { h.nextElementSibling.classList.toggle('collapsed'); h.classList.toggle('collapsed'); };
                nav.appendChild(h);
                const c = document.createElement('div'); c.className = 'nav-child-container';
                items.forEach(id => {
                    const m = CONFIG.menus.find(x => x.id === id);
                    const a = document.createElement('a'); a.className = 'nav-item'; a.id = `nav-${m.id}`;
                    a.style.paddingLeft = '24px'; a.style.fontSize = '12px';
                    a.innerHTML = `<span class="nav-icon material-icons-round" style="font-size:18px">${m.icon}</span> ${m.label}`;
                    a.onclick = () => navTo(m.id); c.appendChild(a);
                });
                nav.appendChild(c);
            }
        }
    });
  }

  // --- CSV & DATA HANDLING ---
  async function loadAllData() {
    document.getElementById('loading-overlay').style.display = 'grid';
    try {
        const res = await Promise.all([
            fetchCSV(CONFIG.urls.attendance), fetchCSV(CONFIG.urls.pajsk), fetchCSV(CONFIG.urls.announcements),
            fetchCSV(CONFIG.urls.calendar), fetchCSV(CONFIG.urls.parents), fetchCSV(CONFIG.urls.database),
            fetchCSV(CONFIG.urls.asnaf), fetchCSV(CONFIG.urls.yatim), fetchCSV(CONFIG.urls.student_list), fetchCSV(CONFIG.urls.delima)
        ]);
        DATA.att=res[0]; DATA.pajsk=res[1]; DATA.ann=res[2]; DATA.cal=res[3]; DATA.par=res[4]; DATA.db=res[5]; DATA.asnaf=res[6]; DATA.yatim=res[7]; DATA.stu=res[8]; DATA.delima=res[9];
        processAttendance(); processEnrolment(); renderAnn(); initPajsk(); renderParents(); initCalendar(); renderCalendarTable(); renderStudentList();
    } finally { document.getElementById('loading-overlay').style.display = 'none'; }
  }

  async function fetchCSV(url) { if(!url) return []; try { const res = await fetch(url + (url.includes('?')?'&':'?') + 't=' + Date.now()); const text = await res.text(); return parseCSV(text); } catch { return []; } }
  
  function parseCSV(text) {
      const rows = []; let row = []; let cur = ""; let inQuotes = false;
      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        if (ch === '"') inQuotes = !inQuotes;
        else if (ch === "," && !inQuotes) { row.push(cur.trim()); cur = ""; }
        else if (ch === "\n" && !inQuotes) { row.push(cur.trim()); rows.push(row); row = []; cur = ""; }
        else cur += ch;
      }
      row.push(cur.trim()); rows.push(row);
      const headers = rows[0].map(h => h.toUpperCase());
      return rows.slice(1).map(r => { const o = {}; headers.forEach((h, i) => o[h] = r[i] || ""); return o; });
  }

  function getVal(r, k) { const key = Object.keys(r).find(x => x.includes(k.toUpperCase())); return key ? r[key] : ""; }

  // --- CORE SYSTEMS ---
  function processEnrolment() {
    const grid = document.getElementById('classGrid'); grid.innerHTML = '';
    const classList = ["1 AL-FARABI", "2 AL-FARABI", "3 AL-FARABI", "4 AL-FARABI", "5 AL-FARABI"];
    let totalL=0, totalP=0;
    classList.forEach(cls => {
        const stds = DATA.db.filter(r => getVal(r,'KELAS').includes(cls[0]));
        let l=0, p=0;
        stds.forEach(s => { const g = getVal(s,'JANTINA').toUpperCase(); if(g.startsWith('L')) l++; else if(g.startsWith('P')) p++; });
        totalL+=l; totalP+=p;
        const div = document.createElement('div'); div.className='class-card-mini';
        div.innerHTML=`<div class="cc-icon-box"><span class="material-icons-round">school</span></div><div class="cc-info"><div class="cc-name">${cls}</div><div class="cc-count">${l+p} Murid</div></div>`;
        div.onclick = () => updateChart(cls, l, p);
        grid.appendChild(div);
    });
    updateChart('SEMUA', totalL, totalP);
  }

  function updateChart(label, l, p) {
    document.getElementById('centerCount').innerText = l+p;
    const ctx = document.getElementById('genderChart').getContext('2d');
    if(chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, { type:'doughnut', data:{ labels:['Lelaki','Perempuan'], datasets:[{ data:[l,p], backgroundColor:['#2E90FA','#F63D68'], borderWidth:0 }] }, options:{ cutout:'70%', plugins:{ legend:{ display:false }, datalabels:{ display:false } } } });
  }

  window.checkEmail = function() {
    const ic = document.getElementById('inputIC').value.trim();
    const student = DATA.delima.find(r => (getVal(r,'KP')||getVal(r,'MYKID')).replace(/-/g,'') === ic.replace(/-/g,''));
    if(student) {
        document.getElementById('resNama').innerText = getVal(student,'NAMA');
        document.getElementById('resEmail').innerText = getVal(student,'EMEL') || getVal(student,'DELIMA');
        document.getElementById('resPass').innerText = getVal(student,'LALUAN') || getVal(student,'KATA LALUAN');
        document.getElementById('idResultContainer').style.display='block';
        document.getElementById('idError').style.display='none';
    } else {
        document.getElementById('idError').innerText='Rekod tidak dijumpai.';
        document.getElementById('idError').style.display='block';
    }
  }

  function processAttendance() {
    const present = DATA.att.filter(r => getVal(r,'STATUS').toUpperCase()==='HADIR').length;
    document.getElementById('dToday').innerText = present;
    document.getElementById('attBody').innerHTML = DATA.att.slice(0,50).map(r => `<tr><td>${getVal(r,'TARIKH')}</td><td>${getVal(r,'NAMA')}</td><td>${getVal(r,'KELAS')}</td><td><span class="badge ${getVal(r,'STATUS').toUpperCase()==='HADIR'?'b-green':'b-red'}">${getVal(r,'STATUS')}</span></td></tr>`).join('');
  }

  function renderStudentList() {
    document.getElementById('stuBody').innerHTML = DATA.stu.map(r => `<tr><td>${getVal(r,'NAMA')}</td><td>${getVal(r,'KP')}</td><td>${getVal(r,'KELAS')}</td><td>${getVal(r,'JANTINA')}</td></tr>`).join('');
    document.getElementById('stuCount').innerText = `Jumlah: ${DATA.stu.length} Murid`;
  }

  function renderAsnafTable() { document.getElementById('asnafBody').innerHTML = DATA.asnaf.map(r => `<tr><td>${getVal(r,'NAMA')}</td><td>${getVal(r,'KELAS')}</td><td>${getVal(r,'PENDAPATAN')}</td></tr>`).join(''); }
  function renderYatimTable() { document.getElementById('yatimBody').innerHTML = DATA.yatim.map(r => `<tr><td>${getVal(r,'NAMA')}</td><td>${getVal(r,'KELAS')}</td><td>${getVal(r,'PENDAPATAN')}</td></tr>`).join(''); }
  function initPajsk() { document.getElementById('pajskBody').innerHTML = DATA.pajsk.map(r => `<tr><td>${getVal(r,'TAHUN')}</td><td>${getVal(r,'TARIKH')}</td><td>${getVal(r,'UNIT')}</td><td>${getVal(r,'NAMA')}</td><td>${getVal(r,'ACARA')}</td><td>${getVal(r,'PENCAPAIAN')}</td></tr>`).join(''); }
  function renderAnn() { document.getElementById('annGrid').innerHTML = DATA.ann.map(a => `<div class="card"><h4>${getVal(a,'TAJUK')}</h4><p>${getVal(a,'ISI KANDUNGAN')}</p></div>`).join(''); }
  function renderParents() { document.getElementById('parentsGrid').innerHTML = DATA.par.map(p => `<div class="card clickable" onclick="window.open('${getVal(p,'URL')}','_blank')"><h4>${getVal(p,'TAJUK')}</h4><p>${getVal(p,'KANDUNGAN')}</p></div>`).join(''); }
  function initCalendar() { document.getElementById('calBody').innerHTML = DATA.cal.map(r => `<tr><td>${getVal(r,'BULAN')}</td><td>${getVal(r,'TARIKH')}</td><td>${getVal(r,'AKTIVITI')}</td><td>${getVal(r,'TINDAKAN')}</td></tr>`).join(''); }

  window.copyText = (id) => { navigator.clipboard.writeText(document.getElementById(id).innerText); alert('Disalin!'); };
  window.toggleSidebar = () => document.body.classList.toggle('mobile-active');
  window.toggleTheme = () => { const n = document.documentElement.getAttribute('data-mode')==='dark'?'light':'dark'; document.documentElement.setAttribute('data-mode',n); localStorage.setItem('theme',n); };
  function applyTheme() { document.documentElement.setAttribute('data-mode', localStorage.getItem('theme')||'light'); }
  function setupTrendSelectors() { /* implementation */ }
  window.forceReload = (t) => loadAllData();

  init();
</script>
</body>
</html>
