<!doctype html>
<html lang="ms" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portal Rasmi PPKI SK Paya Resak</title>

  <style>
    :root{
      /* ===== Fixed Theme (like your screenshot) ===== */
      --brand:#1F6F4A;        /* main green */
      --brand2:#0f4f34;       /* darker green */
      --accent:#111827;       /* dark text */
      --muted:#6b7280;
      --bg:#f3f4f6;           /* light background */
      --card:#ffffff;
      --card2:#f9fafb;
      --border:#e5e7eb;
      --shadow: 0 12px 28px rgba(17,24,39,.08);

      /* layout */
      --radius:18px;
      --radius2:22px;
      --rail:72px;            /* icon rail width */
      --sidebarW:280px;       /* expanded sidebar */
      --contentMax: 1180px;
    }

    html[data-mode="dark"]{
      --bg:#0b1220;
      --accent:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.65);
      --card:#111827;
      --card2:#0f172a;
      --border:rgba(255,255,255,.12);
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --brand:#1F6F4A;
      --brand2:#0f4f34;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg);
      color: var(--accent);
      min-height:100vh;
    }
    a{color:inherit;text-decoration:none}
    button,input,select{font-family:inherit}
    .app{display:flex;min-height:100vh}

    /* ===== Desktop: icon rail (always) ===== */
    .rail{
      width: var(--rail);
      background: #0b0f1a;
      color: rgba(255,255,255,.92);
      display:flex;
      flex-direction:column;
      align-items:center;
      padding: 10px 8px;
      gap: 10px;
      position: sticky;
      top:0;
      height: 100vh;
      z-index: 30;
    }
    html[data-mode="dark"] .rail{
      background:#060a12;
    }

    .railLogo{
      width:48px;height:48px;border-radius:16px;
      background: rgba(255,255,255,.10);
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.14);
      overflow:hidden;
      cursor:pointer;
      user-select:none;
    }
    .railLogo img{width:100%;height:100%;object-fit:cover;display:block}
    .railBtn{
      width:48px;height:48px;border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      display:grid;place-items:center;
      cursor:pointer;
      user-select:none;
      transition: transform .04s ease, background .15s ease;
      font-size:18px;
    }
    .railBtn:hover{ background: rgba(255,255,255,.10); }
    .railBtn:active{ transform: translateY(1px); }
    .railBtn.active{ background: rgba(31,111,74,.55); border-color: rgba(31,111,74,.55); }

    .railSpacer{flex:1}
    .railFooter{
      font-size:11px;
      opacity:.8;
      text-align:center;
      line-height:1.3;
      padding-bottom:6px;
      user-select:none;
    }

    /* ===== Expanded sidebar (optional) ===== */
    .sidebar{
      width: var(--sidebarW);
      background: var(--card);
      border-right:1px solid var(--border);
      padding: 14px 14px;
      position: sticky;
      top:0;
      height:100vh;
      overflow:auto;
      display:none; /* default collapsed (like screenshot) */
      z-index: 25;
    }
    body.sidebar-open .sidebar{ display:block; }

    .brandBox{
      border:1px solid var(--border);
      border-radius: var(--radius2);
      padding: 12px;
      background: var(--card2);
      display:flex; gap:10px; align-items:center;
      cursor:pointer;
      user-select:none;
    }
    .brandBox .logo{
      width:44px;height:44px;border-radius:16px;
      background: rgba(31,111,74,.14);
      border:1px solid var(--border);
      overflow:hidden;
      display:grid;place-items:center;
      flex:0 0 auto;
    }
    .brandBox .logo img{width:100%;height:100%;object-fit:cover;display:block}
    .brandBox .t{min-width:0}
    .brandBox .t .name{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .brandBox .t .motto{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .sideList{margin-top:12px;display:flex;flex-direction:column;gap:8px;}
    .sideItem{
      display:flex;align-items:center;gap:12px;
      border:1px solid transparent;
      border-radius: 16px;
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      background: transparent;
      transition: background .15s ease, border-color .15s ease;
      font-weight:800;
    }
    .sideItem:hover{ background: var(--card2); border-color: var(--border); }
    .sideItem.active{ background: rgba(31,111,74,.12); border-color: rgba(31,111,74,.25); }
    .sideIcon{
      width:36px;height:36px;border-radius:14px;
      display:grid;place-items:center;
      border:1px solid var(--border);
      background: var(--card);
      flex:0 0 auto;
    }
    .sideFoot{
      margin-top:14px;
      border:1px solid var(--border);
      border-radius: var(--radius2);
      padding: 10px 12px;
      background: var(--card2);
      color: var(--muted);
      font-size:12px;
      line-height:1.4;
    }

    /* ===== Main area ===== */
    .main{
      flex:1;
      min-width:0;
      padding: 14px 16px 26px;
    }

    .topbar{
      max-width: var(--contentMax);
      margin: 0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 12px 14px;
      border-radius: var(--radius2);
      background: var(--card);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      position: sticky;
      top: 10px;
      z-index: 20;
    }

    .topLeft{display:flex;align-items:center;gap:10px;min-width:0;}
    .hamburger{
      width:44px;height:44px;border-radius:16px;
      border:1px solid var(--border);
      background: var(--card2);
      display:grid;place-items:center;
      cursor:pointer;
      user-select:none;
      font-size:18px;
    }
    .pageTitleWrap{min-width:0}
    .pageTitle{font-weight:950;letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .pageSub{font-size:12px;color:var(--muted);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .topRight{display:flex;align-items:center;gap:10px;}
    .iconBtn{
      width:44px;height:44px;border-radius:16px;
      border:1px solid var(--border);
      background: var(--card2);
      display:grid;place-items:center;
      cursor:pointer;
      user-select:none;
      font-size:18px;
    }

    /* ===== Content layout like screenshot 2 ===== */
    .content{
      max-width: var(--contentMax);
      margin: 14px auto 0;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .banner{
      border-radius: var(--radius2);
      padding: 14px 16px;
      background: linear-gradient(90deg, var(--brand2), var(--brand));
      color: #fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      box-shadow: var(--shadow);
    }
    html[data-mode="dark"] .banner{
      box-shadow: 0 18px 55px rgba(0,0,0,.5);
    }
    .banner h1{margin:0;font-size:22px;letter-spacing:.2px}
    .banner .timeBox{
      background: rgba(255,255,255,.16);
      border:1px solid rgba(255,255,255,.25);
      padding: 10px 12px;
      border-radius: 16px;
      font-weight:900;
      white-space:nowrap;
    }

    .gridStats{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
    }
    .statCard{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius2);
      padding: 14px;
      box-shadow: var(--shadow);
      min-width:0;
    }
    .statLabel{font-size:13px;color:var(--muted);font-weight:900}
    .statValue{margin-top:6px;font-size:30px;font-weight:1000;letter-spacing:.2px}
    .statSub{margin-top:2px;font-size:12px;color:var(--muted);font-weight:900}

    .panelRow{
      display:grid;
      grid-template-columns: 1fr 2fr; /* left announcements, right trend chart */
      gap: 12px;
      align-items:start;
    }

    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius2);
      padding: 14px;
      box-shadow: var(--shadow);
      min-width:0;
    }
    .cardHead{
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
      margin-bottom: 8px;
    }
    .cardHead h2{margin:0;font-size:16px;letter-spacing:.2px}
    .sub{margin:0;color:var(--muted);font-size:12px;font-weight:800}

    .pillRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{
      border:1px solid var(--border);
      background: var(--card2);
      padding: 8px 12px;
      border-radius: 999px;
      cursor:pointer;
      user-select:none;
      font-weight:950;
      color: var(--muted);
    }
    .pill.active{
      background: rgba(31,111,74,.14);
      border-color: rgba(31,111,74,.28);
      color: var(--accent);
    }

    .field{
      border:1px solid var(--border);
      background: var(--card2);
      color: var(--accent);
      padding: 10px 12px;
      border-radius: 14px;
      outline:none;
      font-weight:900;
    }

    /* announcement items */
    .annList{display:flex;flex-direction:column;gap:10px;}
    .annItem{
      border:1px solid var(--border);
      background: var(--card2);
      border-radius: 18px;
      padding: 12px;
      cursor:pointer;
      user-select:none;
    }
    .annTitle{font-weight:1000;margin:0 0 6px 0}
    .annMeta{font-size:12px;color:var(--muted);font-weight:900;margin:0}

    /* chart area */
    .chartWrap{
      border:1px solid var(--border);
      background: var(--card2);
      border-radius: 18px;
      padding: 10px;
      overflow:hidden;
    }

    /* ===== Attendance Page table ===== */
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      border:1px solid var(--border);
      background: var(--card2);
      color: var(--accent);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      user-select:none;
      font-weight:1000;
    }
    .btnPrimary{
      background: rgba(31,111,74,.14);
      border-color: rgba(31,111,74,.28);
    }

    .tableWrap{
      margin-top: 12px;
      overflow:auto;
      border-radius: 18px;
      border:1px solid var(--border);
      background: var(--card);
    }
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:860px}
    th,td{padding:10px 10px;border-bottom:1px solid var(--border);vertical-align:top}
    th{position:sticky;top:0;background: var(--card);text-align:left;font-size:12px;color:var(--muted);font-weight:1000}
    td{font-size:13px}
    tr:hover td{background: rgba(31,111,74,.06)}
    html[data-mode="dark"] tr:hover td{background: rgba(255,255,255,.03)}

    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding: 6px 10px;border-radius:999px;
      border:1px solid var(--border);
      background: var(--card2);
      font-weight:1000;font-size:12px;
    }
    .bOk{background: rgba(34,197,94,.12);border-color: rgba(34,197,94,.28)}
    .bNo{background: rgba(239,68,68,.12);border-color: rgba(239,68,68,.28)}
    .bHi{background: rgba(245,158,11,.12);border-color: rgba(245,158,11,.30)}

    /* ===== Modals ===== */
    .overlay{
      position:fixed;inset:0;background: rgba(0,0,0,.55);
      display:none;z-index:70;padding:14px;overflow:auto;
    }
    .overlay.show{display:block}
    .modal{
      width:min(980px,100%);
      margin: 40px auto;
      background: var(--card);
      border:1px solid var(--border);
      border-radius: 22px;
      box-shadow: 0 22px 80px rgba(0,0,0,.45);
      overflow:hidden;
      display:flex;flex-direction:column;
      max-height: calc(100vh - 80px);
    }
    .modalHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding: 14px;
      border-bottom:1px solid var(--border);
      background: var(--card2);
    }
    .modalHead h3{margin:0;font-size:15px;font-weight:1000}
    .modalBody{padding:14px;overflow:auto}

    .warnBox{
      border:1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.12);
      border-radius: 16px;
      padding: 10px 12px;
      font-weight:1000;
      display:none;
      margin-top: 10px;
    }
    .warnBox.show{display:block}

    /* ===== Responsive ===== */
    @media (max-width: 1100px){
      .gridStats{grid-template-columns: repeat(2, minmax(0, 1fr));}
      .panelRow{grid-template-columns: 1fr;}
    }
    @media (max-width: 860px){
      /* Mobile practical */
      .rail{display:none;} /* hide rail on mobile */
      .sidebar{
        display:block;
        position:fixed;
        left:0;top:0;height:100vh;
        transform: translateX(-105%);
        z-index:80;
        box-shadow: 0 25px 70px rgba(0,0,0,.55);
      }
      body.sidebar-open .sidebar{ transform: translateX(0); }
      .main{padding: 12px;}
      .topbar{top: 8px;}
      .banner{flex-direction:column;align-items:flex-start}
      .banner h1{font-size:18px}
      .banner .timeBox{align-self:flex-end}
      .gridStats{grid-template-columns: repeat(2, minmax(0, 1fr));}
      .statValue{font-size:26px}
      table{min-width: 780px;}
    }
  </style>
</head>

<body>
<div class="app">

  <!-- Icon Rail (Desktop) -->
  <aside class="rail" id="rail">
    <div class="railLogo" id="railHome" title="Home">
      <span id="railLogoFallback" style="font-weight:1000;">üè´</span>
      <img id="railLogoImg" alt="" style="display:none;">
    </div>

    <div class="railBtn" id="railToggle" title="Buka/Tutup Menu">‚ò∞</div>

    <div class="railBtn active" data-page="home" title="Laman Utama">üè†</div>
    <div class="railBtn" data-page="attendance" title="Kehadiran">üßæ</div>
    <div class="railBtn" data-page="announcements" title="Pengumuman">üì¢</div>
    <div class="railBtn" data-page="calendar" title="Takwim">üóìÔ∏è</div>
    <div class="railBtn" data-page="parents" title="Ibu Bapa">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>

    <div class="railSpacer"></div>

    <div class="railBtn" id="railMode" title="Mode Cerah/Gelap">üåô</div>
    <div class="railBtn" id="railSettings" title="Tetapan">‚öôÔ∏è</div>

    <div class="railFooter" id="railFooterText">
      ¬© 2025<br/>NK
    </div>
  </aside>

  <!-- Sidebar (Mobile drawer + optional desktop expanded) -->
  <aside class="sidebar" id="sidebar">
    <div class="brandBox" id="brandGoHome">
      <div class="logo" id="sideLogo">
        <span style="font-weight:1000;">üè´</span>
      </div>
      <div class="t">
        <div class="name" id="schoolNameSide">SK Paya Resak</div>
        <div class="motto" id="schoolMottoSide">Moving Forward</div>
      </div>
    </div>

    <div class="sideList" id="sideList">
      <div class="sideItem active" data-page="home"><div class="sideIcon">üè†</div> Laman Utama</div>
      <div class="sideItem" data-page="attendance"><div class="sideIcon">üßæ</div> Kehadiran</div>
      <div class="sideItem" data-page="announcements"><div class="sideIcon">üì¢</div> Pengumuman</div>
      <div class="sideItem" data-page="calendar"><div class="sideIcon">üóìÔ∏è</div> Takwim</div>
      <div class="sideItem" data-page="parents"><div class="sideIcon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div> Ibu Bapa</div>
    </div>

    <div class="sideFoot">
      <div id="footerLine1Side">¬© 2025 NK.</div>
      <div id="footerLine2Side">Hak Cipta Terpelihara.</div>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">
    <!-- Topbar -->
    <header class="topbar">
      <div class="topLeft">
        <button class="hamburger" id="btnMenu" title="Menu">‚ò∞</button>
        <div class="pageTitleWrap">
          <div class="pageTitle" id="pageTitle">Laman Utama</div>
          <div class="pageSub" id="pageSub">Portal Rasmi PPKI</div>
        </div>
      </div>
      <div class="topRight">
        <button class="iconBtn" id="btnReload" title="Muat Semula">‚ü≥</button>
        <button class="iconBtn" id="btnMode" title="Mode Cerah/Gelap">üåô</button>
        <button class="iconBtn" id="btnSettings" title="Tetapan">‚öôÔ∏è</button>
      </div>
    </header>

    <section class="content">

      <!-- HOME -->
      <div class="page" id="page-home">
        <div class="banner">
          <h1 id="bannerText">Selamat Datang ke Portal Rasmi PPKI SK Paya Resak</h1>
          <div class="timeBox" id="timeNow">Ahad, 28 Disember 2025 ¬∑ 00:00:00</div>
        </div>

        <div class="gridStats">
          <div class="statCard">
            <div class="statLabel">Kehadiran Hari Ini</div>
            <div class="statValue" id="vToday">-</div>
            <div class="statSub" id="sToday">‚Äî</div>
          </div>
          <div class="statCard">
            <div class="statLabel">Kehadiran Minggu Ini</div>
            <div class="statValue" id="vWeek">-</div>
            <div class="statSub" id="sWeek">‚Äî</div>
          </div>
          <div class="statCard">
            <div class="statLabel">Kehadiran Bulan Ini</div>
            <div class="statValue" id="vMonth">-</div>
            <div class="statSub" id="sMonth">‚Äî</div>
          </div>
          <div class="statCard">
            <div class="statLabel">% Kehadiran Bulanan</div>
            <div class="statValue" id="vPct">-</div>
            <div class="statSub" id="sPct">Bulan semasa</div>
          </div>
        </div>

        <div class="panelRow">
          <div class="card">
            <div class="cardHead">
              <div>
                <h2>Status Pengumuman Aktif</h2>
                <p class="sub" id="annCount">‚Äî</p>
              </div>
              <button class="btn" id="btnToAnnouncements">Lihat Semua</button>
            </div>
            <div class="annList" id="annListHome"></div>
          </div>

          <div class="card">
            <div class="cardHead">
              <div>
                <h2>Trend Harian (Bulan Dipilih)</h2>
                <p class="sub">Pilih Bulan + Kelas dan mod paparan.</p>
              </div>
            </div>

            <div class="pillRow" id="trendMode">
              <div class="pill active" data-mode="hadir">Hadir</div>
              <div class="pill" data-mode="tidak">Tidak Hadir</div>
              <div class="pill" data-mode="pct">%</div>

              <select class="field" id="trendMonth"></select>
              <select class="field" id="trendYear"></select>
              <select class="field" id="trendClass"><option value="">Semua Kelas</option></select>
            </div>

            <div style="margin-top:10px" class="chartWrap">
              <div id="trendChart"></div>
            </div>

            <p class="sub" style="margin-top:10px">
              *Graf ringkas berdasarkan data kehadiran (Tarikh dd/mm/yyyy).
            </p>
          </div>
        </div>
      </div>

      <!-- ATTENDANCE -->
      <div class="page" id="page-attendance" style="display:none;">
        <div class="card">
          <div class="cardHead">
            <div>
              <h2>Dashboard Kehadiran</h2>
              <p class="sub">Filter ini akan ubah sekali statistik kad di atas (ikut kelas/status/date range/carian).</p>
            </div>
            <div class="row">
              <button class="btn" id="btnReloadAttendance">Muat Semula Data</button>
            </div>
          </div>

          <!-- ‚úÖ These cards follow FILTER -->
          <div class="gridStats" style="margin-top:10px">
            <div class="statCard">
              <div class="statLabel">Kehadiran Hari Ini</div>
              <div class="statValue" id="vToday2">-</div>
              <div class="statSub" id="sToday2">‚Äî</div>
            </div>
            <div class="statCard">
              <div class="statLabel">Kehadiran Minggu Ini</div>
              <div class="statValue" id="vWeek2">-</div>
              <div class="statSub" id="sWeek2">‚Äî</div>
            </div>
            <div class="statCard">
              <div class="statLabel">Kehadiran Bulan Ini</div>
              <div class="statValue" id="vMonth2">-</div>
              <div class="statSub" id="sMonth2">‚Äî</div>
            </div>
            <div class="statCard">
              <div class="statLabel">% Kehadiran Bulanan</div>
              <div class="statValue" id="vPct2">-</div>
              <div class="statSub" id="sPct2">Bulan semasa</div>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <div class="row" style="justify-content:space-between">
              <div class="row" style="flex:1;min-width:0">
                <input class="field" id="searchAttendance" placeholder="Carian (nama/kelas/status...)" style="flex:1;min-width:220px">
                <select class="field" id="filterClass"><option value="">Kelas: Semua</option></select>
                <select class="field" id="filterStatus">
                  <option value="">Status: Semua</option>
                  <option value="HADIR">Hadir</option>
                  <option value="TIDAK HADIR">Tidak Hadir</option>
                </select>
              </div>

              <div class="row">
                <input class="field" id="dateFrom" type="date" title="Tarikh mula">
                <input class="field" id="dateTo" type="date" title="Tarikh hingga">
                <button class="btn btnPrimary" id="btnApplyFilter">Tapis</button>
                <button class="btn" id="btnResetFilter">Reset</button>
              </div>
            </div>

            <div class="tableWrap">
              <table>
                <thead><tr id="attendanceHead"></tr></thead>
                <tbody id="attendanceBody"></tbody>
              </table>
            </div>

            <p class="sub" id="attendanceMeta" style="margin-top:10px">‚Äî</p>
          </div>
        </div>
      </div>

      <!-- ANNOUNCEMENTS -->
      <div class="page" id="page-announcements" style="display:none;">
        <div class="card">
          <div class="cardHead">
            <div>
              <h2>Pengumuman</h2>
              <p class="sub">Klik kad untuk lihat butiran penuh.</p>
            </div>
            <button class="btn" id="btnReloadAnnouncements">Muat Semula</button>
          </div>
          <div id="annGrid" style="display:grid;gap:12px;grid-template-columns:repeat(2,minmax(0,1fr))"></div>
        </div>
      </div>

      <!-- CALENDAR -->
      <div class="page" id="page-calendar" style="display:none;">
        <div class="card">
          <div class="cardHead">
            <div>
              <h2>Takwim</h2>
              <p class="sub">Jika nak paparan grid takwim (bulan), saya boleh upgrade.</p>
            </div>
          </div>
          <div id="calendarArea" class="sub">Belum disambungkan.</div>
        </div>
      </div>

      <!-- PARENTS -->
      <div class="page" id="page-parents" style="display:none;">
        <div class="card">
          <div class="cardHead">
            <div>
              <h2>Ibu Bapa</h2>
              <p class="sub">Kad info (pop out / buka tab baru ikut setting CSV).</p>
            </div>
            <button class="btn" id="btnReloadParents">Muat Semula</button>
          </div>
          <div id="parentsGrid" style="display:grid;gap:12px;grid-template-columns:repeat(2,minmax(0,1fr))"></div>
        </div>
      </div>

    </section>
  </main>
</div>

<!-- Modal: Announcement / Info -->
<div class="overlay" id="overlayInfo">
  <div class="modal">
    <div class="modalHead">
      <h3 id="infoTitle">Butiran</h3>
      <button class="iconBtn" id="btnCloseInfo" title="Tutup">‚úï</button>
    </div>
    <div class="modalBody" id="infoBody"></div>
  </div>
</div>

<!-- Modal: Settings (PIN gate) -->
<div class="overlay" id="overlaySettings">
  <div class="modal">
    <div class="modalHead">
      <h3>Tetapan Portal</h3>
      <button class="iconBtn" id="btnCloseSettings" title="Tutup">‚úï</button>
    </div>

    <div class="modalBody">
      <div id="pinStep">
        <p class="sub" style="margin:0 0 10px;">
          Untuk kemaskini Nama/Moto/Footer/Logo & URL CSV, masukkan PIN.
        </p>
        <div class="row">
          <input class="field" id="pinInput" inputmode="numeric" placeholder="Masukkan PIN" style="min-width:220px">
          <button class="btn btnPrimary" id="btnPinOk">Masuk</button>
        </div>
        <div class="warnBox" id="pinWarn">PIN salah. Sila cuba lagi.</div>
      </div>

      <div id="settingsStep" style="display:none;">
        <div style="display:grid;gap:12px;grid-template-columns:1fr 1fr;">
          <div class="card" style="box-shadow:none">
            <div class="cardHead">
              <div>
                <h2>Identiti Portal</h2>
                <p class="sub">Nama/Moto/Footer/Logo</p>
              </div>
            </div>
            <input class="field" id="setSchoolName" placeholder="Nama Sekolah" style="width:100%;margin-top:6px">
            <input class="field" id="setSchoolMotto" placeholder="Moto Sekolah" style="width:100%;margin-top:10px">
            <input class="field" id="setFooter1" placeholder="Footer (Baris 1)" style="width:100%;margin-top:10px">
            <input class="field" id="setFooter2" placeholder="Footer (Baris 2)" style="width:100%;margin-top:10px">

            <div style="margin-top:12px">
              <div class="sub" style="font-weight:1000">Logo Sekolah</div>
              <input class="field" id="setLogoFile" type="file" accept="image/*" style="width:100%;margin-top:6px">
              <p class="sub" style="margin-top:8px">Logo disimpan dalam browser (localStorage).</p>
            </div>
          </div>

          <div class="card" style="box-shadow:none">
            <div class="cardHead">
              <div>
                <h2>URL CSV</h2>
                <p class="sub">Kehadiran / Pengumuman / Ibu Bapa / Takwim</p>
              </div>
            </div>

            <div class="sub" style="font-weight:1000;margin-top:6px">Kehadiran</div>
            <input class="field" id="setUrlAttendance" style="width:100%;margin-top:6px">

            <div class="sub" style="font-weight:1000;margin-top:10px">Pengumuman</div>
            <input class="field" id="setUrlAnnouncements" style="width:100%;margin-top:6px">

            <div class="sub" style="font-weight:1000;margin-top:10px">Ibu Bapa</div>
            <input class="field" id="setUrlParents" style="width:100%;margin-top:6px">

            <div class="sub" style="font-weight:1000;margin-top:10px">Takwim (optional)</div>
            <input class="field" id="setUrlCalendar" style="width:100%;margin-top:6px" placeholder="(optional)">

            <div class="row" style="margin-top:12px">
              <button class="btn btnPrimary" id="btnSaveSettings">Simpan</button>
              <button class="btn" id="btnResetSettings">Reset</button>
              <button class="btn" id="btnLockSettings">Kunci Semula</button>
            </div>

            <p class="sub" style="margin-top:10px">Semua tetapan disimpan dalam browser (localStorage).</p>
          </div>
        </div>

        <div class="card" style="margin-top:12px;box-shadow:none">
          <div class="cardHead">
            <div>
              <h2>Pemetaan Kolum Kehadiran</h2>
              <p class="sub">Jika nama kolum berubah, edit di sini.</p>
            </div>
          </div>

          <div style="display:grid;gap:12px;grid-template-columns:1fr 1fr;">
            <div>
              <div class="sub" style="font-weight:1000">Tarikh</div>
              <input class="field" id="mapTarikh" style="width:100%;margin-top:6px" placeholder="Contoh: Tarikh">
            </div>
            <div>
              <div class="sub" style="font-weight:1000">Kelas</div>
              <input class="field" id="mapKelas" style="width:100%;margin-top:6px" placeholder="Contoh: Kelas">
            </div>
            <div>
              <div class="sub" style="font-weight:1000">Nama Murid</div>
              <input class="field" id="mapNama" style="width:100%;margin-top:6px" placeholder="Contoh: Nama Murid / Nama_Murid">
            </div>
            <div>
              <div class="sub" style="font-weight:1000">Status</div>
              <input class="field" id="mapStatus" style="width:100%;margin-top:6px" placeholder="Contoh: Status">
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <button class="btn btnPrimary" id="btnSaveMapping">Simpan Pemetaan</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   STORAGE + DEFAULTS
========================= */
const DEFAULTS = {
  schoolName: "SK Paya Resak",
  schoolMotto: "Moving Forward",
  footer1: "¬© 2025 NK.",
  footer2: "Hak Cipta Terpelihara.",
  mode: "light",
  pin: "5235",
  urls: {
    attendance: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTKhex5gcCHKoiLqRZpgVRMRfrGGvPtbgc3jo_Q-3FPL5OpcoWvyAnec0dTgykrpkYuS34iNJnEAkDU/pub?gid=880667725&single=true&output=csv",
    announcements: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQvKlO-LRGh8kj_-Be6NxZRR3Z38rjbC33jyvfhQvnR9L4LF7_dZRVXYGK3XO7bAoJwC9bJJmABjV6Z/pub?gid=946270411&single=true&output=csv",
    parents: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ_G1txQOE4Di1XsK6esbw8VgQtW2hcPsjzAmPH7V82JOeXegb7Kb_3Iz8CeHo-KvfvHe9x8BWtSfbB/pub?gid=1684744050&single=true&output=csv",
    calendar: ""
  },
  attendanceMap: {
    tarikh: "Tarikh",
    kelas: "Kelas",
    nama: "Nama Murid",
    status: "Status"
  }
};

const LS = {
  settings: "ppki_portal_settings_v2_fixedtheme",
  logo: "ppki_portal_logo_v2_fixedtheme"
};

function loadSettings(){
  try{
    const raw = localStorage.getItem(LS.settings);
    if(!raw) return structuredClone(DEFAULTS);
    const s = JSON.parse(raw);
    return {
      ...structuredClone(DEFAULTS),
      ...s,
      urls: {...structuredClone(DEFAULTS.urls), ...(s.urls||{})},
      attendanceMap: {...structuredClone(DEFAULTS.attendanceMap), ...(s.attendanceMap||{})}
    };
  }catch{
    return structuredClone(DEFAULTS);
  }
}
function saveSettings(s){
  localStorage.setItem(LS.settings, JSON.stringify(s));
}
let SETTINGS = loadSettings();

/* =========================
   DOM
========================= */
const pageTitle = document.getElementById("pageTitle");
const pageSub = document.getElementById("pageSub");
const btnMenu = document.getElementById("btnMenu");
const btnMode = document.getElementById("btnMode");
const btnReload = document.getElementById("btnReload");
const btnSettings = document.getElementById("btnSettings");

const rail = document.getElementById("rail");
const railToggle = document.getElementById("railToggle");
const railMode = document.getElementById("railMode");
const railSettings = document.getElementById("railSettings");
const railHome = document.getElementById("railHome");
const railLogoImg = document.getElementById("railLogoImg");
const railLogoFallback = document.getElementById("railLogoFallback");
const railFooterText = document.getElementById("railFooterText");

const sidebar = document.getElementById("sidebar");
const sideList = document.getElementById("sideList");
const brandGoHome = document.getElementById("brandGoHome");
const sideLogo = document.getElementById("sideLogo");

const schoolNameSide = document.getElementById("schoolNameSide");
const schoolMottoSide = document.getElementById("schoolMottoSide");
const footerLine1Side = document.getElementById("footerLine1Side");
const footerLine2Side = document.getElementById("footerLine2Side");

const bannerText = document.getElementById("bannerText");
const timeNow = document.getElementById("timeNow");

/* Home stats */
const vToday = document.getElementById("vToday");
const sToday = document.getElementById("sToday");
const vWeek = document.getElementById("vWeek");
const sWeek = document.getElementById("sWeek");
const vMonth = document.getElementById("vMonth");
const sMonth = document.getElementById("sMonth");
const vPct = document.getElementById("vPct");
const sPct = document.getElementById("sPct");

/* Attendance stats (follow filter) */
const vToday2 = document.getElementById("vToday2");
const sToday2 = document.getElementById("sToday2");
const vWeek2 = document.getElementById("vWeek2");
const sWeek2 = document.getElementById("sWeek2");
const vMonth2 = document.getElementById("vMonth2");
const sMonth2 = document.getElementById("sMonth2");
const vPct2 = document.getElementById("vPct2");
const sPct2 = document.getElementById("sPct2");

const btnReloadAttendance = document.getElementById("btnReloadAttendance");
const searchAttendance = document.getElementById("searchAttendance");
const filterClass = document.getElementById("filterClass");
const filterStatus = document.getElementById("filterStatus");
const dateFrom = document.getElementById("dateFrom");
const dateTo = document.getElementById("dateTo");
const btnApplyFilter = document.getElementById("btnApplyFilter");
const btnResetFilter = document.getElementById("btnResetFilter");
const attendanceHead = document.getElementById("attendanceHead");
const attendanceBody = document.getElementById("attendanceBody");
const attendanceMeta = document.getElementById("attendanceMeta");

/* Trend */
const trendMode = document.getElementById("trendMode");
const trendMonth = document.getElementById("trendMonth");
const trendYear = document.getElementById("trendYear");
const trendClass = document.getElementById("trendClass");
const trendChart = document.getElementById("trendChart");

/* Announcements */
const annCount = document.getElementById("annCount");
const annListHome = document.getElementById("annListHome");
const btnToAnnouncements = document.getElementById("btnToAnnouncements");
const annGrid = document.getElementById("annGrid");
const btnReloadAnnouncements = document.getElementById("btnReloadAnnouncements");

/* Parents & Calendar */
const parentsGrid = document.getElementById("parentsGrid");
const btnReloadParents = document.getElementById("btnReloadParents");
const calendarArea = document.getElementById("calendarArea");

/* Info modal */
const overlayInfo = document.getElementById("overlayInfo");
const btnCloseInfo = document.getElementById("btnCloseInfo");
const infoTitle = document.getElementById("infoTitle");
const infoBody = document.getElementById("infoBody");

/* Settings modal */
const overlaySettings = document.getElementById("overlaySettings");
const btnCloseSettings = document.getElementById("btnCloseSettings");
const pinStep = document.getElementById("pinStep");
const settingsStep = document.getElementById("settingsStep");
const pinInput = document.getElementById("pinInput");
const btnPinOk = document.getElementById("btnPinOk");
const pinWarn = document.getElementById("pinWarn");

const setSchoolName = document.getElementById("setSchoolName");
const setSchoolMotto = document.getElementById("setSchoolMotto");
const setFooter1 = document.getElementById("setFooter1");
const setFooter2 = document.getElementById("setFooter2");
const setLogoFile = document.getElementById("setLogoFile");
const setUrlAttendance = document.getElementById("setUrlAttendance");
const setUrlAnnouncements = document.getElementById("setUrlAnnouncements");
const setUrlParents = document.getElementById("setUrlParents");
const setUrlCalendar = document.getElementById("setUrlCalendar");

const btnSaveSettings = document.getElementById("btnSaveSettings");
const btnResetSettings = document.getElementById("btnResetSettings");
const btnLockSettings = document.getElementById("btnLockSettings");

const mapTarikh = document.getElementById("mapTarikh");
const mapKelas = document.getElementById("mapKelas");
const mapNama = document.getElementById("mapNama");
const mapStatus = document.getElementById("mapStatus");
const btnSaveMapping = document.getElementById("btnSaveMapping");

/* =========================
   UTIL
========================= */
function escapeHtml(s){
  return String(s??"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function escapeAttr(s){ return escapeHtml(s); }

function normKey(s){
  return String(s||"").trim().toLowerCase().replace(/\s+/g,"").replace(/_/g,"").replace(/[^\p{L}\p{N}]/gu,"");
}
function pickCol(headers, desired){
  const want = normKey(desired);
  const idx = headers.findIndex(h => normKey(h) === want);
  if(idx !== -1) return headers[idx];
  return headers.find(h => normKey(h).includes(want) || want.includes(normKey(h))) || null;
}

function parseCSV(text){
  const rows = [];
  let row = [], cur = "", inQ = false;
  for(let i=0;i<text.length;i++){
    const ch = text[i], next = text[i+1];
    if(ch === '"'){
      if(inQ && next === '"'){ cur += '"'; i++; }
      else inQ = !inQ;
    } else if(ch === "," && !inQ){
      row.push(cur); cur="";
    } else if((ch === "\n" || ch === "\r") && !inQ){
      if(ch === "\r" && next === "\n") i++;
      row.push(cur);
      if(row.some(v => String(v).trim()!=="")) rows.push(row);
      row=[]; cur="";
    } else {
      cur += ch;
    }
  }
  row.push(cur);
  if(row.some(v => String(v).trim()!=="")) rows.push(row);

  if(!rows.length) return {headers:[], data:[]};
  const headers = rows[0].map(h=>String(h||"").trim());
  const data = rows.slice(1).map(r=>{
    const obj = {};
    headers.forEach((h,idx)=> obj[h] = (r[idx] ?? "").trim());
    return obj;
  });
  return {headers, data};
}

function parseDateDMY(s){
  if(!s) return null;
  const str = String(s).trim();
  if(/^\d{4}-\d{2}-\d{2}/.test(str)){
    const d = new Date(str + "T00:00:00");
    return isNaN(d) ? null : d;
  }
  const m = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if(!m) return null;
  const dd = +m[1], mm = +m[2], yy = +m[3];
  const d = new Date(yy, mm-1, dd, 0,0,0,0);
  if(d.getFullYear()!==yy || d.getMonth()!==mm-1 || d.getDate()!==dd) return null;
  return d;
}
function formatDMY(d){
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  return `${dd}/${mm}/${d.getFullYear()}`;
}

function startOfWeekMonday(d){
  const x = new Date(d); x.setHours(0,0,0,0);
  const day = x.getDay();
  const diff = (day === 0 ? -6 : (1 - day));
  x.setDate(x.getDate() + diff);
  return x;
}
function endOfWeekSunday(d){
  const s = startOfWeekMonday(d);
  const e = new Date(s); e.setDate(e.getDate()+6); e.setHours(23,59,59,999);
  return e;
}

async function fetchCSV(url){
  const res = await fetch(url, { cache:"no-store" });
  if(!res.ok) throw new Error("Gagal fetch CSV");
  return parseCSV(await res.text());
}

function fileToDataURL(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=> resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

/* =========================
   THEME + IDENTITY
========================= */
function applyMode(){
  document.documentElement.dataset.mode = SETTINGS.mode || "light";
  const isDark = document.documentElement.dataset.mode === "dark";
  btnMode.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
  railMode.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
}
function applyIdentity(){
  schoolNameSide.textContent = SETTINGS.schoolName;
  schoolMottoSide.textContent = SETTINGS.schoolMotto;
  footerLine1Side.textContent = SETTINGS.footer1;
  footerLine2Side.textContent = SETTINGS.footer2;

  railFooterText.innerHTML = `${escapeHtml(SETTINGS.footer1).replace("¬©","¬©")}<br/>NK`;

  const logoData = localStorage.getItem(LS.logo);

  sideLogo.innerHTML = "";
  if(logoData){
    const img = document.createElement("img");
    img.src = logoData;
    sideLogo.appendChild(img);

    railLogoImg.src = logoData;
    railLogoImg.style.display = "block";
    railLogoFallback.style.display = "none";
  }else{
    sideLogo.innerHTML = "<span style='font-weight:1000;'>üè´</span>";
    railLogoImg.style.display = "none";
    railLogoFallback.style.display = "block";
  }
}

/* =========================
   NAV / PAGES
========================= */
function isMobile(){
  return window.matchMedia("(max-width: 860px)").matches;
}
function openSidebar(){ document.body.classList.add("sidebar-open"); }
function closeSidebar(){ document.body.classList.remove("sidebar-open"); }
function toggleSidebar(){ document.body.classList.toggle("sidebar-open"); }

btnMenu.addEventListener("click", toggleSidebar);
railToggle.addEventListener("click", ()=> {
  // desktop: open the full sidebar panel (optional)
  if(isMobile()) openSidebar();
  else toggleSidebar();
});

document.addEventListener("click",(e)=>{
  if(!isMobile()) return;
  if(!document.body.classList.contains("sidebar-open")) return;
  if(e.target.closest("#sidebar") || e.target.closest("#btnMenu")) return;
  closeSidebar();
},{capture:true});

function setActiveNav(page){
  document.querySelectorAll(".railBtn[data-page]").forEach(b=>{
    b.classList.toggle("active", b.dataset.page===page);
  });
  document.querySelectorAll(".sideItem").forEach(b=>{
    b.classList.toggle("active", b.dataset.page===page);
  });
}

function showPage(page){
  document.querySelectorAll(".page").forEach(p=>p.style.display="none");
  const el = document.getElementById("page-"+page);
  if(el) el.style.display = "block";

  const titles = {
    home: ["Laman Utama","Portal Rasmi PPKI"],
    attendance: ["Kehadiran","Dashboard & Analisis"],
    announcements: ["Pengumuman","Makluman Semasa"],
    calendar: ["Takwim","Aktiviti & Jadual"],
    parents: ["Ibu Bapa","Info & Pautan"]
  };
  pageTitle.textContent = titles[page]?.[0] || "Portal";
  pageSub.textContent = titles[page]?.[1] || "";

  setActiveNav(page);
  if(isMobile()) closeSidebar();
}

rail.addEventListener("click",(e)=>{
  const btn = e.target.closest(".railBtn[data-page]");
  if(!btn) return;
  showPage(btn.dataset.page);
});
sideList.addEventListener("click",(e)=>{
  const item = e.target.closest(".sideItem");
  if(!item) return;
  showPage(item.dataset.page);
});

railHome.addEventListener("click", ()=> showPage("home"));
brandGoHome.addEventListener("click", ()=> showPage("home"));

/* =========================
   MODE toggle
========================= */
function toggleMode(){
  SETTINGS.mode = (SETTINGS.mode === "dark") ? "light" : "dark";
  saveSettings(SETTINGS);
  applyMode();
  renderTrend();
}
btnMode.addEventListener("click", toggleMode);
railMode.addEventListener("click", toggleMode);

/* =========================
   CLOCK
========================= */
function tickClock(){
  const d = new Date();
  const days = ["Ahad","Isnin","Selasa","Rabu","Khamis","Jumaat","Sabtu"];
  const months = ["Januari","Februari","Mac","April","Mei","Jun","Julai","Ogos","September","Oktober","November","Disember"];
  const pad = n=> String(n).padStart(2,"0");
  const t = `${days[d.getDay()]}, ${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()} ¬∑ ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  timeNow.textContent = t;
}
setInterval(tickClock, 1000);

/* =========================
   DATA STATE
========================= */
let attendanceRaw = [];
let attendanceHeaders = [];
let announcementsRaw = [];
let parentsRaw = [];
let calendarRaw = [];

/* =========================
   NORMALIZE DATA
========================= */
function normalizeAttendance(parsed){
  const headers = parsed.headers;
  attendanceHeaders = headers;

  const colTarikh = pickCol(headers, SETTINGS.attendanceMap.tarikh) || pickCol(headers, "Tarikh");
  const colKelas  = pickCol(headers, SETTINGS.attendanceMap.kelas)  || pickCol(headers, "Kelas");
  const colNama   = pickCol(headers, SETTINGS.attendanceMap.nama)   || pickCol(headers, "Nama Murid") || pickCol(headers, "Nama_Murid");
  const colStatus = pickCol(headers, SETTINGS.attendanceMap.status) || pickCol(headers, "Status");

  const data = parsed.data.map(r=>{
    const tarikh = parseDateDMY(r[colTarikh]);
    const statusRaw = (r[colStatus]||"").trim().toUpperCase();
    const status = statusRaw.includes("TIDAK") ? "TIDAK HADIR" : (statusRaw ? "HADIR" : "");
    return {
      __tarikh: tarikh,
      Tarikh: r[colTarikh] || "",
      Kelas: r[colKelas] || "",
      "Nama Murid": r[colNama] || "",
      Status: status || (r[colStatus]||""),
      __raw: r
    };
  }).filter(x=> x.__tarikh);

  data.sort((a,b)=> b.__tarikh - a.__tarikh);
  return data;
}

function normalizeAnnouncements(parsed){
  const H = parsed.headers;
  const colStart = pickCol(H,"TARIKH MULA") || pickCol(H,"Tarikh Mula");
  const colEnd   = pickCol(H,"TARIKH TAMAT") || pickCol(H,"Tarikh Tamat");
  const colTitle = pickCol(H,"TAJUK");
  const colBody  = pickCol(H,"ISI KANDUNGAN") || pickCol(H,"Isi Kandungan");
  const colUrl   = pickCol(H,"URL");
  const colPri   = pickCol(H,"KEUTAMAAN");
  const colAktif = pickCol(H,"AKTIF");

  const now = new Date(); now.setHours(0,0,0,0);

  const data = parsed.data.map(r=>{
    const start = parseDateDMY(r[colStart]);
    const end = parseDateDMY(r[colEnd]);
    const title = (r[colTitle]||"").trim();
    const body = (r[colBody]||"").trim();
    const url = (r[colUrl]||"").trim();
    const pri = (r[colPri]||"").trim().toUpperCase();
    const aktif = (r[colAktif]||"").trim().toUpperCase();

    let computedActive = false;
    if(start && title){
      computedActive = (start <= now) && (!end || end >= now);
    }
    let finalActive = computedActive;
    if(aktif === "YA") finalActive = true;
    if(aktif === "TIDAK") finalActive = false;

    return { start,end,title,body,url, pri: pri||"SEDERHANA", active: finalActive,
      startText: r[colStart]||"", endText:r[colEnd]||"" };
  });

  const rank = p => String(p||"").includes("TINGGI") ? 3 : (String(p||"").includes("SEDER") ? 2 : 1);
  data.sort((a,b)=> (rank(b.pri)-rank(a.pri)) || ((b.start?.getTime()||0)-(a.start?.getTime()||0)));
  return data;
}

function normalizeParents(parsed){
  const H = parsed.headers;
  const colTitle = pickCol(H,"TAJUK") || pickCol(H,"Tajuk");
  const colBody  = pickCol(H,"ISI KANDUNGAN") || pickCol(H,"Isi Kandungan") || pickCol(H,"Isi");
  const colUrl   = pickCol(H,"URL") || pickCol(H,"Pautan");
  const colMode  = pickCol(H,"MOD") || pickCol(H,"Mode") || pickCol(H,"TINDAKAN");

  return parsed.data.map(r=>({
    title:(r[colTitle]||"").trim(),
    body:(r[colBody]||"").trim(),
    url:(r[colUrl]||"").trim(),
    mode: ((r[colMode]||"POPUP").trim().toUpperCase())
  })).filter(x=>x.title);
}

/* =========================
   STATS (IMPORTANT FIX)
   - home stats = based on ALL attendanceRaw
   - attendance page stats = based on FILTERED list
========================= */
function computeStats(list){
  const now = new Date(); now.setHours(0,0,0,0);
  const weekStart = startOfWeekMonday(now);
  const weekEnd = endOfWeekSunday(now);

  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
  const monthEnd = new Date(now.getFullYear(), now.getMonth()+1, 0, 23,59,59,999);

  const isHadir = r => String(r.Status||"").toUpperCase()==="HADIR";

  const todayList = list.filter(r => r.__tarikh && r.__tarikh.getTime()===now.getTime());
  const weekList  = list.filter(r => r.__tarikh && r.__tarikh>=weekStart && r.__tarikh<=weekEnd);
  const monthList = list.filter(r => r.__tarikh && r.__tarikh>=monthStart && r.__tarikh<=monthEnd);

  const todayHadir = todayList.filter(isHadir).length;
  const weekHadir = weekList.filter(isHadir).length;
  const monthHadir = monthList.filter(isHadir).length;

  const todayTotal = todayList.length;
  const weekTotal = weekList.length;
  const monthTotal = monthList.length;

  const pct = monthTotal ? (monthHadir/monthTotal*100) : 0;

  return {todayHadir,todayTotal,weekHadir,weekTotal,monthHadir,monthTotal,pct};
}

function setHomeStats(stats){
  vToday.textContent = stats.todayHadir;
  sToday.textContent = `${stats.todayHadir} / ${stats.todayTotal}`;
  vWeek.textContent = stats.weekHadir;
  sWeek.textContent = `${stats.weekHadir} / ${stats.weekTotal}`;
  vMonth.textContent = stats.monthHadir;
  sMonth.textContent = `${stats.monthHadir} / ${stats.monthTotal}`;
  vPct.textContent = `${stats.pct.toFixed(1)}%`;
  sPct.textContent = "Bulan semasa";
}

function setAttendanceStats(stats){
  vToday2.textContent = stats.todayHadir;
  sToday2.textContent = `${stats.todayHadir} / ${stats.todayTotal}`;
  vWeek2.textContent = stats.weekHadir;
  sWeek2.textContent = `${stats.weekHadir} / ${stats.weekTotal}`;
  vMonth2.textContent = stats.monthHadir;
  sMonth2.textContent = `${stats.monthHadir} / ${stats.monthTotal}`;
  vPct2.textContent = `${stats.pct.toFixed(1)}%`;
  sPct2.textContent = "Bulan semasa";
}

/* =========================
   TREND CHART (SVG)
========================= */
function renderLineChartSVG({width=860,height=260,data=[],mode="hadir"}){
  const padL=44,padR=16,padT=14,padB=34;
  const W=width,H=height;
  const innerW=W-padL-padR, innerH=H-padT-padB;

  const ys = data.map(d=>d.y);
  const maxY = (mode==="pct") ? 100 : Math.max(1,...ys,1);
  const minY = 0;
  const range = (maxY-minY)||1;

  const minX = data.length ? Math.min(...data.map(d=>d.xValue)) : 1;
  const maxX = data.length ? Math.max(...data.map(d=>d.xValue)) : 31;
  const rx = (maxX-minX)||1;

  const xScale = x => padL + ((x-minX)/rx)*innerW;
  const yScale = y => padT + (1-((y-minY)/range))*innerH;

  const yTicks = (mode==="pct") ? [0,25,50,75,100] : (()=>{
    const t=4, step=Math.max(1, Math.round(maxY/t));
    const arr=[];
    for(let v=0; v<=maxY; v+=step) arr.push(v);
    if(arr[arr.length-1]!==maxY) arr.push(maxY);
    return arr.slice(0,6);
  })();

  const xTicks = [1,5,10,15,20,25,30,31];

  const pts = data.sort((a,b)=>a.xValue-b.xValue)
    .map(d=>`${xScale(d.xValue).toFixed(1)},${yScale(d.y).toFixed(1)}`).join(" ");

  const stroke = (document.documentElement.dataset.mode==="dark") ? "rgba(255,255,255,.92)" : "rgba(17,24,39,.92)";
  const grid = (document.documentElement.dataset.mode==="dark") ? "rgba(255,255,255,.12)" : "rgba(17,24,39,.10)";
  const area = (document.documentElement.dataset.mode==="dark") ? "rgba(31,111,74,.22)" : "rgba(31,111,74,.12)";
  const label = (document.documentElement.dataset.mode==="dark") ? "rgba(255,255,255,.65)" : "rgba(107,114,128,.95)";

  return `
  <svg viewBox="0 0 ${W} ${H}" width="100%" height="${H}">
    ${yTicks.map(v=>{
      const y=yScale(v);
      return `
        <line x1="${padL}" y1="${y}" x2="${W-padR}" y2="${y}" stroke="${grid}" stroke-width="1"/>
        <text x="${padL-8}" y="${y+4}" text-anchor="end" font-size="11" fill="${label}" font-weight="900">${v}${mode==="pct"?"%":""}</text>
      `;
    }).join("")}

    <line x1="${padL}" y1="${H-padB}" x2="${W-padR}" y2="${H-padB}" stroke="${grid}" stroke-width="1"/>
    <line x1="${padL}" y1="${padT}" x2="${padL}" y2="${H-padB}" stroke="${grid}" stroke-width="1"/>

    ${xTicks.map(v=>{
      if(!data.length) return "";
      if(v<minX || v>maxX) return "";
      const x=xScale(v);
      return `
        <line x1="${x}" y1="${H-padB}" x2="${x}" y2="${H-padB+5}" stroke="${grid}" stroke-width="1"/>
        <text x="${x}" y="${H-12}" text-anchor="middle" font-size="11" fill="${label}" font-weight="900">${v}</text>
      `;
    }).join("")}

    ${data.length ? `
      <path d="M ${padL} ${H-padB} L ${pts.replaceAll(" ", " L ")} L ${W-padR} ${H-padB} Z"
        fill="${area}" stroke="none" />
      <polyline points="${pts}" fill="none" stroke="${stroke}" stroke-width="3.2"
        stroke-linecap="round" stroke-linejoin="round"/>
    ` : `
      <text x="${W/2}" y="${H/2}" text-anchor="middle" font-size="13" fill="${label}" font-weight="900">
        Tiada data untuk pilihan ini
      </text>
    `}
  </svg>`;
}

function setupTrendSelectors(){
  const now = new Date();
  const months = ["Jan","Feb","Mac","Apr","Mei","Jun","Jul","Ogos","Sep","Okt","Nov","Dis"];

  trendMonth.innerHTML = months.map((m,i)=>`<option value="${i}">${m}</option>`).join("");
  trendMonth.value = String(now.getMonth());

  const y = now.getFullYear();
  trendYear.innerHTML = "";
  for(let i=y-2; i<=y+1; i++){
    trendYear.innerHTML += `<option value="${i}">${i}</option>`;
  }
  trendYear.value = String(y);

  trendMode.addEventListener("click",(e)=>{
    const p = e.target.closest(".pill");
    if(!p) return;
    trendMode.querySelectorAll(".pill").forEach(x=>x.classList.remove("active"));
    p.classList.add("active");
    renderTrend();
  });
  trendMonth.addEventListener("change", renderTrend);
  trendYear.addEventListener("change", renderTrend);
  trendClass.addEventListener("change", renderTrend);
}

function renderTrend(){
  if(!attendanceRaw.length){
    trendChart.innerHTML = renderLineChartSVG({data:[], mode:"hadir"});
    return;
  }
  const mode = trendMode.querySelector(".pill.active")?.dataset.mode || "hadir";
  const month = Number(trendMonth.value);
  const year = Number(trendYear.value);
  const kelas = trendClass.value;

  const filtered = attendanceRaw.filter(r=>{
    if(!r.__tarikh) return false;
    if(r.__tarikh.getFullYear()!==year) return false;
    if(r.__tarikh.getMonth()!==month) return false;
    if(kelas && String(r.Kelas||"")!==kelas) return false;
    return true;
  });

  const isHadir = r => String(r.Status||"").toUpperCase()==="HADIR";
  const isTidak = r => String(r.Status||"").toUpperCase().includes("TIDAK");

  const map = new Map();
  filtered.forEach(r=>{
    const day = r.__tarikh.getDate();
    if(!map.has(day)) map.set(day,{hadir:0,tidak:0,total:0});
    const o = map.get(day);
    o.total++;
    if(isHadir(r)) o.hadir++;
    if(isTidak(r)) o.tidak++;
  });

  const lastDay = new Date(year, month+1, 0).getDate();
  const series = [];
  for(let d=1; d<=lastDay; d++){
    const o = map.get(d) || {hadir:0,tidak:0,total:0};
    let y=0;
    if(mode==="hadir") y=o.hadir;
    if(mode==="tidak") y=o.tidak;
    if(mode==="pct") y=o.total ? +(o.hadir/o.total*100).toFixed(1) : 0;
    series.push({xValue:d,y});
  }

  trendChart.innerHTML = renderLineChartSVG({data:series, mode});
}

/* =========================
   ATTENDANCE TABLE + FILTER
========================= */
function populateClassOptions(){
  const classes = Array.from(new Set(attendanceRaw.map(r=>String(r.Kelas||"").trim()).filter(Boolean))).sort();
  filterClass.innerHTML = `<option value="">Kelas: Semua</option>` + classes.map(c=>`<option value="${escapeAttr(c)}">${escapeHtml(c)}</option>`).join("");
  trendClass.innerHTML = `<option value="">Semua Kelas</option>` + classes.map(c=>`<option value="${escapeAttr(c)}">${escapeHtml(c)}</option>`).join("");
}

function renderAttendanceTable(list){
  const cols = ["Tarikh","Kelas","Nama Murid","Status"];
  attendanceHead.innerHTML = cols.map(c=>`<th>${escapeHtml(c)}</th>`).join("");

  attendanceBody.innerHTML = list.map(r=>{
    const s = String(r.Status||"").toUpperCase();
    let badge = `<span class="badge">${escapeHtml(r.Status||"")}</span>`;
    if(s==="HADIR") badge = `<span class="badge bOk">‚úÖ HADIR</span>`;
    if(s.includes("TIDAK")) badge = `<span class="badge bNo">‚õî TIDAK HADIR</span>`;
    return `
      <tr>
        <td>${escapeHtml(r.Tarikh||"")}</td>
        <td>${escapeHtml(r.Kelas||"")}</td>
        <td>${escapeHtml(r["Nama Murid"]||"")}</td>
        <td>${badge}</td>
      </tr>
    `;
  }).join("");

  attendanceMeta.textContent = `Paparan: ${list.length} rekod`;
}

/* ‚úÖ MAIN FIX: apply filter updates BOTH table + top cards (attendance page) */
function applyAttendanceFilter(){
  const q = (searchAttendance.value||"").trim().toLowerCase();
  const kelas = filterClass.value;
  const statusSel = filterStatus.value;

  const df = dateFrom.value ? new Date(dateFrom.value+"T00:00:00") : null;
  const dt = dateTo.value ? new Date(dateTo.value+"T23:59:59") : null;

  const filtered = attendanceRaw.filter(r=>{
    if(kelas && String(r.Kelas||"")!==kelas) return false;
    if(statusSel){
      if(statusSel==="HADIR" && String(r.Status||"").toUpperCase()!=="HADIR") return false;
      if(statusSel==="TIDAK HADIR" && !String(r.Status||"").toUpperCase().includes("TIDAK")) return false;
    }
    if(df && r.__tarikh < df) return false;
    if(dt && r.__tarikh > dt) return false;
    if(q){
      const hay = `${r.Tarikh} ${r.Kelas} ${r["Nama Murid"]} ${r.Status}`.toLowerCase();
      if(!hay.includes(q)) return false;
    }
    return true;
  });

  renderAttendanceTable(filtered);

  /* ‚úÖ update cards based on filtered set */
  const stats = computeStats(filtered);
  setAttendanceStats(stats);
}

btnApplyFilter.addEventListener("click", applyAttendanceFilter);
btnResetFilter.addEventListener("click", ()=>{
  searchAttendance.value="";
  filterClass.value="";
  filterStatus.value="";
  dateFrom.value="";
  dateTo.value="";
  renderAttendanceTable(attendanceRaw);
  setAttendanceStats(computeStats(attendanceRaw)); // reset cards to full attendance data
});
searchAttendance.addEventListener("input", applyAttendanceFilter);
filterClass.addEventListener("change", applyAttendanceFilter);
filterStatus.addEventListener("change", applyAttendanceFilter);
dateFrom.addEventListener("change", applyAttendanceFilter);
dateTo.addEventListener("change", applyAttendanceFilter);

/* =========================
   ANNOUNCEMENTS UI
========================= */
function openInfoModal(title, html){
  infoTitle.textContent = title || "Butiran";
  infoBody.innerHTML = html;
  overlayInfo.classList.add("show");
}
btnCloseInfo.addEventListener("click", ()=> overlayInfo.classList.remove("show"));
overlayInfo.addEventListener("click",(e)=>{ if(e.target===overlayInfo) overlayInfo.classList.remove("show"); });

function renderAnnouncements(){
  const active = announcementsRaw.filter(a=>a.active);
  annCount.textContent = `${active.length} aktif`;

  annListHome.innerHTML = "";
  if(!active.length){
    annListHome.innerHTML = `<div class="sub">Tiada pengumuman aktif.</div>`;
  }else{
    active.slice(0,6).forEach(a=>{
      const pri = String(a.pri||"").toUpperCase();
      const priBadge = pri.includes("TINGGI") ? `<span class="badge bHi">üî• TINGGI</span>` : `<span class="badge">${escapeHtml(pri)}</span>`;
      const el = document.createElement("div");
      el.className = "annItem";
      el.innerHTML = `
        <div class="annTitle">${escapeHtml(a.title)}</div>
        <p class="annMeta">${escapeHtml(a.startText || (a.start?formatDMY(a.start):""))} ¬∑ ${priBadge}</p>
      `;
      el.addEventListener("click", ()=>{
        openInfoModal(a.title, `
          <div class="card" style="box-shadow:none">
            <div class="row" style="justify-content:space-between">
              <div class="sub" style="font-weight:1000">Tarikh Mula: ${escapeHtml(a.startText || (a.start?formatDMY(a.start):"-"))}</div>
              <div class="sub" style="font-weight:1000">Keutamaan: ${escapeHtml(a.pri||"-")}</div>
            </div>
            <div style="margin-top:10px;white-space:pre-wrap;line-height:1.6">${escapeHtml(a.body||"-")}</div>
            ${a.url ? `<div style="margin-top:12px"><a class="btn btnPrimary" href="${escapeAttr(a.url)}" target="_blank" rel="noopener">Buka Pautan</a></div>` : ""}
          </div>
        `);
      });
      annListHome.appendChild(el);
    });
  }

  annGrid.innerHTML = "";
  const list = active;
  if(!list.length){
    annGrid.innerHTML = `<div class="sub">Tiada pengumuman aktif.</div>`;
    return;
  }
  list.forEach(a=>{
    const pri = String(a.pri||"").toUpperCase();
    const priBadge = pri.includes("TINGGI") ? `<span class="badge bHi">üî• TINGGI</span>` : `<span class="badge">${escapeHtml(pri)}</span>`;
    const el = document.createElement("div");
    el.className = "card";
    el.style.cursor="pointer";
    el.innerHTML = `
      <div class="cardHead">
        <div>
          <h2 style="margin:0">${escapeHtml(a.title)}</h2>
          <p class="sub">${escapeHtml(a.startText || (a.start?formatDMY(a.start):""))}</p>
        </div>
        <div>${priBadge}</div>
      </div>
      <div class="sub" style="white-space:pre-wrap;line-height:1.6;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden">
        ${escapeHtml(a.body||"")}
      </div>
    `;
    el.addEventListener("click", ()=>{
      openInfoModal(a.title, `
        <div class="card" style="box-shadow:none">
          <div style="white-space:pre-wrap;line-height:1.6">${escapeHtml(a.body||"-")}</div>
          ${a.url ? `<div style="margin-top:12px"><a class="btn btnPrimary" href="${escapeAttr(a.url)}" target="_blank" rel="noopener">Buka Pautan</a></div>` : ""}
        </div>
      `);
    });
    annGrid.appendChild(el);
  });
}

/* =========================
   PARENTS UI
========================= */
function renderParents(){
  parentsGrid.innerHTML = "";
  if(!parentsRaw.length){
    parentsGrid.innerHTML = `<div class="sub">Tiada data.</div>`;
    return;
  }
  parentsRaw.forEach(item=>{
    const el = document.createElement("div");
    el.className = "card";
    el.style.cursor="pointer";
    const badge = item.url ? `<span class="badge">${item.mode==="TAB" ? "Buka Tab" : "Pop out"}</span>` : `<span class="badge">Pop out</span>`;
    el.innerHTML = `
      <div class="cardHead">
        <div><h2 style="margin:0">${escapeHtml(item.title)}</h2></div>
        ${badge}
      </div>
      <div class="sub" style="white-space:pre-wrap;line-height:1.6">${escapeHtml(item.body||"")}</div>
    `;
    el.addEventListener("click", ()=>{
      if(item.url && item.mode==="TAB"){
        window.open(item.url, "_blank", "noopener");
        return;
      }
      openInfoModal(item.title, `
        <div class="card" style="box-shadow:none">
          <div style="white-space:pre-wrap;line-height:1.6">${escapeHtml(item.body||"-")}</div>
          ${item.url ? `<div style="margin-top:12px"><a class="btn btnPrimary" href="${escapeAttr(item.url)}" target="_blank" rel="noopener">Buka Pautan</a></div>` : ""}
        </div>
      `);
    });
    parentsGrid.appendChild(el);
  });
}

/* =========================
   CALENDAR UI (simple)
========================= */
function renderCalendar(){
  if(!SETTINGS.urls.calendar){
    calendarArea.textContent = "Belum disambungkan.";
    return;
  }
  if(!calendarRaw.length){
    calendarArea.textContent = "Tiada data.";
    return;
  }
  const cols = Object.keys(calendarRaw[0]||{});
  calendarArea.innerHTML = `
    <div class="tableWrap">
      <table>
        <thead><tr>${cols.map(c=>`<th>${escapeHtml(c)}</th>`).join("")}</tr></thead>
        <tbody>
          ${calendarRaw.slice(0,50).map(r=>`
            <tr>${cols.map(c=>`<td>${escapeHtml(r[c]||"")}</td>`).join("")}</tr>
          `).join("")}
        </tbody>
      </table>
    </div>
    <p class="sub" style="margin-top:10px">Paparan ringkas (maks 50 rekod).</p>
  `;
}

/* =========================
   LOADERS
========================= */
async function loadAttendance(){
  try{
    const parsed = await fetchCSV(SETTINGS.urls.attendance);
    attendanceRaw = normalizeAttendance(parsed);
    populateClassOptions();

    // home stats based on ALL
    setHomeStats(computeStats(attendanceRaw));

    // attendance page default stats based on ALL
    setAttendanceStats(computeStats(attendanceRaw));

    // table initial
    renderAttendanceTable(attendanceRaw);
    attendanceMeta.textContent = `Paparan: ${attendanceRaw.length} rekod`;

    renderTrend();
  }catch(e){
    console.error(e);
    attendanceRaw = [];
    renderAttendanceTable([]);
    setHomeStats({todayHadir:0,todayTotal:0,weekHadir:0,weekTotal:0,monthHadir:0,monthTotal:0,pct:0});
    setAttendanceStats({todayHadir:0,todayTotal:0,weekHadir:0,weekTotal:0,monthHadir:0,monthTotal:0,pct:0});
    trendChart.innerHTML = renderLineChartSVG({data:[],mode:"hadir"});
  }
}

async function loadAnnouncements(){
  try{
    const parsed = await fetchCSV(SETTINGS.urls.announcements);
    announcementsRaw = normalizeAnnouncements(parsed);
    renderAnnouncements();
  }catch(e){
    console.error(e);
    announcementsRaw = [];
    annCount.textContent = "Gagal load";
    annListHome.innerHTML = `<div class="sub">Gagal load pengumuman. Sila semak URL CSV.</div>`;
    annGrid.innerHTML = `<div class="sub">Gagal load pengumuman.</div>`;
  }
}

async function loadParents(){
  try{
    const parsed = await fetchCSV(SETTINGS.urls.parents);
    parentsRaw = normalizeParents(parsed);
    renderParents();
  }catch(e){
    console.error(e);
    parentsRaw = [];
    parentsGrid.innerHTML = `<div class="sub">Gagal load data Ibu Bapa. Sila semak URL CSV.</div>`;
  }
}

async function loadCalendar(){
  if(!SETTINGS.urls.calendar){
    calendarRaw = [];
    renderCalendar();
    return;
  }
  try{
    const parsed = await fetchCSV(SETTINGS.urls.calendar);
    calendarRaw = parsed.data || [];
    renderCalendar();
  }catch(e){
    console.error(e);
    calendarRaw = [];
    renderCalendar();
  }
}

async function loadAll(){
  await Promise.all([
    loadAttendance(),
    loadAnnouncements(),
    loadParents(),
    loadCalendar()
  ]);
}

/* =========================
   SETTINGS MODAL
========================= */
let settingsUnlocked = false;

function openSettings(){
  overlaySettings.classList.add("show");
  pinWarn.classList.remove("show");
  pinInput.value="";
  settingsUnlocked=false;
  pinStep.style.display="block";
  settingsStep.style.display="none";
}
function closeSettings(){
  overlaySettings.classList.remove("show");
}
btnSettings.addEventListener("click", openSettings);
railSettings.addEventListener("click", openSettings);
document.getElementById("btnCloseSettings").addEventListener("click", closeSettings);
overlaySettings.addEventListener("click",(e)=>{ if(e.target===overlaySettings) closeSettings(); });

btnPinOk.addEventListener("click", ()=>{
  const pin = String(pinInput.value||"").trim();
  if(pin !== SETTINGS.pin){
    pinWarn.classList.add("show");
    return;
  }
  pinWarn.classList.remove("show");
  settingsUnlocked=true;
  pinStep.style.display="none";
  settingsStep.style.display="block";

  setSchoolName.value = SETTINGS.schoolName;
  setSchoolMotto.value = SETTINGS.schoolMotto;
  setFooter1.value = SETTINGS.footer1;
  setFooter2.value = SETTINGS.footer2;

  setUrlAttendance.value = SETTINGS.urls.attendance;
  setUrlAnnouncements.value = SETTINGS.urls.announcements;
  setUrlParents.value = SETTINGS.urls.parents;
  setUrlCalendar.value = SETTINGS.urls.calendar || "";

  mapTarikh.value = SETTINGS.attendanceMap.tarikh;
  mapKelas.value = SETTINGS.attendanceMap.kelas;
  mapNama.value = SETTINGS.attendanceMap.nama;
  mapStatus.value = SETTINGS.attendanceMap.status;
});
pinInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter") btnPinOk.click(); });

btnSaveSettings.addEventListener("click", async ()=>{
  if(!settingsUnlocked) return;

  SETTINGS.schoolName = setSchoolName.value.trim() || DEFAULTS.schoolName;
  SETTINGS.schoolMotto = setSchoolMotto.value.trim() || DEFAULTS.schoolMotto;
  SETTINGS.footer1 = setFooter1.value.trim() || DEFAULTS.footer1;
  SETTINGS.footer2 = setFooter2.value.trim() || DEFAULTS.footer2;

  SETTINGS.urls.attendance = setUrlAttendance.value.trim() || DEFAULTS.urls.attendance;
  SETTINGS.urls.announcements = setUrlAnnouncements.value.trim() || DEFAULTS.urls.announcements;
  SETTINGS.urls.parents = setUrlParents.value.trim() || DEFAULTS.urls.parents;
  SETTINGS.urls.calendar = setUrlCalendar.value.trim();

  saveSettings(SETTINGS);
  applyIdentity();
  await loadAll();
  alert("Tetapan berjaya disimpan.");
});

btnResetSettings.addEventListener("click", ()=>{
  if(!settingsUnlocked) return;
  SETTINGS = loadSettings();
  saveSettings(SETTINGS);
  applyMode();
  applyIdentity();

  setSchoolName.value = SETTINGS.schoolName;
  setSchoolMotto.value = SETTINGS.schoolMotto;
  setFooter1.value = SETTINGS.footer1;
  setFooter2.value = SETTINGS.footer2;

  setUrlAttendance.value = SETTINGS.urls.attendance;
  setUrlAnnouncements.value = SETTINGS.urls.announcements;
  setUrlParents.value = SETTINGS.urls.parents;
  setUrlCalendar.value = SETTINGS.urls.calendar || "";

  mapTarikh.value = SETTINGS.attendanceMap.tarikh;
  mapKelas.value = SETTINGS.attendanceMap.kelas;
  mapNama.value = SETTINGS.attendanceMap.nama;
  mapStatus.value = SETTINGS.attendanceMap.status;

  alert("Tetapan disegar semula.");
});

btnLockSettings.addEventListener("click", ()=>{
  settingsUnlocked=false;
  pinStep.style.display="block";
  settingsStep.style.display="none";
  pinInput.value="";
  pinWarn.classList.remove("show");
});

setLogoFile.addEventListener("change", async (e)=>{
  if(!settingsUnlocked) return;
  const file = e.target.files && e.target.files[0];
  if(!file) return;
  const dataUrl = await fileToDataURL(file);
  localStorage.setItem(LS.logo, dataUrl);
  applyIdentity();
});

btnSaveMapping.addEventListener("click", ()=>{
  if(!settingsUnlocked) return;
  SETTINGS.attendanceMap = {
    tarikh: mapTarikh.value.trim() || DEFAULTS.attendanceMap.tarikh,
    kelas: mapKelas.value.trim() || DEFAULTS.attendanceMap.kelas,
    nama: mapNama.value.trim() || DEFAULTS.attendanceMap.nama,
    status: mapStatus.value.trim() || DEFAULTS.attendanceMap.status
  };
  saveSettings(SETTINGS);
  alert("Pemetaan disimpan. Data akan dikira ikut kolum ini.");
  loadAttendance();
});

/* =========================
   LOGO click
========================= */
railSettings.addEventListener("click", openSettings);

/* =========================
   BUTTONS
========================= */
btnReload.addEventListener("click", loadAll);
btnReloadAttendance.addEventListener("click", loadAttendance);
btnReloadAnnouncements.addEventListener("click", loadAnnouncements);
btnReloadParents.addEventListener("click", loadParents);
btnToAnnouncements.addEventListener("click", ()=> showPage("announcements"));

btnReloadAnnouncements.addEventListener("click", loadAnnouncements);
btnReloadParents.addEventListener("click", loadParents);

document.getElementById("btnCloseInfo").addEventListener("click", ()=> overlayInfo.classList.remove("show"));

/* =========================
   INIT
========================= */
function init(){
  applyMode();
  applyIdentity();
  tickClock();
  setupTrendSelectors();
  showPage("home");
  loadAll();
}
init();
</script>
</body>
</html>
