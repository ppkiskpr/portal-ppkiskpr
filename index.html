<!doctype html>
<html lang="ms" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Portal Rasmi PPKI - SK Paya Resak</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Smooth UI helpers */
    .card { @apply bg-white rounded-2xl shadow-sm border border-slate-100; }
    .btn  { @apply inline-flex items-center justify-center rounded-xl px-4 py-2 font-semibold transition; }
    .btn-primary { @apply bg-slate-900 text-white hover:bg-slate-800; }
    .btn-ghost { @apply bg-white border border-slate-200 hover:bg-slate-50; }
    .pill { @apply inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold; }
    .input { @apply w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 outline-none focus:ring-2 focus:ring-slate-200; }
    .select { @apply w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 outline-none focus:ring-2 focus:ring-slate-200; }
    .table-th { @apply text-left text-xs font-bold tracking-wide text-slate-500 uppercase px-4 py-3 border-b border-slate-100; }
    .table-td { @apply px-4 py-3 border-b border-slate-50 text-sm text-slate-700; }
    .sidebar-item { @apply flex items-center gap-3 rounded-xl px-3 py-2 text-slate-200 hover:bg-white/10 transition cursor-pointer; }
    .sidebar-item.active { @apply bg-white/10; }
    .icon-btn { @apply inline-flex items-center justify-center rounded-xl bg-white border border-slate-200 w-11 h-11 hover:bg-slate-50 transition; }
  </style>
</head>

<body class="h-full bg-slate-50 text-slate-900">
  <div id="app" class="h-full">
    <!-- Layout -->
    <div class="flex h-full">

      <!-- Sidebar -->
      <aside id="sidebar"
        class="fixed md:static z-40 inset-y-0 left-0 w-72 md:w-72 bg-slate-900 text-white
               transform transition-transform duration-300 ease-in-out
               -translate-x-full md:translate-x-0">
        <div class="h-full flex flex-col">

          <!-- Top branding -->
          <div class="p-5 flex items-center gap-3 border-b border-white/10">
            <div class="w-12 h-12 rounded-2xl bg-white/10 overflow-hidden flex items-center justify-center">
              <!-- Replace this image src with your logo url OR leave it -->
              <img id="schoolLogo" alt="Logo Sekolah"
                src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5a/School_icon.svg/1024px-School_icon.svg.png"
                class="w-full h-full object-cover" />
            </div>
            <div class="leading-tight">
              <div id="schoolName" class="font-extrabold text-base">SK Paya Resak</div>
              <div id="schoolMoto" class="text-xs text-slate-300">Moving Forward</div>
            </div>
          </div>

          <!-- Menu -->
          <nav class="p-3 space-y-1 flex-1 overflow-y-auto">
            <div class="sidebar-item active" data-route="home">
              <span class="text-xl">üè†</span><span class="font-semibold">Laman Utama</span>
            </div>
            <div class="sidebar-item" data-route="kehadiran">
              <span class="text-xl">üìä</span><span class="font-semibold">Kehadiran</span>
            </div>
            <div class="sidebar-item" data-route="pengumuman">
              <span class="text-xl">üì¢</span><span class="font-semibold">Pengumuman</span>
            </div>
            <div class="sidebar-item" data-route="takwim">
              <span class="text-xl">üìÖ</span><span class="font-semibold">Takwim</span>
            </div>
            <div class="sidebar-item" data-route="ibubapa">
              <span class="text-xl">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span><span class="font-semibold">Ibu Bapa</span>
            </div>
          </nav>

          <!-- Footer -->
          <div class="p-4 border-t border-white/10 text-xs text-slate-300">
            <div>¬© 2025 NK.</div>
            <div>Hak Cipta Terpelihara.</div>
          </div>
        </div>
      </aside>

      <!-- Overlay for mobile -->
      <div id="overlay" class="fixed inset-0 bg-black/40 z-30 hidden md:hidden"></div>

      <!-- Main content -->
      <main class="flex-1 md:ml-0">
        <!-- Header -->
        <header class="sticky top-0 z-20 bg-white/90 backdrop-blur border-b border-slate-100">
          <div class="px-4 md:px-8 py-4 flex items-center justify-between gap-4">
            <div class="flex items-center gap-3">
              <button id="btnToggleSidebar" class="icon-btn md:hidden" aria-label="Toggle sidebar">‚ò∞</button>

              <div class="flex items-center gap-3">
                <div class="hidden md:flex w-10 h-10 rounded-2xl overflow-hidden border border-slate-100 bg-white">
                  <img id="schoolLogoMini" alt="Logo Mini" class="w-full h-full object-cover" />
                </div>
                <div>
                  <div id="pageTitle" class="text-xl font-extrabold leading-tight">Laman Utama</div>
                  <div class="text-sm text-slate-500">Portal Rasmi PPKI</div>
                </div>
              </div>
            </div>

            <div class="flex items-center gap-2">
              <button id="btnReload" class="btn btn-primary gap-2">
                <span>‚ü≥</span><span>Muat Semula</span>
              </button>
            </div>
          </div>
        </header>

        <!-- Pages container -->
        <div class="px-4 md:px-8 py-6 space-y-6">

          <!-- HOME -->
          <section id="page-home" class="space-y-6">
            <div class="card p-6">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div>
                  <div class="text-sm font-bold text-slate-500">Selamat Datang</div>
                  <div class="text-2xl md:text-3xl font-extrabold mt-1">
                    Selamat Datang ke Portal Rasmi PPKI SK Paya Resak
                  </div>
                </div>
                <div class="text-right">
                  <div id="homeClock" class="text-2xl font-extrabold tabular-nums"></div>
                  <div id="homeDate" class="text-sm text-slate-500"></div>
                </div>
              </div>
            </div>

            <!-- Home stats -->
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
              <div class="card p-5 cursor-pointer hover:shadow-md transition" id="homeCardHariIni">
                <div class="text-sm font-bold text-slate-500">Hari Ini (Ditapis)</div>
                <div class="mt-4 grid grid-cols-2 gap-3">
                  <div class="rounded-2xl bg-slate-50 border border-slate-100 p-4">
                    <div class="text-xs font-bold text-slate-500">Hadir</div>
                    <div id="homeHariIniHadir" class="text-2xl font-extrabold">0</div>
                  </div>
                  <div class="rounded-2xl bg-slate-50 border border-slate-100 p-4">
                    <div class="text-xs font-bold text-slate-500">Tidak Hadir</div>
                    <div id="homeHariIniTH" class="text-2xl font-extrabold">0</div>
                  </div>
                </div>
              </div>

              <div class="card p-5 cursor-pointer hover:shadow-md transition" id="homeCardMingguIni">
                <div class="text-sm font-bold text-slate-500">Minggu Ini (Ditapis)</div>
                <div class="mt-4 grid grid-cols-2 gap-3">
                  <div class="rounded-2xl bg-slate-50 border border-slate-100 p-4">
                    <div class="text-xs font-bold text-slate-500">Hadir</div>
                    <div id="homeMingguHadir" class="text-2xl font-extrabold">0</div>
                  </div>
                  <div class="rounded-2xl bg-slate-50 border border-slate-100 p-4">
                    <div class="text-xs font-bold text-slate-500">Tidak Hadir</div>
                    <div id="homeMingguTH" class="text-2xl font-extrabold">0</div>
                  </div>
                </div>
              </div>

              <div class="card p-5 cursor-pointer hover:shadow-md transition" id="homeCardBulanIni">
                <div class="text-sm font-bold text-slate-500">Bulan Ini (Ditapis)</div>
                <div class="mt-4 grid grid-cols-2 gap-3">
                  <div class="rounded-2xl bg-slate-50 border border-slate-100 p-4">
                    <div class="text-xs font-bold text-slate-500">Hadir</div>
                    <div id="homeBulanHadir" class="text-2xl font-extrabold">0</div>
                  </div>
                  <div class="rounded-2xl bg-slate-50 border border-slate-100 p-4">
                    <div class="text-xs font-bold text-slate-500">Tidak Hadir</div>
                    <div id="homeBulanTH" class="text-2xl font-extrabold">0</div>
                  </div>
                </div>
              </div>

              <div class="card p-5 cursor-pointer hover:shadow-md transition" id="homeCardPctBulanan">
                <div class="text-sm font-bold text-slate-500">% Kehadiran Bulanan (Ditapis)</div>
                <div class="mt-4 grid grid-cols-2 gap-3">
                  <div class="rounded-2xl bg-slate-50 border border-slate-100 p-4">
                    <div class="text-xs font-bold text-slate-500">% Hadir</div>
                    <div id="homePctBulanan" class="text-2xl font-extrabold">0%</div>
                  </div>
                  <div class="rounded-2xl bg-slate-50 border border-slate-100 p-4">
                    <div class="text-xs font-bold text-slate-500">Bulan</div>
                    <div id="homeBulanLabel" class="text-2xl font-extrabold">-</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Announcements summary -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
              <div class="card p-6 lg:col-span-2">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-lg font-extrabold">Ringkasan</div>
                    <div class="text-sm text-slate-500">Data ditunjukkan berdasarkan penapis semasa (jika ada).</div>
                  </div>
                </div>

                <div class="mt-5 grid grid-cols-1 md:grid-cols-4 gap-3">
                  <div class="rounded-2xl bg-slate-50 border border-slate-100 p-4">
                    <div class="text-xs font-bold text-slate-500">Jumlah Rekod Ditapis</div>
                    <div id="homeFilteredTotal" class="text-2xl font-extrabold">0</div>
                  </div>
                  <div class="rounded-2xl bg-slate-50 border border-slate-100 p-4">
                    <div class="text-xs font-bold text-slate-500">Murid Unik Ditapis</div>
                    <div id="homeFilteredMurid" class="text-2xl font-extrabold">0</div>
                  </div>
                  <div class="rounded-2xl bg-slate-50 border border-slate-100 p-4">
                    <div class="text-xs font-bold text-slate-500">Kelas Unik Ditapis</div>
                    <div id="homeFilteredKelas" class="text-2xl font-extrabold">0</div>
                  </div>
                  <div class="rounded-2xl bg-slate-50 border border-slate-100 p-4">
                    <div class="text-xs font-bold text-slate-500">% Hadir (Ditapis)</div>
                    <div id="homeFilteredPct" class="text-2xl font-extrabold">0%</div>
                  </div>
                </div>
              </div>

              <div class="card p-6 cursor-pointer hover:shadow-md transition" id="homeCardPengumuman">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-lg font-extrabold">üì¢ Pengumuman Aktif</div>
                    <div class="text-sm text-slate-500">Klik untuk buka halaman Pengumuman.</div>
                  </div>
                  <div class="pill bg-slate-900 text-white" id="homePengumumanCount">0</div>
                </div>
                <ol class="mt-4 space-y-2 text-sm text-slate-700" id="homePengumumanList"></ol>
              </div>
            </div>
          </section>

          <!-- KEHADIRAN -->
          <section id="page-kehadiran" class="space-y-6 hidden">
            <div class="card p-6">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div>
                  <div class="text-2xl font-extrabold">Dashboard Kehadiran</div>
                  <div class="text-sm text-slate-500">Kad & jadual akan berubah ikut penapis semasa.</div>
                </div>

                <div class="flex items-center gap-2">
                  <button id="btnResetFilters" class="btn btn-ghost">Reset</button>
                  <button id="btnColumns" class="btn btn-primary">Kolum</button>
                </div>
              </div>
            </div>

            <!-- Cards that follow FILTERED data (best) -->
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
              <div class="card p-5">
                <div class="text-sm font-bold text-slate-500">Ditapis</div>
                <div class="mt-4 grid grid-cols-2 gap-3">
                  <div class="rounded-2xl bg-slate-50 border border-slate-100 p-4">
                    <div class="text-xs font-bold text-slate-500">Hadir</div>
                    <div id="fHadir" class="text-2xl font-extrabold">0</div>
                  </div>
                  <div class="rounded-2xl bg-slate-50 border border-slate-100 p-4">
                    <div class="text-xs font-bold text-slate-500">Tidak Hadir</div>
                    <div id="fTH" class="text-2xl font-extrabold">0</div>
                  </div>
                </div>
              </div>

              <div class="card p-5">
                <div class="text-sm font-bold text-slate-500">% Hadir (Ditapis)</div>
                <div class="mt-4 grid grid-cols-2 gap-3">
                  <div class="rounded-2xl bg-slate-50 border border-slate-100 p-4">
                    <div class="text-xs font-bold text-slate-500">% Hadir</div>
                    <div id="fPct" class="text-2xl font-extrabold">0%</div>
                  </div>
                  <div class="rounded-2xl bg-slate-50 border border-slate-100 p-4">
                    <div class="text-xs font-bold text-slate-500">Rekod</div>
                    <div id="fTotal" class="text-2xl font-extrabold">0</div>
                  </div>
                </div>
              </div>

              <div class="card p-5">
                <div class="text-sm font-bold text-slate-500">Unik (Ditapis)</div>
                <div class="mt-4 grid grid-cols-2 gap-3">
                  <div class="rounded-2xl bg-slate-50 border border-slate-100 p-4">
                    <div class="text-xs font-bold text-slate-500">Murid</div>
                    <div id="fMuridUnik" class="text-2xl font-extrabold">0</div>
                  </div>
                  <div class="rounded-2xl bg-slate-50 border border-slate-100 p-4">
                    <div class="text-xs font-bold text-slate-500">Kelas</div>
                    <div id="fKelasUnik" class="text-2xl font-extrabold">0</div>
                  </div>
                </div>
              </div>

              <!-- Optional: still show "Today/Week/Month" but based on FILTERED set -->
              <div class="card p-5">
                <div class="text-sm font-bold text-slate-500">Ringkasan Masa (Ditapis)</div>
                <div class="mt-4 grid grid-cols-2 gap-3">
                  <div class="rounded-2xl bg-slate-50 border border-slate-100 p-4">
                    <div class="text-xs font-bold text-slate-500">Hari Ini</div>
                    <div id="fHariIni" class="text-2xl font-extrabold">0</div>
                  </div>
                  <div class="rounded-2xl bg-slate-50 border border-slate-100 p-4">
                    <div class="text-xs font-bold text-slate-500">Bulan Ini</div>
                    <div id="fBulanIni" class="text-2xl font-extrabold">0</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Filter panel -->
            <div class="card p-6 space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
                <div class="md:col-span-4">
                  <div class="text-sm font-bold text-slate-600 mb-2">Carian</div>
                  <input id="qSearch" class="input" placeholder="Cari nama, kelas, status..." />
                </div>

                <div class="md:col-span-2">
                  <div class="text-sm font-bold text-slate-600 mb-2">Kelas</div>
                  <select id="qKelas" class="select"></select>
                </div>

                <div class="md:col-span-2">
                  <div class="text-sm font-bold text-slate-600 mb-2">Status</div>
                  <select id="qStatus" class="select"></select>
                </div>

                <div class="md:col-span-2">
                  <div class="text-sm font-bold text-slate-600 mb-2">Jantina</div>
                  <select id="qJantina" class="select"></select>
                </div>

                <div class="md:col-span-2">
                  <div class="text-sm font-bold text-slate-600 mb-2">Papar/halaman</div>
                  <select id="qPageSize" class="select">
                    <option value="20">20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="200">200</option>
                  </select>
                </div>

                <div class="md:col-span-3">
                  <div class="text-sm font-bold text-slate-600 mb-2">Tarikh Dari</div>
                  <input id="qDateFrom" type="date" class="input" />
                </div>

                <div class="md:col-span-3">
                  <div class="text-sm font-bold text-slate-600 mb-2">Tarikh Hingga</div>
                  <input id="qDateTo" type="date" class="input" />
                </div>

                <div class="md:col-span-6">
                  <div class="text-sm font-bold text-slate-600 mb-2">Penapis Aktif</div>
                  <div id="filterSummary" class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-700">
                    -
                  </div>
                </div>
              </div>
            </div>

            <!-- Table -->
            <div class="card overflow-hidden">
              <div class="px-6 py-4 flex items-center justify-between">
                <div class="text-lg font-extrabold">Rekod Kehadiran</div>
                <div class="text-sm text-slate-500">Jumlah rekod: <span id="totalRowsLabel" class="font-bold">0</span></div>
              </div>
              <div class="overflow-x-auto">
                <table class="min-w-full">
                  <thead class="bg-white">
                    <tr id="tableHead"></tr>
                  </thead>
                  <tbody id="tableBody" class="bg-white"></tbody>
                </table>
              </div>

              <!-- Pagination -->
              <div class="px-6 py-4 flex items-center justify-between gap-3 bg-white border-t border-slate-100">
                <div class="text-sm text-slate-500">
                  Papar <span id="pageFrom">0</span> ‚Äì <span id="pageTo">0</span>
                </div>
                <div class="flex items-center gap-2">
                  <button id="btnPrev" class="btn btn-ghost">Sebelum</button>
                  <div class="text-sm font-bold">Halaman <span id="pageNum">1</span></div>
                  <button id="btnNext" class="btn btn-ghost">Seterusnya</button>
                </div>
              </div>
            </div>
          </section>

          <!-- PENGUMUMAN -->
          <section id="page-pengumuman" class="space-y-6 hidden">
            <div class="card p-6">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-2xl font-extrabold">üì¢ Pengumuman</div>
                  <div class="text-sm text-slate-500">Pengumuman tamat tempoh akan hilang automatik.</div>
                </div>
                <div class="pill bg-slate-900 text-white" id="pengumumanCount">0</div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="pengumumanGrid"></div>
          </section>

          <!-- TAKWIM -->
          <section id="page-takwim" class="space-y-6 hidden">
            <div class="card p-6">
              <div class="text-2xl font-extrabold">üìÖ Takwim</div>
              <div class="text-sm text-slate-500">Sambungan Google Sheet boleh ditambah kemudian.</div>
            </div>
            <div class="card p-6 text-sm text-slate-600">
              Buat masa ini, modul Takwim disediakan sebagai tapak. Bila cikgu beri CSV Takwim, saya boleh sambungkan macam Pengumuman.
            </div>
          </section>

          <!-- IBU BAPA -->
          <section id="page-ibubapa" class="space-y-6 hidden">
            <div class="card p-6">
              <div class="text-2xl font-extrabold">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Ibu Bapa</div>
              <div class="text-sm text-slate-500">Kad info boleh pop-out atau buka pautan terus.</div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="ibubapaGrid"></div>
          </section>

        </div>

        <footer class="px-4 md:px-8 pb-6 text-xs text-slate-500">
          Dibina untuk PPKI ‚Äî paparan responsif (mobile sidebar tertutup secara default).
        </footer>
      </main>
    </div>
  </div>

  <!-- MODAL -->
  <div id="modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40" id="modalBackdrop"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="bg-white w-full max-w-2xl rounded-2xl shadow-lg border border-slate-100 overflow-hidden">
        <div class="px-5 py-4 border-b border-slate-100 flex items-center justify-between">
          <div id="modalTitle" class="font-extrabold text-lg">Tajuk</div>
          <button id="modalClose" class="icon-btn">‚úï</button>
        </div>
        <div class="p-5 space-y-3">
          <div id="modalMeta" class="text-sm text-slate-500"></div>
          <div id="modalBody" class="text-slate-700 whitespace-pre-wrap leading-relaxed"></div>
          <div id="modalLinkWrap" class="pt-2 hidden">
            <a id="modalLink" target="_blank" class="btn btn-primary w-full text-center">Buka Pautan</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Column Picker -->
  <div id="colPicker" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40" id="colBackdrop"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="bg-white w-full max-w-xl rounded-2xl shadow-lg border border-slate-100 overflow-hidden">
        <div class="px-5 py-4 border-b border-slate-100 flex items-center justify-between">
          <div class="font-extrabold text-lg">Pilih Kolum</div>
          <button id="colClose" class="icon-btn">‚úï</button>
        </div>
        <div class="p-5">
          <div class="text-sm text-slate-500 mb-3">Tanda kolum yang cikgu mahu papar.</div>
          <div id="colList" class="grid grid-cols-1 md:grid-cols-2 gap-2"></div>
          <div class="mt-4 flex gap-2">
            <button id="colAll" class="btn btn-ghost flex-1">Semua</button>
            <button id="colApply" class="btn btn-primary flex-1">Terapkan</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===========================
   CONFIG: CSV URLs (Your links)
=========================== */
const CSV_URLS = {
  kehadiran: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTKhex5gcCHKoiLqRZpgVRMRfrGGvPtbgc3jo_Q-3FPL5OpcoWvyAnec0dTgykrpkYuS34iNJnEAkDU/pub?gid=880667725&single=true&output=csv",
  pengumuman:"https://docs.google.com/spreadsheets/d/e/2PACX-1vQvKlO-LRGh8kj_-Be6NxZRR3Z38rjbC33jyvfhQvnR9L4LF7_dZRVXYGK3XO7bAoJwC9bJJmABjV6Z/pub?gid=946270411&single=true&output=csv",
  ibubapa:  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ_G1txQOE4Di1XsK6esbw8VgQtW2hcPsjzAmPH7V82JOeXegb7Kb_3Iz8CeHo-KvfvHe9x8BWtSfbB/pub?gid=1684744050&single=true&output=csv",
};

// Expected columns for Pengumuman template:
// ID | TARIKH MULA | TARIKH TAMAT | TAJUK | ISI KANDUNGAN | URL | KEUTAMAAN | AKTIF

// Expected columns for Ibu Bapa template (recommended):
// TAJUK | ISI KANDUNGAN | URL | JENIS (POPUP/LINK)

/* ===========================
   STATE
=========================== */
const state = {
  route: "home",
  kehadiran: [],
  pengumuman: [],
  ibubapa: [],
  columns: [],            // attendance columns
  visibleCols: new Set(), // attendance visible columns
  filters: {
    search: "",
    kelas: "Semua",
    status:"Semua",
    jantina:"Semua",
    dateFrom: "",
    dateTo: "",
    pageSize: 20,
    page: 1
  }
};

/* ===========================
   HELPERS: CSV parse
=========================== */
function parseCSV(text){
  // Robust CSV parser (handles quotes, commas in quotes)
  const rows = [];
  let i=0, field="", row=[], inQuotes=false;
  while(i < text.length){
    const c = text[i];
    if(inQuotes){
      if(c === '"'){
        if(text[i+1] === '"'){ field += '"'; i+=2; continue; }
        inQuotes = false; i++; continue;
      }
      field += c; i++; continue;
    } else {
      if(c === '"'){ inQuotes=true; i++; continue; }
      if(c === ','){ row.push(field); field=""; i++; continue; }
      if(c === '\n'){
        row.push(field); field="";
        // ignore empty trailing line
        if(row.some(x => (x||"").trim() !== "")) rows.push(row);
        row=[]; i++; continue;
      }
      if(c === '\r'){ i++; continue; }
      field += c; i++; continue;
    }
  }
  row.push(field);
  if(row.some(x => (x||"").trim() !== "")) rows.push(row);
  return rows;
}

function csvToObjects(text){
  const rows = parseCSV(text);
  if(!rows.length) return [];
  const headers = rows[0].map(h => (h||"").trim());
  const out = [];
  for(let r=1; r<rows.length; r++){
    const obj = {};
    for(let c=0; c<headers.length; c++){
      obj[headers[c] || `COL_${c}`] = (rows[r][c] ?? "").trim();
    }
    out.push(obj);
  }
  return out;
}

async function fetchCSV(url){
  const res = await fetch(url, { cache: "no-store" });
  if(!res.ok) throw new Error("Gagal muat CSV: " + res.status);
  return await res.text();
}

/* ===========================
   DATE helpers
=========================== */
function toISODate(s){
  // accepts: yyyy-mm-dd, dd/mm/yyyy, dd-mm-yyyy
  if(!s) return "";
  const v = (s||"").trim();
  if(/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;

  // dd/mm/yyyy or dd-mm-yyyy
  const m = v.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if(m){
    const dd = String(m[1]).padStart(2,"0");
    const mm = String(m[2]).padStart(2,"0");
    const yy = m[3];
    return `${yy}-${mm}-${dd}`;
  }
  // fallback: try Date parse
  const d = new Date(v);
  if(!isNaN(d.getTime())){
    const yy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yy}-${mm}-${dd}`;
  }
  return "";
}

function todayISO(){
  const d=new Date();
  const yy=d.getFullYear();
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const dd=String(d.getDate()).padStart(2,"0");
  return `${yy}-${mm}-${dd}`;
}

function startOfWeekISO(dateISO){
  // Monday as start
  const d = new Date(dateISO+"T00:00:00");
  const day = d.getDay(); // 0 Sun..6 Sat
  const diff = (day===0?6:day-1);
  d.setDate(d.getDate()-diff);
  const yy=d.getFullYear();
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const dd=String(d.getDate()).padStart(2,"0");
  return `${yy}-${mm}-${dd}`;
}

function sameMonth(aISO, bISO){
  return aISO?.slice(0,7) === bISO?.slice(0,7);
}

/* ===========================
   Attendance normalization
=========================== */
function normalizeKehadiranRow(r){
  // Try common column names
  // You can adjust if your sheet uses different headers.
  const tarikh = toISODate(r.Tarikh || r.TARIKH || r.Date || r.TARIKH_KEHADIRAN || "");
  const kelas  = (r.Kelas || r.KELAS || r.CLASS || "").trim();
  const nama   = (r["Nama Murid"] || r["NAMA MURID"] || r.Nama || r.NAMA || r["Nama_Murid"] || "").trim();
  const status = (r.Status || r.STATUS || "").trim();
  const jantina= (r.Jantina || r.JANTINA || "").trim();

  // Keep all original cols too
  return { ...r, Tarikh: tarikh, Kelas: kelas, "Nama Murid": nama, Status: status, Jantina: jantina };
}

function isHadir(s){
  const v = (s||"").toUpperCase().trim();
  return v === "HADIR" || v === "YA" || v === "PRESENT";
}
function isTidakHadir(s){
  const v = (s||"").toUpperCase().trim();
  return v === "TIDAK HADIR" || v === "TIDAK" || v === "ABSENT";
}

/* ===========================
   FILTER logic
=========================== */
function filterKehadiran(rows){
  const f = state.filters;
  const q = (f.search||"").toLowerCase().trim();
  const kelas = f.kelas;
  const status = f.status;
  const jantina = f.jantina;

  const from = f.dateFrom ? toISODate(f.dateFrom) : "";
  const to   = f.dateTo   ? toISODate(f.dateTo)   : "";

  return rows.filter(r=>{
    if(kelas !== "Semua" && (r.Kelas||"") !== kelas) return false;

    if(status !== "Semua"){
      const st = (r.Status||"");
      if(st !== status) return false;
    }

    if(jantina !== "Semua" && (r.Jantina||"") !== jantina) return false;

    if(from && r.Tarikh && r.Tarikh < from) return false;
    if(to && r.Tarikh && r.Tarikh > to) return false;

    if(q){
      const hay = Object.values(r).join(" ").toLowerCase();
      if(!hay.includes(q)) return false;
    }
    return true;
  });
}

/* ===========================
   STATS based on FILTERED rows
=========================== */
function calcStatsFromRows(rows){
  const hadir = rows.filter(r=>isHadir(r.Status)).length;
  const th    = rows.filter(r=>isTidakHadir(r.Status)).length;
  const known = hadir + th;
  const pct   = known ? Math.round((hadir/known)*1000)/10 : 0;

  const muridSet = new Set(rows.map(r => (r["Nama Murid"]||"").trim()).filter(Boolean));
  const kelasSet = new Set(rows.map(r => (r.Kelas||"").trim()).filter(Boolean));

  return { hadir, th, total: rows.length, pct, muridUnik: muridSet.size, kelasUnik: kelasSet.size };
}

function calcTimeSlicesFromRows(rows){
  const t = todayISO();
  const w0 = startOfWeekISO(t);
  const m = t.slice(0,7);

  const hariIni = rows.filter(r=>r.Tarikh === t).length;
  const bulanIni = rows.filter(r=> (r.Tarikh||"").slice(0,7) === m).length;
  const mingguIni = rows.filter(r=> r.Tarikh && r.Tarikh >= w0 && r.Tarikh <= t).length;

  // For Home cards: count hadir/th by slice
  const slice = (pred)=> {
    const rr = rows.filter(pred);
    return {
      hadir: rr.filter(x=>isHadir(x.Status)).length,
      th: rr.filter(x=>isTidakHadir(x.Status)).length,
      pct: (()=> {
        const h = rr.filter(x=>isHadir(x.Status)).length;
        const th = rr.filter(x=>isTidakHadir(x.Status)).length;
        const known = h+th;
        return known ? Math.round((h/known)*1000)/10 : 0;
      })()
    };
  };

  return {
    today: slice(r=>r.Tarikh === t),
    week:  slice(r=> r.Tarikh && r.Tarikh >= w0 && r.Tarikh <= t),
    month: slice(r=> (r.Tarikh||"").slice(0,7) === m),
    monthLabel: `${Number(m.slice(5,7))}/${m.slice(0,4)}`,
    hariIniTotal: hariIni,
    bulanIniTotal: bulanIni,
    mingguIniTotal: mingguIni
  };
}

/* ===========================
   Pengumuman logic
=========================== */
function normalizePengumumanRow(r){
  // Map possible headers to standard
  const tarikhMula = toISODate(r["TARIKH MULA"] || r.TARIKH_MULA || r.Tarikh_Mula || r.MULA || "");
  const tarikhTamat= toISODate(r["TARIKH TAMAT"]|| r.TARIKH_TAMAT|| r.Tarikh_Tamat|| r.TAMAT || "");
  const tajuk = (r.TAJUK || r.Tajuk || "").trim();
  const isi   = (r["ISI KANDUNGAN"] || r.ISI || r.KANDUNGAN || "").trim();
  const url   = (r.URL || r.PAUTAN || "").trim();
  const keutamaan = (r.KEUTAMAAN || r.Keutamaan || "").trim();
  const aktif = (r.AKTIF || r.Aktif || "").trim().toUpperCase();
  const id = (r.ID || r.Id || "").trim();

  return { ...r, ID:id, TARIKH_MULA:tarikhMula, TARIKH_TAMAT:tarikhTamat, TAJUK:tajuk, ISI:isi, URL:url, KEUTAMAAN:keutamaan, AKTIF:aktif };
}

function isPengumumanAktif(p){
  const t = todayISO();
  if(p.AKTIF && p.AKTIF !== "YA") return false; // if column exists and not YA => off
  if(!p.TARIKH_MULA) return false;
  if(p.TARIKH_MULA > t) return false;
  if(p.TARIKH_TAMAT && p.TARIKH_TAMAT < t) return false;
  return true;
}

function keutamaanValue(v){
  // Higher first. Accept number or text.
  const n = Number(String(v||"").replace(/[^\d]/g,""));
  return isNaN(n) ? 0 : n;
}

/* ===========================
   Ibu Bapa logic
=========================== */
function normalizeIbuBapaRow(r){
  const tajuk = (r.TAJUK || r.Tajuk || r.Title || "").trim();
  const isi   = (r["ISI KANDUNGAN"] || r.ISI || r.Kandungan || r.Body || "").trim();
  const url   = (r.URL || r.PAUTAN || "").trim();
  const jenis = (r.JENIS || r.Jenis || "").trim().toUpperCase(); // POPUP / LINK
  return { ...r, TAJUK:tajuk, ISI:isi, URL:url, JENIS:jenis };
}

/* ===========================
   UI ROUTING
=========================== */
const pages = ["home","kehadiran","pengumuman","takwim","ibubapa"];

function setRoute(route){
  state.route = route;
  // title
  const titles = {
    home:"Laman Utama",
    kehadiran:"Dashboard Kehadiran",
    pengumuman:"Pengumuman",
    takwim:"Takwim",
    ibubapa:"Ibu Bapa"
  };
  document.getElementById("pageTitle").textContent = titles[route] || "Portal";

  // show/hide pages
  pages.forEach(p=>{
    document.getElementById(`page-${p}`).classList.toggle("hidden", p!==route);
  });

  // sidebar active
  document.querySelectorAll(".sidebar-item").forEach(el=>{
    el.classList.toggle("active", el.dataset.route === route);
  });

  if(route === "kehadiran") renderKehadiran();
  if(route === "pengumuman") renderPengumuman();
  if(route === "ibubapa") renderIbuBapa();

  closeSidebarMobile();
}

/* ===========================
   SIDEBAR mobile
=========================== */
function openSidebarMobile(){
  document.getElementById("sidebar").classList.remove("-translate-x-full");
  document.getElementById("overlay").classList.remove("hidden");
}
function closeSidebarMobile(){
  document.getElementById("sidebar").classList.add("-translate-x-full");
  document.getElementById("overlay").classList.add("hidden");
}

/* ===========================
   RENDER: Home
=========================== */
function renderHome(){
  // Update home cards from FILTERED attendance (best practice)
  const filtered = filterKehadiran(state.kehadiran);
  const stats = calcStatsFromRows(filtered);
  const slices = calcTimeSlicesFromRows(filtered);

  // Home time cards
  document.getElementById("homeHariIniHadir").textContent = slices.today.hadir;
  document.getElementById("homeHariIniTH").textContent    = slices.today.th;

  document.getElementById("homeMingguHadir").textContent = slices.week.hadir;
  document.getElementById("homeMingguTH").textContent    = slices.week.th;

  document.getElementById("homeBulanHadir").textContent = slices.month.hadir;
  document.getElementById("homeBulanTH").textContent    = slices.month.th;

  document.getElementById("homePctBulanan").textContent = `${slices.month.pct}%`;
  document.getElementById("homeBulanLabel").textContent = slices.monthLabel;

  // Filtered summary
  document.getElementById("homeFilteredTotal").textContent = stats.total;
  document.getElementById("homeFilteredMurid").textContent = stats.muridUnik;
  document.getElementById("homeFilteredKelas").textContent = stats.kelasUnik;
  document.getElementById("homeFilteredPct").textContent = `${stats.pct}%`;

  // Pengumuman list
  const active = state.pengumuman.filter(isPengumumanAktif)
    .sort((a,b)=> keutamaanValue(b.KEUTAMAAN) - keutamaanValue(a.KEUTAMAAN) || (b.TARIKH_MULA||"").localeCompare(a.TARIKH_MULA||""));

  document.getElementById("homePengumumanCount").textContent = active.length;
  const list = document.getElementById("homePengumumanList");
  list.innerHTML = "";
  active.slice(0,6).forEach((p, idx)=>{
    const li = document.createElement("li");
    li.className = "flex gap-2 items-start";
    li.innerHTML = `<span class="font-extrabold text-slate-900">${idx+1}.</span>
                    <span class="text-slate-700">${escapeHTML(p.TAJUK || "Pengumuman")}</span>`;
    list.appendChild(li);
  });
  if(active.length === 0){
    const li = document.createElement("li");
    li.className="text-slate-500";
    li.textContent="Tiada pengumuman aktif.";
    list.appendChild(li);
  }
}

/* ===========================
   RENDER: Attendance
=========================== */
function buildFilterOptions(){
  const kelas = unique(state.kehadiran.map(r=>r.Kelas).filter(Boolean)).sort();
  const status= unique(state.kehadiran.map(r=>r.Status).filter(Boolean)).sort();
  const jantina=unique(state.kehadiran.map(r=>r.Jantina).filter(Boolean)).sort();

  fillSelect("qKelas", ["Semua", ...kelas], state.filters.kelas);
  fillSelect("qStatus",["Semua", ...status], state.filters.status);
  fillSelect("qJantina",["Semua", ...jantina], state.filters.jantina);
}

function renderKehadiran(){
  buildFilterOptions();

  // filtered set
  const filtered = filterKehadiran(state.kehadiran);
  const stats = calcStatsFromRows(filtered);
  const slices = calcTimeSlicesFromRows(filtered);

  // stats cards
  byId("fHadir").textContent = stats.hadir;
  byId("fTH").textContent = stats.th;
  byId("fPct").textContent = `${stats.pct}%`;
  byId("fTotal").textContent = stats.total;
  byId("fMuridUnik").textContent = stats.muridUnik;
  byId("fKelasUnik").textContent = stats.kelasUnik;
  byId("fHariIni").textContent = slices.hariIniTotal;
  byId("fBulanIni").textContent = slices.bulanIniTotal;

  // summary text
  byId("filterSummary").textContent = buildFilterSummaryText();

  // pagination
  const pageSize = Number(state.filters.pageSize) || 20;
  const total = filtered.length;
  const totalPages = Math.max(1, Math.ceil(total / pageSize));
  state.filters.page = Math.min(state.filters.page, totalPages);
  const page = state.filters.page;

  const start = (page-1)*pageSize;
  const end = Math.min(total, start + pageSize);
  const pageRows = filtered.slice(start, end);

  byId("totalRowsLabel").textContent = total;
  byId("pageNum").textContent = page;
  byId("pageFrom").textContent = total ? (start+1) : 0;
  byId("pageTo").textContent = total ? end : 0;

  // render table
  renderAttendanceTable(pageRows);

  // enable/disable pagination buttons
  byId("btnPrev").disabled = page <= 1;
  byId("btnNext").disabled = page >= totalPages;
  byId("btnPrev").classList.toggle("opacity-50", page<=1);
  byId("btnNext").classList.toggle("opacity-50", page>=totalPages);

  // update Home too (because best practice: cards follow filter)
  renderHome();
}

function renderAttendanceTable(rows){
  const head = byId("tableHead");
  const body = byId("tableBody");
  head.innerHTML = "";
  body.innerHTML = "";

  const cols = state.columns;
  const visible = Array.from(state.visibleCols);

  const activeCols = visible.length ? cols.filter(c=>state.visibleCols.has(c)) : cols;

  activeCols.forEach(c=>{
    const th = document.createElement("th");
    th.className = "table-th";
    th.textContent = c;
    head.appendChild(th);
  });

  rows.forEach(r=>{
    const tr = document.createElement("tr");
    tr.className = "hover:bg-slate-50";

    activeCols.forEach(c=>{
      const td = document.createElement("td");
      td.className = "table-td";
      let val = r[c] ?? "";

      // Special pill for Status
      if(String(c).toLowerCase() === "status"){
        const v = String(val||"").toUpperCase();
        const pill = document.createElement("span");
        pill.className = "pill " + (isHadir(v) ? "bg-emerald-100 text-emerald-800" : "bg-rose-100 text-rose-800");
        pill.textContent = v || "-";
        td.textContent = "";
        td.appendChild(pill);
      } else {
        td.textContent = val || "-";
      }
      tr.appendChild(td);
    });

    body.appendChild(tr);
  });

  if(rows.length === 0){
    const tr = document.createElement("tr");
    const td = document.createElement("td");
    td.className = "table-td text-slate-500";
    td.colSpan = Math.max(1, activeCols.length);
    td.textContent = "Tiada rekod untuk penapis semasa.";
    tr.appendChild(td);
    body.appendChild(tr);
  }
}

/* ===========================
   RENDER: Pengumuman
=========================== */
function renderPengumuman(){
  const grid = byId("pengumumanGrid");
  grid.innerHTML = "";

  const active = state.pengumuman
    .filter(isPengumumanAktif)
    .sort((a,b)=> keutamaanValue(b.KEUTAMAAN) - keutamaanValue(a.KEUTAMAAN)
      || (b.TARIKH_MULA||"").localeCompare(a.TARIKH_MULA||""));

  byId("pengumumanCount").textContent = active.length;

  if(active.length === 0){
    const div = document.createElement("div");
    div.className="card p-6 text-slate-600 text-sm";
    div.textContent="Tiada pengumuman aktif.";
    grid.appendChild(div);
    return;
  }

  active.forEach(p=>{
    const card = document.createElement("div");
    card.className = "card p-6 cursor-pointer hover:shadow-md transition";
    const badge = keutamaanValue(p.KEUTAMAAN) ? `<span class="pill bg-slate-900 text-white">Keutamaan ${escapeHTML(p.KEUTAMAAN)}</span>` : "";
    const meta = `${p.TARIKH_MULA ? formatDateMY(p.TARIKH_MULA) : ""}`;
    const excerpt = (p.ISI||"").slice(0,140) + ((p.ISI||"").length>140 ? "..." : "");

    card.innerHTML = `
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <div class="text-lg font-extrabold">${escapeHTML(p.TAJUK || "Pengumuman")}</div>
          <div class="text-sm text-slate-500 mt-1">${escapeHTML(meta)}</div>
        </div>
        ${badge}
      </div>
      <div class="text-sm text-slate-700 mt-4 whitespace-pre-wrap">${escapeHTML(excerpt)}</div>
      ${p.URL ? `<div class="mt-4 text-sm font-bold text-slate-900 underline">Ada pautan</div>` : ``}
    `;

    card.addEventListener("click", ()=>{
      openModal({
        title: p.TAJUK || "Pengumuman",
        meta: meta,
        body: p.ISI || "-",
        url: p.URL || ""
      });
    });

    grid.appendChild(card);
  });

  // Home card counts too
  renderHome();
}

/* ===========================
   RENDER: Ibu Bapa
=========================== */
function renderIbuBapa(){
  const grid = byId("ibubapaGrid");
  grid.innerHTML = "";

  if(!state.ibubapa.length){
    const div = document.createElement("div");
    div.className="card p-6 text-slate-600 text-sm";
    div.textContent="Tiada data Ibu Bapa ditemui.";
    grid.appendChild(div);
    return;
  }

  state.ibubapa.forEach(item=>{
    const card = document.createElement("div");
    card.className = "card p-6 hover:shadow-md transition";

    const jenis = item.JENIS || (item.URL ? "LINK" : "POPUP");
    const pill = (jenis === "LINK")
      ? `<span class="pill bg-slate-900 text-white">Pautan</span>`
      : `<span class="pill bg-slate-100 text-slate-700">Pop-out</span>`;

    card.innerHTML = `
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <div class="text-lg font-extrabold">${escapeHTML(item.TAJUK || "Makluman")}</div>
          <div class="text-sm text-slate-500 mt-1">${item.URL ? "Ada URL" : "Tiada URL"}</div>
        </div>
        ${pill}
      </div>
      <div class="text-sm text-slate-700 mt-4 whitespace-pre-wrap">${escapeHTML((item.ISI||"").slice(0,160))}${(item.ISI||"").length>160 ? "..." : ""}</div>
      <div class="mt-4 flex gap-2">
        <button class="btn btn-ghost flex-1" data-action="popup">Lihat</button>
        ${item.URL ? `<button class="btn btn-primary flex-1" data-action="link">Buka URL</button>` : ``}
      </div>
    `;

    card.querySelector('[data-action="popup"]').addEventListener("click", (e)=>{
      e.stopPropagation();
      openModal({
        title: item.TAJUK || "Makluman Ibu Bapa",
        meta: "",
        body: item.ISI || "-",
        url: (jenis === "LINK" ? "" : (item.URL||"")) // if POPUP and has URL, show button
      });
    });

    const linkBtn = card.querySelector('[data-action="link"]');
    if(linkBtn){
      linkBtn.addEventListener("click", (e)=>{
        e.stopPropagation();
        window.open(item.URL, "_blank");
      });
    }

    // If user clicks whole card: follow "jenis"
    card.addEventListener("click", ()=>{
      if(jenis === "LINK" && item.URL){
        window.open(item.URL, "_blank");
      } else {
        openModal({
          title: item.TAJUK || "Makluman Ibu Bapa",
          meta: "",
          body: item.ISI || "-",
          url: item.URL || ""
        });
      }
    });

    grid.appendChild(card);
  });
}

/* ===========================
   Column Picker
=========================== */
function openColPicker(){
  byId("colPicker").classList.remove("hidden");
  const list = byId("colList");
  list.innerHTML = "";

  const cols = state.columns;
  if(state.visibleCols.size === 0){
    cols.forEach(c=>state.visibleCols.add(c)); // default all
  }

  cols.forEach(c=>{
    const id = "col_" + c.replace(/\W+/g,"_");
    const wrap = document.createElement("label");
    wrap.className = "flex items-center gap-2 rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 cursor-pointer";
    wrap.innerHTML = `
      <input type="checkbox" class="w-4 h-4" id="${id}">
      <span class="text-sm font-semibold text-slate-700">${escapeHTML(c)}</span>
    `;
    const cb = wrap.querySelector("input");
    cb.checked = state.visibleCols.has(c);
    cb.addEventListener("change", ()=>{
      if(cb.checked) state.visibleCols.add(c);
      else state.visibleCols.delete(c);
    });
    list.appendChild(wrap);
  });
}

function closeColPicker(){
  byId("colPicker").classList.add("hidden");
}

/* ===========================
   Modal
=========================== */
function openModal({title, meta, body, url}){
  byId("modalTitle").textContent = title || "";
  byId("modalMeta").textContent = meta || "";
  byId("modalBody").textContent = body || "";
  if(url){
    byId("modalLinkWrap").classList.remove("hidden");
    byId("modalLink").href = url;
  } else {
    byId("modalLinkWrap").classList.add("hidden");
    byId("modalLink").removeAttribute("href");
  }
  byId("modal").classList.remove("hidden");
}
function closeModal(){
  byId("modal").classList.add("hidden");
}

/* ===========================
   Utility
=========================== */
function byId(id){ return document.getElementById(id); }
function unique(arr){ return Array.from(new Set(arr)); }
function fillSelect(id, options, selected){
  const el = byId(id);
  el.innerHTML = "";
  options.forEach(opt=>{
    const o = document.createElement("option");
    o.value = opt;
    o.textContent = opt;
    el.appendChild(o);
  });
  el.value = selected ?? options[0];
}
function escapeHTML(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function formatDateMY(iso){
  if(!iso) return "";
  const [y,m,d] = iso.split("-");
  return `${d}/${m}/${y}`;
}
function buildFilterSummaryText(){
  const f = state.filters;
  const parts = [];
  if(f.search) parts.push(`Carian: "${f.search}"`);
  if(f.kelas !== "Semua") parts.push(`Kelas: ${f.kelas}`);
  if(f.status !== "Semua") parts.push(`Status: ${f.status}`);
  if(f.jantina !== "Semua") parts.push(`Jantina: ${f.jantina}`);
  if(f.dateFrom) parts.push(`Dari: ${formatDateMY(toISODate(f.dateFrom))}`);
  if(f.dateTo) parts.push(`Hingga: ${formatDateMY(toISODate(f.dateTo))}`);
  if(!parts.length) return "Tiada penapis ‚Äî paparan semua data.";
  return parts.join(" ¬∑ ");
}

/* ===========================
   INIT: load data
=========================== */
async function loadAll(){
  // visual
  byId("schoolLogoMini").src = byId("schoolLogo").src;

  try{
    // Fetch all CSVs in parallel
    const [kCSV, pCSV, iCSV] = await Promise.all([
      fetchCSV(CSV_URLS.kehadiran),
      fetchCSV(CSV_URLS.pengumuman),
      fetchCSV(CSV_URLS.ibubapa),
    ]);

    // Attendance
    const kObj = csvToObjects(kCSV).map(normalizeKehadiranRow);
    state.kehadiran = kObj;

    // Columns from first row
    state.columns = kObj.length ? Object.keys(kObj[0]) : [];
    // default visible columns: prefer key columns first
    const preferred = ["Tarikh","Kelas","Nama Murid","Status","Jantina"];
    state.visibleCols = new Set();
    preferred.forEach(c=> { if(state.columns.includes(c)) state.visibleCols.add(c); });
    // If nothing matched, show all
    if(state.visibleCols.size === 0) state.columns.forEach(c=>state.visibleCols.add(c));

    // Pengumuman
    const pObj = csvToObjects(pCSV).map(normalizePengumumanRow);
    state.pengumuman = pObj;

    // Ibu bapa
    const iObj = csvToObjects(iCSV).map(normalizeIbuBapaRow);
    state.ibubapa = iObj;

    // If no date range set, set to full range of data
    const dates = state.kehadiran.map(r=>r.Tarikh).filter(Boolean).sort();
    if(dates.length){
      // default: last 60 days window (nice)
      const max = dates[dates.length-1];
      const d = new Date(max+"T00:00:00");
      d.setDate(d.getDate()-60);
      const yy=d.getFullYear();
      const mm=String(d.getMonth()+1).padStart(2,"0");
      const dd=String(d.getDate()).padStart(2,"0");
      const min = `${yy}-${mm}-${dd}`;
      state.filters.dateFrom = min;
      state.filters.dateTo = max;
      byId("qDateFrom").value = min;
      byId("qDateTo").value = max;
    }

    buildFilterOptions();
    renderHome();
    if(state.route === "kehadiran") renderKehadiran();
    if(state.route === "pengumuman") renderPengumuman();
    if(state.route === "ibubapa") renderIbuBapa();

  }catch(err){
    console.error(err);
    alert("Gagal muat data CSV. Semak link publish CSV dan sambungan internet.");
  }
}

/* ===========================
   EVENTS
=========================== */
function wireEvents(){
  // Sidebar menu click
  document.querySelectorAll(".sidebar-item").forEach(item=>{
    item.addEventListener("click", ()=>{
      setRoute(item.dataset.route);
    });
  });

  // Sidebar mobile toggles
  byId("btnToggleSidebar").addEventListener("click", openSidebarMobile);
  byId("overlay").addEventListener("click", closeSidebarMobile);

  // Reload
  byId("btnReload").addEventListener("click", ()=>{
    location.reload();
  });

  // Home card clicks -> attendance/pengumuman
  byId("homeCardHariIni").addEventListener("click", ()=> setRoute("kehadiran"));
  byId("homeCardMingguIni").addEventListener("click", ()=> setRoute("kehadiran"));
  byId("homeCardBulanIni").addEventListener("click", ()=> setRoute("kehadiran"));
  byId("homeCardPctBulanan").addEventListener("click", ()=> setRoute("kehadiran"));
  byId("homeCardPengumuman").addEventListener("click", ()=> setRoute("pengumuman"));

  // Filters
  byId("qSearch").addEventListener("input", (e)=>{ state.filters.search = e.target.value; state.filters.page=1; renderKehadiran(); });
  byId("qKelas").addEventListener("change",(e)=>{ state.filters.kelas = e.target.value; state.filters.page=1; renderKehadiran(); });
  byId("qStatus").addEventListener("change",(e)=>{ state.filters.status = e.target.value; state.filters.page=1; renderKehadiran(); });
  byId("qJantina").addEventListener("change",(e)=>{ state.filters.jantina = e.target.value; state.filters.page=1; renderKehadiran(); });
  byId("qDateFrom").addEventListener("change",(e)=>{ state.filters.dateFrom = e.target.value; state.filters.page=1; renderKehadiran(); });
  byId("qDateTo").addEventListener("change",(e)=>{ state.filters.dateTo = e.target.value; state.filters.page=1; renderKehadiran(); });
  byId("qPageSize").addEventListener("change",(e)=>{ state.filters.pageSize = Number(e.target.value)||20; state.filters.page=1; renderKehadiran(); });

  // Pagination
  byId("btnPrev").addEventListener("click", ()=>{ state.filters.page = Math.max(1, state.filters.page-1); renderKehadiran(); });
  byId("btnNext").addEventListener("click", ()=>{
    const total = filterKehadiran(state.kehadiran).length;
    const totalPages = Math.max(1, Math.ceil(total / (Number(state.filters.pageSize)||20)));
    state.filters.page = Math.min(totalPages, state.filters.page+1);
    renderKehadiran();
  });

  // Reset filters
  byId("btnResetFilters").addEventListener("click", ()=>{
    state.filters.search = "";
    state.filters.kelas = "Semua";
    state.filters.status = "Semua";
    state.filters.jantina = "Semua";
    state.filters.pageSize = 20;
    state.filters.page = 1;

    byId("qSearch").value = "";
    byId("qPageSize").value = "20";

    // Keep date range as-is (optional), or clear:
    // state.filters.dateFrom=""; state.filters.dateTo="";
    // byId("qDateFrom").value=""; byId("qDateTo").value="";

    buildFilterOptions();
    renderKehadiran();
  });

  // Column picker
  byId("btnColumns").addEventListener("click", ()=>{
    openColPicker();
    byId("colPicker").classList.remove("hidden");
  });
  byId("colBackdrop").addEventListener("click", closeColPicker);
  byId("colClose").addEventListener("click", closeColPicker);
  byId("colAll").addEventListener("click", ()=>{
    state.visibleCols = new Set(state.columns);
    openColPicker(); // re-render list
  });
  byId("colApply").addEventListener("click", ()=>{
    closeColPicker();
    renderKehadiran();
  });

  // Modal
  byId("modalBackdrop").addEventListener("click", closeModal);
  byId("modalClose").addEventListener("click", closeModal);

  // Clock
  setInterval(()=>{
    const now = new Date();
    const t = now.toLocaleTimeString("ms-MY", { hour:"2-digit", minute:"2-digit", second:"2-digit" });
    const d = now.toLocaleDateString("ms-MY", { weekday:"long", year:"numeric", month:"long", day:"numeric" });
    byId("homeClock").textContent = t;
    byId("homeDate").textContent = d;
  }, 500);
}

/* ===========================
   START
=========================== */
(function init(){
  // Mobile sidebar closed by default (already hidden). On desktop it's open.
  closeSidebarMobile();
  wireEvents();
  loadAll();
  setRoute("home");
})();
</script>

</body>
</html>
