<!doctype html>
<html lang="ms" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Portal PPKI SK Paya Resak</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --primary:#0f3d2e; /* forest */
      --accent:#10b981;
    }
    .bg-primary{ background-color: var(--primary); }
    .text-primary{ color: var(--primary); }
    .ring-primary{ --tw-ring-color: var(--primary); }
    .bg-accent{ background-color: var(--accent); }
    .text-accent{ color: var(--accent); }
    .ring-accent{ --tw-ring-color: var(--accent); }
  </style>
</head>

<body class="h-full bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-50">
  <div id="app" class="h-full"></div>

  <script>
    /**********************
     * KONFIG URL CSV
     **********************/
    const CSV_KEHADIRAN = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTKhex5gcCHKoiLqRZpgVRMRfrGGvPtbgc3jo_Q-3FPL5OpcoWvyAnec0dTgykrpkYuS34iNJnEAkDU/pub?gid=880667725&single=true&output=csv";
    const CSV_PENGUMUMAN = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQvKlO-LRGh8kj_-Be6NxZRR3Z38rjbC33jyvfhQvnR9L4LF7_dZRVXYGK3XO7bAoJwC9bJJmABjV6Z/pub?gid=946270411&single=true&output=csv";
    const CSV_IBUBAPA = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ_G1txQOE4Di1XsK6esbw8VgQtW2hcPsjzAmPH7V82JOeXegb7Kb_3Iz8CeHo-KvfvHe9x8BWtSfbB/pub?gid=1684744050&single=true&output=csv";

    // Takwim (boleh set kemudian dalam Settings)
    const DEFAULT_CSV_TAKWIM = "";

    /**********************
     * PIN SETTINGS
     **********************/
    const SETTINGS_PIN = "5235"; // seperti diminta

    /**********************
     * STATE + STORAGE
     **********************/
    const LS_KEY = "ppki_pr_portal_settings_v1";
    const LS_UI  = "ppki_pr_portal_ui_v1";

    const THEME_PRESETS = {
      forest: { primary: "#0f3d2e", accent: "#10b981" },
      ocean:  { primary: "#0b3a6a", accent: "#22c1c3" },
      purple: { primary: "#4c1d95", accent: "#a855f7" },
      slate:  { primary: "#0f172a", accent: "#64748b" }
    };

    const defaultSettings = {
      schoolName: "SK Paya Resak",
      schoolMotto: "Moving Forward",
      logoDataUrl: "",
      footerLine1: "¬© 2025 NK.",
      footerLine2: "Hak Cipta Terpelihara.",

      // theme (boleh semua orang ubah untuk paparan sendiri)
      themePreset: "forest",
      darkMode: false,

      // data URLs
      csvKehadiran: CSV_KEHADIRAN,
      csvPengumuman: CSV_PENGUMUMAN,
      csvIbuBapa: CSV_IBUBAPA,
      csvTakwim: DEFAULT_CSV_TAKWIM,

      // admin-only display controls
      hiddenKehadiranColumns: [] // contoh: ["ID", "No KP"]
    };

    const defaultUI = {
      currentPage: "home",     // home | kehadiran | pengumuman | takwim | ibubapa
      sidebarOpen: false,      // mobile default tertutup
      desktopSidebarCollapsed: false
    };

    let settings = loadSettings();
    let ui = loadUI();

    function loadSettings(){
      try{
        const saved = JSON.parse(localStorage.getItem(LS_KEY) || "null");
        return { ...defaultSettings, ...(saved || {}) };
      }catch(e){
        return { ...defaultSettings };
      }
    }
    function saveSettings(){
      localStorage.setItem(LS_KEY, JSON.stringify(settings));
    }
    function loadUI(){
      try{
        const saved = JSON.parse(localStorage.getItem(LS_UI) || "null");
        return { ...defaultUI, ...(saved || {}) };
      }catch(e){
        return { ...defaultUI };
      }
    }
    function saveUI(){
      localStorage.setItem(LS_UI, JSON.stringify(ui));
    }

    function applyThemeToDocument(){
      const root = document.documentElement;
      const preset = THEME_PRESETS[settings.themePreset] || THEME_PRESETS.forest;

      if (settings.darkMode) root.classList.add("dark");
      else root.classList.remove("dark");

      root.style.setProperty("--primary", preset.primary);
      root.style.setProperty("--accent", preset.accent);
    }

    /**********************
     * CSV HELPERS
     **********************/
    function parseCSV(text){
      // CSV sederhana (cukup untuk sheet biasa). Menyokong quote.
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for (let i=0;i<text.length;i++){
        const ch = text[i];
        const next = text[i+1];

        if (ch === '"' && inQuotes && next === '"'){
          cur += '"'; i++;
        } else if (ch === '"'){
          inQuotes = !inQuotes;
        } else if (ch === "," && !inQuotes){
          row.push(cur); cur="";
        } else if ((ch === "\n" || ch === "\r") && !inQuotes){
          if (ch === "\r" && next === "\n") i++;
          row.push(cur);
          rows.push(row);
          row=[]; cur="";
        } else {
          cur += ch;
        }
      }
      if (cur.length || row.length){
        row.push(cur);
        rows.push(row);
      }

      if (!rows.length) return { headers: [], data: [] };
      const headers = rows[0].map(h => (h || "").trim());
      const data = rows.slice(1)
        .filter(r => r.some(c => (c || "").trim() !== ""))
        .map(r => {
          const obj = {};
          headers.forEach((h, idx) => obj[h] = (r[idx] ?? "").trim());
          return obj;
        });

      return { headers, data };
    }

    async function fetchCSV(url){
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("Gagal ambil CSV");
      const text = await res.text();
      return parseCSV(text);
    }

    function normalizeKey(s){
      return (s || "")
        .toString()
        .trim()
        .toLowerCase()
        .replace(/\s+/g, "_")
        .replace(/[^\w_]/g, "");
    }

    function toISODateMaybe(val){
      // terima: YYYY-MM-DD, DD/MM/YYYY, DD-MM-YYYY, dll (best effort)
      const v = (val || "").trim();
      if (!v) return "";
      if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;

      // DD/MM/YYYY or DD-MM-YYYY
      const m = v.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
      if (m){
        const dd = String(m[1]).padStart(2,"0");
        const mm = String(m[2]).padStart(2,"0");
        const yy = m[3];
        return `${yy}-${mm}-${dd}`;
      }

      // try Date parsing
      const d = new Date(v);
      if (!isNaN(d.getTime())){
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const dd = String(d.getDate()).padStart(2,"0");
        return `${yyyy}-${mm}-${dd}`;
      }
      return "";
    }

    function startOfWeekISO(date){
      // Monday as start
      const d = new Date(date);
      const day = (d.getDay() + 6) % 7; // Mon=0
      d.setDate(d.getDate() - day);
      d.setHours(0,0,0,0);
      return d;
    }

    function sameMonth(isoA, isoB){
      return isoA.slice(0,7) === isoB.slice(0,7);
    }

    /**********************
     * DATA CACHE
     **********************/
    const dataStore = {
      kehadiran: { headers: [], rows: [], loaded:false, error:"" },
      pengumuman:{ headers: [], rows: [], loaded:false, error:"" },
      ibubapa:   { headers: [], rows: [], loaded:false, error:"" },
      takwim:    { headers: [], rows: [], loaded:false, error:"" }
    };

    async function loadAllData(){
      // Load in parallel (silent fail per dataset)
      await Promise.allSettled([
        loadKehadiran(),
        loadPengumuman(),
        loadIbuBapa(),
        loadTakwim()
      ]);
    }

    async function loadKehadiran(){
      try{
        dataStore.kehadiran.loaded = false;
        dataStore.kehadiran.error = "";
        const { headers, data } = await fetchCSV(settings.csvKehadiran);
        dataStore.kehadiran.headers = headers;
        dataStore.kehadiran.rows = data;
        dataStore.kehadiran.loaded = true;
      }catch(e){
        dataStore.kehadiran.error = "Data kehadiran tidak dapat dimuat.";
        dataStore.kehadiran.loaded = true;
      }
    }
    async function loadPengumuman(){
      try{
        dataStore.pengumuman.loaded = false;
        dataStore.pengumuman.error = "";
        const { headers, data } = await fetchCSV(settings.csvPengumuman);
        dataStore.pengumuman.headers = headers;
        dataStore.pengumuman.rows = data;
        dataStore.pengumuman.loaded = true;
      }catch(e){
        dataStore.pengumuman.error = "Data pengumuman tidak dapat dimuat.";
        dataStore.pengumuman.loaded = true;
      }
    }
    async function loadIbuBapa(){
      try{
        dataStore.ibubapa.loaded = false;
        dataStore.ibubapa.error = "";
        const { headers, data } = await fetchCSV(settings.csvIbuBapa);
        dataStore.ibubapa.headers = headers;
        dataStore.ibubapa.rows = data;
        dataStore.ibubapa.loaded = true;
      }catch(e){
        dataStore.ibubapa.error = "Data Ibu Bapa tidak dapat dimuat.";
        dataStore.ibubapa.loaded = true;
      }
    }
    async function loadTakwim(){
      try{
        dataStore.takwim.loaded = false;
        dataStore.takwim.error = "";
        if (!settings.csvTakwim){
          dataStore.takwim.headers = [];
          dataStore.takwim.rows = [];
          dataStore.takwim.loaded = true;
          return;
        }
        const { headers, data } = await fetchCSV(settings.csvTakwim);
        dataStore.takwim.headers = headers;
        dataStore.takwim.rows = data;
        dataStore.takwim.loaded = true;
      }catch(e){
        dataStore.takwim.error = "Data takwim tidak dapat dimuat.";
        dataStore.takwim.loaded = true;
      }
    }

    /**********************
     * KEHADIRAN - STAT & FILTER
     **********************/
    function detectKehadiranColumns(headers){
      const n = headers.map(h => ({h, k: normalizeKey(h)}));
      const dateCol =
        n.find(x => ["tarikh","date","tanggal"].includes(x.k))?.h ||
        n.find(x => x.k.includes("tarikh"))?.h ||
        n.find(x => x.k.includes("date"))?.h ||
        headers[0];

      const statusCol =
        n.find(x => ["status","kehadiran","hadir"].includes(x.k))?.h ||
        n.find(x => x.k.includes("status"))?.h ||
        n.find(x => x.k.includes("kehadiran"))?.h ||
        null;

      const classCol =
        n.find(x => ["kelas","class"].includes(x.k))?.h ||
        n.find(x => x.k.includes("kelas"))?.h ||
        null;

      return { dateCol, statusCol, classCol };
    }

    function isHadirValue(v){
      const s = (v || "").toString().trim().toLowerCase();
      return ["hadir","h","present","ya","y"].includes(s);
    }
    function isTidakHadirValue(v){
      const s = (v || "").toString().trim().toLowerCase();
      return ["tidak hadir","x hadir","absent","tidak","x","no","n"].includes(s);
    }

    function computeKehadiranStats(){
      const { headers, rows } = dataStore.kehadiran;
      if (!headers.length || !rows.length) return null;

      const { dateCol, statusCol } = detectKehadiranColumns(headers);
      const todayIso = toISODateMaybe(new Date().toISOString().slice(0,10));
      const weekStart = startOfWeekISO(new Date());
      const weekStartIso = weekStart.toISOString().slice(0,10);

      let todayH=0, todayT=0, weekH=0, weekT=0, monthH=0, monthT=0;

      for (const r of rows){
        const dIso = toISODateMaybe(r[dateCol]);
        if (!dIso) continue;

        const st = statusCol ? r[statusCol] : "";
        const hadir = isHadirValue(st);
        const tidak = isTidakHadirValue(st);

        // if status not detected, treat non-empty as hadir? (avoid wrong)
        const hInc = hadir ? 1 : 0;
        const tInc = tidak ? 1 : 0;

        // Today
        if (dIso === todayIso){
          todayH += hInc; todayT += tInc;
        }
        // Week
        if (new Date(dIso) >= new Date(weekStartIso)){
          weekH += hInc; weekT += tInc;
        }
        // Month (current month)
        if (sameMonth(dIso, todayIso)){
          monthH += hInc; monthT += tInc;
        }
      }

      const monthTotal = monthH + monthT;
      const monthPct = monthTotal ? Math.round((monthH / monthTotal) * 1000) / 10 : 0;

      return {
        today: { hadir: todayH, tidak: todayT, total: todayH+todayT },
        week:  { hadir: weekH,  tidak: weekT,  total: weekH+weekT },
        month: { hadir: monthH, tidak: monthT, total: monthTotal, pct: monthPct }
      };
    }

    function buildMonthlyDailySeries(){
      // series untuk chart (bulan semasa): kira "Hadir" per hari
      const { headers, rows } = dataStore.kehadiran;
      if (!headers.length || !rows.length) return null;

      const { dateCol, statusCol } = detectKehadiranColumns(headers);
      const todayIso = new Date().toISOString().slice(0,10);
      const monthKey = todayIso.slice(0,7);

      const map = new Map(); // date -> {h,t}
      for (const r of rows){
        const dIso = toISODateMaybe(r[dateCol]);
        if (!dIso || dIso.slice(0,7) !== monthKey) continue;

        const st = statusCol ? r[statusCol] : "";
        if (!map.has(dIso)) map.set(dIso, {h:0,t:0});
        const obj = map.get(dIso);
        if (isHadirValue(st)) obj.h += 1;
        if (isTidakHadirValue(st)) obj.t += 1;
      }

      const dates = Array.from(map.keys()).sort();
      if (!dates.length) return { dates: [], hadir: [], tidak: [] };

      return {
        dates,
        hadir: dates.map(d => map.get(d).h),
        tidak: dates.map(d => map.get(d).t)
      };
    }

    function renderBarChartSVG(labels, values, options={}){
      const w = 760, h = 170, padX = 18, padY = 18;
      const n = Math.max(1, values.length);
      const max = Math.max(1, ...values);
      const barW = (w - padX*2) / n;

      const bars = values.map((v,i)=>{
        const bh = ((h - padY*2) * (v / max));
        const x = padX + i * barW;
        const y = (h - padY) - bh;
        const title = `${labels[i]}: ${v}`;
        return `
          <g>
            <title>${escapeHtml(title)}</title>
            <rect x="${x+1}" y="${y}" width="${Math.max(2, barW-3)}" height="${bh}"
              rx="4" ry="4" fill="currentColor" opacity="0.85"></rect>
          </g>
        `;
      }).join("");

      const caption = options.caption ? `
        <div class="text-xs text-slate-500 dark:text-slate-300 mt-1">${escapeHtml(options.caption)}</div>
      ` : "";

      return `
        <div class="text-slate-800 dark:text-slate-100">
          <svg viewBox="0 0 ${w} ${h}" class="w-full h-36">
            ${bars}
          </svg>
          ${caption}
        </div>
      `;
    }

    /**********************
     * PENGUMUMAN - FILTER AKTIF
     **********************/
    function detectPengumumanColumns(headers){
      const n = headers.map(h => ({h, k: normalizeKey(h)}));
      const mula = n.find(x => ["tarikh_mula","mula"].includes(x.k))?.h || n.find(x => x.k.includes("tarikh_mula"))?.h || "TARIKH MULA";
      const tamat= n.find(x => ["tarikh_tamat","tamat","expired"].includes(x.k))?.h || n.find(x => x.k.includes("tarikh_tamat"))?.h || "TARIKH TAMAT";
      const tajuk= n.find(x => ["tajuk","title"].includes(x.k))?.h || "TAJUK";
      const isi  = n.find(x => ["isi_kandungan","isi","kandungan","content"].includes(x.k))?.h || "ISI KANDUNGAN";
      const url  = n.find(x => ["url","pautan","link"].includes(x.k))?.h || "URL";
      const utm  = n.find(x => ["keutamaan","priority"].includes(x.k))?.h || "KEUTAMAAN";
      const aktif= n.find(x => ["aktif","active"].includes(x.k))?.h || "AKTIF";
      return { mula, tamat, tajuk, isi, url, utm, aktif };
    }

    function getPengumumanAktif(){
      const { headers, rows } = dataStore.pengumuman;
      if (!headers.length || !rows.length) return [];
      const c = detectPengumumanColumns(headers);

      const today = new Date();
      const todayIso = today.toISOString().slice(0,10);

      const out = rows
        .map(r => {
          const mulaIso = toISODateMaybe(r[c.mula]);
          const tamatIso = toISODateMaybe(r[c.tamat]);
          const tajuk = (r[c.tajuk] || "").trim();
          const isi = (r[c.isi] || "").trim();
          const url = (r[c.url] || "").trim();
          const aktif = (r[c.aktif] || "").toString().trim().toUpperCase();
          const pr = parseFloat((r[c.utm] || "0").toString().replace(",", ".")) || 0;
          return { mulaIso, tamatIso, tajuk, isi, url, aktif, pr };
        })
        .filter(x => x.tajuk)
        .filter(x => (x.aktif === "YA" || x.aktif === "Y" || x.aktif === "TRUE" || x.aktif === "1"))
        .filter(x => {
          if (!x.mulaIso) return true;
          return x.mulaIso <= todayIso;
        })
        .filter(x => {
          if (!x.tamatIso) return true;
          return x.tamatIso >= todayIso;
        })
        .sort((a,b) => (b.pr - a.pr) || (b.mulaIso.localeCompare(a.mulaIso)));

      return out;
    }

    /**********************
     * IBU BAPA - CARD
     **********************/
    function detectIbuBapaColumns(headers){
      const n = headers.map(h => ({h, k: normalizeKey(h)}));
      const tajuk = n.find(x => ["tajuk","title"].includes(x.k))?.h || "TAJUK";
      const isi   = n.find(x => ["isi_kandungan","isi","kandungan","content"].includes(x.k))?.h || "ISI KANDUNGAN";
      const url   = n.find(x => ["url","pautan","link"].includes(x.k))?.h || "URL";
      const mode  = n.find(x => ["mode","jenis","buka"].includes(x.k))?.h || ""; // optional: "POPUP" / "TAB"
      return { tajuk, isi, url, mode };
    }

    /**********************
     * UI RENDER
     **********************/
    function escapeHtml(s){
      return (s ?? "")
        .toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function pageTitle(){
      switch(ui.currentPage){
        case "home": return "Laman Utama";
        case "kehadiran": return "Kehadiran";
        case "pengumuman": return "Pengumuman";
        case "takwim": return "Takwim";
        case "ibubapa": return "Ibu Bapa";
        default: return "Portal";
      }
    }

    function setPage(p){
      ui.currentPage = p;
      // mobile: auto close sidebar after click
      ui.sidebarOpen = false;
      saveUI();
      render();
    }

    function toggleMobileSidebar(){
      ui.sidebarOpen = !ui.sidebarOpen;
      saveUI();
      render();
    }
    function toggleDesktopSidebar(){
      ui.desktopSidebarCollapsed = !ui.desktopSidebarCollapsed;
      saveUI();
      render();
    }

    function setThemePreset(preset){
      settings.themePreset = preset;
      saveSettings();
      applyThemeToDocument();
      render();
    }
    function toggleDarkMode(){
      settings.darkMode = !settings.darkMode;
      saveSettings();
      applyThemeToDocument();
      render();
    }

    // Modal controls
    let modal = { open:false, type:"", payload:null };
    function openModal(type, payload=null){
      modal.open = true; modal.type = type; modal.payload = payload;
      render();
    }
    function closeModal(){
      modal.open = false; modal.type = ""; modal.payload = null;
      render();
    }

    /**********************
     * SETTINGS (PIN-GUARDED SAVE)
     **********************/
    function openSettings(){
      openModal("settings");
      setTimeout(() => {
        // init values
        const $ = (id) => document.getElementById(id);
        if (!$("setSchoolName")) return;

        $("setSchoolName").value = settings.schoolName || "";
        $("setSchoolMotto").value = settings.schoolMotto || "";
        $("setFooter1").value = settings.footerLine1 || "";
        $("setFooter2").value = settings.footerLine2 || "";
        $("setThemePreset").value = settings.themePreset || "forest";

        $("setCsvKehadiran").value = settings.csvKehadiran || "";
        $("setCsvPengumuman").value = settings.csvPengumuman || "";
        $("setCsvIbuBapa").value = settings.csvIbuBapa || "";
        $("setCsvTakwim").value = settings.csvTakwim || "";

        // columns (depends on loaded)
        renderHiddenColsSelector();

        // logo preview
        const preview = $("logoPreview");
        if (preview){
          if (settings.logoDataUrl){
            preview.src = settings.logoDataUrl;
            preview.classList.remove("hidden");
          } else {
            preview.classList.add("hidden");
          }
        }
      }, 30);
    }

    function renderHiddenColsSelector(){
      const wrap = document.getElementById("hiddenColsWrap");
      if (!wrap) return;

      const { headers } = dataStore.kehadiran;
      if (!headers.length){
        wrap.innerHTML = `<div class="text-sm text-slate-500 dark:text-slate-300">Kolum kehadiran akan muncul selepas data dimuat.</div>`;
        return;
      }
      wrap.innerHTML = headers.map(h => {
        const checked = settings.hiddenKehadiranColumns.includes(h) ? "checked" : "";
        return `
          <label class="flex items-center gap-2 px-3 py-2 rounded-xl bg-slate-100 dark:bg-white/10">
            <input type="checkbox" class="h-4 w-4" data-hidden-col="${escapeHtml(h)}" ${checked}>
            <span class="text-sm">${escapeHtml(h)}</span>
          </label>
        `;
      }).join("");
    }

    function handleLogoUpload(file){
      const reader = new FileReader();
      reader.onload = () => {
        const dataUrl = reader.result;
        const img = document.getElementById("logoPreview");
        if (img){
          img.src = dataUrl;
          img.classList.remove("hidden");
        }
        // store temp in dataset
        document.getElementById("setLogoDataUrl").value = dataUrl;
      };
      reader.readAsDataURL(file);
    }

    function saveSettingsWithPin(){
      const pin = (document.getElementById("pinInput")?.value || "").trim();
      if (pin !== SETTINGS_PIN){
        const el = document.getElementById("pinError");
        if (el) el.textContent = "PIN tidak tepat.";
        return;
      }
      const el = document.getElementById("pinError");
      if (el) el.textContent = "";

      // commit form
      settings.schoolName = (document.getElementById("setSchoolName").value || "").trim() || defaultSettings.schoolName;
      settings.schoolMotto = (document.getElementById("setSchoolMotto").value || "").trim();
      settings.footerLine1 = (document.getElementById("setFooter1").value || "").trim();
      settings.footerLine2 = (document.getElementById("setFooter2").value || "").trim();

      settings.themePreset = document.getElementById("setThemePreset").value || "forest";

      settings.csvKehadiran = (document.getElementById("setCsvKehadiran").value || "").trim();
      settings.csvPengumuman = (document.getElementById("setCsvPengumuman").value || "").trim();
      settings.csvIbuBapa = (document.getElementById("setCsvIbuBapa").value || "").trim();
      settings.csvTakwim = (document.getElementById("setCsvTakwim").value || "").trim();

      const logoData = document.getElementById("setLogoDataUrl").value || "";
      if (logoData) settings.logoDataUrl = logoData;

      // hidden columns
      const checks = document.querySelectorAll("[data-hidden-col]");
      const hidden = [];
      checks.forEach(ch => {
        if (ch.checked) hidden.push(ch.getAttribute("data-hidden-col"));
      });
      settings.hiddenKehadiranColumns = hidden;

      saveSettings();
      applyThemeToDocument();

      // reload data using possibly new urls
      refreshData(true);
      closeModal();
    }

    async function refreshData(force=false){
      // show a subtle toast via re-render
      openModal("loading", { text: "Mengemas kini data..." });
      try{
        await loadAllData();
      }catch(e){}
      closeModal();
      render();
    }

    /**********************
     * PAGE RENDERS
     **********************/
    function renderHome(){
      const stats = computeKehadiranStats();
      const ann = getPengumumanAktif();
      const series = buildMonthlyDailySeries();

      const now = new Date();
      const timeStr = now.toLocaleString("ms-MY", {
        weekday: "long", year: "numeric", month:"long", day:"numeric",
        hour: "2-digit", minute:"2-digit"
      });

      // chart (Hadir per hari bulan semasa)
      let chartHtml = "";
      if (series && series.dates.length){
        const labels = series.dates.map(d => d.slice(8,10)); // day
        chartHtml = renderBarChartSVG(labels, series.hadir, {
          caption: "Hadir (hari) ‚Äî Bulan semasa"
        });
      } else {
        chartHtml = `<div class="text-sm text-slate-500 dark:text-slate-300">Tiada data chart untuk bulan semasa.</div>`;
      }

      const cardStats = stats ? `
        <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
          ${statCard("Kehadiran Hari Ini", stats.today.hadir, stats.today.total, "kehadiran", { scope:"today" })}
          ${statCard("Kehadiran Minggu Ini", stats.week.hadir, stats.week.total, "kehadiran", { scope:"week" })}
          ${statCard("Kehadiran Bulan Ini", stats.month.hadir, stats.month.total, "kehadiran", { scope:"month" })}
          ${pctCard("Peratus Kehadiran Bulanan", stats.month.pct, "kehadiran", { scope:"month" })}
        </div>
      ` : `
        <div class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-slate-900 p-5">
          <div class="text-sm text-slate-500 dark:text-slate-300">Statistik kehadiran akan dipaparkan selepas data dimuat.</div>
        </div>
      `;

      const annCard = `
        <div class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-slate-900 p-5">
          <div class="flex items-center justify-between gap-3">
            <div class="font-extrabold text-slate-900 dark:text-white">üì¢ Pengumuman</div>
            <button class="text-sm font-semibold text-accent hover:underline" onclick="setPage('pengumuman')">Lihat semua</button>
          </div>

          <div class="mt-3">
            ${
              dataStore.pengumuman.error ? `<div class="text-sm text-rose-500">${escapeHtml(dataStore.pengumuman.error)}</div>` :
              (ann.length ? `
                <div class="space-y-2">
                  ${ann.slice(0,6).map((x, idx) => `
                    <button class="w-full text-left px-3 py-2 rounded-xl bg-slate-50 dark:bg-white/5 hover:bg-slate-100 dark:hover:bg-white/10 transition"
                      onclick="openModal('pengumumanDetail', ${idx})">
                      <div class="flex items-start justify-between gap-3">
                        <div class="font-bold">${escapeHtml((idx+1)+'. '+x.tajuk)}</div>
                        <div class="text-xs text-slate-500 dark:text-slate-300">${escapeHtml(x.mulaIso || "")}</div>
                      </div>
                      <div class="text-sm text-slate-600 dark:text-slate-300 line-clamp-2">${escapeHtml(x.isi || "")}</div>
                    </button>
                  `).join("")}
                </div>
              ` : `<div class="text-sm text-slate-500 dark:text-slate-300">Tiada pengumuman aktif.</div>`)
            }
          </div>
        </div>
      `;

      return `
        <div class="space-y-5">
          <!-- Banner -->
          <div class="rounded-2xl bg-gradient-to-r from-[var(--primary)] to-[var(--accent)] p-6 text-white shadow-sm">
            <div class="text-sm font-semibold opacity-95">Selamat Datang ke Portal Rasmi PPKI SK Paya Resak</div>
            <div class="mt-1 text-2xl font-extrabold">${escapeHtml(settings.schoolName)}</div>
            <div class="mt-3 inline-flex items-center gap-2 rounded-xl bg-white/15 px-4 py-2">
              <span class="text-sm font-semibold">${escapeHtml(timeStr)}</span>
            </div>
          </div>

          ${cardStats}

          <div class="grid grid-cols-1 xl:grid-cols-3 gap-5">
            <div class="xl:col-span-2 rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-slate-900 p-5">
              <div class="flex items-center justify-between">
                <div class="font-extrabold">Trend Kehadiran</div>
                <button class="text-sm font-semibold text-accent hover:underline" onclick="setPage('kehadiran')">Buka Dashboard Kehadiran</button>
              </div>
              <div class="mt-4">
                ${chartHtml}
              </div>
            </div>
            ${annCard}
          </div>
        </div>
      `;
    }

    function statCard(title, value, total, gotoPage, navExtra){
      const sub = total ? `${value} / ${total}` : `${value}`;
      const hint = total ? `${Math.round((value/Math.max(1,total))*100)}%` : "";
      return `
        <button class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-slate-900 p-5 text-left hover:shadow-sm transition"
          onclick="setPage('${gotoPage}')">
          <div class="text-sm font-bold text-slate-600 dark:text-slate-300">${escapeHtml(title)}</div>
          <div class="mt-2 text-3xl font-extrabold text-slate-900 dark:text-white">${escapeHtml(String(value))}</div>
          <div class="mt-1 text-sm text-slate-500 dark:text-slate-300">${escapeHtml(sub)} ${hint ? "‚Ä¢ "+escapeHtml(hint) : ""}</div>
        </button>
      `;
    }
    function pctCard(title, pct, gotoPage){
      return `
        <button class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-slate-900 p-5 text-left hover:shadow-sm transition"
          onclick="setPage('${gotoPage}')">
          <div class="text-sm font-bold text-slate-600 dark:text-slate-300">${escapeHtml(title)}</div>
          <div class="mt-2 text-3xl font-extrabold text-slate-900 dark:text-white">${escapeHtml(String(pct))}%</div>
          <div class="mt-1 text-sm text-slate-500 dark:text-slate-300">Bulan semasa</div>
        </button>
      `;
    }

    // Kehadiran page
    function renderKehadiran(){
      const { headers, rows, error } = dataStore.kehadiran;

      // build filters UI (dynamic per column)
      if (error){
        return `
          <div class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-slate-900 p-6">
            <div class="text-rose-500 font-semibold">${escapeHtml(error)}</div>
          </div>
        `;
      }

      if (!headers.length){
        return `
          <div class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-slate-900 p-6">
            <div class="text-sm text-slate-500 dark:text-slate-300">Tiada data untuk dipaparkan.</div>
          </div>
        `;
      }

      const stats = computeKehadiranStats();
      const { dateCol } = detectKehadiranColumns(headers);

      // Build hide columns (admin saved)
      const visibleHeaders = headers.filter(h => !settings.hiddenKehadiranColumns.includes(h));

      return `
        <div class="space-y-5">
          <div class="flex items-start justify-between gap-3 flex-wrap">
            <div>
              <div class="text-2xl font-extrabold">Dashboard Kehadiran</div>
              <div class="text-sm text-slate-500 dark:text-slate-300">Data daripada CSV</div>
            </div>
            <button class="px-4 py-2 rounded-xl bg-slate-100 dark:bg-white/10 hover:bg-slate-200 dark:hover:bg-white/15 transition font-semibold text-sm"
              onclick="refreshData(true)">
              Segar Semula
            </button>
          </div>

          ${
            stats ? `
              <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
                ${statCard("Kehadiran Hari Ini", stats.today.hadir, stats.today.total, "kehadiran")}
                ${statCard("Kehadiran Minggu Ini", stats.week.hadir, stats.week.total, "kehadiran")}
                ${statCard("Kehadiran Bulan Ini", stats.month.hadir, stats.month.total, "kehadiran")}
                ${pctCard("Peratus Kehadiran Bulanan", stats.month.pct, "kehadiran")}
              </div>
            ` : ``
          }

          <!-- Filter Panel -->
          <div class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-slate-900 p-5">
            <div class="font-extrabold">Penapisan</div>

            <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-4">
              <div class="lg:col-span-1">
                <label class="text-xs font-bold text-slate-600 dark:text-slate-300">Carian</label>
                <input id="kSearch" class="mt-1 w-full px-4 py-3 rounded-xl bg-slate-100 dark:bg-white/10 dark:text-white ring-1 ring-slate-200 dark:ring-white/10"
                  placeholder="Cari nama / kelas / apa-apa..."
                  oninput="applyKehadiranFilters()"
                />
              </div>

              <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="text-xs font-bold text-slate-600 dark:text-slate-300">Tarikh (Dari)</label>
                  <input id="kDateFrom" type="date" class="mt-1 w-full px-4 py-3 rounded-xl bg-slate-100 dark:bg-white/10 dark:text-white ring-1 ring-slate-200 dark:ring-white/10"
                    onchange="applyKehadiranFilters()"
                  />
                </div>
                <div>
                  <label class="text-xs font-bold text-slate-600 dark:text-slate-300">Tarikh (Hingga)</label>
                  <input id="kDateTo" type="date" class="mt-1 w-full px-4 py-3 rounded-xl bg-slate-100 dark:bg-white/10 dark:text-white ring-1 ring-slate-200 dark:ring-white/10"
                    onchange="applyKehadiranFilters()"
                  />
                </div>
              </div>
            </div>

            <div class="mt-4">
              <div class="text-xs font-bold text-slate-600 dark:text-slate-300 mb-2">Filter kolum (pilih nilai)</div>
              <div id="kColumnFilters" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-3"></div>
            </div>

            <div class="mt-4 flex items-center justify-between gap-3 flex-wrap">
              <div class="text-sm text-slate-500 dark:text-slate-300">
                Kolum tarikh dikesan: <span class="font-semibold">${escapeHtml(dateCol)}</span>
              </div>
              <button class="text-sm font-semibold text-accent hover:underline" onclick="resetKehadiranFilters()">Reset filter</button>
            </div>
          </div>

          <!-- Table -->
          <div class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-slate-900 overflow-hidden">
            <div class="px-5 py-4 border-b border-slate-200 dark:border-white/10 flex items-center justify-between gap-3">
              <div class="font-extrabold">Rekod Kehadiran</div>
              <div class="text-sm text-slate-500 dark:text-slate-300"><span id="kRowCount">0</span> rekod</div>
            </div>
            <div class="overflow-auto">
              <table class="min-w-full text-sm">
                <thead class="bg-slate-50 dark:bg-white/5 sticky top-0">
                  <tr>
                    ${visibleHeaders.map(h => `<th class="text-left px-4 py-3 font-extrabold text-slate-700 dark:text-slate-100 whitespace-nowrap">${escapeHtml(h)}</th>`).join("")}
                  </tr>
                </thead>
                <tbody id="kTableBody">
                  <!-- rows injected -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    function initKehadiranFilters(){
      const { headers, rows } = dataStore.kehadiran;
      if (!headers.length) return;

      const visibleHeaders = headers.filter(h => !settings.hiddenKehadiranColumns.includes(h));
      const wrap = document.getElementById("kColumnFilters");
      if (!wrap) return;

      // build dropdown filters for up to 6 columns (excluding tarikh if too big)
      const { dateCol } = detectKehadiranColumns(headers);
      const candidate = visibleHeaders.filter(h => h !== dateCol).slice(0, 6);

      wrap.innerHTML = candidate.map(h => {
        const values = Array.from(new Set(rows.map(r => (r[h] || "").trim()).filter(Boolean))).slice(0, 200);
        return `
          <div class="rounded-2xl bg-slate-100 dark:bg-white/10 p-3">
            <div class="text-xs font-extrabold text-slate-600 dark:text-slate-200">${escapeHtml(h)}</div>
            <select class="mt-2 w-full px-3 py-2 rounded-xl bg-white dark:bg-slate-900 ring-1 ring-slate-200 dark:ring-white/10"
              data-kfilter-col="${escapeHtml(h)}"
              onchange="applyKehadiranFilters()">
              <option value="">Semua</option>
              ${values.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("")}
            </select>
          </div>
        `;
      }).join("");

      applyKehadiranFilters();
    }

    function applyKehadiranFilters(){
      const { headers, rows } = dataStore.kehadiran;
      if (!headers.length) return;

      const visibleHeaders = headers.filter(h => !settings.hiddenKehadiranColumns.includes(h));
      const { dateCol } = detectKehadiranColumns(headers);

      const search = (document.getElementById("kSearch")?.value || "").trim().toLowerCase();
      const from = document.getElementById("kDateFrom")?.value || "";
      const to = document.getElementById("kDateTo")?.value || "";

      // column filters
      const selects = document.querySelectorAll("[data-kfilter-col]");
      const colFilters = [];
      selects.forEach(s => {
        const col = s.getAttribute("data-kfilter-col");
        const val = (s.value || "").trim();
        if (col && val) colFilters.push({ col, val });
      });

      const filtered = rows.filter(r => {
        // date range
        const dIso = toISODateMaybe(r[dateCol]);
        if (from && dIso && dIso < from) return false;
        if (to && dIso && dIso > to) return false;

        // dropdown filters
        for (const f of colFilters){
          if (((r[f.col] || "").trim()) !== f.val) return false;
        }

        // search across visible columns
        if (search){
          let ok = false;
          for (const h of visibleHeaders){
            const v = (r[h] || "").toString().toLowerCase();
            if (v.includes(search)) { ok = true; break; }
          }
          if (!ok) return false;
        }
        return true;
      });

      const tbody = document.getElementById("kTableBody");
      const rc = document.getElementById("kRowCount");
      if (rc) rc.textContent = String(filtered.length);

      if (!tbody) return;
      tbody.innerHTML = filtered.slice(0, 2000).map(r => `
        <tr class="border-t border-slate-100 dark:border-white/5 hover:bg-slate-50 dark:hover:bg-white/5">
          ${visibleHeaders.map(h => `<td class="px-4 py-3 whitespace-nowrap">${escapeHtml(r[h] || "")}</td>`).join("")}
        </tr>
      `).join("");
    }

    function resetKehadiranFilters(){
      const ids = ["kSearch","kDateFrom","kDateTo"];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = "";
      });
      const selects = document.querySelectorAll("[data-kfilter-col]");
      selects.forEach(s => s.value = "");
      applyKehadiranFilters();
    }

    // Pengumuman page
    function renderPengumuman(){
      const err = dataStore.pengumuman.error;
      const list = getPengumumanAktif();

      return `
        <div class="space-y-5">
          <div class="flex items-start justify-between gap-3 flex-wrap">
            <div>
              <div class="text-2xl font-extrabold">Pengumuman</div>
              <div class="text-sm text-slate-500 dark:text-slate-300">Senarai pengumuman aktif</div>
            </div>
            <button class="px-4 py-2 rounded-xl bg-slate-100 dark:bg-white/10 hover:bg-slate-200 dark:hover:bg-white/15 transition font-semibold text-sm"
              onclick="refreshData(true)">
              Segar Semula
            </button>
          </div>

          ${
            err ? `<div class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-slate-900 p-6 text-rose-500 font-semibold">${escapeHtml(err)}</div>` : ""
          }

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            ${
              list.length ? list.map((x, idx) => `
                <button class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-slate-900 p-5 text-left hover:shadow-sm transition"
                  onclick="openModal('pengumumanDetail', ${idx})">
                  <div class="flex items-start justify-between gap-3">
                    <div class="font-extrabold text-lg">${escapeHtml(x.tajuk)}</div>
                    <div class="text-xs text-slate-500 dark:text-slate-300 whitespace-nowrap">${escapeHtml(x.mulaIso || "")}</div>
                  </div>
                  <div class="mt-2 text-sm text-slate-600 dark:text-slate-300 line-clamp-3">${escapeHtml(x.isi || "")}</div>
                  ${x.url ? `<div class="mt-3 text-sm font-semibold text-accent">Pautan tersedia</div>` : ``}
                </button>
              `).join("") : `
                <div class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-slate-900 p-6">
                  <div class="text-sm text-slate-500 dark:text-slate-300">Tiada pengumuman aktif.</div>
                </div>
              `
            }
          </div>
        </div>
      `;
    }

    // Takwim page
    function renderTakwim(){
      const err = dataStore.takwim.error;
      const { headers, rows } = dataStore.takwim;

      if (err){
        return `<div class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-slate-900 p-6 text-rose-500 font-semibold">${escapeHtml(err)}</div>`;
      }
      if (!settings.csvTakwim){
        return `
          <div class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-slate-900 p-6">
            <div class="text-2xl font-extrabold">Takwim</div>
            <div class="mt-2 text-sm text-slate-500 dark:text-slate-300">URL CSV takwim belum ditetapkan.</div>
            <div class="mt-4">
              <button class="px-4 py-2 rounded-xl bg-slate-100 dark:bg-white/10 hover:bg-slate-200 dark:hover:bg-white/15 transition font-semibold text-sm"
                onclick="openSettings()">
                Tetapkan dalam Settings
              </button>
            </div>
          </div>
        `;
      }

      // best-effort columns
      const n = headers.map(h => ({h, k: normalizeKey(h)}));
      const colDate = n.find(x => ["tarikh","date"].includes(x.k) || x.k.includes("tarikh"))?.h || headers[0];
      const colTitle= n.find(x => ["tajuk","title","program","aktiviti"].includes(x.k))?.h || headers[1] || headers[0];
      const colTime = n.find(x => ["masa","time"].includes(x.k) || x.k.includes("masa"))?.h || "";
      const colLoc  = n.find(x => ["tempat","lokasi","location"].includes(x.k) || x.k.includes("tempat"))?.h || "";

      const items = rows
        .map(r => ({
          date: toISODateMaybe(r[colDate]),
          title: (r[colTitle]||"").trim(),
          time: colTime ? (r[colTime]||"").trim() : "",
          loc:  colLoc ? (r[colLoc]||"").trim() : ""
        }))
        .filter(x => x.title)
        .sort((a,b) => (a.date||"").localeCompare(b.date||""));

      return `
        <div class="space-y-5">
          <div class="flex items-start justify-between gap-3 flex-wrap">
            <div>
              <div class="text-2xl font-extrabold">Takwim</div>
              <div class="text-sm text-slate-500 dark:text-slate-300">Senarai aktiviti</div>
            </div>
            <button class="px-4 py-2 rounded-xl bg-slate-100 dark:bg-white/10 hover:bg-slate-200 dark:hover:bg-white/15 transition font-semibold text-sm"
              onclick="refreshData(true)">
              Segar Semula
            </button>
          </div>

          <div class="space-y-3">
            ${
              items.length ? items.map(x => `
                <div class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-slate-900 p-5">
                  <div class="flex items-start justify-between gap-3">
                    <div class="font-extrabold">${escapeHtml(x.title)}</div>
                    <div class="text-xs text-slate-500 dark:text-slate-300 whitespace-nowrap">${escapeHtml(x.date || "")}</div>
                  </div>
                  <div class="mt-2 text-sm text-slate-600 dark:text-slate-300">
                    ${x.time ? `üïí ${escapeHtml(x.time)}` : ``}
                    ${x.time && x.loc ? `<span class="mx-2">‚Ä¢</span>` : ``}
                    ${x.loc ? `üìç ${escapeHtml(x.loc)}` : ``}
                  </div>
                </div>
              `).join("") : `
                <div class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-slate-900 p-6">
                  <div class="text-sm text-slate-500 dark:text-slate-300">Tiada rekod takwim.</div>
                </div>
              `
            }
          </div>
        </div>
      `;
    }

    // Ibu Bapa page
    function renderIbuBapa(){
      const err = dataStore.ibubapa.error;
      const { headers, rows } = dataStore.ibubapa;

      if (err){
        return `<div class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-slate-900 p-6 text-rose-500 font-semibold">${escapeHtml(err)}</div>`;
      }
      if (!headers.length){
        return `
          <div class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-slate-900 p-6">
            <div class="text-sm text-slate-500 dark:text-slate-300">Tiada data.</div>
          </div>
        `;
      }

      const c = detectIbuBapaColumns(headers);
      const items = rows
        .map(r => ({
          tajuk: (r[c.tajuk]||"").trim(),
          isi: (r[c.isi]||"").trim(),
          url: (r[c.url]||"").trim(),
          mode: c.mode ? (r[c.mode]||"").trim().toUpperCase() : ""
        }))
        .filter(x => x.tajuk);

      return `
        <div class="space-y-5">
          <div class="flex items-start justify-between gap-3 flex-wrap">
            <div>
              <div class="text-2xl font-extrabold">Ibu Bapa</div>
              <div class="text-sm text-slate-500 dark:text-slate-300">Makluman & pautan penting</div>
            </div>
            <button class="px-4 py-2 rounded-xl bg-slate-100 dark:bg-white/10 hover:bg-slate-200 dark:hover:bg-white/15 transition font-semibold text-sm"
              onclick="refreshData(true)">
              Segar Semula
            </button>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            ${items.map(x => {
              const go = x.url ? (x.mode === "TAB" ? `window.open('${escapeHtml(x.url)}','_blank')` : `openModal('ibubapaDetail', ${JSON.stringify(x).replaceAll('"','&quot;')})`) : `openModal('ibubapaDetail', ${JSON.stringify(x).replaceAll('"','&quot;')})`;
              return `
                <button class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-slate-900 p-5 text-left hover:shadow-sm transition"
                  onclick="${go}">
                  <div class="font-extrabold text-lg">${escapeHtml(x.tajuk)}</div>
                  <div class="mt-2 text-sm text-slate-600 dark:text-slate-300 line-clamp-3">${escapeHtml(x.isi)}</div>
                  ${x.url ? `<div class="mt-3 text-sm font-semibold text-accent">Buka pautan</div>` : ``}
                </button>
              `;
            }).join("")}
          </div>
        </div>
      `;
    }

    /**********************
     * MODAL RENDER
     **********************/
    function renderModal(){
      if (!modal.open) return "";
      const base = `
        <div class="fixed inset-0 z-50">
          <div class="absolute inset-0 bg-black/40" onclick="closeModal()"></div>
          <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="w-full max-w-2xl rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-white/10 shadow-lg overflow-hidden">
              ${renderModalInner()}
            </div>
          </div>
        </div>
      `;
      return base;
    }

    function renderModalInner(){
      if (modal.type === "loading"){
        return `
          <div class="p-6">
            <div class="text-lg font-extrabold">${escapeHtml(modal.payload?.text || "Memuat...")}</div>
            <div class="mt-3 text-sm text-slate-500 dark:text-slate-300">Sila tunggu sebentar.</div>
          </div>
        `;
      }

      if (modal.type === "pengumumanDetail"){
        const list = getPengumumanAktif();
        const x = list[modal.payload] || null;
        if (!x) return `<div class="p-6"><div class="font-extrabold">Tiada data.</div></div>`;

        return `
          <div class="px-6 py-4 border-b border-slate-200 dark:border-white/10 flex items-center justify-between">
            <div class="font-extrabold text-lg">üì¢ ${escapeHtml(x.tajuk)}</div>
            <button class="px-3 py-2 rounded-xl bg-slate-100 dark:bg-white/10 hover:bg-slate-200 dark:hover:bg-white/15 transition text-sm font-semibold" onclick="closeModal()">Tutup</button>
          </div>
          <div class="p-6 space-y-4">
            <div class="text-sm text-slate-500 dark:text-slate-300">${escapeHtml(x.mulaIso || "")}</div>
            <div class="whitespace-pre-wrap text-slate-800 dark:text-slate-100">${escapeHtml(x.isi || "")}</div>
            ${x.url ? `
              <div>
                <a class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-accent text-white font-semibold"
                  href="${escapeHtml(x.url)}" target="_blank" rel="noopener">
                  Buka Pautan
                </a>
              </div>
            ` : ``}
          </div>
        `;
      }

      if (modal.type === "ibubapaDetail"){
        const x = modal.payload || {};
        return `
          <div class="px-6 py-4 border-b border-slate-200 dark:border-white/10 flex items-center justify-between">
            <div class="font-extrabold text-lg">${escapeHtml(x.tajuk || "Makluman")}</div>
            <button class="px-3 py-2 rounded-xl bg-slate-100 dark:bg-white/10 hover:bg-slate-200 dark:hover:bg-white/15 transition text-sm font-semibold" onclick="closeModal()">Tutup</button>
          </div>
          <div class="p-6 space-y-4">
            <div class="whitespace-pre-wrap text-slate-800 dark:text-slate-100">${escapeHtml(x.isi || "")}</div>
            ${x.url ? `
              <div>
                <a class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-accent text-white font-semibold"
                  href="${escapeHtml(x.url)}" target="_blank" rel="noopener">
                  Buka Pautan
                </a>
              </div>
            ` : ``}
          </div>
        `;
      }

      if (modal.type === "settings"){
        return `
          <div class="px-6 py-4 border-b border-slate-200 dark:border-white/10 flex items-center justify-between">
            <div class="font-extrabold text-lg">Tetapan Portal</div>
            <button class="px-3 py-2 rounded-xl bg-slate-100 dark:bg-white/10 hover:bg-slate-200 dark:hover:bg-white/15 transition text-sm font-semibold" onclick="closeModal()">Tutup</button>
          </div>

          <div class="p-6 space-y-5">
            <div class="rounded-2xl bg-slate-50 dark:bg-white/5 p-4">
              <div class="text-sm font-extrabold">Kemas kini tetapan memerlukan PIN</div>
              <div class="mt-2 flex items-center gap-3">
                <input id="pinInput" type="password" inputmode="numeric" placeholder="Masukkan PIN"
                  class="w-48 px-4 py-3 rounded-xl bg-white dark:bg-slate-900 ring-1 ring-slate-200 dark:ring-white/10" />
                <div id="pinError" class="text-sm text-rose-500 font-semibold"></div>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <div>
                <label class="text-xs font-bold text-slate-600 dark:text-slate-300">Nama Sekolah</label>
                <input id="setSchoolName" class="mt-1 w-full px-4 py-3 rounded-xl bg-slate-100 dark:bg-white/10 dark:text-white ring-1 ring-slate-200 dark:ring-white/10" />
              </div>
              <div>
                <label class="text-xs font-bold text-slate-600 dark:text-slate-300">Moto</label>
                <input id="setSchoolMotto" class="mt-1 w-full px-4 py-3 rounded-xl bg-slate-100 dark:bg-white/10 dark:text-white ring-1 ring-slate-200 dark:ring-white/10" />
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <div>
                <label class="text-xs font-bold text-slate-600 dark:text-slate-300">Footer (Baris 1)</label>
                <input id="setFooter1" class="mt-1 w-full px-4 py-3 rounded-xl bg-slate-100 dark:bg-white/10 dark:text-white ring-1 ring-slate-200 dark:ring-white/10" />
              </div>
              <div>
                <label class="text-xs font-bold text-slate-600 dark:text-slate-300">Footer (Baris 2)</label>
                <input id="setFooter2" class="mt-1 w-full px-4 py-3 rounded-xl bg-slate-100 dark:bg-white/10 dark:text-white ring-1 ring-slate-200 dark:ring-white/10" />
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <div>
                <label class="text-xs font-bold text-slate-600 dark:text-slate-300">Tema Preset</label>
                <select id="setThemePreset" class="mt-1 w-full px-4 py-3 rounded-xl bg-slate-100 dark:bg-white/10 dark:text-white ring-1 ring-slate-200 dark:ring-white/10">
                  <option value="forest">Forest (Hijau)</option>
                  <option value="ocean">Ocean (Biru/Teal)</option>
                  <option value="purple">Purple</option>
                  <option value="slate">Slate (Gelap)</option>
                </select>
                <div class="mt-2 text-xs text-slate-500 dark:text-slate-300">Tema ini untuk paparan peranti semasa.</div>
              </div>

              <div>
                <label class="text-xs font-bold text-slate-600 dark:text-slate-300">Logo Sekolah</label>
                <input type="hidden" id="setLogoDataUrl" value="" />
                <div class="mt-1 flex items-center gap-3">
                  <input id="setLogoFile" type="file" accept="image/*"
                    class="block w-full text-sm text-slate-500 file:mr-3 file:rounded-xl file:border-0 file:bg-slate-100 file:px-4 file:py-2 file:font-semibold hover:file:bg-slate-200 dark:file:bg-white/10 dark:text-slate-300 dark:hover:file:bg-white/15"
                    onchange="handleLogoUpload(this.files[0])" />
                  <img id="logoPreview" class="hidden h-12 w-12 rounded-xl object-cover border border-slate-200 dark:border-white/10" />
                </div>
              </div>
            </div>

            <div class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-slate-900 p-4">
              <div class="font-extrabold">URL CSV</div>
              <div class="mt-3 grid grid-cols-1 gap-3">
                <div>
                  <label class="text-xs font-bold text-slate-600 dark:text-slate-300">Kehadiran</label>
                  <input id="setCsvKehadiran" class="mt-1 w-full px-4 py-3 rounded-xl bg-slate-100 dark:bg-white/10 dark:text-white ring-1 ring-slate-200 dark:ring-white/10" />
                </div>
                <div>
                  <label class="text-xs font-bold text-slate-600 dark:text-slate-300">Pengumuman</label>
                  <input id="setCsvPengumuman" class="mt-1 w-full px-4 py-3 rounded-xl bg-slate-100 dark:bg-white/10 dark:text-white ring-1 ring-slate-200 dark:ring-white/10" />
                </div>
                <div>
                  <label class="text-xs font-bold text-slate-600 dark:text-slate-300">Ibu Bapa</label>
                  <input id="setCsvIbuBapa" class="mt-1 w-full px-4 py-3 rounded-xl bg-slate-100 dark:bg-white/10 dark:text-white ring-1 ring-slate-200 dark:ring-white/10" />
                </div>
                <div>
                  <label class="text-xs font-bold text-slate-600 dark:text-slate-300">Takwim</label>
                  <input id="setCsvTakwim" class="mt-1 w-full px-4 py-3 rounded-xl bg-slate-100 dark:bg-white/10 dark:text-white ring-1 ring-slate-200 dark:ring-white/10" placeholder="(optional)" />
                </div>
              </div>
            </div>

            <div class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white dark:bg-slate-900 p-4">
              <div class="font-extrabold">Kehadiran: Sembunyikan Kolum</div>
              <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2" id="hiddenColsWrap"></div>
            </div>

            <div class="flex items-center justify-end gap-3 pt-2">
              <button class="px-4 py-2 rounded-xl bg-slate-100 dark:bg-white/10 hover:bg-slate-200 dark:hover:bg-white/15 transition font-semibold"
                onclick="closeModal()">
                Batal
              </button>
              <button class="px-5 py-2 rounded-xl bg-primary text-white hover:opacity-95 transition font-extrabold"
                onclick="saveSettingsWithPin()">
                Simpan
              </button>
            </div>
          </div>
        `;
      }

      return `<div class="p-6"><div class="font-extrabold">Modal</div></div>`;
    }

    /**********************
     * MAIN APP RENDER
     **********************/
    function render(){
      applyThemeToDocument();

      const app = document.getElementById("app");
      const sidebarCollapsed = ui.desktopSidebarCollapsed;

      const menu = [
        { id:"home", label:"Laman Utama", icon:"üè†" },
        { id:"kehadiran", label:"Kehadiran", icon:"üßæ" },
        { id:"pengumuman", label:"Pengumuman", icon:"üì¢" },
        { id:"takwim", label:"Takwim", icon:"üóìÔ∏è" },
        { id:"ibubapa", label:"Ibu Bapa", icon:"üë®‚Äçüë©‚Äçüëß‚Äçüë¶" }
      ];

      const active = ui.currentPage;

      const sidebarWidth = sidebarCollapsed ? "w-20" : "w-72";

      app.innerHTML = `
        <div class="h-full flex">
          <!-- Mobile overlay -->
          <div class="${ui.sidebarOpen ? "" : "hidden"} fixed inset-0 z-40 bg-black/40 lg:hidden" onclick="toggleMobileSidebar()"></div>

          <!-- Sidebar -->
          <aside class="
            fixed lg:static z-50 lg:z-auto inset-y-0 left-0
            ${ui.sidebarOpen ? "translate-x-0" : "-translate-x-full"}
            lg:translate-x-0
            ${sidebarWidth}
            transition-transform duration-200
            bg-white dark:bg-slate-900
            border-r border-slate-200 dark:border-white/10
            flex flex-col
          ">
            <!-- Brand -->
            <div class="px-4 py-4 border-b border-slate-200 dark:border-white/10">
              <div class="flex items-center gap-3">
                <div class="h-12 w-12 rounded-2xl bg-slate-100 dark:bg-white/10 overflow-hidden flex items-center justify-center shrink-0">
                  ${
                    settings.logoDataUrl
                      ? `<img src="${escapeHtml(settings.logoDataUrl)}" class="h-full w-full object-cover" alt="Logo">`
                      : `<div class="text-xl">üè´</div>`
                  }
                </div>
                <div class="${sidebarCollapsed ? "hidden" : ""}">
                  <div class="font-extrabold leading-tight">${escapeHtml(settings.schoolName)}</div>
                  <div class="text-sm text-slate-500 dark:text-slate-300">${escapeHtml(settings.schoolMotto)}</div>
                </div>

                <div class="ml-auto hidden lg:block">
                  <button class="p-2 rounded-xl bg-slate-100 dark:bg-white/10 hover:bg-slate-200 dark:hover:bg-white/15 transition"
                    onclick="toggleDesktopSidebar()" title="Kecil/Besar sidebar">
                    ${sidebarCollapsed ? "‚û°Ô∏è" : "‚¨ÖÔ∏è"}
                  </button>
                </div>
              </div>
            </div>

            <!-- Menu -->
            <nav class="p-3 space-y-1 flex-1 overflow-auto">
              ${menu.map(m => {
                const isActive = m.id === active;
                return `
                  <button class="
                    w-full flex items-center gap-3 px-3 py-3 rounded-2xl text-left
                    ${isActive ? "bg-slate-100 dark:bg-white/10" : "hover:bg-slate-50 dark:hover:bg-white/5"}
                    transition
                  " onclick="setPage('${m.id}')">
                    <div class="text-lg">${m.icon}</div>
                    <div class="${sidebarCollapsed ? "hidden" : ""} font-semibold">${escapeHtml(m.label)}</div>
                  </button>
                `;
              }).join("")}
            </nav>

            <!-- Footer -->
            <div class="p-4 border-t border-slate-200 dark:border-white/10">
              <div class="${sidebarCollapsed ? "hidden" : ""} text-xs text-slate-500 dark:text-slate-300">
                <div>${escapeHtml(settings.footerLine1)}</div>
                <div>${escapeHtml(settings.footerLine2)}</div>
              </div>
              <div class="${sidebarCollapsed ? "" : "hidden"} text-xs text-slate-500 dark:text-slate-300 text-center">¬©</div>
            </div>
          </aside>

          <!-- Main -->
          <div class="flex-1 min-w-0 flex flex-col lg:ml-0">
            <!-- Header -->
            <header class="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-white/10">
              <div class="px-4 lg:px-6 py-4 flex items-center justify-between gap-3">
                <div class="flex items-center gap-3 min-w-0">
                  <button class="p-2 rounded-xl bg-slate-100 dark:bg-white/10 hover:bg-slate-200 dark:hover:bg-white/15 transition lg:hidden"
                    onclick="toggleMobileSidebar()" aria-label="Menu">
                    ‚ò∞
                  </button>

                  <button class="hidden lg:flex items-center gap-2 rounded-xl hover:bg-slate-50 dark:hover:bg-white/5 px-2 py-1 transition"
                    onclick="setPage('home')" title="Kembali ke Laman Utama">
                    <div class="h-9 w-9 rounded-xl bg-slate-100 dark:bg-white/10 overflow-hidden flex items-center justify-center">
                      ${
                        settings.logoDataUrl
                          ? `<img src="${escapeHtml(settings.logoDataUrl)}" class="h-full w-full object-cover" alt="Logo">`
                          : `<div>üè´</div>`
                      }
                    </div>
                  </button>

                  <div class="min-w-0">
                    <div class="font-extrabold text-lg truncate">${escapeHtml(pageTitle())}</div>
                    <div class="text-sm text-slate-500 dark:text-slate-300 truncate">${escapeHtml(settings.schoolName)}</div>
                  </div>
                </div>

                <div class="flex items-center gap-2">
                  <!-- Theme preset -->
                  <select class="hidden sm:block px-3 py-2 rounded-xl bg-slate-100 dark:bg-white/10 dark:text-white ring-1 ring-slate-200 dark:ring-white/10 text-sm font-semibold"
                    onchange="setThemePreset(this.value)">
                    <option value="forest" ${settings.themePreset==="forest"?"selected":""}>Forest</option>
                    <option value="ocean"  ${settings.themePreset==="ocean"?"selected":""}>Ocean</option>
                    <option value="purple" ${settings.themePreset==="purple"?"selected":""}>Purple</option>
                    <option value="slate"  ${settings.themePreset==="slate"?"selected":""}>Slate</option>
                  </select>

                  <!-- Dark mode toggle -->
                  <button class="px-3 py-2 rounded-xl bg-slate-100 dark:bg-white/10 hover:bg-slate-200 dark:hover:bg-white/15 transition text-sm font-extrabold"
                    onclick="toggleDarkMode()"
                    title="Tukar tema">
                    ${settings.darkMode ? "üåô" : "‚òÄÔ∏è"}
                  </button>

                  <!-- Settings (PIN required to save) -->
                  <button class="px-3 py-2 rounded-xl bg-primary text-white hover:opacity-95 transition text-sm font-extrabold"
                    onclick="openSettings()">
                    ‚öôÔ∏è
                  </button>
                </div>
              </div>
            </header>

            <!-- Content -->
            <main class="flex-1 overflow-auto px-4 lg:px-6 py-6">
              ${active === "home" ? renderHome() :
                active === "kehadiran" ? renderKehadiran() :
                active === "pengumuman" ? renderPengumuman() :
                active === "takwim" ? renderTakwim() :
                active === "ibubapa" ? renderIbuBapa() : renderHome()
              }
            </main>
          </div>
        </div>

        ${renderModal()}
      `;

      // After render hooks
      if (ui.currentPage === "kehadiran"){
        // init dropdown filters after DOM exists
        setTimeout(() => initKehadiranFilters(), 30);
      }
    }

    /**********************
     * STARTUP
     **********************/
    (async function init(){
      // mobile default sidebar tertutup: sudah di defaultUI.sidebarOpen=false
      applyThemeToDocument();
      render();

      await loadAllData();
      render();
    })();
  </script>
</body>
</html>
