<!doctype html>
<html lang="ms" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portal Rasmi PPKI SK Paya Resak</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

  <style>
    :root {
      --font-main: 'Poppins', sans-serif;
      --bg-body: #F2F4F7;
      --bg-sidebar: #FFFFFF;
      --bg-card: #FFFFFF;
      --bg-element: #F9FAFB;
      --border-color: #EAECF0;
      --text-main: #101828;
      --text-muted: #667085;
      --primary: #1F6F4A; 
      --primary-light: #E8F5E9;
      --accent: #F79009;
      --shadow-md: 0 4px 6px -1px rgba(16, 24, 40, 0.1);
      --sidebar-w-full: 260px;
      --sidebar-w-mini: 80px;
    }

    html[data-mode="dark"] {
      --bg-body: #0F1115;
      --bg-sidebar: #161B22;
      --bg-card: #1C2128;
      --bg-element: #252B36;
      --border-color: #30363D;
      --text-main: #F0F6FC;
      --text-muted: #8B949E;
      --primary: #2EA043;
      --primary-light: rgba(46, 160, 67, 0.15);
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; font-family: var(--font-main); background: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; }

    .app-container { display: flex; height: 100%; width: 100%; }

    /* ===== SIDEBAR ===== */
    .sidebar {
      background: var(--bg-sidebar);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      padding: 20px 14px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 50;
      flex-shrink: 0;
      white-space: nowrap;
      overflow: hidden;
    }

    /* Desktop */
    @media (min-width: 769px) {
      .sidebar { width: var(--sidebar-w-full); }
      body.desktop-collapsed .sidebar { width: var(--sidebar-w-mini); }
      body.desktop-collapsed .brand-text, 
      body.desktop-collapsed .nav-text,
      body.desktop-collapsed .sidebar-footer { opacity: 0; pointer-events: none; display: none; }
      body.desktop-collapsed .nav-item { justify-content: center; padding-left: 0; padding-right: 0; }
      body.desktop-collapsed .brand { justify-content: center; padding-left: 0; }
    }

    /* Mobile */
    @media (max-width: 768px) {
      .sidebar {
        position: fixed; left: -100%; top: 0; height: 100%; width: 260px;
        box-shadow: 10px 0 30px rgba(0,0,0,0.2);
      }
      body.mobile-open .sidebar { left: 0; }
      /* Mobile Backdrop */
      .backdrop {
        position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40;
        display: none; opacity: 0; transition: opacity 0.3s;
      }
      body.mobile-open .backdrop { display: block; opacity: 1; }
    }

    .brand { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; min-height: 45px; }
    .brand-logo { width: 40px; height: 40px; border-radius: 8px; overflow: hidden; flex-shrink: 0; }
    .brand-logo img { width: 100%; height: 100%; object-fit: contain; }
    .brand-text h1 { margin: 0; font-size: 15px; font-weight: 700; }
    .brand-text p { margin: 0; font-size: 11px; color: var(--text-muted); }

    .nav-menu { flex: 1; display: flex; flex-direction: column; gap: 6px; overflow-y: auto; }
    .nav-item {
      display: flex; align-items: center; gap: 12px; padding: 12px;
      border-radius: 10px; cursor: pointer; color: var(--text-muted);
      text-decoration: none; transition: background 0.2s;
    }
    .nav-item:hover { background: var(--bg-element); color: var(--text-main); }
    .nav-item.active { background: var(--primary-light); color: var(--primary); font-weight: 600; }
    .nav-icon { font-size: 22px; display: flex; align-items: center; justify-content: center; }

    .sidebar-footer { margin-top: auto; font-size: 11px; text-align: center; color: var(--text-muted); padding-top: 20px; }

    /* ===== MAIN CONTENT ===== */
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
    
    .top-bar {
      height: 64px; display: flex; align-items: center; justify-content: space-between;
      padding: 0 24px; background: var(--bg-body); flex-shrink: 0;
    }
    .icon-btn {
      width: 40px; height: 40px; border-radius: 8px; border: none; background: transparent;
      color: var(--text-main); display: grid; place-items: center; cursor: pointer; font-size: 24px;
    }
    .icon-btn:hover { background: var(--bg-element); }

    .content-area { flex: 1; overflow-y: auto; padding: 10px 24px 40px 24px; }

    .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 24px; }
    .card { background: var(--bg-card); padding: 20px; border-radius: 16px; border: 1px solid var(--border-color); box-shadow: var(--shadow-md); }
    
    .stat-label { font-size: 13px; color: var(--text-muted); font-weight: 500; }
    .stat-val { font-size: 28px; font-weight: 700; margin: 5px 0; color: var(--text-main); }
    .stat-sub { font-size: 12px; display: flex; align-items: center; gap: 4px; color: var(--text-muted); }
    .stat-sub.red { color: #D92D20; font-weight: 600; }

    .page-banner {
      background: linear-gradient(135deg, var(--primary), #144d33); color: white;
      padding: 24px; border-radius: 16px; margin-bottom: 24px;
      display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;
    }
    .banner-text h2 { margin: 0; font-size: 22px; font-weight: 700; }
    .btn-action {
      background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);
      padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px;
    }
    .btn-action:hover { background: rgba(255,255,255,0.3); }

    .filter-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .form-select, .form-input {
      background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-main);
      padding: 8px 12px; border-radius: 8px; font-family: inherit; font-size: 13px;
    }
    .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 500; font-size: 13px; }
    .btn-primary { background: var(--primary); color: white; }

    .table-wrap { overflow-x: auto; border-radius: 12px; border: 1px solid var(--border-color); }
    table { width: 100%; border-collapse: collapse; min-width: 600px; font-size: 13px; }
    th { text-align: left; padding: 12px 16px; background: var(--bg-element); color: var(--text-muted); font-weight: 600; }
    td { padding: 12px 16px; border-top: 1px solid var(--border-color); color: var(--text-main); }
    .badge { padding: 4px 8px; border-radius: 20px; font-size: 11px; font-weight: 600; }
    .b-green { background: #ECFDF3; color: #027A48; }
    .b-red { background: #FEF3F2; color: #B42318; }

    .link-card { cursor: pointer; transition: transform 0.2s; }
    .link-card:hover { transform: translateY(-3px); border-color: var(--primary); }

    /* Modal Styling */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100;
      display: none; place-items: center; backdrop-filter: blur(2px);
    }
    .modal-overlay.active { display: grid; }
    .modal-content {
      width: 90%; max-width: 450px; background: var(--bg-card);
      border-radius: 16px; padding: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      max-height: 85vh; overflow-y: auto;
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-header h3 { margin: 0; font-size: 18px; }

    /* Settings Menu Toggles */
    .menu-toggle-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 8px;
    }
    .menu-toggle-item input { width: 18px; height: 18px; accent-color: var(--primary); }

    @media (max-width: 1024px) { .dashboard-grid { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 768px) { 
      .dashboard-grid { grid-template-columns: 1fr; }
      .page-banner { flex-direction: column; align-items: flex-start; }
      .filter-row { width: 100%; } .form-select { flex: 1; }
    }
  </style>
</head>
<body>

<div class="backdrop" onclick="toggleSidebar()"></div>

<div class="app-container">
  
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <div class="brand-logo">
        <img src="https://i.ibb.co/Y7sp2wZg/SKPR-1.png" alt="Logo">
      </div>
      <div class="brand-text">
        <h1>SK Paya Resak</h1>
        <p>Moving Forward</p>
      </div>
    </div>
    
    <nav class="nav-menu" id="sidebarMenu">
      </nav>

    <div class="sidebar-footer">
      Â© 2025 NK.
      Hak Cipta Terpelihara.
    </div>
  </aside>

  <main class="main-content">
    <header class="top-bar">
      <button class="icon-btn" onclick="toggleSidebar()">
        <span class="material-icons-round">menu</span>
      </button>
      
      <div style="display:flex; gap:10px;">
        <button class="icon-btn" onclick="toggleTheme()" title="Tema">
          <span class="material-icons-round">dark_mode</span>
        </button>
        <button class="icon-btn" onclick="openSettings()" title="Tetapan">
          <span class="material-icons-round">settings</span>
        </button>
      </div>
    </header>

    <div class="content-area">
      
      <div id="page-home" class="page-section">
        <div class="page-banner">
          <div class="banner-text">
            <h2>Dashboard</h2>
            <p>Selamat Datang ke Portal Rasmi PPKI</p>
          </div>
        </div>

        <div class="dashboard-grid">
          <div class="card stat-card">
            <div class="stat-label">Kehadiran Hari Ini</div>
            <div class="stat-val" id="dToday">-</div>
            <div class="stat-sub red" id="dAbsent">- Tidak Hadir</div>
          </div>
          <div class="card stat-card">
            <div class="stat-label">Minggu Ini</div>
            <div class="stat-val" id="dWeek">-</div>
            <div class="stat-sub">Rekod Kehadiran</div>
          </div>
          <div class="card stat-card">
            <div class="stat-label">Bulan Ini</div>
            <div class="stat-val" id="dPct">-</div>
            <div class="stat-sub">Peratus Kehadiran</div>
          </div>
          <div class="card stat-card">
            <div class="stat-label">Pengumuman</div>
            <div class="stat-val" id="dAnn">-</div>
            <div class="stat-sub">Aktif</div>
          </div>
        </div>

        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px; margin-bottom:20px;">
            <h3 style="margin:0; font-size:16px;">ðŸ“ˆ Trend Harian</h3>
            <div class="filter-row">
              <select class="form-select" id="trendType" onchange="renderTrend()">
                <option value="hadir">Hadir</option>
                <option value="tidak">Tidak Hadir</option>
                <option value="pct">%</option>
              </select>
              <select class="form-select" id="trendMonth" onchange="renderTrend()"></select>
              <select class="form-select" id="trendYear" onchange="renderTrend()"></select>
              <select class="form-select" id="trendClass" onchange="renderTrend()">
                <option value="">Semua Kelas</option>
              </select>
            </div>
          </div>
          <div id="chartContainer" style="height:280px; width:100%;"></div>
        </div>
      </div>

      <div id="page-attendance" class="page-section" style="display:none;">
        <div class="page-banner">
          <div class="banner-text">
            <h2>Analisis Kehadiran</h2>
            <p>Rekod kehadiran murid PPKI</p>
          </div>
          <div class="banner-actions">
            <button class="btn-action" onclick="loadAttendance(true)"><span class="material-icons-round" style="font-size:16px">refresh</span> Reload</button>
            <button class="btn-action" onclick="window.print()"><span class="material-icons-round" style="font-size:16px">print</span> Cetak</button>
          </div>
        </div>

        <div class="dashboard-grid">
          <div class="card">
            <div class="stat-label">Hadir (Tapis)</div>
            <div class="stat-val" id="attStatHadir">-</div>
          </div>
          <div class="card">
            <div class="stat-label">Tidak Hadir (Tapis)</div>
            <div class="stat-val" id="attStatTidak">-</div>
          </div>
          <div class="card">
            <div class="stat-label">Peratus (Tapis)</div>
            <div class="stat-val" id="attStatPct">-</div>
          </div>
          <div class="card">
            <div class="stat-label">Jumlah Rekod</div>
            <div class="stat-val" id="attStatTotal">-</div>
          </div>
        </div>

        <div class="card">
          <div class="filter-row" style="margin-bottom:15px; background:var(--bg-element); padding:10px; border-radius:12px;">
            <input class="form-input" id="searchAtt" placeholder="Cari Nama..." style="flex:1;">
            <select class="form-select" id="filterClassAtt"><option value="">Semua Kelas</option></select>
            <select class="form-select" id="filterStatusAtt">
              <option value="">Semua Status</option>
              <option value="HADIR">Hadir</option>
              <option value="TIDAK">Tidak Hadir</option>
            </select>
            <input type="date" class="form-input" id="filterDateAtt">
            <button class="btn btn-primary" onclick="applyFilterAtt()">Tapis</button>
            <button class="btn" style="background:transparent; border:1px solid var(--border-color)" onclick="resetFilterAtt()">Reset</button>
          </div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>Tarikh</th><th>Nama Murid</th><th>Kelas</th><th>Status</th></tr></thead>
              <tbody id="attBody"></tbody>
            </table>
          </div>
          <div style="margin-top:10px; font-size:12px; color:var(--text-muted);" id="attCount"></div>
        </div>
      </div>

      <div id="page-pajsk" class="page-section" style="display:none;">
        <div class="page-banner">
          <div class="banner-text">
            <h2>Rekod PAJSK</h2>
            <p>Pencapaian Kokurikulum</p>
          </div>
          <div class="banner-actions">
            <button class="btn-action" onclick="loadPajsk(true)"><span class="material-icons-round" style="font-size:16px">refresh</span> Reload</button>
            <button class="btn-action" onclick="window.print()"><span class="material-icons-round" style="font-size:16px">print</span> Cetak</button>
          </div>
        </div>
        <div class="card">
          <div class="filter-row" style="margin-bottom:15px;">
            <input class="form-input" id="searchPajsk" placeholder="Cari..." style="flex:1;" oninput="filterPajsk()">
          </div>
          <div class="table-wrap">
            <table><thead id="pajskHead"></thead><tbody id="pajskBody"></tbody></table>
          </div>
        </div>
      </div>

      <div id="page-announcements" class="page-section" style="display:none;">
        <div class="page-banner">
          <div class="banner-text">
            <h2>Pengumuman</h2>
            <p>Info Terkini</p>
          </div>
          <div class="banner-actions">
            <button class="btn-action" onclick="loadAnnouncements(true)"><span class="material-icons-round" style="font-size:16px">refresh</span> Reload</button>
          </div>
        </div>
        <div class="dashboard-grid" id="annGrid" style="grid-template-columns: 1fr 1fr;"></div>
      </div>

      <div id="page-calendar" class="page-section" style="display:none;">
        <div class="page-banner">
          <div class="banner-text"><h2>Takwim</h2><p>Jadual Aktiviti</p></div>
        </div>
        <div class="card">
          <div class="table-wrap"><table><thead id="calHead"></thead><tbody id="calBody"></tbody></table></div>
        </div>
      </div>

      <div id="page-parents" class="page-section" style="display:none;">
        <div class="page-banner">
          <div class="banner-text"><h2>Info Ibu Bapa</h2><p>Pautan & Dokumen</p></div>
        </div>
        <div class="dashboard-grid" id="parentsGrid"></div>
      </div>

    </div>
  </main>
</div>

<div class="modal-overlay" id="settingsModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Tetapan Portal</h3>
      <button class="icon-btn" onclick="closeSettings()"><span class="material-icons-round">close</span></button>
    </div>

    <div id="pinStep">
      <p style="font-size:13px; color:var(--text-muted); margin-bottom:10px;">Masukkan PIN keselamatan:</p>
      <input type="password" id="pinInput" class="form-input" placeholder="PIN" style="width:100%; margin-bottom:15px; text-align:center; letter-spacing:4px; font-size:18px;">
      <button class="btn btn-primary" onclick="checkPin()" style="width:100%">Log Masuk</button>
    </div>

    <div id="settingStep" style="display:none;">
      <label style="font-size:12px; font-weight:600; margin-top:10px; display:block;">Nama Sekolah</label>
      <input id="setName" class="form-input" style="width:100%;">
      
      <div style="margin:20px 0 10px; border-bottom:1px solid var(--border-color); padding-bottom:5px; font-weight:700;">Paparan Menu (Hide/Unhide)</div>
      <div id="menuManagerList"></div>

      <div style="margin:20px 0 10px; border-bottom:1px solid var(--border-color); padding-bottom:5px; font-weight:700;">Pautan CSV</div>
      <input id="setUrlAtt" class="form-input" style="width:100%; margin-bottom:8px;" placeholder="URL Kehadiran">
      <input id="setUrlPajsk" class="form-input" style="width:100%; margin-bottom:8px;" placeholder="URL PAJSK">
      <input id="setUrlAnn" class="form-input" style="width:100%; margin-bottom:8px;" placeholder="URL Pengumuman">

      <div style="display:flex; gap:10px; margin-top:20px;">
        <button class="btn btn-primary" onclick="saveSettings()" style="flex:1">Simpan</button>
        <button class="btn" style="border:1px solid var(--border-color); flex:1" onclick="closeSettings()">Batal</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ================= STATE & CONFIG ================= */
const DEFAULTS = {
  schoolName: "SK Paya Resak",
  pin: "5235", // Changed to your PIN
  urls: {
    attendance: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTKhex5gcCHKoiLqRZpgVRMRfrGGvPtbgc3jo_Q-3FPL5OpcoWvyAnec0dTgykrpkYuS34iNJnEAkDU/pub?gid=880667725&single=true&output=csv",
    pajsk: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRGcqw1v5SRbEL_2LMhX9I_X8uIo5CTQRzOpY5nTlbSc8_6Q4cx56LWtTI3-I5D9pJYeS20nEgADikT/pub?gid=0&single=true&output=csv",
    announcements: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQvKlO-LRGh8kj_-Be6NxZRR3Z38rjbC33jyvfhQvnR9L4LF7_dZRVXYGK3XO7bAoJwC9bJJmABjV6Z/pub?gid=946270411&single=true&output=csv",
    parents: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ_G1txQOE4Di1XsK6esbw8VgQtW2hcPsjzAmPH7V82JOeXegb7Kb_3Iz8CeHo-KvfvHe9x8BWtSfbB/pub?gid=1684744050&single=true&output=csv",
    calendar: ""
  },
  menus: [
    {id:'home', label:'Dashboard', icon:'dashboard', hidden:false},
    {id:'attendance', label:'Kehadiran', icon:'analytics', hidden:false},
    {id:'pajsk', label:'PAJSK', icon:'emoji_events', hidden:false},
    {id:'announcements', label:'Pengumuman', icon:'campaign', hidden:false},
    {id:'calendar', label:'Takwim', icon:'calendar_month', hidden:false},
    {id:'parents', label:'Ibu Bapa', icon:'diversity_3', hidden:false}
  ]
};

let CONFIG = JSON.parse(localStorage.getItem('portalConfig')) || DEFAULTS;
let DATA = { att: [], pajsk: [], ann: [], cal: [], par: [] };
let DATA_ATT_CLEAN = [];

/* ================= INIT ================= */
function init() {
  applyTheme();
  renderSidebar();
  setupTrendSelectors();
  loadAllData();
  document.querySelector('.brand-text h1').textContent = CONFIG.schoolName;
}

/* ================= SETTINGS LOGIC ================= */
function openSettings() {
  document.getElementById('settingsModal').classList.add('active');
  document.getElementById('pinInput').value = '';
  document.getElementById('pinStep').style.display = 'block';
  document.getElementById('settingStep').style.display = 'none';
}

function closeSettings() {
  document.getElementById('settingsModal').classList.remove('active');
}

function checkPin() {
  if(document.getElementById('pinInput').value === CONFIG.pin) {
    document.getElementById('pinStep').style.display = 'none';
    document.getElementById('settingStep').style.display = 'block';
    renderMenuSettings(); // Populate toggles
    // Populate Inputs
    document.getElementById('setName').value = CONFIG.schoolName;
    document.getElementById('setUrlAtt').value = CONFIG.urls.attendance;
    document.getElementById('setUrlPajsk').value = CONFIG.urls.pajsk;
    document.getElementById('setUrlAnn').value = CONFIG.urls.announcements;
  } else {
    alert('PIN salah!');
  }
}

function renderMenuSettings() {
  const c = document.getElementById('menuManagerList');
  c.innerHTML = CONFIG.menus.map((m,i) => `
    <div class="menu-toggle-item">
      <span style="display:flex; align-items:center; gap:10px">
        <span class="material-icons-round" style="font-size:18px; color:var(--text-muted)">${m.icon}</span> 
        ${m.label}
      </span>
      <input type="checkbox" ${!m.hidden?'checked':''} id="menuToggle_${i}">
    </div>
  `).join('');
}

function saveSettings() {
  // Update Config
  CONFIG.schoolName = document.getElementById('setName').value;
  CONFIG.urls.attendance = document.getElementById('setUrlAtt').value;
  CONFIG.urls.pajsk = document.getElementById('setUrlPajsk').value;
  CONFIG.urls.announcements = document.getElementById('setUrlAnn').value;

  // Save Menus status
  CONFIG.menus.forEach((m, i) => {
    const cb = document.getElementById(`menuToggle_${i}`);
    m.hidden = !cb.checked;
  });

  localStorage.setItem('portalConfig', JSON.stringify(CONFIG));
  alert('Tetapan disimpan.');
  location.reload(); // Reload to reflect changes
}

/* ================= SIDEBAR LOGIC ================= */
function toggleSidebar() {
  const body = document.body;
  if (window.innerWidth > 768) {
    body.classList.toggle('desktop-collapsed');
  } else {
    body.classList.toggle('mobile-open');
  }
}

function renderSidebar() {
  const nav = document.getElementById('sidebarMenu');
  nav.innerHTML = '';
  CONFIG.menus.forEach(m => {
    if(m.hidden) return;
    const a = document.createElement('a');
    a.className = `nav-item ${m.id==='home'?'active':''}`;
    a.id = `nav-${m.id}`;
    a.innerHTML = `<span class="nav-icon material-icons-round">${m.icon}</span> <span class="nav-text">${m.label}</span>`;
    a.onclick = () => navTo(m.id);
    nav.appendChild(a);
  });
}

function navTo(id) {
  document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
  const el = document.getElementById(`nav-${id}`);
  if(el) el.classList.add('active');
  
  document.querySelectorAll('.page-section').forEach(e => e.style.display='none');
  document.getElementById(`page-${id}`).style.display='block';
  
  if(window.innerWidth <= 768) document.body.classList.remove('mobile-open');
}

/* ================= DATA HANDLING ================= */
async function fetchCSV(url) {
  if(!url) return [];
  try {
    const res = await fetch(url + (url.includes('?')?'&':'?') + 't=' + Date.now());
    const text = await res.text();
    return parseCSV(text);
  } catch(e) { console.error(e); return []; }
}

function parseCSV(text) {
  const rows = text.split('\n').map(r => r.split(','));
  const headers = rows[0].map(h => h.trim().toUpperCase());
  return rows.slice(1).filter(r => r.length === headers.length).map(row => {
    let obj = {};
    headers.forEach((h, i) => obj[h] = row[i]?.trim());
    return obj;
  });
}

function getVal(row, keyPart) {
  const key = Object.keys(row).find(k => k.includes(keyPart.toUpperCase()));
  return key ? row[key] : "";
}

async function loadAllData() {
  const [att, pajsk, ann, cal, par] = await Promise.all([
    fetchCSV(CONFIG.urls.attendance),
    fetchCSV(CONFIG.urls.pajsk),
    fetchCSV(CONFIG.urls.announcements),
    fetchCSV(CONFIG.urls.calendar),
    fetchCSV(CONFIG.urls.parents)
  ]);
  DATA = { att, pajsk, ann, cal, par };
  
  processAttendance();
  renderAnn();
  renderPajskTable();
  renderParents();
  renderCalendar();
}

/* ================= ATTENDANCE & CHART ================= */
function processAttendance() {
  if(!DATA.att.length) return;
  
  DATA_ATT_CLEAN = DATA.att.map(r => {
    const dStr = getVal(r, 'TARIKH');
    let dObj = null;
    if(dStr && dStr.includes('/')) {
      const p = dStr.split('/');
      dObj = new Date(`${p[2]}-${p[1]}-${p[0]}`);
    } else if (dStr) dObj = new Date(dStr);

    return {
      date: dStr,
      rawDate: dObj,
      name: getVal(r, 'NAMA'),
      kelas: getVal(r, 'KELAS'),
      status: getVal(r, 'STATUS').toUpperCase()
    };
  }).filter(r => r.rawDate && !isNaN(r.rawDate));

  DATA_ATT_CLEAN.sort((a,b) => b.rawDate - a.rawDate);

  // Global Stats
  const todayStr = new Date().toISOString().split('T')[0];
  const todayRecs = DATA_ATT_CLEAN.filter(r => r.rawDate.toISOString().startsWith(todayStr));
  const present = todayRecs.filter(r => r.status === 'HADIR').length;
  const absent = todayRecs.filter(r => r.status.includes('TIDAK')).length;
  
  document.getElementById('dToday').innerText = present;
  document.getElementById('dAbsent').innerText = `${absent} Tidak Hadir`;
  document.getElementById('dWeek').innerText = DATA_ATT_CLEAN.length;
  document.getElementById('dPct').innerText = DATA_ATT_CLEAN.length ? Math.round((present/(present+absent||1))*100) + "%" : "0%";

  populateAttSelectors();
  renderAttTable(DATA_ATT_CLEAN);
  updateAttStats(DATA_ATT_CLEAN);
  renderTrend();
}

function renderAttTable(data) {
  const tb = document.getElementById('attBody');
  tb.innerHTML = data.slice(0,100).map(r => `
    <tr>
      <td>${r.date}</td>
      <td><strong>${r.name}</strong></td>
      <td>${r.kelas}</td>
      <td><span class="badge ${r.status==='HADIR'?'b-green':'b-red'}">${r.status}</span></td>
    </tr>
  `).join('');
  document.getElementById('attCount').innerText = `Menunjukkan ${Math.min(data.length,100)} daripada ${data.length} rekod.`;
}

function updateAttStats(data) {
  const p = data.filter(r => r.status==='HADIR').length;
  const a = data.filter(r => r.status.includes('TIDAK')).length;
  const t = data.length;
  document.getElementById('attStatHadir').innerText = p;
  document.getElementById('attStatTidak').innerText = a;
  document.getElementById('attStatTotal').innerText = t;
  document.getElementById('attStatPct').innerText = t ? Math.round((p/t)*100)+"%" : "0%";
}

function applyFilterAtt() {
  const q = document.getElementById('searchAtt').value.toLowerCase();
  const c = document.getElementById('filterClassAtt').value;
  const s = document.getElementById('filterStatusAtt').value;
  const d = document.getElementById('filterDateAtt').value;

  const filtered = DATA_ATT_CLEAN.filter(r => {
    let dateMatch = true;
    if(d) dateMatch = r.rawDate.toISOString().startsWith(d);
    return (!q || r.name.toLowerCase().includes(q)) &&
           (!c || r.kelas === c) &&
           (!s || (s==='HADIR'?r.status==='HADIR':r.status.includes('TIDAK'))) &&
           dateMatch;
  });
  renderAttTable(filtered);
  updateAttStats(filtered);
}

function populateAttSelectors() {
  const classes = [...new Set(DATA_ATT_CLEAN.map(r => r.kelas))].sort();
  const opts = '<option value="">Semua Kelas</option>' + classes.map(c=>`<option value="${c}">${c}</option>`).join('');
  document.getElementById('filterClassAtt').innerHTML = opts;
  document.getElementById('trendClass').innerHTML = opts;
}

/* ================= CHART (SVG) ================= */
function setupTrendSelectors() {
  const m = ["Jan","Feb","Mac","Apr","Mei","Jun","Jul","Ogos","Sep","Okt","Nov","Dis"];
  document.getElementById('trendMonth').innerHTML = m.map((n,i)=>`<option value="${i}">${n}</option>`).join('');
  document.getElementById('trendMonth').value = new Date().getMonth();
  const y = new Date().getFullYear();
  document.getElementById('trendYear').innerHTML = `<option value="${y-1}">${y-1}</option><option value="${y}" selected>${y}</option>`;
}

function renderTrend() {
  if(!DATA_ATT_CLEAN.length) return;
  const mode = document.getElementById('trendType').value;
  const mo = parseInt(document.getElementById('trendMonth').value);
  const yr = parseInt(document.getElementById('trendYear').value);
  const cl = document.getElementById('trendClass').value;

  const filtered = DATA_ATT_CLEAN.filter(r => r.rawDate.getMonth()===mo && r.rawDate.getFullYear()===yr && (!cl || r.kelas===cl));
  const daysInMonth = new Date(yr, mo+1, 0).getDate();
  let points = [];
  let maxVal = 0;

  for(let d=1; d<=daysInMonth; d++) {
    const dayRecs = filtered.filter(r => r.rawDate.getDate()===d);
    let val = 0;
    if(mode==='hadir') val = dayRecs.filter(r=>r.status==='HADIR').length;
    else if(mode==='tidak') val = dayRecs.filter(r=>r.status.includes('TIDAK')).length;
    else { if(dayRecs.length) val = (dayRecs.filter(r=>r.status==='HADIR').length / dayRecs.length) * 100; }
    if(val > maxVal) maxVal = val;
    points.push({x:d, y:val});
  }
  if(mode==='pct') maxVal = 100;
  if(maxVal===0) maxVal = 10;

  const W=900, H=280, Pad=30;
  const innerW = W - Pad*2;
  const innerH = H - Pad*2;
  
  const path = points.map((p,i) => {
    const px = Pad + (i * (innerW / (daysInMonth-1)));
    const py = (H - Pad) - (p.y / maxVal) * innerH;
    return `${px},${py}`;
  }).join(' ');

  document.getElementById('chartContainer').innerHTML = `
    <svg viewBox="0 0 ${W} ${H}" width="100%" height="100%" style="background:var(--bg-card); border-radius:12px;">
      <polyline points="${path}" fill="none" stroke="var(--primary)" stroke-width="3" />
      <text x="${Pad}" y="20" fill="var(--text-muted)" font-size="12">Max: ${Math.round(maxVal)}</text>
    </svg>
  `;
}

/* ================= OTHER DATA ================= */
function renderParents() {
  document.getElementById('parentsGrid').innerHTML = DATA.par.map(p => {
    const url = getVal(p, 'PAUTAN') || getVal(p, 'URL');
    const click = url ? `onclick="window.open('${url}', '_blank')"` : '';
    return `<div class="card link-card" ${click}><h4 style="margin:0 0 10px 0; color:var(--primary)">${getVal(p,'TAJUK')||'Info'}</h4><p style="font-size:13px; color:var(--text-muted); margin:0;">${getVal(p,'KANDUNGAN')}</p>${url?'<div style="margin-top:15px; font-size:12px; color:var(--accent); font-weight:600;">Buka Pautan &nearr;</div>':''}</div>`;
  }).join('');
}

function renderAnn() {
  document.getElementById('dAnn').innerText = DATA.ann.length;
  document.getElementById('annGrid').innerHTML = DATA.ann.map(a => `<div class="card"><div style="display:flex; justify-content:space-between; margin-bottom:10px"><span class="badge b-green">INFO</span><span style="font-size:11px; color:var(--text-muted)">${getVal(a,'TARIKH')}</span></div><h4 style="margin:0 0 10px;">${getVal(a,'TAJUK')}</h4><p style="font-size:13px; color:var(--text-muted);">${getVal(a,'KANDUNGAN')}</p></div>`).join('');
}

function renderPajskTable() {
  const h = document.getElementById('pajskHead');
  const b = document.getElementById('pajskBody');
  if(!DATA.pajsk.length) { b.innerHTML = '<tr><td>Tiada Data</td></tr>'; return; }
  const keys = Object.keys(DATA.pajsk[0]);
  h.innerHTML = `<tr>${keys.map(k=>`<th>${k}</th>`).join('')}</tr>`;
  const q = document.getElementById('searchPajsk').value.toLowerCase();
  b.innerHTML = DATA.pajsk.filter(r => !q || Object.values(r).some(v=>v.toLowerCase().includes(q))).map(r => `<tr>${keys.map(k=>`<td>${r[k]}</td>`).join('')}</tr>`).join('');
}
function filterPajsk() { renderPajskTable(); }
function renderCalendar() {
  if(!DATA.cal.length) return;
  const k=Object.keys(DATA.cal[0]);
  document.getElementById('calHead').innerHTML=`<tr>${k.map(x=>`<th>${x}</th>`).join('')}</tr>`;
  document.getElementById('calBody').innerHTML=DATA.cal.map(r=>`<tr>${k.map(x=>`<td>${r[x]}</td>`).join('')}</tr>`).join('');
}

function loadAttendance(m){ if(m)alert('Loading...'); fetchCSV(CONFIG.urls.attendance).then(d=>{DATA.att=d;processAttendance();}); }
function loadPajsk(m){ if(m)alert('Loading...'); fetchCSV(CONFIG.urls.pajsk).then(d=>{DATA.pajsk=d;renderPajskTable();}); }
function loadAnnouncements(m){ if(m)alert('Loading...'); fetchCSV(CONFIG.urls.announcements).then(d=>{DATA.ann=d;renderAnn();}); }

function toggleTheme() {
  const n = document.documentElement.getAttribute('data-mode')==='dark'?'light':'dark';
  document.documentElement.setAttribute('data-mode', n);
  localStorage.setItem('theme', n);
  renderTrend();
}
function applyTheme() { document.documentElement.setAttribute('data-mode', localStorage.getItem('theme')||'light'); }

init();
</script>
</body>
</html>
